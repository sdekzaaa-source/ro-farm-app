<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>OGHza Tracker V6.0.3</title>
    
    <!-- App Icon -->
    <link rel="icon" href="icon.png" type="image/png">
    <link rel="apple-touch-icon" href="icon.png">
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/prop-types@15.8.1/prop-types.min.js"></script>
    <script src="https://unpkg.com/recharts@2.12.7/umd/Recharts.js"></script>
    <script src="https://unpkg.com/@babel/standalone@7.23.7/babel.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&family=Kanit:wght@300;400;500;600&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Noto+Color+Emoji&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@700;900&display=swap');

        :root {
            /* ROX Authentic Theme (Light Only) */
            --app-bg: #f0f2f5; 
            --glass-bg: rgba(255, 255, 255, 0.98); 
            --panel-bg: #ffffff; 
            
            /* Text Colors */
            --text-main: #4a4238; 
            --text-muted: #8b96a5;
            
            --border-color: #dce1e8; 
            --input-bg: #f7f9fc; 
            --shadow-color: rgba(60, 68, 85, 0.08); 
            
            /* ROX Signature Colors */
            --accent-primary: #4a90e2; /* Blue Button */
            --accent-secondary: #ff5e78; /* Pink/Red Button */
            --accent-highlight: #f5a623; /* Gold/Yellow */
            
            --card-gradient: linear-gradient(180deg, #ffffff 0%, #f7fafc 100%);
            
            --badge-bg: #e53e3e; 
            --badge-text: #ffffff; 
            
            --modal-bg: #ffffff;
            
            --nav-active: #d69e2e; 
            --nav-inactive: #8b96a5; 
            
            --blur-strength: 8px;
            --currency-bg: #ffffff;
            
            /* Inventory Slot */
            --slot-bg: #f1f5f9;
        }

        /* --- GLOBAL OVERRIDES --- */
        
        /* Map Dark classes to Light Theme for compatibility */
        .bg-zinc-900, .bg-zinc-900\/50, .bg-zinc-900\/80, .bg-zinc-900\/95, .bg-black\/90, .bg-black {
            background-color: #f8fafc !important; /* Very light grey */
            border-color: #e2e8f0 !important;
            color: var(--text-main) !important;
        }

        .bg-zinc-800, .bg-zinc-800\/50, .bg-zinc-800\/95 {
            background-color: #ffffff !important; 
            border-color: var(--border-color) !important;
            color: var(--text-main) !important;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05) !important;
        }

        .bg-zinc-700, .bg-zinc-600 {
            background-color: #e2e8f0 !important; 
            color: #475569 !important; 
            border-color: #cbd5e0 !important;
        }
        
        button.text-white { color: #ffffff !important; }
        .text-zinc-200, .text-zinc-300, .text-zinc-400 { color: var(--text-main) !important; }
        .text-zinc-500, .text-zinc-600 { color: var(--text-muted) !important; }
        .border-zinc-700, .border-zinc-800, .border-zinc-800\/50 { border-color: var(--border-color) !important; }

        /* Input Fields - Underline Style Override */
        .slate-input {
            background-color: transparent !important; 
            border: none !important;
            border-bottom: 2px solid #cbd5e0 !important;
            border-radius: 0 !important;
            box-shadow: none !important;
            padding-left: 0 !important;
            padding-right: 0 !important;
            text-align: center;
        }
        
        input[type="text"], input[type="number"], textarea {
            background-color: var(--input-bg);
            border: 1px solid #cbd5e0;
            border-radius: 8px;
        }

        .slate-input:focus, .shop-input:focus {
            background-color: transparent !important;
            border-bottom-color: var(--accent-primary) !important;
            box-shadow: none !important;
            outline: none !important;
        }
        
        /* Specific Override for Adventure Note to prevent dark background on focus */
        textarea.note-input:focus {
            background-color: #ffffff !important;
            border-color: var(--accent-primary) !important;
            color: var(--text-main) !important;
        }

        /* Inventory Slot Style */
        .sunken-slot {
            background-color: var(--slot-bg) !important;
            border: 1px solid #e2e8f0 !important;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.03) !important;
            border-radius: 12px !important; 
        }
        
        .currency-pill { 
            background: var(--currency-bg); 
            border-radius: 9999px; 
            padding: 4px 12px; 
            display: flex; 
            align-items: center; 
            gap: 6px; 
            font-size: 11px; 
            font-weight: bold; 
            color: var(--text-main); 
            border: 1px solid var(--border-color); 
            box-shadow: 0 2px 4px rgba(0,0,0,0.05); 
        }

        /* Colors Mapping - ROX Style */
        .bg-emerald-500, .bg-emerald-600 { 
            background: linear-gradient(180deg, #6aaeff 0%, #4a82ee 100%) !important;
            box-shadow: 0 2px 4px rgba(74, 144, 226, 0.3) !important;
            border: 1px solid #3b66c4 !important;
        }
        .text-emerald-400, .text-emerald-500 { color: #4a90e2 !important; }
        
        .bg-gradient-to-r.from-emerald-600 {
            background: linear-gradient(135deg, #4a90e2 0%, #357abd 100%) !important;
            box-shadow: 0 4px 10px rgba(74, 144, 226, 0.4) !important;
        }

        .bg-rose-900\/50, .bg-rose-900\/20 { background-color: rgba(255, 94, 120, 0.15) !important; }
        .text-rose-400 { color: #ff5e78 !important; } 
        
        .text-blue-400 { color: #4a90e2 !important; }
        .text-amber-400 { color: #f5a623 !important; }

        /* Nav Bar - Gold/Yellow for active */
        .nav-item-active { 
            color: var(--nav-active) !important; 
            opacity: 1 !important; 
            font-weight: 800 !important; 
            transform: translateY(-2px);
        }
        .nav-item-inactive { color: var(--nav-inactive) !important; opacity: 0.7 !important; }

        /* Reward Card */
        .reward-card-base {
            background: linear-gradient(180deg, #ffffff 0%, #f7fafc 100%) !important;
            border-color: #dce1e8 !important;
            box-shadow: 0 20px 60px rgba(0,0,0,0.15) !important;
            color: var(--text-main) !important;
        }
        .modal-overlay-base { background-color: rgba(255, 255, 255, 0.8) !important; backdrop-filter: blur(8px); }
        .bg-black\/20 { background-color: rgba(0,0,0,0.03) !important; }
        
        .item-badge { background-color: var(--badge-bg) !important; color: var(--badge-text) !important; border: 2px solid white !important; box-shadow: 0 2px 4px rgba(0,0,0,0.2); border-radius: 9999px; }
        .modal-bg-flip { background-color: #ffffff !important; color: var(--text-main) !important; border-color: #e2e8f0 !important; box-shadow: 0 20px 40px rgba(0,0,0,0.1) !important; }

        /* Active Character Card */
        .active-char-card {
            background-color: #fffbef !important;
            border-color: #f7c756 !important;
            box-shadow: 0 2px 6px rgba(247, 199, 86, 0.2) !important;
        }
        .active-char-card p { color: #b7791f !important; }

        @keyframes redPulseBorder {
            0% { border-color: rgba(255, 94, 120, 0.4); box-shadow: 0 0 0 0 rgba(255, 94, 120, 0.2); }
            50% { border-color: rgba(255, 94, 120, 1); box-shadow: 0 0 0 4px rgba(255, 94, 120, 0.1); }
            100% { border-color: rgba(255, 94, 120, 0.4); box-shadow: 0 0 0 0 rgba(255, 94, 120, 0); }
        }
        .red-alert { animation: redPulseBorder 2s infinite; border-width: 2px !important; border-style: solid !important; }

        .scrollbar-hide::-webkit-scrollbar { display: none !important; }
        .scrollbar-hide { -ms-overflow-style: none !important; scrollbar-width: none !important; }

        .view-content { padding-bottom: calc(env(safe-area-inset-bottom) + 120px) !important; }

        /* Share Card Fix */
        .rom-card { background: linear-gradient(180deg, #ffffff 0%, #f7fafc 100%) !important; border: 2px solid #d1d5db !important; }
        .rom-item-box { background: rgba(0,0,0,0.03) !important; border-color: rgba(0,0,0,0.05) !important; }
        .rom-header-text { color: #4a4238 !important; text-shadow: none !important; }

        body { font-family: 'Inter', 'Kanit', sans-serif; background-color: var(--app-bg); color: var(--text-main); overflow-x: hidden; margin: 0; padding: 0; user-select: none; -webkit-user-select: none; -webkit-tap-highlight-color: transparent; transition: background-color 0.3s, color 0.3s; }
        .glass-panel { background: var(--glass-bg); backdrop-filter: blur(var(--blur-strength)); -webkit-backdrop-filter: blur(var(--blur-strength)); border: 1px solid var(--border-color); box-shadow: 0 4px 12px -2px var(--shadow-color); transition: background 0.3s, border-color 0.3s, box-shadow 0.3s; }
        
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
        .calendar-cell { aspect-ratio: 1; border-radius: 8px; font-size: 10px; font-weight: bold; display: flex; align-items: center; justify-content: center; position: relative; }
        .calendar-header { font-size: 10px; text-transform: uppercase; color: var(--text-muted); text-align: center; font-weight: 900; margin-bottom: 4px; }
        .calendar-green { background-color: rgba(16, 185, 129, 0.15); color: #059669; border: 1px solid rgba(16, 185, 129, 0.3); }
        .calendar-red { background-color: rgba(244, 63, 94, 0.15); color: #e11d48; border: 1px solid rgba(244, 63, 94, 0.3); }
        .calendar-neutral { background-color: var(--input-bg); color: var(--text-muted); border: 1px solid transparent; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module" data-presets="react">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { getFirestore, doc, setDoc, getDoc, updateDoc, collection, query, orderBy, onSnapshot, addDoc, deleteDoc, getDocs, increment, writeBatch, limit } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

        const { useState, useEffect, useMemo, useRef, memo } = React;

        const APP_VERSION = "Ver.6.0.3";
        
        const MANUAL_FIREBASE_CONFIG = { apiKey: "AIzaSyAbWzr8o_OhkjGbEetBYq_nzYmVZ2fTf40", authDomain: "rocogh-88a38.firebaseapp.com", projectId: "rocogh-88a38", storageBucket: "rocogh-88a38.firebasestorage.app", messagingSenderId: "1025971309206", appId: "1:1025971309206:web:d4f9e0ab6bb016dde590b7" };
        const INITIAL_STATS = { baseLv: 1, baseExp: 0, jobLv: 1, jobExp: 0, jobClass: 'Novice', coins: 0, zeny: 0, unlockedTitles: ['Novice'], savingsGoal: 0, wishlist: null };
        const SHOP_ITEMS = [ { id: 'premium_box', name: 'Premium Service Box', duration: 30, type: 'buff_box', icon: 'Premium', desc: 'กล่องพรีเมียม 30 วัน', rarity: 'Rare', category: 'Consumable' }, { id: 'kafra_box', name: 'Kafra Buff (7d)', duration: 7, type: 'buff_box', icon: 'Kafra', desc: 'บัฟคลังคาฟร่า 7 วัน', rarity: 'Uncommon', category: 'Consumable' }, { id: 'silvervine_box', name: 'Silvervine Box (10ea)', qty: 10, type: 'consumable_box', subType: 'silvervine', icon: 'SilvervineBox', desc: 'กล่องผลไม้แมว 10 ชิ้น', rarity: 'Uncommon', category: 'Consumable' }, { id: 'gum_box', name: 'Bubble Gum Box (10ea)', qty: 10, type: 'consumable_box', subType: 'gum', icon: 'GumBox', desc: 'กล่องหมากฝรั่ง 10 ชิ้น', rarity: 'Common', category: 'Consumable' }, { id: 'he_gum_box', name: 'HE Bubble Gum Box (5ea)', qty: 5, type: 'consumable_box', subType: 'he_gum', icon: 'HeGumBox', desc: 'กล่องหมากฝรั่ง HE 5 ชิ้น', rarity: 'Rare', category: 'Consumable' } ];
        
        const ITEM_DETAILS = { 
            'spell': { name: 'Coagulated Spell', desc: 'ผลึกเวทมนตร์สีม่วง', type: 'Etc', rarity: 'Common', category: 'Etc', icon: 'Spell' }, 
            'magic': { name: 'Contaminated Magic', desc: 'ผลึกเวทมนตร์สีแดง', type: 'Etc', rarity: 'Uncommon', category: 'Etc', icon: 'Magic' }, 
            'gum': { name: 'Bubble Gum', desc: 'เพิ่ม drop rate 100%', type: 'Consumable', rarity: 'Common', category: 'Consumable', icon: 'Gum' }, 
            'he_gum': { name: 'HE Bubble Gum', desc: 'เพิ่ม drop rate 200%', type: 'Consumable', rarity: 'Rare', category: 'Consumable', icon: 'HeGum' }, 
            'silvervine': { name: 'Silvervine', desc: 'ผลไม้แมว', type: 'Etc', rarity: 'Common', category: 'Etc', icon: 'Silvervine' }, 
            'premium_staff': { name: 'Premium Staff', desc: 'คฑา VIP', type: 'Tool', rarity: 'Legendary', category: 'Consumable', icon: 'PremiumStaff' }, 
            'premium_box': { name: 'Premium Service Box', desc: 'VIP 30 วัน', type: 'Consumable', rarity: 'Rare', category: 'Consumable', icon: 'Premium' },
            'silvervine_box': { name: 'Silvervine Box', desc: 'กล่องผลไม้แมว 10 ชิ้น', type: 'Consumable', rarity: 'Uncommon', category: 'Consumable', icon: 'SilvervineBox' },
            'gum_box': { name: 'Bubble Gum Box', desc: 'กล่องหมากฝรั่ง 10 ชิ้น', type: 'Consumable', rarity: 'Common', category: 'Consumable', icon: 'GumBox' },
            'he_gum_box': { name: 'HE Bubble Gum Box', desc: 'กล่องหมากฝรั่ง HE 5 ชิ้น', type: 'Consumable', rarity: 'Rare', category: 'Consumable', icon: 'HeGumBox' },
            'kafra_box': { name: 'Kafra Buff', desc: 'บัฟคลังคาฟร่า 7 วัน', type: 'Consumable', rarity: 'Uncommon', category: 'Consumable', icon: 'Kafra' },
            'card_wk': { name: 'White Knight', desc: 'Card', icon: 'Card', rarity: 'Rare' },
            'card_kk': { name: 'Khalitzburg', desc: 'Card', icon: 'Card', rarity: 'Rare' },
            'card_ogh': { name: 'OGH Card', desc: 'Legendary Card', icon: 'Card', rarity: 'Legendary' }
        };
        const DROP_TABLE = [ { id: 'elu', name: 'Elunium', rate: 0.4, min: 1, max: 2, icon: 'Elunium' }, { id: 'ori', name: 'Oridecon', rate: 0.4, min: 1, max: 2, icon: 'Oridecon' }, { id: 'card_wk', name: 'White Knight Card', rarity: 'Rare', rate: 0.05, min: 1, max: 1, icon: 'Card' }, { id: 'card_kk', name: 'Khalitzburg Card', rarity: 'Rare', rate: 0.05, min: 1, max: 1, icon: 'Card' }, { id: 'card_ogh', name: 'OGH Card', rarity: 'Legendary', rate: 0.001, min: 1, max: 1, icon: 'Card' } ];

        const formatMoney = (n) => new Intl.NumberFormat('en-US', { notation: "compact", maximumFractionDigits: 1 }).format(n || 0);
        const getExpReq = (lv) => Math.floor(100 * Math.pow(lv || 1, 1.5));
        
        const copyToClipboard = (text) => { const textArea = document.createElement("textarea"); textArea.value = text; document.body.appendChild(textArea); textArea.select(); try { document.execCommand('copy'); } catch (err) {} document.body.removeChild(textArea); };
        const getItemInfo = (id) => { 
            if (!id) return { name: 'Unknown', desc: 'Error', type: 'Etc', rarity: 'Common', icon: 'Box' };
            if (ITEM_DETAILS[id]) return ITEM_DETAILS[id]; 
            const dropItem = DROP_TABLE.find(d => d.id === id); 
            if (dropItem) return dropItem; 
            const shopItem = SHOP_ITEMS.find(s => s.id === id); 
            if (shopItem) return { ...shopItem, type: 'Box', rarity: shopItem.rarity || 'Common', category: shopItem.category || 'Consumable' }; 
            return { name: 'Unknown Item', desc: 'No description.', type: 'Etc', rarity: 'Common', icon: 'Box', category: 'Etc' }; 
        };

        const getRankInfo = (profit, averageProfit) => { if (profit < 0) return { rank: 'F', css: 'rank-f', text: 'LOSS' }; if (!averageProfit || averageProfit === 0) return { rank: 'B', css: 'rank-b', text: 'NORMAL' }; const diff = (profit - averageProfit) / averageProfit; if (diff >= 0.5) return { rank: 'S', css: 'rank-s', text: 'LUCKY' }; if (diff >= 0.3) return { rank: 'A', css: 'rank-a', text: 'GOOD' }; if (diff >= -0.1) return { rank: 'B', css: 'rank-b', text: 'NORMAL' }; if (diff >= -0.3) return { rank: 'C', css: 'rank-c', text: 'BAD' }; if (diff >= -0.5) return { rank: 'D', css: 'rank-d', text: 'POOR' }; return { rank: 'E', css: 'rank-e', text: 'AWFUL' }; };
        
        // Utility: Get current date relative to game reset (4 AM)
        const getGameDate = () => {
            const now = new Date();
            now.setHours(now.getHours() - 4);
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };
        
        // Utility: Get Date object relative to game reset
        const getGameDateObj = () => {
            const now = new Date();
            now.setHours(now.getHours() - 4);
            return now;
        };

        const Icon = ({ name, size = 20, className }) => {
            let viewBox = "0 0 24 24";
            let content = null;
            let stroke = "currentColor";
            let fill = "none";
            
            const defaultProps = { strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round" };

            switch (name) {
                case 'Home': viewBox="0 0 48 48"; stroke="none"; content=(<><path fill="#c8d3de" d="M42,39H6v2c0,1.1,0.9,2,2,2h32c1.1,0,2-0.9,2-2V39z"/><path fill="#e8e8e8" d="M42,39H6V20L24,3l18,17V39z"/><path fill="#de490d" d="M13,25h10c0.6,0,1,0.4,1,1v17H12V26C12,25.4,12.4,25,13,25z"/><path fill="#b9360c" d="M44.5,19.5L25.3,2.5C24.9,2.2,24.5,2,24,2s-0.9,0.2-1.3,0.5L3.5,19.5c-0.4,0.4-0.4,1-0.1,1.4l1.6,1.7c0.4,0.4,1,0.4,1.4,0.1L24,7.4l17.5,15.3c0.4,0.4,1,0.3,1.4-0.1l1.6-1.7C44.9,20.5,44.9,19.9,44.5,19.5z"/><path fill="#0a85d9" d="M29,25h6c0.6,0,1,0.4,1,1v6c0,0.6-0.4,1-1,1h-6c-0.6,0-1-0.4-1-1v-6C28,25.4,28.4,25,29,25z"/></>); break;
                case 'Inventory': viewBox="0 0 50 50"; stroke="none"; content=(<><polygon fill="#e68f3a" points="43,14.6 43,33.08 23,44.63 23,44.62 7,35.39 7,16.91 27,5.36"/><polygon fill="#ff9f40" points="23,26.149 23,44.624 7,35.389 7,16.904"/><polygon fill="#b3702d" points="43,33.083 23,44.63 23,26.149 43,14.602"/><polygon fill="#d98836" points="12,24.423 12,26.732 18,30.196 18,27.887"/><polygon fill="#b3702d" points="12,24.423 12,26.732 14,25.577"/></>); break;
                case 'Shop': viewBox="0 0 128 128"; stroke="none"; content=(<><path d="M93.46 39.45c6.71-1.49 15.45-8.15 16.78-11.43c.78-1.92-3.11-4.92-4.15-6.13c-2.38-2.76-1.42-4.12-.5-7.41c1.05-3.74-1.44-7.87-4.97-9.49s-7.75-1.11-11.3.47c-3.55 1.58-6.58 4.12-9.55 6.62c-2.17-1.37-5.63-7.42-11.23-3.49c-3.87 2.71-4.22 8.61-3.72 13.32c1.17 10.87 3.85 16.51 8.9 18.03c6.38 1.92 13.44.91 19.74-.49z" fill="#FFCA28"/><path d="M104.36 8.18c-.85 14.65-15.14 24.37-21.92 28.65l4.4 3.78s2.79.06 6.61-1.16c6.55-2.08 16.12-7.96 16.78-11.43c.97-5.05-4.21-3.95-5.38-7.94c-.61-2.11 2.97-6.1-.49-11.9zm-24.58 3.91s-2.55-2.61-4.44-3.8c-.94 1.77-1.61 3.69-1.94 5.67c-.59 3.48 0 8.42 1.39 12.1c.22.57 1.04.48 1.13-.12c1.2-7.91 3.86-13.85 3.86-13.85z" fill="#E2A610"/><path d="M61.96 38.16S30.77 41.53 16.7 68.61c-14.07 27.08-2.11 43.5 10.55 49.48c12.66 5.98 44.56 8.09 65.31 3.17s25.94-15.12 24.97-24.97c-1.41-14.38-14.77-23.22-14.77-23.22s.53-17.76-13.25-29.29c-12.23-10.24-27.55-5.62-27.55-5.62z" fill="#FFCA28"/><path d="M74.76 83.73c-6.69-8.44-14.59-9.57-17.12-12.6c-1.38-1.65-2.19-3.32-1.88-5.39c.33-2.2 2.88-3.72 4.86-4.09c2.31-.44 7.82-.21 12.45 4.2c1.1 1.04.7 2.66.67 4.11c-.08 3.11 4.37 6.13 7.97 3.53c3.61-2.61.84-8.42-1.49-11.24c-1.76-2.13-8.14-6.82-16.07-7.56c-2.23-.21-11.2-1.54-16.38 8.31c-1.49 2.83-2.04 9.67 5.76 15.45c1.63 1.21 10.09 5.51 12.44 8.3c4.07 4.83 1.28 9.08-1.9 9.64c-8.67 1.52-13.58-3.17-14.49-5.74c-.65-1.83.03-3.81-.81-5.53c-.86-1.77-2.62-2.47-4.48-1.88c-6.1 1.94-4.16 8.61-1.46 12.28c2.89 3.93 6.44 6.3 10.43 7.6c14.89 4.85 22.05-2.81 23.3-8.42c.92-4.11.82-7.67-1.8-10.97z" fill="#6B4B46"/></>); break;
                case 'Dungeon': viewBox="0 0 504.32 504.32"; stroke="none"; content=(<><path style={{fill:"#FFD0A1"}} d="M95.427,448.707L161.133,383l-42.667-42.667L52.76,406.04l-14.507-14.507c-3.413-3.413-8.533-3.413-11.947,0L6.68,411.16c-3.413,3.413-3.413,8.533,0,11.947l72.533,72.533c3.413,3.413,8.533,3.413,11.947,0l19.627-19.627c3.413-3.413,3.413-9.387-1.707-13.653L95.427,448.707L95.427,448.707z M74.093,427.374L52.76,406.04l0,0l0,0L74.093,427.374z"/><path style={{fill:"#ECF4F7"}} d="M173.933,327.533L173.933,327.533L203.8,357.4l0,0l46.933-46.933L220.867,280.6L173.933,327.533L173.933,327.533L173.933,327.533l46.933-46.933L191,250.733l-46.933,46.933l0,0L173.933,327.533L173.933,327.533z M498.2,3.267l-17.067,76.8L310.467,250.733L280.6,220.867L498.2,3.267z M498.2,3.267l-217.6,217.6L250.733,191L421.4,20.333L498.2,3.267z"/><path style={{fill:"#ECF4F7"}} d="M357.4,297.667l-29.867,29.867L3.267,3.267l76.8,17.067L250.733,191l29.867,29.867l29.867,29.867L357.4,297.667z M327.533,327.533L297.667,357.4l-46.933-46.933L220.867,280.6L191,250.733L20.333,80.067L3.267,3.267L327.533,327.533z"/><path style={{fill:"#AE938D"}} d="M203.8,357.4l29.867,29.867c-22.187,22.187-45.227,23.04-68.267,0L161.133,383l0,0l-42.667-42.667l-4.267-4.267c-22.187-22.187-23.04-45.227,0-68.267l29.867,29.867l29.867,29.867L203.8,357.4z M357.4,297.667l29.867-29.867c23.04,22.187,23.04,45.227,0,68.267L383,340.333l0,0L340.333,383l-4.267,4.267c-22.187-22.187-45.227,23.04-68.267,0l29.867-29.867l29.867-29.867L357.4,297.667z"/><path style={{fill:"#FFD0A1"}} d="M406.893,448.707l41.813-41.813L383,341.187l0,0l-42.667,42.667L406.893,448.707L406.893,448.707l-15.36,15.36c-3.413,3.413-3.413,8.533,0,11.947l19.627,19.627c3.413,3.413,8.533,3.413,11.947,0l72.533-72.533c3.413,3.413,3.413-8.533,0-11.947l-19.627-19.627c-3.413-3.413-9.387-3.413-13.653,1.707l-12.8,12.8C448.707,406.04,406.893,448.707,406.893,448.707z"/><path style={{fill:"#51565F"}} d="M418.133,503.467c-3.413,0-6.827-1.707-9.387-3.413l-19.627-19.627c-5.12-5.12-5.12-12.8,0-17.92l11.947-11.947l-59.733-59.733l-0.853,0.853c-23.893,23.893-50.347,23.893-74.24,0c-1.707-1.707-1.707-4.267,0-5.973L385.707,266.24c1.707-1.707,4.267-1.707,5.973,0c11.947,11.947,17.92,24.747,17.92,36.693c0,12.8-5.973,24.747-17.92,37.547l-0.853,0.853l59.733,59.733l10.24-10.24c6.827-6.827,15.36-6.827,20.48-1.707l19.627,19.627c2.56,2.56,3.413,5.973,3.413,9.387c0,3.413-1.707,6.827-3.413,9.387l-72.533,72.533C424.96,501.76,421.547,503.467,418.133,503.467z"/></>); break;
                case 'History': viewBox = "0 0 1024 1024"; stroke = "none"; content = (<><path d="M903.73,183.71l-57.87-0.55c-0.73,0-91.94-5.44-128.64-11.87c-79.15-13.82-142.53-12.6-209.45,35.23c-68.57-47.29-114.94-50.22-204.13-35.05c-7.52,1.28-14.74,2.63-21.9,3.98c-26.79,5.14-104.05,8.26-104.05,8.26H120c-12.97,0-23.49,10.52-23.49,23.49v599.17c0,12.97,10.52,23.49,23.49,23.49h292.83c-0.67,2.08-1.35,4.16-1.35,6.48c0,12.6,10.64,22.82,23.92,22.82h146.14c13.27,0,23.98-10.22,23.98-22.82c0-2.32-0.67-4.4-1.41-6.48h299.62c13.03,0,23.55-10.52,23.55-23.49V207.2c0-12.97-10.52-23.49-23.55-23.49z" fill="#27323A"/><path d="M143.55,230.75h30.71v552.13H143.55z" fill="#FFFFFF"/><path d="M206.62,230.94c33.95-0.18,59.58-4.71,83.87-9.3a825.05,825.05,0,0,1,21.04-3.86c88.09-14.92,119.77-8.93,178.5,33.77c0.37,0.24,0.74,0.37,1.1,0.55v497.93c-76.1-66.74-144.49-40.25-230.31-6.48l-54.2,22.63c-0.12-92.31-0.12-431.2-0.001-535.25z" fill="#79CCBF"/><path d="M272.56,772.3c88.51-34.81,141.92-55.73,208.47,10.52c0,0,0.06,0.06,0.12,0.06H247.18l25.39-10.58z" fill="#F4CE73"/><path d="M534.75,782.89c0.3-0.24,0.73-0.43,1.04-0.73c61.41-66.92,119.47-45.02,215.32-8.93l23.61,9.67H534.75z" fill="#F4CE73"/><path d="M814.85,765.88l-52.36-21.53c-93.16-35.11-167.49-62.88-240.03,7.28v-498.3c1.41-0.67,2.88-1.22,4.16-2.2c57.56-45.02,108.58-46.49,182.54-33.52c29.06,5.08,80.2,9.48,105.7,11.44c0.24,103.32,0.24,445.7,0,536.84z" fill="#79CCBF"/><path d="M846.11,230.75h34.13v552.13h-34.13z" fill="#FFFFFF"/></>); break;
                case 'Chart': content=<><rect x="3" y="3" width="18" height="18" rx="2" ry="2" stroke="currentColor" strokeWidth="2" fill="none"/><path d="M8 17V11M12 17V7M16 17V13" stroke="currentColor" strokeWidth="2" strokeLinecap="round"/></>; break;
                case 'Calendar': content=<><rect x="3" y="4" width="18" height="18" rx="2" ry="2" stroke="currentColor" strokeWidth="2" fill="none"/><line x1="16" y1="2" x2="16" y2="6" stroke="currentColor" strokeWidth="2"/><line x1="8" y1="2" x2="8" y2="6" stroke="currentColor" strokeWidth="2"/><line x1="3" y1="10" x2="21" y2="10" stroke="currentColor" strokeWidth="2"/></>; break;
                case 'Target': content=<><circle cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="2" fill="none"/><circle cx="12" cy="12" r="6" stroke="currentColor" strokeWidth="2" fill="none"/><circle cx="12" cy="12" r="2" fill="currentColor"/></>; break;
                case 'Tag': content=<><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z" fill="none" stroke="currentColor" strokeWidth="2"/><line x1="7" y1="7" x2="7.01" y2="7" stroke="currentColor" strokeWidth="2"/></>; break;
                case 'Shield': content = <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" stroke="currentColor" strokeWidth="2" fill="none" strokeLinecap="round" strokeLinejoin="round"/>; break;
                case 'Sword': content = <><path d="M14.5 4l-8.5 8.5a2.121 2.121 0 0 0 3 3l8.5-8.5-3-3zM2 18l3 3 2.5-2.5-3-3L2 18zM15 3.5l5.5 5.5" stroke="currentColor" strokeWidth="2" fill="none" strokeLinecap="round" strokeLinejoin="round"/></>; break;
                // Reuse existing icons...
                case 'Settings': content = <><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></>; break;
                case 'Trash': content = <><polyline points="3 6 5 6 21 6" fill="none" stroke="currentColor" strokeWidth="2"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" fill="none" stroke="currentColor" strokeWidth="2"/><line x1="10" y1="11" x2="10" y2="17" stroke="currentColor" strokeWidth="2"/><line x1="14" y1="11" x2="14" y2="17" stroke="currentColor" strokeWidth="2"/></>; break;
                case 'Plus': content = <><line x1="12" y1="5" x2="12" y2="19" stroke="currentColor" strokeWidth="2"/><line x1="5" y1="12" x2="19" y2="12" stroke="currentColor" strokeWidth="2"/></>; break;
                case 'X': content = <><line x1="18" y1="6" x2="6" y2="18" stroke="currentColor" strokeWidth="2"/><line x1="6" y1="6" x2="18" y2="18" stroke="currentColor" strokeWidth="2"/></>; break;
                case 'Check': content = <polyline points="20 6 9 17 4 12" stroke="currentColor" strokeWidth="2" fill="none"/>; break;
                case 'Copy': content = <><rect x="9" y="9" width="13" height="13" rx="2" ry="2" stroke="currentColor" strokeWidth="2" fill="none"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1" stroke="currentColor" strokeWidth="2" fill="none"/></>; break;
                case 'Info': content = <><circle cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="2" fill="none"/><line x1="12" y1="16" x2="12" y2="12" stroke="currentColor" strokeWidth="2"/><line x1="12" y1="8" x2="12.01" y2="8" stroke="currentColor" strokeWidth="2"/></>; break;
                case 'Clock': content = <><circle cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="2" fill="none"/><polyline points="12 6 12 12 16 14" stroke="currentColor" strokeWidth="2" fill="none"/></>; break;
                case 'Cost': content = <><line x1="12" y1="1" x2="12" y2="23" stroke="currentColor" strokeWidth="2"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6" stroke="currentColor" strokeWidth="2" fill="none"/></>; break;
                case 'TrendingUp': content = <><polyline points="23 6 13.5 15.5 8.5 10.5 1 18" stroke="currentColor" fill="none" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/><polyline points="17 6 23 6 23 12" stroke="currentColor" fill="none" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/></>; break;
                case 'Box': content = <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z" stroke="currentColor" strokeWidth="2" fill="none"/>; break;
                case 'ShoppingCart': content = <><circle cx="9" cy="21" r="1" fill="currentColor"/><circle cx="20" cy="21" r="1" fill="currentColor"/><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6" stroke="currentColor" strokeWidth="2" fill="none"/></>; break;
                case 'FileText': content = <><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z" stroke="currentColor" strokeWidth="2" fill="none"/><polyline points="14 2 14 8 20 8" stroke="currentColor" strokeWidth="2" fill="none"/><line x1="16" y1="13" x2="8" y2="13" stroke="currentColor" strokeWidth="2"/><line x1="16" y1="17" x2="8" y2="17" stroke="currentColor" strokeWidth="2"/><line x1="10" y1="9" x2="8" y2="9" stroke="currentColor" strokeWidth="2"/></>; break;
                case 'Skull': content = <><path d="M12 2c-4.97 0-9 4.03-9 9 0 4.14 2.84 7.63 6.72 8.64a1 1 0 0 1 .58.55l.65 1.5a1 1 0 0 0 .91.59h6.27a1 1 0 0 0 .91-.59l.65-1.5a1 1 0 0 1 .58-.55C21.16 18.63 24 15.14 24 11c0-4.97-4.03-9-9-9z" stroke="currentColor" strokeWidth="2" fill="none"/><circle cx="8.5" cy="9.5" r="1.5" fill="currentColor"/><circle cx="15.5" cy="9.5" r="1.5" fill="currentColor"/><path d="M12 14.5v1.5" stroke="currentColor" strokeWidth="2" strokeLinecap="round"/></>; break;
                case 'LayoutGrid': content = <><rect width="7" height="7" x="3" y="3" rx="1" stroke="currentColor" strokeWidth="2" fill="none"/><rect width="7" height="7" x="14" y="3" rx="1" stroke="currentColor" strokeWidth="2" fill="none"/><rect width="7" height="7" x="14" y="14" rx="1" stroke="currentColor" strokeWidth="2" fill="none"/><rect width="7" height="7" x="3" y="14" rx="1" stroke="currentColor" strokeWidth="2" fill="none"/></>; break;
                case 'Flask': content = <><path d="M10 2v7.527a2 2 0 0 1 .211.896v.669L6.81 18.61A3.202 3.202 0 0 0 6 20.556V21h12v-.444a3.202 3.202 0 0 0-.81-1.946l-3.4-7.518v-.669a2 2 0 0 1 .211-.896V2H10z" stroke="currentColor" strokeWidth="2" fill="none"/><path d="M8.5 2h7" stroke="currentColor" strokeWidth="2"/></>; break;
                case 'Layers': content = <><polygon points="12 2 2 7 12 12 22 7 12 2" stroke="currentColor" strokeWidth="2" fill="none"/><polyline points="2 17 12 22 22 17" stroke="currentColor" strokeWidth="2" fill="none"/><polyline points="2 12 12 17 22 12" stroke="currentColor" strokeWidth="2" fill="none"/></>; break;
                case 'Diamond': content = <path d="M6 3h12l4 6-10 13L2 9z" stroke="currentColor" strokeWidth="2" fill="none" strokeLinejoin="round"/>; break;
                case 'Lock': content = <><rect width="18" height="11" x="3" y="11" rx="2" ry="2" stroke="currentColor" strokeWidth="2" fill="none"/><path d="M7 11V7a5 5 0 0 1 10 0v4" stroke="currentColor" strokeWidth="2" fill="none"/></>; break;
                case 'DollarSign': content = <><line x1="12" y1="1" x2="12" y2="23" stroke="currentColor" strokeWidth="2"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6" stroke="currentColor" strokeWidth="2" fill="none"/></>; break;
                case 'ToggleOn': content = <><rect x="1" y="5" width="22" height="14" rx="7" fill="#10b981"/><circle cx="16" cy="12" r="5" fill="white"/></>; break;
                case 'ToggleOff': content = <><rect x="1" y="5" width="22" height="14" rx="7" fill="#52525b"/><circle cx="8" cy="12" r="5" fill="white"/></>; break;
                case 'Profile': content = <><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" stroke="currentColor" strokeWidth="2" fill="none"/><circle cx="12" cy="7" r="4" stroke="currentColor" strokeWidth="2" fill="none"/><line x1="12" y1="2" x2="12" y2="15" stroke="currentColor" strokeWidth="2"/></>; break;
                case 'Share': content = <><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8" stroke="currentColor" strokeWidth="2" fill="none"/><polyline points="16 6 12 2 8 6" stroke="currentColor" strokeWidth="2" fill="none"/><line x1="12" y1="2" x2="12" y2="15" stroke="currentColor" strokeWidth="2"/></>; break;
                case 'Globe': content = <><circle cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="2" fill="none"/><line x1="2" y1="12" x2="22" y2="12" stroke="currentColor" strokeWidth="2"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z" stroke="currentColor" strokeWidth="2" fill="none"/></>; break;
                case 'Sword': content = <><path d="M14.5 4l-8.5 8.5a2.121 2.121 0 0 0 3 3l8.5-8.5-3-3zM2 18l3 3 2.5-2.5-3-3L2 18zM15 3.5l5.5 5.5" stroke="currentColor" strokeWidth="2" fill="none" strokeLinecap="round" strokeLinejoin="round"/></>; break;
                default: content = <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z" stroke="currentColor" strokeWidth="2" fill="none"/>; break;
            }

            return (
                <svg width={size} height={size} viewBox={viewBox} fill={fill} stroke={stroke} strokeWidth={defaultProps.strokeWidth} strokeLinecap={defaultProps.strokeLinecap} strokeLinejoin={defaultProps.strokeLinejoin} className={className}>
                    {content}
                </svg>
            );
        };

        const SmartIcon = ({ name, className }) => { const [error, setError] = useState(false); const BASE_URL = "https://sdekza.github.io/OGHza/"; const imgMap = { 'Spell': 'Coagulated Spell.png', 'Magic': 'Contaminated Magic.png', 'Gum': 'Bubble Gum.png', 'HeGum': 'HE Bubble Gum.png', 'Silvervine': 'Silvervine Fruit.png', 'GumBox': 'Bubble Gum Box.png', 'HeGumBox': 'HE Bubble Gum Box.png', 'SilvervineBox': 'Silvervine Box.png', 'Premium': 'Premium Box.png', 'Kafra': 'Kafra Buff.png', 'PremiumStaff': 'Premium Service Staff.png', 'Elunium': 'Elunium.png', 'Oridecon': 'Oridecon.png', 'Card': 'Card.png', 'Zeny': 'Zeny.png', 'DEK': 'DEK.png', 'OGH_BOSS': 'OGH BOSS.png', 'AOGH_BOSS': 'AOGH BOSS.png', 'Calendar': 'Calendar.png', 'Graph': 'Graph.png' }; const finalName = imgMap[name] ? name : (Object.keys(imgMap).find(k => k.toLowerCase() === name?.toLowerCase()) || 'Box'); 
        if (['Sword', 'Shield', 'Box'].includes(name)) { return <div className={className}><Icon name={name} size="100%" /></div>; }
        if (finalName === 'GumBox') return (<div className={`relative ${className}`}><img crossOrigin="anonymous" src={`${BASE_URL}Bubble Gum Box.png`} className="w-full h-full object-contain" /><img crossOrigin="anonymous" src={`${BASE_URL}Bubble Gum.png`} className="absolute bottom-0 right-0 w-1/2 h-1/2 object-contain filter drop-shadow-md" /></div>); 
        if (finalName === 'HeGumBox') return (<div className={`relative ${className}`}><img crossOrigin="anonymous" src={`${BASE_URL}Bubble Gum Box.png`} className="w-full h-full object-contain filter hue-rotate-15" /><img crossOrigin="anonymous" src={`${BASE_URL}HE Bubble Gum.png`} className="absolute bottom-0 right-0 w-1/2 h-1/2 object-contain filter drop-shadow-md" /></div>); 
        if (!error && imgMap[finalName]) return <img crossOrigin="anonymous" src={`${BASE_URL}${imgMap[finalName]}`} className={`object-contain ${className}`} onError={() => setError(true)} />; 
        return <div className={`w-full h-full bg-zinc-700 rounded-md flex items-center justify-center ${className}`}><span className="text-[8px] text-zinc-500">?</span></div>; };

        // --- SUB-COMPONENTS ---
        const BuffIcon = ({ buff }) => {
            const [timeLeft, setTimeLeft] = useState('');
            useEffect(() => {
                const tick = () => {
                      const now = new Date();
                      const end = new Date(buff.endDate);
                      const diff = end - now;
                      if (diff <= 0) return setTimeLeft('Exp');
                      
                      const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                      const hours = Math.floor((diff / (1000 * 60 * 60)) % 24);
                      const minutes = Math.floor((diff / 1000 / 60) % 60);

                      if (days > 0) setTimeLeft(`${days}d`);
                      else if (hours > 0) setTimeLeft(`${hours}h`);
                      else setTimeLeft(`${minutes}m`);
                };
                tick();
                const timer = setInterval(tick, 60000);
                return () => clearInterval(timer);
            }, [buff]);

            let icon = 'Check'; 
            if(buff.itemId.includes('premium')) icon='Premium'; 
            if(buff.itemId.includes('kafra')) icon='Kafra'; 
            if(buff.itemId.includes('silvervine_24h')) icon='Silvervine';

            return (
                <div className="relative w-8 h-8 rounded-lg bg-zinc-800 border border-zinc-700 flex-shrink-0 flex items-center justify-center group">
                    <SmartIcon name={icon} className="w-6 h-6"/>
                    <div className="absolute -bottom-1 -right-2 bg-black/80 text-white text-[8px] px-1 rounded-sm border border-zinc-600 backdrop-blur-sm whitespace-nowrap z-10 font-mono font-bold scale-75 origin-bottom-right">
                        {timeLeft}
                    </div>
                </div>
            );
        };

        function CurrencyHeader({ stats, activeBuffs, selectedCharId, runCount }) {
            const [now, setNow] = useState(new Date());
            useEffect(() => { const interval = setInterval(() => setNow(new Date()), 60000); return () => clearInterval(interval); }, []);

            return (
                <div className="rox-currency-bar sticky top-0 z-50 flex items-center justify-between bg-[#f0f2f5]/90 backdrop-blur-md px-4 py-2 border-b border-zinc-200 shadow-sm">
                    <div className="flex flex-1 items-center gap-2 overflow-x-auto scrollbar-hide mr-2">
                         {activeBuffs.map(b => {
                            const end = new Date(b.endDate);
                            if (end < now) return null;
                            const isAccountWide = b.isAccountWide === true;
                            const isMyChar = b.characterId === selectedCharId;
                            if (!isAccountWide && !isMyChar) return null;
                            return <BuffIcon key={b.uid} buff={b} />;
                        })}
                    </div>
                    <div className="flex gap-2 flex-shrink-0 items-center justify-end">
                        <div className="currency-pill bg-zinc-100"><Icon name="Sword" size={12} className="text-zinc-500"/><span>{runCount || 0}</span></div>
                        <div className="currency-pill"><SmartIcon name="Zeny" className="w-4 h-4"/><span>{formatMoney(stats.zeny)}</span></div>
                        <div className="currency-pill"><SmartIcon name="DEK" className="w-4 h-4"/><span>{formatMoney(stats.coins)}</span></div>
                    </div>
                </div>
            );
        }

        function DeleteButton({ onDelete, duration = 750, className = "w-full mt-2", label = "Hold Delete" }) { 
            const [isDeleting, setIsDeleting] = useState(false); 
            const timerRef = useRef(null); 
            const startDelete = () => { setIsDeleting(true); timerRef.current = setTimeout(() => { onDelete(); setIsDeleting(false); }, duration); }; 
            const cancelDelete = () => { clearTimeout(timerRef.current); setIsDeleting(false); }; 
            return (
                <div className={`relative h-8 bg-zinc-800 rounded-lg overflow-hidden cursor-pointer border border-rose-900/30 select-none touch-none ${className}`} onMouseDown={startDelete} onMouseUp={cancelDelete} onMouseLeave={cancelDelete} onTouchStart={(e) => { e.preventDefault(); startDelete(); }} onTouchEnd={(e) => { e.preventDefault(); cancelDelete(); }}>
                    <div className={`absolute top-0 left-0 h-full bg-rose-600 delete-progress ${isDeleting ? 'w-full' : 'w-0'}`} style={{ transitionDuration: isDeleting ? `${duration}ms` : '100ms' }}></div>
                    <div className="absolute inset-0 flex items-center justify-center pointer-events-none"><span className={`text-[10px] font-bold uppercase tracking-widest ${isDeleting ? 'text-white animate-pulse' : 'text-rose-400'}`}>{isDeleting ? "DELETING..." : label}</span></div>
                </div>
            ); 
        }

        function Toast({ message }) { return (<div className="fixed top-14 left-1/2 transform -translate-x-1/2 z-[100] animate-slide-down pointer-events-none w-full max-w-sm px-4"><div className="bg-zinc-800/95 backdrop-blur-md border border-zinc-700 text-white px-5 py-3 rounded-full shadow-2xl flex items-center gap-3 justify-center"><div className="bg-emerald-500/20 p-1 rounded-full text-emerald-400"><Icon name="Check" size={14} /></div><span className="text-xs font-bold tracking-wide">{message}</span></div></div>); }
        function Modal({ children, onClose }) { return (<div className="fixed inset-0 z-50 flex items-center justify-center p-6 bg-black/80 backdrop-blur-sm animate-fade-in" onClick={onClose}><div className="w-full max-w-sm bg-zinc-900 rounded-[2.5rem] p-6 relative border border-zinc-800 modal-bg-flip" onClick={e => e.stopPropagation()}><button onClick={onClose} className="absolute top-6 right-6 text-zinc-500 hover:text-black transition-colors"><Icon name="X" size={20}/></button>{children}</div></div>); }
        
        function InfoModal({ onClose }) {
            return (
                <Modal onClose={onClose}>
                    <div className="text-center space-y-4">
                        <h3 className="text-xl font-black text-zinc-200">Rank Criteria</h3>
                        <div className="space-y-2 text-left bg-zinc-900/50 p-4 rounded-xl border border-zinc-700">
                            <div className="flex justify-between"><span className="rank-s">S (Lucky)</span><span>&gt; +50% Avg</span></div>
                            <div className="flex justify-between"><span className="rank-a">A (Good)</span><span>&gt; +30% Avg</span></div>
                            <div className="flex justify-between"><span className="rank-b">B (Normal)</span><span>-10% ~ +30%</span></div>
                            <div className="flex justify-between"><span className="rank-c">C (Bad)</span><span>-30% ~ -10%</span></div>
                            <div className="flex justify-between"><span className="rank-d">D (Poor)</span><span>-50% ~ -30%</span></div>
                            <div className="flex justify-between"><span className="rank-f">F (Loss)</span><span>Negative Profit</span></div>
                        </div>
                        <p className="text-[10px] text-zinc-500">Compares your run profit against your average history.</p>
                    </div>
                </Modal>
            );
        }

        function GlobalStatsModal({ stats, onClose }) {
            return (
                <Modal onClose={onClose}>
                    <div className="text-center space-y-6 py-4">
                        <div>
                            <div className="w-20 h-20 bg-blue-500/10 rounded-full flex items-center justify-center mx-auto mb-4 border border-blue-500/30">
                                <Icon name="Globe" size={40} className="text-blue-500" />
                            </div>
                            <h3 className="text-2xl font-black text-zinc-200 tracking-tight">Global Statistics</h3>
                            <p className="text-xs text-zinc-500 font-bold uppercase tracking-widest mt-1">OGHza Tracker Community</p>
                        </div>
                        <div className="grid grid-cols-2 gap-4">
                            <div className="bg-zinc-800/50 p-4 rounded-2xl border border-zinc-700">
                                <p className="text-[10px] text-zinc-500 uppercase font-bold mb-1">Total Users</p>
                                <p className="text-3xl font-black text-emerald-400">{stats ? formatMoney(stats.totalUsers) : '...'}</p>
                            </div>
                            <div className="bg-zinc-800/50 p-4 rounded-2xl border border-zinc-700">
                                <p className="text-[10px] text-zinc-500 uppercase font-bold mb-1">Total Runs</p>
                                <p className="text-3xl font-black text-amber-400">{stats ? formatMoney(stats.totalRuns) : '...'}</p>
                            </div>
                        </div>
                        <div className="text-xs text-zinc-600 italic">
                            "Together we farm, together we prosper!"
                        </div>
                    </div>
                </Modal>
            );
        }

        function MarketPriceModal({ prices, onClose, onSave }) {
            const [localPrices, setLocalPrices] = useState(prices);
            const handleChange = (key, val) => {
                setLocalPrices(prev => ({ ...prev, [key]: parseInt(val.replace(/\D/g, '')) || 0 }));
            };
            return (
                <Modal onClose={onClose}>
                    <div className="space-y-4">
                        <div className="text-center mb-4">
                            <h3 className="text-xl font-black text-zinc-800">Market Price Manager</h3>
                            <p className="text-xs text-zinc-500">Update daily prices for accurate tracking</p>
                        </div>
                        <div className="space-y-3">
                            {['purpleStonePrice', 'contMagicPrice', 'gumBoxPrice', 'silvervineBoxPrice'].map(key => {
                                let label = 'Item';
                                let icon = 'Box';
                                if(key === 'purpleStonePrice') { label = 'Purple Stone'; icon = 'Spell'; }
                                if(key === 'contMagicPrice') { label = 'Red Stone'; icon = 'Magic'; }
                                if(key === 'gumBoxPrice') { label = 'Gum Box (10)'; icon = 'GumBox'; }
                                if(key === 'silvervineBoxPrice') { label = 'Silvervine Box (10)'; icon = 'SilvervineBox'; }
                                return (
                                    <div key={key} className="flex items-center gap-2 bg-zinc-100 p-2 rounded-xl border border-zinc-200">
                                        <div className="w-8 h-8 flex-shrink-0"><SmartIcon name={icon} className="w-full h-full"/></div>
                                        <div className="flex-1">
                                            <p className="text-[9px] font-bold uppercase text-zinc-500">{label}</p>
                                            <input type="text" inputMode="numeric" value={localPrices[key]} onChange={e => handleChange(key, e.target.value)} className="w-full bg-transparent text-sm font-black text-zinc-800 outline-none"/>
                                        </div>
                                        <div className="text-xs font-bold text-zinc-400">Z</div>
                                    </div>
                                );
                            })}
                        </div>
                        <button onClick={() => onSave(localPrices)} className="w-full py-3 bg-emerald-600 rounded-xl font-black text-white shadow-lg active:scale-95 transition-transform mt-2">UPDATE PRICES</button>
                    </div>
                </Modal>
            );
        }

        function WishlistModal({ onClose, onSave }) {
            const [name, setName] = useState('');
            const [price, setPrice] = useState('');
            const [icon, setIcon] = useState('Card');
            const icons = ['Card', 'Elunium', 'Oridecon', 'Spell', 'Magic', 'Gum', 'HeGum', 'Premium', 'Kafra', 'Silvervine'];
            
            return (
                <Modal onClose={onClose}>
                    <div className="space-y-4">
                        <div className="text-center mb-4">
                            <h3 className="text-xl font-black text-zinc-800">Set Your Goal</h3>
                            <p className="text-xs text-zinc-500">What are you farming for?</p>
                        </div>
                        <div className="flex justify-center gap-2 mb-4 flex-wrap">
                            {icons.map(ic => (
                                <div key={ic} onClick={() => setIcon(ic)} className={`w-10 h-10 rounded-lg border-2 flex items-center justify-center cursor-pointer transition-all ${icon === ic ? 'border-emerald-500 bg-emerald-50' : 'border-transparent bg-zinc-100'}`}>
                                    <SmartIcon name={ic} className="w-6 h-6"/>
                                </div>
                            ))}
                        </div>
                        <input type="text" placeholder="Item Name (e.g. OGH Card)" value={name} onChange={e => setName(e.target.value)} className="slate-input w-full p-2 rounded-xl text-sm font-bold text-zinc-800 bg-zinc-50"/>
                        <input type="text" inputMode="numeric" placeholder="Target Price (Zeny)" value={price} onChange={e => setPrice(e.target.value.replace(/\D/g, ''))} className="slate-input w-full p-2 rounded-xl text-sm font-bold text-zinc-800 bg-zinc-50"/>
                        <button disabled={!name || !price} onClick={() => onSave({ name, price: parseInt(price), icon })} className="w-full py-3 bg-gradient-to-r from-amber-400 to-orange-500 rounded-xl font-black text-white shadow-lg active:scale-95 transition-transform disabled:opacity-50 disabled:grayscale">SET TARGET</button>
                    </div>
                </Modal>
            );
        }

        function ShareModal({ data, onClose }) {
            const cardRef = useRef(null);
            const [imgUrl, setImgUrl] = useState(null);
            const [loading, setLoading] = useState(true);
            useEffect(() => {
                const generate = async () => {
                    await new Promise(r => setTimeout(r, 500));
                    if (cardRef.current && window.html2canvas) {
                        try {
                            const canvas = await window.html2canvas(cardRef.current, { backgroundColor: '#18181b', scale: 2, logging: false, useCORS: true, allowTaint: true });
                            setImgUrl(canvas.toDataURL("image/png"));
                            setLoading(false);
                        } catch (e) { console.error(e); setLoading(false); }
                    }
                };
                generate();
            }, []);
            return (
                <div className="fixed inset-0 z-[70] flex items-center justify-center p-6 bg-black/95 backdrop-blur-xl animate-fade-in" onClick={onClose}>
                    <div className="w-full max-w-sm flex flex-col items-center gap-6" onClick={e => e.stopPropagation()}>
                        <div className="text-center space-y-1">
                            <h3 className="text-white font-black text-xl tracking-tighter">Share Result</h3>
                            <p className="text-zinc-500 text-xs font-bold uppercase tracking-widest">{loading ? "Generating Card..." : "Long Press Image to Save"}</p>
                        </div>
                        {loading && (<div className="w-64 h-64 flex items-center justify-center"><div className="w-12 h-12 border-4 border-emerald-500 border-t-transparent rounded-full animate-spin"></div></div>)}
                        {!loading && imgUrl && (<div className="relative group animate-pop-in"><img src={imgUrl} alt="Result Card" className="w-full rounded-lg shadow-2xl border border-zinc-800/50" /><div className="absolute -bottom-8 left-0 right-0 text-center opacity-50 text-[10px] text-zinc-500">Saved as PNG</div></div>)}
                        <div className="flex gap-4"><button onClick={onClose} className="w-12 h-12 rounded-full bg-zinc-200 text-black flex items-center justify-center hover:bg-white transition-colors border border-zinc-400"><Icon name="X" size={20}/></button></div>
                        <div className="absolute top-0 left-0 pointer-events-none opacity-0" style={{ transform: 'translate(-9999px, -9999px)' }}>
                            <div ref={cardRef} className="rom-card p-6 bg-[#18181b] relative flex flex-col gap-4 !rounded-none" style={{ width: '375px' }}>
                                <div className="text-center border-b border-zinc-700 pb-3 mb-2"><h2 className="text-2xl font-black text-[#4a90e2] italic tracking-tighter drop-shadow-md font-sans">OGHza <span className="text-[#eab308]">Tracker</span></h2><p className="text-[10px] text-zinc-500 tracking-[0.3em] uppercase font-bold mt-1">ADVENTURE REPORT</p></div>
                                <div className="flex justify-between items-center px-1"><span className={`text-4xl font-black uppercase tracking-tighter drop-shadow-lg ${data.runMode === 'AOGH' ? 'text-rose-500' : 'text-purple-400'} font-sans`}>{data.runMode === 'AOGH' ? 'AOGH' : 'OGH'}</span><div className="flex items-center gap-1.5 text-zinc-300"><span className="text-lg">⏱️</span><span className="text-lg font-bold font-sans">{data.minutesUsed}m</span></div></div>
                                <div className="text-center py-2 flex flex-col items-center justify-center"><p className="text-[10px] text-zinc-500 font-bold uppercase tracking-widest mb-1">NET PROFIT (ZENY)</p><div className="flex items-baseline gap-2"><span className="text-6xl font-black text-emerald-400 drop-shadow-lg leading-tight font-sans">{formatMoney(data.profit)}</span></div></div>
                                <div className="flex justify-between items-center px-2 py-2 mb-2 w-full"><div className="text-center flex-1"><p className="text-[9px] text-zinc-500 uppercase font-bold tracking-wider">COST</p><p className="text-sm font-bold text-rose-400 font-sans">-{formatMoney((data.trashAmount||0) - data.profit)}</p></div><div className="w-px h-8 bg-zinc-800"></div><div className="text-center flex-1"><p className="text-[9px] text-zinc-500 uppercase font-bold tracking-wider">SALES</p><p className="text-sm font-bold text-blue-400 font-sans">+{formatMoney(data.trashAmount)}</p></div><div className="w-px h-8 bg-zinc-800"></div><div className="text-center flex-1"><p className="text-[9px] text-zinc-500 uppercase font-bold tracking-wider">RATE</p><p className="text-sm font-bold text-amber-400 font-sans">{formatMoney(Math.floor(data.profit / (data.minutesUsed || 1)))}/m</p></div></div>
                                <div className="rom-item-box p-4 flex justify-center gap-8 mt-2 items-end !rounded-xl"><div className="flex flex-col items-center gap-2"><div className="w-8 h-8"><SmartIcon name="Spell" className="w-full h-full drop-shadow-md"/></div><span className="text-[10px] font-bold text-zinc-400 font-sans">x{data.purpleStoneCount}</span></div>{data.runMode === 'AOGH' && (<div className="flex flex-col items-center gap-2"><div className="w-8 h-8"><SmartIcon name="Magic" className="w-full h-full drop-shadow-md"/></div><span className="text-[10px] font-bold text-zinc-400 font-sans">x{data.contMagicCount}</span></div>)}<div className="flex flex-col items-center gap-2"><div className="w-8 h-8"><SmartIcon name="Gum" className="w-full h-full drop-shadow-md"/></div><span className="text-[10px] font-bold text-zinc-400 font-sans">x{data.normalGumUsed || 0}</span></div>{data.heGumUsed > 0 && (<div className="flex flex-col items-center gap-2"><div className="w-8 h-8"><SmartIcon name="HeGum" className="w-full h-full drop-shadow-md"/></div><span className="text-[10px] font-bold text-zinc-400 font-sans">x{data.heGumUsed}</span></div>)}</div>
                                <div className="text-center mt-4 opacity-30"><p className="text-[9px] text-zinc-500 tracking-widest font-mono">created by @SDekza-Ro • {new Date().toLocaleDateString()}</p></div>
                            </div>
                        </div>
                    </div>
                </div>
            ); 
        }

        function RewardPopup({ data, onClose, onShare }) {
            const [displayExpPercent, setDisplayExpPercent] = useState(Math.min(100, Math.floor((data.beforeExp / getExpReq(data.beforeLv)) * 100)));
            const targetExpPercent = Math.min(100, Math.floor((data.afterExp / getExpReq(data.afterLv)) * 100));
            const isLevelUp = data.afterLv > data.beforeLv;
            useEffect(() => { const timer = setTimeout(() => { setDisplayExpPercent(targetExpPercent); }, 100); return () => clearTimeout(timer); }, [targetExpPercent]);
            return (
                <div className="fixed inset-0 z-[70] flex items-center justify-center p-6 modal-overlay-base animate-fade-in" onClick={onClose}>
                    <div className="w-full max-w-sm reward-card-base rounded-[2rem] p-8 relative flex flex-col items-center" onClick={e => e.stopPropagation()}>
                        <div className={`absolute -top-12 transition-all duration-700 ${isLevelUp ? 'scale-125' : ''}`}><div className={`w-24 h-24 rounded-full bg-gradient-to-br from-amber-400 to-orange-500 flex items-center justify-center border-4 border-zinc-900 shadow-xl animate-pop-in ${isLevelUp ? 'level-up-glow' : ''}`}>{isLevelUp ? <Icon name="Clover" size={50} /> : <Icon name="Medal" size={50} />}</div></div>
                        {isLevelUp && <h2 className="text-4xl font-black text-emerald-400 mt-12 mb-2 tracking-tighter drop-shadow-md animate-bounce">LEVEL UP!</h2>}
                        {!isLevelUp && <h2 className="text-2xl font-black text-amber-400 mt-10 mb-2 tracking-tighter drop-shadow-md">STAGE CLEAR!</h2>}
                        <p className="text-xs text-zinc-400 mb-6 uppercase tracking-widest font-bold">Rewards Obtained</p>
                        <div className="flex gap-4 mb-6 w-full justify-center">
                            <div className="bg-zinc-900/80 px-4 py-2 rounded-xl border border-zinc-700 flex flex-col items-center min-w-[80px]"><span className="text-[9px] text-zinc-500 uppercase font-bold tracking-widest mb-1">PROFIT</span><span className={`font-black text-lg flex items-center gap-1 ${data.profit >= 0 ? 'text-emerald-400' : 'text-rose-400'}`}>{formatMoney(data.profit)}</span></div>
                             <div className="bg-zinc-900/80 px-4 py-2 rounded-xl border border-zinc-700 flex flex-col items-center min-w-[80px]"><span className="text-[9px] text-zinc-500 uppercase font-bold tracking-widest mb-1">EXP</span><span className="text-blue-400 font-black text-lg flex items-center gap-1">+{formatMoney(data.expGain)}</span></div>
                            <div className="bg-zinc-900/80 px-4 py-2 rounded-xl border border-zinc-700 flex flex-col items-center min-w-[80px]"><span className="text-[9px] text-zinc-500 uppercase font-bold tracking-widest mb-1">DEK</span><span className="text-amber-400 font-black text-lg flex items-center gap-1"><SmartIcon name="DEK" className="w-4 h-4"/>+{formatMoney(data.dek)}</span></div>
                        </div>
                         <div className="w-full mb-6"><div className="flex justify-between text-[10px] font-bold text-zinc-500 mb-1"><span>LV.{data.afterLv}</span><span>{Math.floor(displayExpPercent)}%</span></div><div className="w-full h-3 bg-zinc-900 rounded-full overflow-hidden relative border border-zinc-700"><div className="h-full bg-gradient-to-r from-emerald-500 to-green-400 transition-all duration-1000 ease-out" style={{ width: `${displayExpPercent}%` }}></div></div></div>
                        <div className="flex gap-2 w-full"><button onClick={onShare} className="flex-1 py-3 bg-zinc-700 hover:bg-zinc-600 text-white font-black rounded-xl shadow-lg transition-transform active:scale-95 flex items-center justify-center gap-2"><Icon name="Share" size={18}/> SHARE</button><button onClick={onClose} className="flex-1 py-3 bg-gradient-to-r from-emerald-600 to-teal-600 hover:from-emerald-500 hover:to-teal-500 text-white font-black rounded-xl shadow-lg transition-transform active:scale-95">CONTINUE</button></div>
                    </div>
                </div>
            ); 
        }

        function ItemDetailModal({ item, onClose, onSell }) { 
            const rColors = { Common: "text-zinc-400", Uncommon: "text-emerald-400", Rare: "text-blue-400", Legendary: "text-amber-400" }; 
            const rBg = { Common: "bg-zinc-800/50", Uncommon: "bg-emerald-500/10", Rare: "bg-blue-500/10", Legendary: "bg-amber-500/10" }; 
            const info = getItemInfo(item.itemId || item.id); 
            const [sellQty, setSellQty] = useState('1'); 
            const [sellPrice, setSellPrice] = useState(''); 
            return (
                <div className="fixed inset-0 z-[60] flex items-center justify-center p-6 bg-black/90 backdrop-blur-sm animate-fade-in" onClick={onClose}>
                    <div className="w-full max-w-xs bg-zinc-900 rounded-[2.5rem] p-6 relative border border-zinc-800 modal-bg-flip" onClick={e => e.stopPropagation()}>
                        <button onClick={onClose} className="absolute top-5 right-5 text-zinc-500 hover:text-white"><Icon name="X" size={20}/></button>
                        <div className={`w-24 h-24 mx-auto rounded-3xl flex items-center justify-center mb-4 ${rBg[info.rarity]} border border-white/5 shadow-xl`}><SmartIcon name={info.icon} className="w-16 h-16" /></div>
                        <h3 className={`text-lg font-black text-center ${rColors[info.rarity]}`}>{info.name}</h3>
                        <p className="text-[10px] font-bold text-center opacity-40 uppercase tracking-widest mb-4">{info.type} • {info.rarity}</p>
                        <p className="text-xs text-center opacity-60 mb-6 italic">"{info.desc}"</p>
                        {item.isSellable ? (
                            <div className="bg-zinc-900 p-4 rounded-2xl mb-4 border border-zinc-800">
                                <p className="text-[10px] font-bold opacity-40 uppercase mb-2 text-center">Sell Item</p>
                                <div className="grid grid-cols-2 gap-2 mb-2">
                                    <div><label className="text-[8px] font-bold opacity-30 uppercase ml-1">Qty</label><input type="text" inputMode="numeric" value={sellQty} onChange={e => setSellQty(e.target.value.replace(/\D/g,''))} className="slate-input w-full p-2 rounded-xl text-center font-bold text-sm outline-none placeholder-white/20"/></div>
                                    <div><label className="text-[8px] font-bold opacity-30 uppercase ml-1">Price/Unit</label><input type="text" inputMode="numeric" value={sellPrice} onChange={e => setSellPrice(e.target.value.replace(/\D/g,''))} className="slate-input w-full p-2 rounded-xl text-center font-bold text-sm outline-none placeholder-white/20"/></div>
                                </div>
                                <button onClick={() => onSell(item, sellQty, sellPrice)} disabled={!sellQty || !sellPrice} className="w-full py-2 bg-emerald-600 rounded-xl text-xs font-black uppercase hover:bg-emerald-500 transition-colors disabled:opacity-50 flex items-center justify-center gap-2"><Icon name="DollarSign" size={14}/> Confirm Sell</button>
                            </div>
                        ) : (<div className="text-center"><p className="text-xs font-bold opacity-50">Owned: {item.count || item.qty}</p></div>)}
                    </div>
                </div>
            ); 
        }
        const TabButton = ({ label, icon: IconName, active, onClick }) => ( <button onClick={onClick} className={`flex-1 py-2 text-[10px] font-black uppercase transition-all rounded-xl flex flex-col items-center justify-center gap-1 ${active ? 'nav-item-active' : 'nav-item-inactive'}`}><Icon name={IconName} size={16} />{label}</button> );

        function ProfileView({ stats, uid, onResetUid, onSetUid, prices, setPrices, db, showToast, onBack, characters, setCharacters, setTheme, currentTheme }) {
            const [localPrices, setLocalPrices] = useState(prices);
            const [inputUid, setInputUid] = useState('');
            const [newCharName, setNewCharName] = useState('');
            const [newCharJob, setNewCharJob] = useState('');
            const [isExporting, setIsExporting] = useState(false);
            const [showMarketModal, setShowMarketModal] = useState(false);
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'oghza-tracker';

            useEffect(() => { setLocalPrices(prices); }, [prices]);
            const hasNoCharacters = !characters || characters.length === 0;

            const handleSavePrices = async (newPrices) => { await setDoc(doc(db, 'artifacts', appId, 'users', uid, 'config', 'prices'), newPrices); showToast("Market Prices Updated!"); setShowMarketModal(false); };
            const handleDeleteAllData = async () => { if(!confirm("⚠️ ARE YOU SURE? This will PERMANENTLY DELETE all your data!")) return; try { const batch = writeBatch(db); const recordsSnapshot = await getDocs(collection(db, 'artifacts', appId, 'users', uid, 'records')); recordsSnapshot.forEach((doc) => batch.delete(doc.ref)); const inventorySnapshot = await getDocs(collection(db, 'artifacts', appId, 'users', uid, 'inventory')); inventorySnapshot.forEach((doc) => batch.delete(doc.ref)); batch.delete(doc(db, 'artifacts', appId, 'users', uid, 'config', 'prices')); batch.delete(doc(db, 'artifacts', appId, 'users', uid, 'config', 'characters')); batch.delete(doc(db, 'artifacts', appId, 'users', uid, 'config', 'stock')); batch.delete(doc(db, 'artifacts', appId, 'users', uid, 'gamification', 'stats')); await batch.commit(); showToast("All Data Deleted!"); setTimeout(() => window.location.reload(), 1500); } catch (error) { console.error("Error deleting data:", error); showToast("Failed to delete data"); } };
            const copyUid = () => { navigator.clipboard.writeText(uid); showToast("Copied UID"); };
            const addCharacter = async () => { if (!newCharName || !newCharJob) return; const newChar = { id: Date.now().toString(), name: newCharName, job: newCharJob }; const updatedChars = [...(characters || []), newChar]; await setDoc(doc(db, 'artifacts', appId, 'users', uid, 'config', 'characters'), { list: updatedChars }); setNewCharName(''); setNewCharJob(''); showToast(`Added ${newChar.name}`); };
            const deleteCharacter = async (charId) => { const updatedChars = characters.filter(c => c.id !== charId); await setDoc(doc(db, 'artifacts', appId, 'users', uid, 'config', 'characters'), { list: updatedChars }); showToast("Character Deleted"); };
            const handleExportData = async () => { setIsExporting(true); try { const recordsSnap = await getDocs(collection(db, 'artifacts', appId, 'users', uid, 'records')); const inventorySnap = await getDocs(collection(db, 'artifacts', appId, 'users', uid, 'inventory')); const exportData = { version: APP_VERSION, timestamp: Date.now(), stats: stats, prices: prices, characters: characters, records: recordsSnap.docs.map(d => d.data()), inventory: inventorySnap.docs.map(d => d.data()) }; const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(exportData)); const downloadAnchorNode = document.createElement('a'); downloadAnchorNode.setAttribute("href", dataStr); downloadAnchorNode.setAttribute("download", `oghza_backup_${new Date().toISOString().split('T')[0]}.json`); document.body.appendChild(downloadAnchorNode); downloadAnchorNode.click(); downloadAnchorNode.remove(); showToast("Backup Downloaded!"); } catch (e) { console.error(e); showToast("Export Failed!"); } setIsExporting(false); };
            const handleImportData = async (e) => { const file = e.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = async (event) => { try { const data = JSON.parse(event.target.result); if (!data.records || !data.inventory) throw new Error("Invalid Format"); if(!confirm("⚠️ WARNING: This will OVERWRITE your current data. Continue?")) return; const batch = writeBatch(db); if (data.stats) batch.set(doc(db, 'artifacts', appId, 'users', uid, 'gamification', 'stats'), data.stats); if (data.prices) batch.set(doc(db, 'artifacts', appId, 'users', uid, 'config', 'prices'), data.prices); if (data.characters) batch.set(doc(db, 'artifacts', appId, 'users', uid, 'config', 'characters'), { list: data.characters }); data.records.forEach(r => { const newRef = doc(collection(db, 'artifacts', appId, 'users', uid, 'records')); batch.set(newRef, r); }); data.inventory.forEach(i => { const newRef = doc(collection(db, 'artifacts', appId, 'users', uid, 'inventory')); batch.set(newRef, i); }); await batch.commit(); showToast("Data Imported Successfully!"); setTimeout(() => window.location.reload(), 1500); } catch (err) { console.error(err); showToast("Import Failed: Invalid JSON"); } }; reader.readAsText(file); };

            return (
                <div className="p-6 animate-fade-in view-content space-y-6">
                    <div className="flex items-center justify-between mb-4">
                        <div className="flex items-center gap-4">
                            <h2 className="text-2xl font-black tracking-tighter text-zinc-700">Profile</h2>
                        </div>
                        <a href="https://www.youtube.com/@SDekza-RO" target="_blank" rel="noopener noreferrer" className="relative group">
                            <div className="w-11 h-11 rounded-full bg-zinc-100 border-2 border-white shadow-md overflow-hidden relative z-10 group-hover:scale-105 transition-transform flex items-center justify-center">
                                <img src="https://yt3.googleusercontent.com/vlD4rkRPBg-HIUX6kAbuW1AHgE1FzYa4cs7W3ZD1AV0z4Xg_vM42d1r_slf8SVPhjmJXPslvcg=s160-c-k-c0x00ffffff-no-rj" className="w-full h-full object-cover" alt="SDekza" onError={(e) => {e.target.style.display='none';}} />
                                <div className="absolute inset-0 flex items-center justify-center bg-zinc-200 -z-10 text-[10px] font-black text-zinc-400">SD</div>
                            </div>
                            <div className="absolute -bottom-0.5 -right-0.5 z-20 bg-[#FF0000] text-white w-5 h-5 rounded-full flex items-center justify-center border-2 border-white shadow-sm">
                                <svg viewBox="0 0 24 24" fill="currentColor" className="w-2.5 h-2.5"><path d="M8 5v14l11-7z"/></svg>
                            </div>
                        </a>
                    </div>
                    <div className={`glass-panel p-4 rounded-2xl space-y-4 ${hasNoCharacters ? 'red-alert' : ''}`}>
                        <p className="text-[10px] font-bold opacity-40 uppercase tracking-widest flex items-center gap-2"><Icon name="Profile" size={12}/> Character List</p>
                        <div className="space-y-2 max-h-[180px] overflow-y-auto custom-scrollbar pr-1">
                            {characters && characters.length > 0 ? (characters.map(c => (<div key={c.id} className="flex justify-between items-center bg-zinc-100 p-3 rounded-xl border border-zinc-200"><div><p className="text-sm font-bold text-zinc-800">{c.name}</p><p className="text-[10px] text-zinc-500 uppercase">{c.job}</p></div><button onClick={() => deleteCharacter(c.id)} className="text-zinc-400 hover:text-rose-500"><Icon name="Trash" size={16}/></button></div>))) : (<p className="text-center text-zinc-500 text-xs italic py-2">No characters added yet.</p>)}
                        </div>
                        <div className="flex gap-2 pt-2 border-t border-zinc-200">
                            <input type="text" placeholder="Name (e.g. Main)" value={newCharName} onChange={e => setNewCharName(e.target.value)} className={`flex-1 bg-white p-2 rounded-xl text-xs text-zinc-800 border border-zinc-300 outline-none ${hasNoCharacters ? 'ring-2 ring-red-500/50' : ''}`}/>
                            <input type="text" placeholder="Job" value={newCharJob} onChange={e => setNewCharJob(e.target.value)} className="w-20 bg-white p-2 rounded-xl text-xs text-zinc-800 border border-zinc-300 outline-none"/>
                            <button onClick={addCharacter} disabled={!newCharName} className="px-3 bg-zinc-200 rounded-xl text-zinc-500 hover:text-zinc-800 disabled:opacity-50"><Icon name="Plus" size={16}/></button>
                        </div>
                    </div>
                    
                    <button onClick={() => setShowMarketModal(true)} className="w-full py-4 bg-white border border-zinc-200 rounded-2xl font-bold text-zinc-700 shadow-sm flex items-center justify-center gap-2 hover:bg-zinc-50"><Icon name="TrendingUp" size={18}/> Manage Market Prices</button>

                    <div className="glass-panel p-4 rounded-2xl space-y-3">
                        <p className="text-[10px] font-bold opacity-40 uppercase tracking-widest">Adventure ID</p>
                        <div className="flex gap-2">
                            <div className="flex-1 bg-zinc-100 p-2 rounded-xl text-xs font-mono text-zinc-500 truncate border border-zinc-200 flex items-center">{uid}</div>
                            <button onClick={copyUid} className="p-2 bg-zinc-200 rounded-xl text-zinc-500"><Icon name="Copy" size={16}/></button>
                        </div>
                        <div className="flex gap-2 pt-2 border-t border-zinc-200">
                            <input type="text" placeholder="Load other UID..." value={inputUid} onChange={e => setInputUid(e.target.value)} className="flex-1 bg-white p-2 rounded-xl text-xs text-zinc-800 border border-zinc-300 outline-none"/>
                            <button onClick={() => { if(inputUid) onSetUid(inputUid); }} className="px-4 bg-emerald-600 rounded-xl text-[10px] font-bold text-white uppercase">Load</button>
                            <button onClick={onResetUid} className="px-4 bg-rose-50 text-rose-500 border border-rose-200 rounded-xl text-[10px] font-bold uppercase">Reset</button>
                        </div>
                    </div>
                    <div className="glass-panel p-4 rounded-2xl space-y-3">
                        <p className="text-[10px] font-bold opacity-40 uppercase tracking-widest flex items-center gap-2"><Icon name="Layers" size={12}/> Data Management</p>
                        <div className="flex gap-2">
                            <button onClick={handleExportData} disabled={isExporting} className="flex-1 py-3 bg-white rounded-xl text-xs font-bold text-emerald-600 border border-zinc-200 hover:bg-zinc-50 flex items-center justify-center gap-2 shadow-sm">{isExporting ? 'Exporting...' : <><Icon name="Share" size={14}/> Backup Data</>}</button>
                            <label className="flex-1 py-3 bg-white rounded-xl text-xs font-bold text-blue-500 border border-zinc-200 hover:bg-zinc-50 flex items-center justify-center gap-2 cursor-pointer shadow-sm"><Icon name="Box" size={14}/> Restore Data<input type="file" accept=".json" onChange={handleImportData} className="hidden" /></label>
                        </div>
                        <div className="pt-2 border-t border-zinc-200 mt-2"><p className="text-[9px] text-rose-400 font-bold uppercase tracking-widest mb-1 text-center">Danger Zone</p><DeleteButton onDelete={handleDeleteAllData} duration={10000} label="Hold 10s to Wipe Data" className="w-full h-10 bg-rose-50 border-rose-200" /></div>
                    </div>
                    <div className="text-center pt-8 pb-20"><p className="text-[9px] text-zinc-400 font-mono">OGHza Tracker {APP_VERSION}</p></div>
                    {showMarketModal && <MarketPriceModal prices={prices} onClose={() => setShowMarketModal(false)} onSave={handleSavePrices} />}
                </div>
            );
        }

        function HomeView({ records, stats, goToTab, activeBuffs, stock, characters, selectedCharId, setSelectedCharId, db, uid, showToast }) {
             const { ResponsiveContainer, AreaChart, Area } = window.Recharts || {}; 
             const [showWishlistModal, setShowWishlistModal] = useState(false);
             const appId = typeof __app_id !== 'undefined' ? __app_id : 'oghza-tracker';

             const totalProfit = records.reduce((acc, r) => acc + (r.profit || 0), 0);
             const chartData = [...records].filter(r => !r.isSaleRecord).reverse().slice(-7).map((r, i) => ({ name: `Run ${i+1}`, profit: r.profit }));
             const expPercent = Math.min(100, Math.floor((stats.baseExp / getExpReq(stats.baseLv)) * 100));
             
             // Wishlist Logic
             const savingsGoal = stats.wishlist ? stats.wishlist.price : (stats.savingsGoal || 0);
             const goalPercent = savingsGoal > 0 ? Math.min(100, (stats.zeny / savingsGoal) * 100) : 0;
             const timeToGoal = useMemo(() => {
                 if (savingsGoal <= stats.zeny) return { text: "Goal Reached! 🎉", days: 0 };
                 if (savingsGoal === 0) return { text: "Set Goal", days: 0 };
                 const oneWeekAgo = new Date(); oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
                 const recentRecords = records.filter(r => new Date(r.date) >= oneWeekAgo && !r.isSaleRecord);
                 if (recentRecords.length < 3) return { text: "Need data...", days: 0 };
                 const totalRecentProfit = records.filter(r => !r.isSaleRecord).reduce((acc, r) => acc + (r.profit || 0), 0);
                 const distinctDays = new Set(recentRecords.map(r => r.date)).size || 1;
                 const dailyAvg = totalRecentProfit / distinctDays;
                 if (dailyAvg <= 0) return { text: "Profit < 0", days: 0 };
                 const remaining = savingsGoal - stats.zeny;
                 const daysLeft = Math.ceil(remaining / dailyAvg);
                 return { text: `${daysLeft} days left`, days: daysLeft };
             }, [records, stats.zeny, savingsGoal]);

             const handleSaveWishlist = async (wishlist) => {
                 const newStats = { ...stats, wishlist, savingsGoal: wishlist.price };
                 await setDoc(doc(db, 'artifacts', appId, 'users', uid, 'gamification', 'stats'), newStats);
                 showToast("Goal Updated!");
                 setShowWishlistModal(false);
             };

             const recentLuck = useMemo(() => {
                 if (records.length === 0) return { text: "No Data", icon: "😐", color: "text-zinc-500" };
                 const last5 = records.slice(0, 5);
                 const avgProfit = records.reduce((acc, r) => acc + (r.profit || 0), 0) / (records.length || 1);
                 let score = 0;
                 last5.forEach(r => { const diff = (r.profit - avgProfit) / (avgProfit || 1); if (diff > 0.5) score += 2; else if (diff > 0) score += 1; else if (diff < -0.3) score -= 1; });
                 if (score >= 4) return { text: "Super Lucky!", icon: "🍀", color: "text-emerald-500" };
                 if (score >= 1) return { text: "Good Fortune", icon: "✨", color: "text-amber-500" };
                 if (score >= -1) return { text: "Normal", icon: "😐", color: "text-zinc-400" };
                 return { text: "Cursed...", icon: "💀", color: "text-rose-500" };
             }, [records]);
             
             const dailyChecklist = useMemo(() => {
                if (!characters) return [];
                const today = getGameDate();
                return characters.map(c => {
                    const hasRun = records.some(r => r.date === today && r.characterId === c.id);
                    return { ...c, hasRun };
                });
            }, [characters, records]);
            const hasNoCharacters = !characters || characters.length === 0;

             return (
                <div className="p-6 animate-fade-in view-content">
                    <header className="flex items-center gap-3 mb-6 relative w-full overflow-visible">
                        <div onClick={() => goToTab('profile')} className={`flex-shrink-0 flex items-center gap-2 bg-white p-1.5 pr-3 rounded-full cursor-pointer hover:bg-zinc-50 transition-colors border border-zinc-200 relative overflow-hidden group z-20 ${hasNoCharacters ? 'red-alert' : ''} shadow-sm`}>
                            <div className="w-8 h-8 rounded-full flex items-center justify-center font-black bg-zinc-100 text-zinc-700 shadow-inner relative z-10 text-lg border border-zinc-200">🧙‍♂️</div>
                            <div className="relative z-10"><p className="text-[8px] font-bold uppercase tracking-tighter opacity-70 text-zinc-500">LV.{stats.baseLv}</p><p className="text-[10px] font-black text-zinc-700">{stats.jobClass}</p></div>
                            <div className="absolute bottom-0 left-0 h-0.5 bg-emerald-500 transition-all duration-500" style={{width: `${expPercent}%`}}></div>
                        </div>
                        <div className="w-px h-8 bg-zinc-300 mx-1"></div>
                        <div className="flex-1 overflow-x-auto scrollbar-hide flex gap-2 pb-1">
                            {dailyChecklist.length > 0 ? dailyChecklist.map(c => (
                                <div key={c.id} onClick={() => setSelectedCharId(c.id)} className={`flex-shrink-0 min-w-[90px] p-2 rounded-xl border transition-all cursor-pointer relative flex flex-col justify-center active-char-card ${selectedCharId === c.id ? 'bg-white border-emerald-500 shadow-md' : 'bg-zinc-50 border-zinc-200 opacity-60'}`}>
                                    <div className="flex justify-between items-start"><p className={`text-[11px] font-bold truncate pr-4 ${selectedCharId === c.id ? 'text-zinc-800' : 'text-zinc-500'}`}>{c.name}</p></div>
                                    <p className="text-[9px] text-zinc-400 uppercase truncate">{c.job}</p>
                                    {c.hasRun && <div className="absolute bottom-1 right-1 text-emerald-500 text-[10px]">✅</div>}
                                </div>
                            )) : <div className="text-[10px] text-zinc-500 italic py-2">Add characters in Profile</div>}
                        </div>
                        {hasNoCharacters && <div className="absolute top-14 left-2 z-30 animate-bounce pointer-events-none origin-left"><div className="bg-emerald-500 text-white text-[10px] font-black px-3 py-2 rounded-xl relative shadow-lg">👈 Create Character Here!<div className="absolute -top-1 left-4 w-2.5 h-2.5 bg-emerald-500 transform rotate-45"></div></div></div>}
                    </header>
                    <div className="grid grid-cols-2 gap-3 mb-6">
                        <div className="bg-white rounded-2xl p-3 border border-zinc-200 flex flex-col justify-center items-center relative overflow-hidden shadow-sm">
                            <div className={`absolute inset-0 opacity-5 ${recentLuck.color.replace('text', 'bg')}`}></div>
                            <span className="text-[10px] font-bold text-zinc-400 uppercase tracking-widest z-10">Fortune</span>
                            <div className="flex items-center gap-2 z-10 mt-1"><span className="text-2xl">{recentLuck.icon}</span><span className={`text-xs font-black ${recentLuck.color}`}>{recentLuck.text}</span></div>
                        </div>
                        <div onClick={() => setShowWishlistModal(true)} className="bg-white rounded-2xl p-3 border border-zinc-200 flex flex-col justify-center shadow-sm cursor-pointer hover:bg-zinc-50 transition-colors relative group">
                            <div className="absolute top-2 right-2 text-zinc-300 group-hover:text-emerald-500"><Icon name="Settings" size={12}/></div>
                            <div className="flex justify-between mb-1">
                                <span className="text-[9px] font-bold text-zinc-400 uppercase truncate pr-4">{stats.wishlist ? stats.wishlist.name : 'Set Goal'}</span>
                                <span className="text-[9px] font-bold text-amber-500">{Math.floor(goalPercent)}%</span>
                            </div>
                            <div className="w-full h-2 bg-zinc-100 rounded-full overflow-hidden mb-1"><div className="h-full bg-gradient-to-r from-amber-400 to-orange-500 transition-all" style={{width: `${goalPercent}%`}}></div></div>
                            <div className="flex justify-between items-end">
                                <div className="flex items-center gap-1">
                                    {stats.wishlist && <div className="w-4 h-4"><SmartIcon name={stats.wishlist.icon} className="w-full h-full"/></div>}
                                    <p className="text-[8px] text-zinc-500">{formatMoney(stats.zeny)}</p>
                                </div>
                                <p className="text-[8px] font-bold text-emerald-500">{timeToGoal.text}</p>
                            </div>
                        </div>
                    </div>
                    
                    <div className="text-center mb-8 bg-white p-6 rounded-[2.5rem] border border-zinc-200 relative overflow-hidden shadow-lg shadow-zinc-200/50"><div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-emerald-400/30 to-transparent"></div><div className="flex items-center justify-center gap-2 mb-1"><SmartIcon name="Zeny" className="w-5 h-5"/><p className="text-[10px] opacity-50 font-bold uppercase tracking-widest text-zinc-600">Total Profit</p></div><p className="text-4xl font-black text-zinc-800 drop-shadow-sm">{formatMoney(totalProfit)}</p></div>
                    {window.Recharts && (<div className="glass-panel p-4 rounded-3xl h-48 mb-6 border-zinc-200 bg-white"><p className="text-[10px] font-bold opacity-40 mb-2 uppercase flex items-center gap-2 text-zinc-500"><Icon name="TrendingUp" size={14}/> Profit Trend</p><ResponsiveContainer width="100%" height="90%"><AreaChart data={chartData}><Area type="monotone" dataKey="profit" stroke="#10b981" fill="#10b981" fillOpacity={0.1} strokeWidth={3} /></AreaChart></ResponsiveContainer></div>)}
                    {showWishlistModal && <WishlistModal onClose={() => setShowWishlistModal(false)} onSave={handleSaveWishlist}/>}
                </div>
            );
        }

        function DungeonView({ db, uid, stock, activeBuffs, onSuccess, records, prices, stats, selectedCharId, setSelectedCharId, characters, goToTab }) {
            const [form, setForm] = useState({ runMode: 'ogh', normalGumUsed: 0, heGumUsed: 0, useSilvervine: false, purpleStoneCount: 0, contMagicCount: 0, trashAmount: '', minutesUsed: 60, otherCosts: [], notes: '' });
            const [rewardData, setRewardData] = useState(null);
            const [showHeGum, setShowHeGum] = useState(false);
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'oghza-tracker';
            const NOTE_TAGS = ['MVP Drop', 'Dead', 'Solo', 'Party', 'Disconnect', 'Lag', 'Carry'];

            useEffect(() => {
                if (records.length > 0 && !rewardData && !form.isLoaded) {
                    const lastRun = records.find(r => !r.isSaleRecord && r.characterId === selectedCharId) || records.find(r => !r.isSaleRecord);
                    if (lastRun) {
                        setForm(prev => ({ ...prev, runMode: lastRun.runMode || 'ogh', normalGumUsed: lastRun.normalGumUsed || 0, heGumUsed: lastRun.heGumUsed || 0, minutesUsed: lastRun.minutesUsed || 60, isLoaded: true }));
                        if(lastRun.heGumUsed > 0) setShowHeGum(true);
                    }
                }
            }, [records, rewardData, selectedCharId]);
            
            const hasGumStock = (stock.gum?.qty || 0) > 0;
            const hasHeGumStock = (stock.he_gum?.qty || 0) > 0; 
            const gameDate = getGameDate();
            const hasRunToday = records.some(r => r.characterId === selectedCharId && r.date === gameDate);
            const availableChars = useMemo(() => { if (!characters) return []; return characters.filter(c => c.id !== selectedCharId && !records.some(r => r.date === gameDate && r.characterId === c.id)); }, [characters, records, gameDate, selectedCharId]);
            const addCost = () => setForm(p => ({...p, otherCosts: [...p.otherCosts, {id: Date.now(), name: '', amount: ''}]}));
            const updateCost = (id, field, val) => { if (field === 'amount') val = val.replace(/[^0-9]/g, ''); setForm(p => ({...p, otherCosts: p.otherCosts.map(c => c.id === id ? {...c, [field]: val} : c)})); };
            const removeCost = (id) => setForm(p => ({...p, otherCosts: p.otherCosts.filter(c => c.id !== id)}));
            const addTag = (tag) => setForm(p => ({ ...p, notes: p.notes ? `${p.notes} [${tag}]` : `[${tag}]` }));
            
            const resetForm = () => {
                setForm({ runMode: 'ogh', normalGumUsed: 0, heGumUsed: 0, useSilvervine: false, purpleStoneCount: 0, contMagicCount: 0, trashAmount: '', minutesUsed: 60, otherCosts: [], notes: '', isLoaded: true });
                setShowHeGum(false);
            };

            const handleSave = async () => {
                const prevStats = { ...stats }; let costBreakdown = []; let gumCost = 0;
                if (form.normalGumUsed > 0) { const cost = form.normalGumUsed * (prices.gumBoxPrice / 10 || 150000); gumCost += cost; costBreakdown.push({ name: `Gum x${form.normalGumUsed}`, amount: cost }); }
                if (form.heGumUsed > 0) { const cost = form.heGumUsed * (prices.heGumBoxPrice / 5 || 500000); gumCost += cost; costBreakdown.push({ name: `HE Gum x${form.heGumUsed}`, amount: cost }); }
                form.otherCosts.forEach(c => { costBreakdown.push({ name: c.name || 'Misc', amount: parseInt(c.amount) || 0 }); });
                let consumablesCost = gumCost; 
                let newStock = { ...stock };
                if (form.normalGumUsed > 0) { if(!newStock.gum) newStock.gum = {qty:0}; newStock.gum.qty = Math.max(0, newStock.gum.qty - form.normalGumUsed); }
                if (form.heGumUsed > 0) { if(!newStock.he_gum) newStock.he_gum = {qty:0}; newStock.he_gum.qty = Math.max(0, newStock.he_gum.qty - form.heGumUsed); }
                const profit = (parseInt(form.trashAmount) || 0) - consumablesCost;
                const earnedDek = Math.max(0, Math.floor(profit / 1000));
                const drops = []; 
                const record = { ...form, runMode: form.runMode.toLowerCase(), consumablesCost, profit, drops, timestamp: Date.now(), date: getGameDate(), costBreakdown, characterId: selectedCharId };
                const newStats = { ...stats };
                newStats.coins = (newStats.coins || 0) + earnedDek;
                newStats.zeny = (newStats.zeny || 0) + profit;
                const expGain = form.minutesUsed * (form.runMode === 'aogh' ? 500 : 300);
                newStats.baseExp = (newStats.baseExp || 0) + expGain;
                while (newStats.baseExp >= getExpReq(newStats.baseLv)) { newStats.baseExp -= getExpReq(newStats.baseLv); newStats.baseLv += 1; }
                setRewardData({ ...form, runMode: form.runMode.toUpperCase(), drops, dek: earnedDek, expGain, profit, beforeExp: prevStats.baseExp, afterExp: newStats.baseExp, beforeLv: prevStats.baseLv, afterLv: newStats.baseLv });
                await setDoc(doc(db, 'artifacts', appId, 'users', uid, 'config', 'stock'), newStock);
                await addDoc(collection(db, 'artifacts', appId, 'users', uid, 'records'), record);
                await setDoc(doc(db, 'artifacts', appId, 'users', uid, 'gamification', 'stats'), newStats);
                const statsRef = doc(db, 'artifacts', appId, 'public', 'data', 'global', 'summary');
                try { await updateDoc(statsRef, { totalRuns: increment(1) }); } catch (e) { await setDoc(statsRef, { totalUsers: 1, totalRuns: 1 }, { merge: true }); }
            };
            const closeReward = () => { setRewardData(null); setForm(prev => ({ ...prev, purpleStoneCount: 0, contMagicCount: 0, trashAmount: '', otherCosts: [], notes: '' })); };
            const isFormValid = form.trashAmount && parseInt(form.trashAmount) > 0;
            const [shareData, setShareData] = useState(null);

            if (!characters || characters.length === 0) {
                return (<div className="p-6 flex flex-col items-center justify-center h-[60vh] text-center space-y-4"><div className="w-20 h-20 bg-zinc-100 rounded-full flex items-center justify-center text-4xl shadow-xl">🧙‍♂️</div><h3 className="text-xl font-bold text-zinc-700">No Characters Found</h3><p className="text-sm text-zinc-500">Please create a character to start tracking your adventures.</p><button onClick={() => goToTab('profile')} className="px-6 py-3 bg-emerald-600 rounded-xl font-bold text-white shadow-lg active:scale-95 transition-transform">Go to Profile</button></div>);
            }

            if (hasRunToday && !rewardData) {
                return (<div className="p-6 animate-fade-in view-content flex flex-col items-center justify-center min-h-[50vh] text-center space-y-4"><div className="w-24 h-24 bg-white rounded-full flex items-center justify-center text-4xl shadow-xl border border-zinc-200">✅</div><h3 className="text-xl font-black text-zinc-800">Daily Run Completed</h3><p className="text-sm text-zinc-500">Character has already finished OGH for today.<br/>Reset at 04:00 AM</p><button onClick={() => goToTab('profile')} className="px-6 py-3 mt-4 bg-zinc-100 border border-zinc-200 rounded-xl text-xs font-bold text-zinc-500 hover:text-zinc-800 transition-colors">Create New Character</button>{availableChars.length > 0 && (<div className="mt-8 w-full max-w-xs"><p className="text-[10px] font-bold text-zinc-400 uppercase tracking-widest mb-3">Switch to available character</p><div className="space-y-2">{availableChars.map(c => (<button key={c.id} onClick={() => setSelectedCharId(c.id)} className="w-full bg-white hover:bg-zinc-50 p-3 rounded-xl border border-zinc-200 flex items-center justify-between group transition-all"><div className="text-left"><p className="text-sm font-bold text-zinc-700 group-hover:text-emerald-500 transition-colors">{c.name}</p><p className="text-[10px] text-zinc-400 uppercase">{c.job}</p></div><Icon name="Check" size={16} className="text-zinc-300 group-hover:text-emerald-500"/></button>))}</div></div>)}</div>);
            }

            return (
                <div className="p-6 animate-fade-in view-content space-y-6">
                     <div className="flex bg-zinc-100 p-1 rounded-2xl border border-zinc-200 h-16">
                        <button type="button" onClick={() => setForm({...form, runMode: 'ogh'})} className={`flex-1 rounded-xl flex items-center justify-center gap-2 transition-all ${form.runMode === 'ogh' ? 'bg-purple-100 border border-purple-200 text-purple-700' : 'text-zinc-400 hover:text-zinc-600'}`}><div className="w-8 h-8 rounded-lg overflow-hidden"><SmartIcon name="OGH_BOSS" className="w-full h-full object-cover" /></div><span className="text-xs font-black">OGH</span></button>
                        <button type="button" onClick={() => setForm({...form, runMode: 'aogh'})} className={`flex-1 rounded-xl flex items-center justify-center gap-2 transition-all ${form.runMode === 'aogh' ? 'bg-rose-100 border border-rose-200 text-rose-700' : 'text-zinc-400 hover:text-zinc-600'}`}><div className="w-8 h-8 rounded-lg overflow-hidden"><SmartIcon name="AOGH_BOSS" className="w-full h-full object-cover" /></div><span className="text-xs font-black">AOGH</span></button>
                     </div>
                     <div className="px-4 py-2 flex items-center justify-between"><span className="text-xs font-bold text-zinc-400">Trash Sale</span><div className="flex items-center gap-2"><input type="text" inputMode="numeric" placeholder="0" value={form.trashAmount === 0 ? '' : form.trashAmount} onChange={e => setForm({...form, trashAmount: parseInt(e.target.value) || ''})} className="slate-input text-right text-xl font-black outline-none placeholder-zinc-300 text-emerald-500 w-32" /><span className="text-[10px] font-bold text-zinc-500">ZENY</span></div></div>
                    <div className="glass-panel p-6 rounded-[2rem] space-y-4 bg-white border-zinc-200 relative">
                        <button onClick={resetForm} className="absolute top-2 right-2 text-[10px] font-bold text-zinc-400 border border-zinc-200 px-2 py-1 rounded-lg hover:bg-zinc-50">Reset</button>
                        <div className="space-y-4">
                            <div className="flex justify-between items-center rounded-xl p-2 border border-zinc-100 bg-zinc-50"><span className="text-xs font-bold text-blue-500 flex items-center gap-2 relative z-10"><SmartIcon name="Gum" className="w-5 h-5"/> Bubble Gum</span><div className="flex bg-white rounded-lg p-0.5 gap-1 relative z-10">{[0, 1, 2].map(n => (<button key={n} disabled={!hasGumStock && n>0} onClick={() => setForm({...form, normalGumUsed: n})} className={`w-8 h-8 rounded-md text-xs font-bold transition-all ${form.normalGumUsed === n ? (n===0 ? 'bg-zinc-200 text-zinc-500' : 'bg-blue-500 text-white shadow') : 'text-zinc-400 hover:bg-zinc-100'}`}>{n}</button>))}</div></div>
                            <button onClick={() => setShowHeGum(!showHeGum)} className={`w-full py-2 rounded-xl text-xs font-bold border transition-all ${showHeGum ? 'bg-amber-50 border-amber-200 text-amber-500' : 'bg-zinc-50 border-zinc-100 text-zinc-400'}`}>{showHeGum ? '✅ HE Bubble Gum Active' : 'Enable HE Bubble Gum'}</button>
                            {showHeGum && (<div className="flex justify-between items-center rounded-xl p-2 border border-zinc-100 bg-zinc-50 animate-slide-up"><span className="text-xs font-bold text-amber-500 flex items-center gap-2 relative z-10"><SmartIcon name="HeGum" className="w-5 h-5"/> HE Gum</span><div className="flex bg-white rounded-lg p-0.5 gap-1 relative z-10">{[0, 1, 2, 3, 4].map(n => (<button key={n} disabled={!hasHeGumStock && n>0} onClick={() => setForm({...form, heGumUsed: n})} className={`w-8 h-8 rounded-md text-xs font-bold transition-all ${form.heGumUsed === n ? (n===0 ? 'bg-zinc-200 text-zinc-500' : 'bg-amber-500 text-white shadow') : 'text-zinc-400 hover:bg-zinc-100'}`}>{n}</button>))}</div></div>)}
                        </div>
                        <div className="bg-zinc-50 rounded-2xl p-3 border border-zinc-100"><label className="text-[9px] font-bold opacity-40 uppercase mb-2 flex items-center gap-2 text-zinc-500"><Icon name="Clock" size={14}/> Time Spent (Minutes): <span className="text-emerald-500 ml-auto text-sm">{form.minutesUsed}m</span></label><input type="range" min="1" max="60" value={form.minutesUsed} onChange={e => setForm({...form, minutesUsed: parseInt(e.target.value)})} className="w-full h-1 bg-zinc-200 rounded-lg appearance-none cursor-pointer accent-emerald-500" /></div>
                        <div className="grid grid-cols-2 gap-3">
                             <div className="flex flex-col items-center gap-1 p-2"><div className="relative z-10 mb-1"><SmartIcon name="Spell" className="w-10 h-10 drop-shadow-lg" /></div><input type="text" inputMode="numeric" placeholder="0" value={form.purpleStoneCount === 0 ? '' : form.purpleStoneCount} onChange={e => setForm({...form, purpleStoneCount: e.target.value === '' ? 0 : (parseInt(e.target.value)||0)})} className="slate-input w-full text-lg font-black text-center outline-none text-purple-600 placeholder-zinc-300"/></div>
                             <div className={`flex flex-col items-center gap-1 p-2 ${form.runMode==='ogh'?'opacity-30':''}`}><div className="relative z-10 mb-1"><SmartIcon name="Magic" className="w-10 h-10 drop-shadow-lg" /></div><input type="text" inputMode="numeric" disabled={form.runMode==='ogh'} placeholder="0" value={form.contMagicCount === 0 ? '' : form.contMagicCount} onChange={e => setForm({...form, contMagicCount: e.target.value === '' ? 0 : (parseInt(e.target.value)||0)})} className="slate-input w-full text-lg font-black text-center outline-none text-rose-500 placeholder-zinc-300"/></div>
                        </div>
                    </div>
                    <div className="space-y-2">
                        <div className="flex justify-between items-center"><span className="text-[10px] font-bold opacity-30 uppercase tracking-widest text-zinc-400">Extras</span><button type="button" onClick={addCost} className="text-[10px] text-zinc-400 hover:text-zinc-600 font-bold transition-colors">+ Cost</button></div>{form.otherCosts.map(c => (<div key={c.id} className="flex gap-2 animate-fade-in"><input type="text" placeholder="Name" value={c.name} onChange={e => updateCost(c.id, 'name', e.target.value)} className="slate-input flex-1 p-2 rounded-xl text-xs bg-white text-zinc-700" /><input type="text" inputMode="numeric" placeholder="0" value={c.amount} onChange={e => updateCost(c.id, 'amount', e.target.value)} className="slate-input w-20 p-2 rounded-xl text-xs text-right bg-white text-zinc-700" /><button type="button" onClick={() => removeCost(c.id)} className="text-zinc-400 hover:text-rose-500 p-2"><Icon name="Trash" size={14}/></button></div>))}
                        <textarea placeholder="Add a note..." value={form.notes} onChange={e => setForm({...form, notes: e.target.value})} className="note-input w-full bg-white border border-zinc-200 rounded-xl p-3 text-xs text-zinc-700 outline-none h-12 resize-none placeholder-zinc-400 transition-all"></textarea>
                        <div className="flex gap-1 flex-wrap">{NOTE_TAGS.map(tag => <button key={tag} onClick={() => addTag(tag)} className="px-2 py-1 bg-zinc-100 rounded-lg text-[9px] font-bold text-zinc-500 border border-zinc-200 hover:bg-zinc-200">{tag}</button>)}</div>
                    </div>
                    <button disabled={!isFormValid} onClick={handleSave} className="w-full py-5 bg-gradient-to-r from-emerald-500 to-teal-500 rounded-[1.5rem] font-black text-lg shadow-lg shadow-emerald-500/20 active:scale-95 transition-transform text-white flex items-center justify-center gap-2 disabled:opacity-50 disabled:grayscale"><Icon name="Save" size={20}/> COMPLETE RUN</button>
                    {rewardData && <RewardPopup data={rewardData} onClose={closeReward} onShare={() => setShareData({...rewardData, runMode: form.runMode === 'aogh' ? 'AOGH' : 'OGH', rank: getRankInfo(rewardData.profit, 0).rank, rankCss: getRankInfo(rewardData.profit, 0).css})} />}
                    {shareData && <ShareModal data={shareData} onClose={() => setShareData(null)} />}
                </div>
            );
        }

        function CalendarView({ records }) {
            const getDaysInMonth = (month, year) => new Date(year, month + 1, 0).getDate();
            const now = getGameDateObj(); // Use Game Time
            const daysInMonth = getDaysInMonth(now.getMonth(), now.getFullYear());
            const firstDay = new Date(now.getFullYear(), now.getMonth(), 1).getDay(); // 0 = Sun
            const days = Array.from({length: daysInMonth}, (_, i) => i + 1);
            
            const getStatus = (day) => {
                const dateStr = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
                const dailyRecs = records.filter(r => r.date === dateStr && !r.isSaleRecord);
                if (dailyRecs.length === 0) return 'neutral';
                const profit = dailyRecs.reduce((a, b) => a + (b.profit || 0), 0);
                return profit >= 0 ? 'green' : 'red';
            };

            return (
                <div className="bg-white p-4 rounded-[2rem] border border-zinc-200 shadow-sm mb-6">
                    <div className="flex justify-between items-center mb-4">
                        <span className="text-xs font-black text-zinc-700 uppercase tracking-widest">{now.toLocaleString('default', { month: 'long' })} {now.getFullYear()}</span>
                    </div>
                    <div className="calendar-grid">
                        {['S','M','T','W','T','F','S'].map((d,i)=><div key={i} className="calendar-header">{d}</div>)}
                        {Array.from({length: firstDay}).map((_, i) => <div key={`empty-${i}`}></div>)}
                        {days.map(d => {
                            const status = getStatus(d);
                            const isToday = d === now.getDate();
                            return (
                                <div key={d} className={`calendar-cell calendar-${status} ${isToday ? 'ring-2 ring-blue-400' : ''}`}>
                                    {d}
                                    {status !== 'neutral' && <div className={`absolute bottom-1 w-1 h-1 rounded-full ${status==='green'?'bg-emerald-500':'bg-rose-500'}`}></div>}
                                </div>
                            );
                        })}
                    </div>
                </div>
            );
        }

        function InsightView({ records }) {
            if (records.length < 2) return <div className="text-center text-xs text-zinc-400 py-10">Need more runs to analyze efficiency.</div>;
            
            const oghRuns = records.filter(r => !r.isSaleRecord && r.runMode === 'ogh');
            const aoghRuns = records.filter(r => !r.isSaleRecord && r.runMode === 'aogh');
            const gumRuns = records.filter(r => !r.isSaleRecord && r.normalGumUsed > 0);
            const noGumRuns = records.filter(r => !r.isSaleRecord && r.normalGumUsed === 0 && r.heGumUsed === 0);

            const avgOgh = oghRuns.length ? oghRuns.reduce((a,b)=>a+b.profit,0)/oghRuns.length : 0;
            const avgAogh = aoghRuns.length ? aoghRuns.reduce((a,b)=>a+b.profit,0)/aoghRuns.length : 0;
            const avgGum = gumRuns.length ? gumRuns.reduce((a,b)=>a+b.profit,0)/gumRuns.length : 0;
            const avgNoGum = noGumRuns.length ? noGumRuns.reduce((a,b)=>a+b.profit,0)/noGumRuns.length : 0;

            const Bar = ({ label, val, color }) => (
                <div className="mb-3">
                    <div className="flex justify-between text-[10px] font-bold text-zinc-500 mb-1"><span>{label}</span><span>{formatMoney(val)}</span></div>
                    <div className="w-full h-2 bg-zinc-100 rounded-full overflow-hidden"><div className={`h-full ${color}`} style={{width: `${Math.min(100, (val/Math.max(avgOgh, avgAogh, avgGum, avgNoGum))*100)}%`}}></div></div>
                </div>
            );

            return (
                <div className="glass-panel p-4 rounded-2xl border-zinc-200 bg-white">
                    <h4 className="text-[10px] font-bold opacity-40 uppercase tracking-widest flex items-center gap-2 mb-4"><SmartIcon name="Graph" className="w-4 h-4"/> Efficiency Analysis</h4>
                    <Bar label="OGH Average" val={avgOgh} color="bg-purple-400" />
                    <Bar label="AOGH Average" val={avgAogh} color="bg-rose-400" />
                    <div className="h-px bg-zinc-100 my-3"></div>
                    <Bar label="No Gum Run" val={avgNoGum} color="bg-zinc-400" />
                    <Bar label="With Gum Run" val={avgGum} color="bg-blue-400" />
                </div>
            );
        }

        function HistoryView({ records, db, uid, showToast, prices, activeBuffs, characters }) {
            const { ResponsiveContainer, ScatterChart, Scatter, XAxis, YAxis, Tooltip } = window.Recharts || {};
            const [expandedId, setExpandedId] = useState(null);
            const [showRankInfo, setShowRankInfo] = useState(false);
            const [shareData, setShareData] = useState(null); 
            const [showGlobalStats, setShowGlobalStats] = useState(false);
            const [globalStats, setGlobalStats] = useState(null);
            const [subTab, setSubTab] = useState('List'); 
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'oghza-tracker';

            const fetchGlobalStats = async () => {
                const statsRef = doc(db, 'artifacts', appId, 'public', 'data', 'global', 'summary');
                const snap = await getDoc(statsRef);
                if (snap.exists()) { setGlobalStats(snap.data()); } else { setGlobalStats({ totalUsers: 0, totalRuns: 0 }); }
                setShowGlobalStats(true);
            };
            const groupedRecords = useMemo(() => { const groups = {}; records.forEach(r => { if (!groups[r.date]) groups[r.date] = []; groups[r.date].push(r); }); return groups; }, [records]);
            const avgProfit = useMemo(() => { const profits = records.filter(r => !r.isSaleRecord).map(r => r.profit || 0); if(profits.length === 0) return 0; const sum = profits.reduce((a, b) => a + b, 0); return sum / profits.length; }, [records]);
            const salesData = useMemo(() => { return records.filter(r => r.isSaleRecord).map(r => ({ date: new Date(r.timestamp).getTime(), price: r.pricePerUnit, name: r.itemName })).sort((a,b) => a.date - b.date); }, [records]);
            const handleDeleteRecord = async (record) => { try { await deleteDoc(doc(db, 'artifacts', appId, 'users', uid, 'records', record.id)); const profit = record.profit || 0; const dek = Math.floor(profit / 1000); const statsRef = doc(db, 'artifacts', appId, 'users', uid, 'gamification', 'stats'); await updateDoc(statsRef, { zeny: increment(-profit), coins: increment(-dek) }); showToast("Deleted & Refunded Stats"); } catch (e) { console.error(e); showToast("Error deleting record"); } };

            return (
                <div className="p-6 animate-fade-in view-content space-y-4">
                    <div className="flex justify-between items-center mb-4"><h2 className="text-2xl font-black tracking-tighter text-zinc-700 flex items-center gap-2">History Logs <button onClick={() => setShowRankInfo(true)} className="opacity-40 hover:opacity-100 transition-opacity text-emerald-500"><Icon name="Info" size={20} /></button></h2></div>
                    <div className="flex bg-zinc-100 p-1 rounded-xl mb-4 border border-zinc-200">
                        {['List', 'Calendar', 'Insight'].map(t => <button key={t} onClick={() => setSubTab(t)} className={`flex-1 py-1.5 text-[10px] font-bold uppercase rounded-lg transition-all ${subTab === t ? 'bg-white text-zinc-800 shadow-sm' : 'text-zinc-400'}`}>{t}</button>)}
                    </div>

                    {subTab === 'Insight' && <InsightView records={records} />}
                    {subTab === 'Calendar' && <CalendarView records={records} />}
                    
                    {subTab === 'List' && (
                        <>
                        {salesData.length > 2 && window.Recharts && (<div className="glass-panel p-4 rounded-3xl h-48 mb-6 border-zinc-200 bg-white"><p className="text-[10px] font-bold opacity-40 mb-2 uppercase flex items-center gap-2 text-zinc-500"><Icon name="TrendingUp" size={14}/> Sales History</p><ResponsiveContainer width="100%" height="90%"><ScatterChart margin={{ top: 5, right: 5, bottom: 5, left: 5 }}><XAxis dataKey="date" type="number" domain={['auto', 'auto']} tickFormatter={unix => new Date(unix).getDate()} hide /><YAxis dataKey="price" type="number" hide domain={['auto', 'auto']} /><Tooltip cursor={{ strokeDasharray: '3 3' }} content={({ payload }) => { if (payload && payload.length) { const d = payload[0].payload; return ( <div className="bg-white border border-zinc-200 p-2 rounded-lg text-[10px] shadow-xl"> <p className="font-bold text-zinc-800">{d.name}</p> <p className="text-emerald-500">{formatMoney(d.price)} z</p> <p className="text-zinc-400">{new Date(d.date).toLocaleDateString()}</p> </div> ); } return null; }} /><Scatter name="Sales" data={salesData} fill="#10b981" /></ScatterChart></ResponsiveContainer></div>)}
                        {Object.keys(groupedRecords).length === 0 ? (
                            <div className="text-center text-zinc-400 py-10 italic">No logs yet. Start your adventure! ⚔️</div>
                        ) : (
                            <div className="space-y-6">
                                {Object.keys(groupedRecords).sort((a,b)=>new Date(b)-new Date(a)).map(date => { 
                                    const dailyRecords = groupedRecords[date]; 
                                    return (
                                        <div key={date} className="space-y-3">
                                            <div className="sticky top-14 z-20 bg-white/95 backdrop-blur-md px-3 py-2 rounded-lg border-b border-zinc-200 flex justify-between items-center shadow-sm">
                                                <span className="text-xs font-bold text-zinc-500">{date}</span>
                                                <span className="text-[10px] text-zinc-400">{dailyRecords.length} Records</span>
                                            </div>
                                            {dailyRecords.map(r => { 
                                                const isExpanded = expandedId === r.id; 
                                                const profitValue = r.profit || 0; 
                                                let rankInfo = { rank: '-', css: 'text-zinc-400', text: '' }; 
                                                if (!r.isSaleRecord) { rankInfo = getRankInfo(profitValue, avgProfit); } 
                                                const charName = characters && characters.find(c => c.id === r.characterId)?.name; 
                                                
                                                if (r.isSaleRecord) { 
                                                    return (
                                                        <div key={r.id} className="list-panel rounded-[1.5rem] overflow-hidden transition-all border-zinc-200 mb-2 bg-white shadow-sm">
                                                            <div onClick={() => setExpandedId(expandedId === r.id ? null : r.id)} className="p-4 flex justify-between items-center cursor-pointer">
                                                                <div className="flex gap-3">
                                                                    <div className="w-10 h-10 rounded-xl flex items-center justify-center overflow-hidden border border-zinc-100 relative bg-zinc-50 shadow-inner"><SmartIcon name={r.itemId === 'spell' ? 'Spell' : 'Magic'} className="w-8 h-8" /></div>
                                                                    <div>
                                                                        <p className="font-bold text-sm text-emerald-600">Sold {r.itemName}</p>
                                                                        <p className="text-[10px] opacity-60 text-zinc-500 uppercase font-bold tracking-widest flex items-center gap-1">Qty: {r.qty} @ {formatMoney(r.pricePerUnit)}</p>
                                                                    </div>
                                                                </div>
                                                                <div className="text-right flex flex-col items-end">
                                                                    <p className="font-black text-sm text-emerald-500">+{formatMoney(r.profit)}</p>
                                                                    <div className="flex items-center gap-1 mt-1 text-[10px] font-black text-zinc-400"><Icon name="TrendingUp" size={10}/> SALES</div>
                                                                </div>
                                                            </div>
                                                            {expandedId === r.id && (<div className="px-4 pb-4 animate-slide-up bg-zinc-50 pt-4 border-t border-zinc-100 text-center"><div className="flex justify-end"><DeleteButton onDelete={() => handleDeleteRecord(r)} className="w-28" /></div></div>)}
                                                        </div>
                                                    ); 
                                                } 
                                                
                                                return (
                                                    <div key={r.id} className={`list-panel rounded-[1.5rem] overflow-hidden transition-all border-zinc-200 shadow-sm ${expandedId === r.id ? 'bg-zinc-50 ring-1 ring-zinc-300' : 'bg-white'}`}>
                                                        <div onClick={() => setExpandedId(expandedId === r.id ? null : r.id)} className="p-4 flex justify-between items-center cursor-pointer">
                                                            <div className="flex gap-3">
                                                                <div className={`w-10 h-10 rounded-xl flex items-center justify-center overflow-hidden border border-zinc-100 relative bg-zinc-100`}><SmartIcon name={r.runMode === 'aogh' ? 'AOGH_BOSS' : 'OGH_BOSS'} className="w-full h-full object-cover" /></div>
                                                                <div>
                                                                    <p className="font-bold text-sm text-zinc-700">{r.runMode?.toUpperCase() || 'OGH'} <span className="text-[10px] text-zinc-400 font-normal ml-1">by {charName || 'Unknown'}</span></p>
                                                                    <p className="text-[10px] opacity-40 uppercase font-bold tracking-widest text-zinc-500 flex items-center gap-1"><Icon name="Clock" size={10}/> {r.minutesUsed}m</p>
                                                                </div>
                                                            </div>
                                                            <div className="text-right flex flex-col items-end">
                                                                <p className={`font-black text-sm ${profitValue >= 0 ? 'text-emerald-500' : 'text-rose-500'}`}>{formatMoney(profitValue)}</p>
                                                                <div className="flex items-center gap-1 mt-1"><Icon name="Clover" size={12} className={rankInfo.css}/><span className={`text-[10px] font-black ${rankInfo.css}`}>{rankInfo.text} : {rankInfo.rank}</span></div>
                                                            </div>
                                                        </div>
                                                        {expandedId === r.id && (
                                                            <div className="px-4 pb-4 animate-slide-up bg-zinc-50/50 pt-4 border-t border-zinc-200 text-center">
                                                                <div className="grid grid-cols-2 gap-3 mb-4 text-left">
                                                                    <div className="p-2 border-b border-zinc-100"><p className="text-[9px] uppercase opacity-50 mb-2 text-zinc-400">Stones</p><div className="flex items-center gap-4"><div className="flex items-center gap-2"><SmartIcon name="Spell" className="w-6 h-6"/><span className="text-purple-500 font-bold text-sm">x{r.purpleStoneCount}</span></div>{r.runMode==='aogh' && (<div className="flex items-center gap-2"><SmartIcon name="Magic" className="w-6 h-6"/><span className="text-rose-500 font-bold text-sm">x{r.contMagicCount}</span></div>)}</div></div>
                                                                    <div className="p-2 border-b border-zinc-100"><p className="text-[9px] uppercase opacity-50 mb-2 text-zinc-400">Usage</p><div className="flex flex-wrap gap-4 items-center">{r.normalGumUsed > 0 && <div className="flex items-center gap-2"><SmartIcon name="Gum" className="w-6 h-6"/><span className="text-zinc-600 text-xs">x{r.normalGumUsed}</span></div>}{r.heGumUsed > 0 && <div className="flex items-center gap-2"><SmartIcon name="HeGum" className="w-6 h-6"/><span className="text-zinc-600 text-xs">x{r.heGumUsed}</span></div>}<div className="flex items-center gap-1 text-xs text-zinc-400 ml-auto"><Icon name="Clock" size={14} className="text-zinc-400"/> {r.minutesUsed}m</div></div></div>
                                                                    <div className="col-span-2 p-2 space-y-1"><p className="text-[9px] uppercase opacity-50 font-bold mb-2 flex items-center gap-1 text-zinc-400"><Icon name="Cost" size={10}/> Expenses</p>{r.costBreakdown && r.costBreakdown.length > 0 ? (r.costBreakdown.map((c, i) => (<div key={i} className="flex justify-between text-[10px] text-zinc-500 border-b border-zinc-100 pb-1"><span className="truncate w-32">{c.name}</span><span>-{formatMoney(c.amount)}</span></div>))) : ((r.consumablesCost > 0) && (<div className="flex justify-between text-[10px] text-zinc-500 border-b border-zinc-100 pb-1"><span>Direct Consumables</span><span>-{formatMoney(r.consumablesCost)}</span></div>))}<div className="pt-1 flex justify-between text-[10px] font-bold text-rose-400 mt-1"><span>Total Direct Cost</span><span>-{formatMoney(r.consumablesCost + (r.otherCosts?.reduce((a,x)=>a+parseInt(x.amount||0),0)||0))}</span></div></div>
                                                                    {r.drops && r.drops.length > 0 && (<div className="col-span-2 p-2"><p className="text-[9px] uppercase opacity-50 mb-2 text-zinc-400">Drops</p><div className="flex gap-2 overflow-x-auto pb-1 scrollbar-hide">{r.drops.map((d, i) => (<div key={i} className="flex-shrink-0 w-8 h-8 bg-zinc-100 rounded-lg flex items-center justify-center relative border border-zinc-200"><SmartIcon name={d.icon} className="w-6 h-6"/><span className="absolute bottom-0 right-0 text-[8px] bg-zinc-800 text-white px-1 rounded">{d.qty}</span></div>))}</div></div>)}
                                                                    {r.notes && (<div className="col-span-2 bg-yellow-50 p-3 rounded-xl border border-yellow-100 relative mt-2"><div className="absolute -top-2.5 left-3 bg-white px-2 py-0.5 text-[9px] text-yellow-600 font-bold border border-yellow-200 rounded-full flex items-center gap-1 shadow-sm"><Icon name="FileText" size={8}/> NOTE</div><p className="text-[11px] italic text-zinc-300 mt-1">"{r.notes}"</p></div>)}
                                                                </div>
                                                                <div className="flex gap-2 justify-end mt-2">
                                                                    <button onClick={() => setShareData({...r, runMode: r.runMode === 'aogh' ? 'AOGH' : 'OGH', rank: rankInfo.rank, rankCss: rankInfo.css})} className="h-8 w-8 bg-zinc-100 rounded-lg text-zinc-500 hover:text-zinc-800 flex items-center justify-center"><Icon name="Share" size={14}/></button>
                                                                    <DeleteButton onDelete={() => handleDeleteRecord(r)} className="w-24" />
                                                                </div>
                                                            </div>
                                                        )}
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    ); 
                                })}
                            </div>
                        )}
                        </>
                    )}

                    <div className="mt-8 mb-24 text-center">
                        <button onClick={fetchGlobalStats} className="text-xs text-blue-500 font-bold hover:underline flex items-center justify-center gap-1 mx-auto bg-blue-50 px-4 py-2 rounded-full border border-blue-100 shadow-sm transition-transform active:scale-95">
                            <Icon name="Globe" size={14} /> ดูสถิติเซิร์ฟเวอร์ (Server Stats) 🌎
                        </button>
                    </div>
                    
                    {showRankInfo && <InfoModal onClose={() => setShowRankInfo(false)} />}
                    {shareData && <ShareModal data={shareData} onClose={() => setShareData(null)} />}
                    {showGlobalStats && <GlobalStatsModal stats={globalStats} onClose={() => setShowGlobalStats(false)} />}
                </div>
            );
        }

        function App() {
            const [authUser, setAuthUser] = useState(null);
            const [targetUid, setTargetUid] = useState(null);
            const [activeTab, setActiveTab] = useState('home');
            const [records, setRecords] = useState([]);
            const [prices, setPrices] = useState({ purpleStonePrice: 150000, contMagicPrice: 450000, gumBoxPrice: 1500000, silvervineBoxPrice: 2500000 });
            const [activeBuffs, setActiveBuffs] = useState([]);
            const [stats, setStats] = useState(INITIAL_STATS);
            const [loading, setLoading] = useState(true);
            const [toast, setToast] = useState(null);
            const [db, setDb] = useState(null);
            const [stock, setStock] = useState({});
            const [theme, setTheme] = useState(localStorage.getItem('ogh_theme') || 'dark');
            const [characters, setCharacters] = useState([]);
            const [selectedCharId, setSelectedCharId] = useState(localStorage.getItem('ogh_selected_char_id') || 'default');

            const appId = typeof __app_id !== 'undefined' ? __app_id : 'oghza-tracker';
            const showToast = (message) => { setToast(message); setTimeout(() => setToast(null), 3000); };
            
            useEffect(() => {
                document.documentElement.setAttribute('data-theme', theme);
                localStorage.setItem('ogh_theme', theme);
            }, [theme]);

            const handleSetUid = (newUid) => {
                setTargetUid(newUid);
                localStorage.setItem('ogh_target_uid', newUid);
            };

            const handleResetUid = () => { 
                localStorage.removeItem('ogh_target_uid'); 
                if (authUser) setTargetUid(authUser.uid); 
                showToast("Restored Default ID"); 
            };
            
            useEffect(() => {
                if(selectedCharId) localStorage.setItem('ogh_selected_char_id', selectedCharId);
            }, [selectedCharId]);

            useEffect(() => {
                const init = async () => {
                    const app = initializeApp(MANUAL_FIREBASE_CONFIG);
                    const auth = getAuth(app);
                    const firestore = getFirestore(app);
                    setDb(firestore);
                    await signInAnonymously(auth);
                    onAuthStateChanged(auth, (u) => { setAuthUser(u); setTargetUid(localStorage.getItem('ogh_target_uid') || u?.uid); setLoading(false); });
                };
                init();
            }, []);

            // Register User Globally
            useEffect(() => {
                if (!db || !targetUid) return;
                
                const registerUser = async () => {
                      const userRef = doc(db, 'artifacts', appId, 'public', 'data', 'registry', targetUid);
                      const userSnap = await getDoc(userRef);
                      if (!userSnap.exists()) {
                          await setDoc(userRef, { registeredAt: Date.now() });
                          const statsRef = doc(db, 'artifacts', appId, 'public', 'data', 'global', 'summary');
                          try {
                              await updateDoc(statsRef, { totalUsers: increment(1) });
                          } catch(e) {
                              await setDoc(statsRef, { totalUsers: 1, totalRuns: 0 }, { merge: true });
                          }
                      }
                };
                registerUser();
            }, [db, targetUid]);

            useEffect(() => {
                if (!db || !targetUid) return;
                const unsubRecords = onSnapshot(query(collection(db, 'artifacts', appId, 'users', targetUid, 'records'), orderBy('timestamp', 'desc')), (snap) => setRecords(snap.docs.map(d => ({ ...d.data(), id: d.id }))));
                const unsubPrices = onSnapshot(doc(db, 'artifacts', appId, 'users', targetUid, 'config', 'prices'), d => { if (d.exists()) setPrices(d.data()); });
                const unsubStats = onSnapshot(doc(db, 'artifacts', appId, 'users', targetUid, 'gamification', 'stats'), d => { if (d.exists()) setStats(d.data()); else setStats(INITIAL_STATS); });
                const unsubStock = onSnapshot(doc(db, 'artifacts', appId, 'users', targetUid, 'config', 'stock'), d => { if (d.exists()) setStock(d.data()); });
                
                const unsubChars = onSnapshot(doc(db, 'artifacts', appId, 'users', targetUid, 'config', 'characters'), d => { 
                    if (d.exists()) {
                        const list = d.data().list || [];
                        setCharacters(list);
                        if (list.length > 0 && (!selectedCharId || selectedCharId === 'default' || !list.find(c => c.id === selectedCharId))) {
                            setSelectedCharId(list[0].id);
                        }
                    } else {
                        setCharacters([]);
                    }
                });

                const qInv = query(collection(db, 'artifacts', appId, 'users', targetUid, 'inventory'));
                const unsubBuffs = onSnapshot(qInv, snap => {
                    const buffs = snap.docs.map(d => d.data()).filter(i => i.status === 'active').map(b => {
                          const endDate = new Date(b.activatedAt);
                          if(b.duration === 30) endDate.setDate(endDate.getDate() + 30);
                          else if(b.duration === 7) endDate.setDate(endDate.getDate() + 7);
                          else if(b.duration === 1) endDate.setTime(endDate.getTime() + (24*60*60*1000));
                          return { ...b, endDate };
                    });
                    setActiveBuffs(buffs);
                });
                
                return () => { unsubRecords(); unsubPrices(); unsubStats(); unsubBuffs(); unsubStock(); unsubChars(); };
            }, [db, targetUid]);

            const runCount = useMemo(() => records.filter(r => !r.isSaleRecord).length, [records]);

            if (loading) return <div className="h-screen flex items-center justify-center bg-[#f0f2f5] text-emerald-600 font-bold tracking-widest animate-pulse">LOADING...</div>;

            return (
                <div className="max-w-md mx-auto relative min-h-screen">
                    <CurrencyHeader stats={stats} activeBuffs={activeBuffs} selectedCharId={selectedCharId} runCount={runCount} />
                    {toast && <Toast message={toast} />}
                    {activeTab === 'home' && <HomeView records={records} stats={stats} goToTab={setActiveTab} activeBuffs={activeBuffs} stock={stock} characters={characters} selectedCharId={selectedCharId} setSelectedCharId={setSelectedCharId} db={db} uid={targetUid} showToast={showToast} />}
                    {activeTab === 'add' && <DungeonView db={db} uid={targetUid} stock={stock} activeBuffs={activeBuffs} records={records} prices={prices} stats={stats} selectedCharId={selectedCharId} setSelectedCharId={setSelectedCharId} characters={characters} onSuccess={() => {}} goToTab={setActiveTab} />}
                    {activeTab === 'inventory' && <InventoryView db={db} uid={targetUid} showToast={showToast} records={records} stock={stock} stats={stats} selectedCharId={selectedCharId} />}
                    {activeTab === 'shop' && <ShopView db={db} uid={targetUid} showToast={showToast}/>}
                    {activeTab === 'history' && <HistoryView records={records} db={db} uid={targetUid} showToast={showToast} prices={prices} activeBuffs={activeBuffs} characters={characters} />}
                    {activeTab === 'profile' && <ProfileView stats={stats} uid={targetUid} onResetUid={handleResetUid} onSetUid={handleSetUid} prices={prices} setPrices={setPrices} db={db} showToast={showToast} onBack={() => setActiveTab('home')} characters={characters} setCharacters={setCharacters} setTheme={setTheme} currentTheme={theme} />}
                    
                    <nav className="fixed bottom-0 left-0 right-0 max-w-md mx-auto glass-panel border-t border-white/5 nav-bar-padding pt-2 px-2 flex justify-between items-end z-40 rounded-t-[2rem]">
                        <button onClick={() => setActiveTab('home')} className={`flex-1 flex flex-col items-center gap-1 py-3 ${activeTab === 'home' ? 'nav-item-active' : 'nav-item-inactive'}`}><Icon name="Home" size={24}/><span className="text-[9px] font-bold uppercase">Home</span></button>
                        <button onClick={() => setActiveTab('inventory')} className={`flex-1 flex flex-col items-center gap-1 py-3 ${activeTab === 'inventory' ? 'nav-item-active' : 'nav-item-inactive'}`}><Icon name="Inventory" size={24}/><span className="text-[9px] font-bold uppercase">Item</span></button>
                        <button onClick={() => setActiveTab('shop')} className={`flex-1 flex flex-col items-center gap-1 py-3 ${activeTab === 'shop' ? 'nav-item-active' : 'nav-item-inactive'}`}><Icon name="Shop" size={24}/><span className="text-[9px] font-bold uppercase">Shop</span></button>
                        <button onClick={() => setActiveTab('add')} className={`flex-1 flex flex-col items-center gap-1 py-3 ${activeTab === 'add' ? 'nav-item-active' : 'nav-item-inactive'}`}><Icon name="Dungeon" size={24}/><span className="text-[9px] font-bold uppercase">Adventure</span></button>
                        <button onClick={() => setActiveTab('history')} className={`flex-1 flex flex-col items-center gap-1 py-3 ${activeTab === 'history' ? 'nav-item-active' : 'nav-item-inactive'}`}><Icon name="History" size={24}/><span className="text-[9px] font-bold uppercase">History</span></button>
                    </nav>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);

    </script>
</body>
</html>
