<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Magic Item Manager - GitHub Sync Pro</title>
    
    <!-- Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/imagetracerjs@1.2.6/imagetracer.min.js"></script>

    <style>
        :root {
            --sidebar-width: 260px;
            --bg-dark: #121026;
            --card-bg: rgba(255, 255, 255, 0.05);
            --accent-color: #7c5cdb;
            --warp-blue: #4eeaf6;
            --input-bg: rgba(255, 255, 255, 0.08);
            --danger-color: #ef4444;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --ai-color: #a855f7;
            --github-color: #24292e;
        }

        * { box-sizing: border-box; }

        body {
            display: flex;
            min-height: 100vh;
            margin: 0;
            background-color: var(--bg-dark);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: white;
            overflow-x: hidden;
        }

        /* --- LOGIN SCREEN STYLE --- */
        #login-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: #0b091a;
            z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 0.5s;
        }
        .login-box {
            background: #1a1635;
            padding: 40px;
            border-radius: 20px;
            border: 1px solid var(--accent-color);
            text-align: center;
            width: 300px;
            box-shadow: 0 0 50px rgba(124, 92, 219, 0.2);
        }
        .login-title { font-size: 20px; margin-bottom: 20px; color: var(--accent-color); font-weight: bold; letter-spacing: 1px; }
        .login-input {
            width: 100%; padding: 12px; margin-bottom: 15px;
            background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px; color: white; text-align: center; font-size: 16px;
        }
        .login-input:focus { border-color: var(--accent-color); outline: none; }
        .login-btn {
            width: 100%; padding: 12px;
            background: var(--accent-color); color: white; border: none;
            border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 16px;
            transition: 0.3s;
        }
        .login-btn:hover { background: #6a4eb3; transform: translateY(-2px); }
        .login-error { color: var(--danger-color); font-size: 12px; margin-top: 10px; min-height: 1.2em; }
        
        .blur-content { filter: blur(5px); pointer-events: none; }

        /* Sidebar Navigation */
        .sidebar {
            width: var(--sidebar-width);
            background-color: #1a1635;
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            flex-direction: column;
            position: fixed;
            height: 100vh;
            z-index: 100;
        }

        .sidebar-header {
            padding: 25px 20px;
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            position: relative;
        }

        .sidebar-header h2 {
            margin: 0;
            font-size: 18px;
            color: var(--accent-color);
            letter-spacing: 1px;
            margin-bottom: 10px;
        }

        .lang-toggle {
            display: flex;
            justify-content: center;
            gap: 5px;
        }

        .btn-lang {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            color: white;
            padding: 4px 10px;
            border-radius: 5px;
            font-size: 11px;
            cursor: pointer;
            transition: 0.3s;
        }

        .btn-lang.active {
            background: var(--accent-color);
            border-color: var(--accent-color);
        }

        .menu-scroll {
            flex: 1;
            overflow-y: auto;
        }

        .menu-group { padding: 15px 0; border-bottom: 1px solid rgba(255,255,255,0.03); }
        .menu-label { padding: 10px 25px; font-size: 11px; text-transform: uppercase; color: rgba(255, 255, 255, 0.4); letter-spacing: 2px; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }

        .btn-add-cat { cursor: pointer; color: var(--accent-color); font-size: 16px; transition: 0.2s; }
        .btn-add-cat:hover { transform: scale(1.2); }

        .menu-item {
            padding: 12px 25px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 12px;
            color: rgba(255, 255, 255, 0.7);
            border-left: 3px solid transparent;
        }

        .menu-item:hover, .menu-item.active {
            background: rgba(124, 92, 219, 0.1);
            color: white;
            border-left-color: var(--accent-color);
        }

        .menu-item.drag-over-cat {
            background: rgba(78, 234, 246, 0.1);
            border-left-color: var(--warp-blue);
            transform: translateX(5px);
        }

        /* Sidebar Footer (GitHub Controls) */
        .sidebar-footer {
            padding: 15px;
            background: rgba(0,0,0,0.2);
            border-top: 1px solid rgba(255, 255, 255, 0.05);
            margin-top: auto;
            display: flex;
            gap: 10px;
        }
        
        .footer-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 12px;
            transition: 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }
        
        .btn-push { background: var(--success-color); color: #003322; }
        .btn-pull { background: var(--warp-blue); color: #003344; }
        .footer-btn:hover { filter: brightness(1.2); transform: translateY(-2px); }

        /* Main Content Display */
        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            padding: 40px;
            transition: all 0.3s;
        }

        .section-title {
            margin-bottom: 30px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.05);
            padding-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .section-title h1 { margin: 0; font-size: 28px; }

        /* Improved Grid Layout */
        .item-grid {
            display: grid;
            /* Adaptive columns: min 220px, fit as many as possible */
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 25px;
            width: 100%;
        }

        /* Card Elements */
        .item-card {
            background: var(--card-bg);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: transform 0.3s, background 0.3s, opacity 0.3s;
            position: relative;
            cursor: grab;
        }

        .item-card:active { cursor: grabbing; }
        .item-card.dragging { opacity: 0.4; transform: scale(0.95); }

        .item-card:hover {
            transform: translateY(-8px);
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(124, 92, 219, 0.3);
        }

        .svg-display {
            height: 140px;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            margin-bottom: 15px;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            pointer-events: none;
            overflow: hidden;
        }

        .svg-display svg { 
            width: 100% !important; 
            height: 100% !important; 
            max-width: 100%; 
            max-height: 100%;
            object-fit: contain;
        }
        .svg-display.flipped { transform: scaleX(-1); }

        .item-card h3 { 
            margin: 0 0 10px 0; 
            font-size: 16px; 
            color: #eee; 
            text-align: center; 
            pointer-events: none;
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis; 
            width: 100%;
        }

        .btn-row { display: flex; gap: 8px; width: 100%; margin-top: auto; }
        
        .btn-action {
            border: none;
            padding: 8px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            position: relative;
        }

        .btn-copy-main { flex: 1; background: var(--accent-color); color: white; }
        .btn-flip { width: 35px; background: rgba(255,255,255,0.1); color: white; }
        .btn-edit { width: 35px; background: rgba(255,255,255,0.1); color: var(--warning-color); }
        .btn-delete { width: 35px; background: rgba(239, 68, 68, 0.1); color: var(--danger-color); }
        
        .btn-delete:hover { background: var(--danger-color); color: white; }
        .btn-edit:hover { background: #fbbf24; color: #1a1635; }
        .btn-flip:hover { background: rgba(255,255,255,0.2); }

        .btn-restore { background: var(--success-color); color: white; flex: 1; }
        .btn-permanent { background: var(--danger-color); color: white; flex: 1; }
        .btn-warning { background: var(--warning-color); color: white; flex: 1; }
        .btn-ai-gen { background: var(--ai-color); color: white; flex: 2; }
        .btn-cancel-ai { background: rgba(255,255,255,0.1); color: white; flex: 1; min-width: 80px; }
        .btn-github { background: var(--github-color); color: white; }

        /* Form Card Styles (Wider and Cleaner) */
        .form-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            padding: 40px;
            width: 100%;
            max-width: 100%; /* Fill available space */
            margin-bottom: 30px;
        }

        /* Import Section */
        .import-dropzone {
            border: 2px dashed rgba(255,255,255,0.1);
            padding: 80px 40px;
            text-align: center;
            border-radius: 20px;
            cursor: pointer;
            background: rgba(255,255,255,0.01);
            transition: 0.3s;
            margin-bottom: 20px;
        }

        .import-dropzone:hover, .import-dropzone.drag-active {
            border-color: var(--accent-color);
            background: rgba(124, 92, 219, 0.08);
            transform: scale(1.01);
        }

        .preview-container {
            display: flex;
            gap: 20px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .preview-box {
            flex: 1;
            background: rgba(0,0,0,0.2);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            position: relative;
            min-height: 250px;
            min-width: 300px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .preview-box label { display: block; margin-bottom: 10px; color: rgba(255,255,255,0.5); font-size: 12px; }

        .preview-box img, .preview-box svg {
            max-width: 100%;
            max-height: 200px;
            object-fit: contain;
            margin: auto;
        }

        .mode-toggle {
            display: flex;
            background: var(--input-bg);
            border-radius: 10px;
            padding: 5px;
            margin-bottom: 20px;
        }

        .mode-btn {
            flex: 1;
            padding: 12px;
            border-radius: 8px;
            border: none;
            background: transparent;
            color: rgba(255,255,255,0.5);
            cursor: pointer;
            transition: 0.3s;
            font-weight: 600;
        }

        .mode-btn.active {
            background: var(--accent-color);
            color: white;
        }

        .import-controls {
            display: flex;
            gap: 15px;
            margin-top: 25px;
            flex-wrap: wrap;
        }

        .btn-gen { background: var(--warp-blue); color: #003344; flex: 2; min-width: 150px; padding: 15px; }
        .btn-rbg { background: #6366f1; color: white; flex: 1; min-width: 120px; padding: 15px; }
        .btn-cancel-import { background: rgba(255,255,255,0.1); color: white; flex: 1; min-width: 100px; padding: 15px; }

        /* AI SVG Styles */
        .ai-gen-box {
            background: rgba(168, 85, 247, 0.05);
            border: 1px solid rgba(168, 85, 247, 0.2);
            padding: 30px;
            border-radius: 20px;
            margin-bottom: 20px;
        }
        .ai-loading-bar { height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px; margin-top: 20px; overflow: hidden; display: none; }
        .ai-loading-progress { height: 100%; background: var(--ai-color); width: 50%; animation: loadingScan 1.5s infinite ease-in-out; }
        @keyframes loadingScan { 0% { transform: translateX(-100%); } 100% { transform: translateX(200%); } }

        /* Toast & Modals */
        .msg-toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--accent-color);
            padding: 12px 25px;
            border-radius: 10px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.3);
            z-index: 10000;
            opacity: 0;
            pointer-events: none;
            transition: 0.3s;
        }
        .msg-toast.show { opacity: 1; transform: translateY(-10px); }

        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 200; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal-content { background: #1a1635; padding: 30px; border-radius: 20px; width: 450px; border: 1px solid rgba(255,255,255,0.1); box-sizing: border-box; }

        .hidden { display: none; }

        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; color: rgba(255,255,255,0.6); font-size: 14px; }
        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 15px;
            background: var(--input-bg);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 10px;
            color: white;
            font-family: inherit;
            box-sizing: border-box;
            font-size: 16px;
        }

        @media (max-width: 768px) {
            .sidebar { width: 70px; }
            .sidebar-header h2, .menu-label, .menu-item .label-text { display: none; }
            .sidebar-footer { flex-direction: column; }
            .footer-btn { font-size: 10px; padding: 8px 5px; }
            .main-content { margin-left: 70px; padding: 20px; }
            .menu-item { justify-content: center; padding: 15px; font-size: 24px; }
            .item-grid { grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); }
        }
    </style>
</head>
<body>

    <!-- Login Overlay -->
    <div id="login-overlay">
        <div class="login-box">
            <div class="login-title">üîí LOCKED</div>
            <input type="password" id="login-pass" class="login-input" placeholder="Enter Password" onkeypress="handleLoginEnter(event)">
            <button class="login-btn" onclick="checkLogin()">LOGIN</button>
            <div id="login-error" class="login-error"></div>
        </div>
    </div>

    <!-- Main App Container -->
    <div id="app-container" class="blur-content">

        <!-- Modals -->
        <div id="modal-category" class="modal-overlay">
            <div class="modal-content">
                <h3 id="modal-cat-title">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡πÉ‡∏´‡∏°‡πà</h3>
                <div class="form-group">
                    <label id="lbl-cat-name">‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</label>
                    <input type="text" id="cat-name-input" placeholder="...">
                </div>
                <div class="form-group">
                    <label id="lbl-cat-icon">‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô (Emoji)</label>
                    <input type="text" id="cat-icon-input" placeholder="‚öîÔ∏è">
                </div>
                <div class="btn-row">
                    <button class="btn-action btn-copy-main" onclick="saveCategory()" id="btn-save-cat">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                    <button class="btn-action btn-flip" onclick="closeModal('modal-category')" id="btn-cancel-cat">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                </div>
            </div>
        </div>

        <!-- GitHub Config Modal -->
        <div id="modal-github" class="modal-overlay">
            <div class="modal-content">
                <h3>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ GitHub Sync</h3>
                <div style="font-size:12px; color: #fbbf24; margin-bottom:15px;">*Token ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô (Local Storage)</div>
                <div class="form-group">
                    <label>GitHub Username</label>
                    <input type="text" id="gh-user" value="sdekzaaa-source" placeholder="e.g. yourname">
                </div>
                <div class="form-group">
                    <label>Repository Name</label>
                    <input type="text" id="gh-repo" value="magic-items-db" placeholder="e.g. magic-items">
                </div>
                <div class="form-group">
                    <label>Personal Access Token (Repo scope)</label>
                    <input type="password" id="gh-token" value="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" placeholder="ghp_...">
                </div>
                <div class="form-group">
                    <label>Filename (Path)</label>
                    <input type="text" id="gh-path" value="magic-items-db.json">
                </div>
                <div class="btn-row">
                    <button class="btn-action btn-copy-main" onclick="syncToGitHub('push')">üíæ Save Config</button>
                    <button class="btn-action btn-flip" onclick="closeModal('modal-github')">‡∏õ‡∏¥‡∏î</button>
                </div>
            </div>
        </div>

        <div id="modal-restore" class="modal-overlay">
            <div class="modal-content">
                <h3 id="modal-restore-title">‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h3>
                <p style="font-size: 13px; color: rgba(255,255,255,0.6); margin-bottom: 15px;" id="restore-warn">‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏ô‡∏≥‡∏°‡∏≤‡∏£‡∏ß‡∏°‡∏Å‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà (Merge)</p>
                <div class="form-group">
                    <label id="lbl-restore-json">‡∏ß‡∏≤‡∏á‡∏£‡∏´‡∏±‡∏™ Backup JSON</label>
                    <textarea id="restore-input" style="height: 150px; font-family: monospace;" placeholder='{"categories": [...], "items": [...]}'></textarea>
                </div>
                <div class="btn-row">
                    <button class="btn-action btn-warning" onclick="processRestore()" id="btn-do-restore">‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô</button>
                    <button class="btn-action btn-flip" onclick="closeModal('modal-restore')" id="btn-close-restore">‡∏õ‡∏¥‡∏î</button>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h2>ITEM DB</h2>
                <div class="lang-toggle">
                    <button class="btn-lang active" id="lang-th" onclick="setLanguage('th')">TH</button>
                    <button class="btn-lang" id="lang-en" onclick="setLanguage('en')">EN</button>
                </div>
            </div>
            <div class="menu-scroll">
                <div class="menu-group">
                    <div class="menu-label">
                        <span id="label-categories">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</span>
                        <span class="btn-add-cat" onclick="openModal('modal-category')" title="Add Category">‚äï</span>
                    </div>
                    <div id="sidebar-categories"></div>
                </div>

                <div class="menu-group">
                    <div class="menu-label" id="label-manage">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÑ‡∏≠‡πÄ‡∏ó‡∏°</div>
                    <div class="menu-item" onclick="showSection('add-item', this)">
                        <span>‚ûï</span>
                        <span class="label-text" id="menu-add-item">‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏≠‡πÄ‡∏ó‡∏°</span>
                    </div>
                    <div class="menu-item" onclick="showSection('import-image', this)">
                        <span>üñºÔ∏è</span>
                        <span class="label-text" id="menu-import">‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô/‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</span>
                    </div>
                    <div class="menu-item" onclick="showSection('ai-gen', this)">
                        <span>‚ú®</span>
                        <span class="label-text" id="menu-aigen">AI SVG Creator</span>
                    </div>
                    <div class="menu-item" onclick="showSection('trash-bin', this)">
                        <span>üóëÔ∏è</span>
                        <span class="label-text" id="menu-trash">‡∏ñ‡∏±‡∏á‡∏Ç‡∏¢‡∏∞</span>
                    </div>
                </div>

                <div class="menu-group">
                    <div class="menu-label" id="label-backup">‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>
                    <div class="menu-item" onclick="openGithubModal()">
                        <span>‚öôÔ∏è</span>
                        <span class="label-text" id="menu-github">GitHub Config</span>
                    </div>
                    <div class="menu-item" onclick="backupAll()">
                        <span>üíæ</span>
                        <span class="label-text" id="menu-backup">Backup</span>
                    </div>
                    <div class="menu-item" onclick="openModal('modal-restore')">
                        <span>üîÑ</span>
                        <span class="label-text" id="menu-restore">Restore</span>
                    </div>
                </div>
            </div>
            <!-- Sidebar Footer (Buttons) -->
            <div class="sidebar-footer">
                <button class="footer-btn btn-push" onclick="syncToGitHub('push')">
                    üöÄ Push
                </button>
                <button class="footer-btn btn-pull" onclick="syncToGitHub('pull')">
                    üì• Pull
                </button>
            </div>
        </div>

        <!-- Main -->
        <div class="main-content">
            <div id="section-category-view" class="content-section">
                <div class="section-title"><h1 id="view-title">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÑ‡∏≠‡πÄ‡∏ó‡∏°</h1></div>
                <div class="item-grid" id="items-display-grid"></div>
            </div>

            <div id="section-add-item" class="hidden content-section">
                <div class="section-title"><h1 id="title-add-new">‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏≠‡πÄ‡∏ó‡∏°‡πÉ‡∏´‡∏°‡πà</h1></div>
                <div class="form-card">
                    <div class="form-group">
                        <label id="lbl-item-name">‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏≠‡πÄ‡∏ó‡∏°</label>
                        <input type="text" id="new-item-name" placeholder="...">
                    </div>
                    <div class="form-group">
                        <label id="lbl-item-svg">‡πÇ‡∏Ñ‡πâ‡∏î SVG</label>
                        <textarea id="new-item-svg" style="height: 150px; font-family: monospace;" placeholder="<svg>...</svg>"></textarea>
                    </div>
                    <button class="btn-action btn-copy-main" onclick="createNewItem()" id="btn-save-item">‚ú® ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                </div>
            </div>

            <!-- Import Section -->
            <div id="section-import-image" class="hidden content-section">
                <div class="section-title"><h1 id="title-import">‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô/‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</h1></div>
                <div class="form-card">
                    <div class="mode-toggle">
                        <button class="mode-btn active" id="mode-embed" onclick="setImportMode('embed')">Embed (‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏™‡∏µ)</button>
                        <button class="mode-btn" id="mode-trace" onclick="setImportMode('trace')">Trace (Vector)</button>
                    </div>

                    <div class="import-dropzone" id="import-dropzone" onclick="document.getElementById('file-input').click()" 
                         ondragover="handleImportDragOver(event)" ondragleave="handleImportDragLeave(event)" ondrop="handleImportDrop(event)">
                        <p id="dropzone-text">‡∏Ñ‡∏•‡∏¥‡∏Å, ‡∏•‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡∏°‡∏≤‡∏ß‡∏≤‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏î Ctrl+V ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</p>
                        <input type="file" id="file-input" class="hidden" accept="image/*" onchange="handleFileSelect(event)">
                    </div>

                    <div id="import-preview-area" class="hidden">
                        <div class="preview-container">
                            <div class="preview-box">
                                <label id="lbl-orig-preview">‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö</label>
                                <div style="display: flex; align-items: center; justify-content: center; height: 180px;">
                                    <img id="img-preview" src="">
                                </div>
                            </div>
                            <div class="preview-box">
                                <label id="lbl-gen-preview">‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå SVG</label>
                                <div id="svg-preview-cont" style="display: flex; align-items: center; justify-content: center; height: 180px;"></div>
                            </div>
                        </div>

                        <div class="import-controls">
                            <button class="btn-action btn-rbg" onclick="removeBackgroundSimple()" id="btn-remove-bg">‚úÇÔ∏è ‡∏•‡∏ö‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á (‡∏™‡∏µ‡∏Ç‡∏≤‡∏ß)</button>
                            <button class="btn-action btn-gen" onclick="generateSVG()" id="btn-generate">üî® Generate SVG</button>
                            <button class="btn-action btn-cancel-import" onclick="resetImport()" id="btn-cancel-import">‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                        </div>

                        <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1);">
                            <div class="form-group">
                                <label id="lbl-import-name">‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏≠‡πÄ‡∏ó‡∏°</label>
                                <input type="text" id="import-item-name" placeholder="...">
                            </div>
                            <button class="btn-action btn-copy-main" onclick="saveImportedItem()" id="btn-save-imported">‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- AI Gen Section -->
            <div id="section-ai-gen" class="hidden content-section">
                <div class="section-title"><h1 id="title-aigen">AI SVG Creator</h1></div>
                <div class="form-card">
                    <div class="ai-gen-box">
                        <div class="form-group">
                            <label id="lbl-ai-prompt">‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á (Prompt)</label>
                            <textarea id="ai-prompt-input" rows="3" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏î‡∏≤‡∏ö‡∏ß‡∏¥‡πÄ‡∏®‡∏©‡∏™‡∏µ‡∏ü‡πâ‡∏≤‡∏î‡πâ‡∏≤‡∏°‡∏ó‡∏≠‡∏á, ‡∏¢‡∏≤‡∏Ç‡∏ß‡∏î‡∏™‡∏µ‡πÅ‡∏î‡∏á‡∏°‡∏µ‡∏ü‡∏≠‡∏á..."></textarea>
                        </div>
                        <div class="btn-row">
                            <button class="btn-action btn-ai-gen" onclick="generateAiSvg()" id="btn-run-ai">‚ú® ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏π‡∏õ SVG ‡∏î‡πâ‡∏ß‡∏¢ AI</button>
                            <button class="btn-action btn-cancel-ai" onclick="resetAiGen()" id="btn-cancel-ai">‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                        </div>
                        <div id="ai-loading" class="ai-loading-bar">
                            <div class="ai-loading-progress"></div>
                        </div>
                    </div>

                    <div id="ai-result-area" class="hidden">
                        <div class="preview-box" style="margin-bottom: 20px;">
                            <label>AI Result</label>
                            <div id="ai-svg-output" style="display: flex; align-items: center; justify-content: center; height: 200px;"></div>
                        </div>

                        <div class="form-group">
                            <label id="lbl-ai-item-name">‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏≠‡πÄ‡∏ó‡∏°</label>
                            <input type="text" id="ai-item-name" placeholder="...">
                        </div>
                        <button class="btn-action btn-copy-main" onclick="saveAiItem()" id="btn-save-ai">‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á‡∏Ñ‡∏•‡∏±‡∏á</button>
                    </div>
                </div>
            </div>

            <div id="section-trash-bin" class="hidden content-section">
                <div class="section-title"><h1 id="title-trash">‡∏ñ‡∏±‡∏á‡∏Ç‡∏¢‡∏∞</h1></div>
                <div class="item-grid" id="trash-display-grid"></div>
            </div>
        </div>
    </div>

    <div id="toast" class="msg-toast">‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</div>

    <script>
        // --- 1. SECURITY & AUTH ---
        // Password split into 3 parts for basic obfuscation
        const _p1 = "sdek";
        const _p2 = "zasvg";
        const _p3 = "1234";
        
        const SESSION_DURATION = 7 * 24 * 60 * 60 * 1000; // 7 Days in ms

        function checkLogin() {
            const input = document.getElementById('login-pass').value;
            if (!input) return;
            
            const correctPass = _p1 + _p2 + _p3;
            
            if (input === correctPass) {
                localStorage.setItem('auth_token', Date.now().toString());
                hideLogin();
            } else {
                document.getElementById('login-error').innerText = "‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á";
                document.getElementById('login-pass').value = '';
            }
        }

        function handleLoginEnter(e) { if(e.key === 'Enter') checkLogin(); }

        function checkSession() {
            const token = localStorage.getItem('auth_token');
            if (token) {
                const now = Date.now();
                const sessionTime = parseInt(token);
                if (now - sessionTime < SESSION_DURATION) {
                    hideLogin();
                } else {
                    localStorage.removeItem('auth_token');
                    showLogin();
                }
            } else {
                showLogin();
            }
        }

        function showLogin() {
            document.getElementById('login-overlay').style.opacity = '1';
            document.getElementById('login-overlay').style.pointerEvents = 'auto';
            document.getElementById('app-container').classList.add('blur-content');
        }

        function hideLogin() {
            document.getElementById('login-overlay').style.opacity = '0';
            document.getElementById('login-overlay').style.pointerEvents = 'none';
            document.getElementById('app-container').classList.remove('blur-content');
        }

        // --- 2. HELPERS (Declared first) ---
        function normalizeSVG(svgString) {
            if (!svgString) return '';
            try {
                const parser = new DOMParser();
                const doc = parser.parseFromString(svgString, "image/svg+xml");
                const svg = doc.querySelector("svg");
                if (!svg) return svgString;
                if (!svg.hasAttribute("viewBox")) {
                    const w = svg.getAttribute("width") || 100;
                    const h = svg.getAttribute("height") || 100;
                    svg.setAttribute("viewBox", `0 0 ${parseFloat(w)} ${parseFloat(h)}`);
                }
                svg.setAttribute("width", "100%");
                svg.setAttribute("height", "100%");
                svg.setAttribute("preserveAspectRatio", "xMidYMid meet");
                svg.style.width = ""; svg.style.height = ""; svg.style.maxWidth = ""; svg.style.maxHeight = "";
                return new XMLSerializer().serializeToString(svg);
            } catch (e) { return svgString; }
        }

        function minifySVG(svg) {
            if (!svg) return '';
            let clean = svg.replace(/[\r\n\t]+/g, ' ').replace(/\s+/g, ' ');
            clean = clean.replace(/<!--[\s\S]*?-->/g, '');
            clean = clean.replace(/(\d+\.\d{2,})/g, (match) => parseFloat(match).toFixed(1));
            clean = clean.replace(/<\?xml.*?\?>/g, '');
            clean = clean.replace(/<!DOCTYPE.*?>/g, '');
            return clean.trim();
        }

        function copyToClipboard(text) { 
            const el = document.createElement('textarea'); 
            el.value = text; 
            document.body.appendChild(el); 
            el.select(); 
            document.execCommand('copy'); 
            document.body.removeChild(el); 
        }

        function toast(msg) { 
            const t = document.getElementById('toast'); 
            if(t) {
                t.innerText = msg; 
                t.classList.add('show'); 
                setTimeout(() => t.classList.remove('show'), 2000);
            }
        }
        
        function openModal(id) { document.getElementById(id).style.display = 'flex'; }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }

        // --- 3. App State ---
        const _pool = [
            { k1: "AIzaSyCGlXcUwyk5tHZ0cwcn", k2: "-98aw19R2XuiF_Y" },
            { k1: "AIzaSyBmYB-nlMaFNkPxI-BWRQ8k", k2: "n02wbE5ybB8" }
        ];
        let activeKeyIndex = 0;
        let currentLang = 'th';
        
        let categories = [
            { id: 'cat-ai-gen', name: 'AI Gen', icon: '‚ú®' },
            { id: 'cat-import-code', name: 'Import Code', icon: 'üíª' },
            { id: 'cat-import-img', name: 'Import Img', icon: 'üñºÔ∏è' },
            { id: 'cat-restore', name: 'Restore', icon: '‚ôªÔ∏è' },
            { id: 'cat-consumables', name: '‡πÑ‡∏≠‡πÄ‡∏ó‡∏°‡∏Å‡∏î‡πÉ‡∏ä‡πâ', icon: 'üì¶' }, 
            { id: 'cat-treasures', name: '‡∏™‡∏°‡∏ö‡∏±‡∏ï‡∏¥‡∏•‡πâ‡∏≥‡∏Ñ‡πà‡∏≤', icon: 'üíé' }
        ];
        let items = [];
        let trash = [];
        let currentCatId = 'cat-ai-gen';
        let draggedItemId = null;
        let importMode = 'embed';
        let currentGeneratedSvg = '';
        let originalImgData = '';
        let currentAiSvg = '';

        const translations = {
            th: {
                categories: "‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà", manage: "‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÑ‡∏≠‡πÄ‡∏ó‡∏°", addItem: "‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏≠‡πÄ‡∏ó‡∏°", trash: "‡∏ñ‡∏±‡∏á‡∏Ç‡∏¢‡∏∞", backup: "Backup",
                viewTitle: "‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÑ‡∏≠‡πÄ‡∏ó‡∏°", noItems: "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏≠‡πÄ‡∏ó‡∏°", trashEmpty: "‡∏ñ‡∏±‡∏á‡∏Ç‡∏¢‡∏∞‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤", addTitle: "‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏≠‡πÄ‡∏ó‡∏°‡πÉ‡∏´‡∏°‡πà",
                restoreTitle: "‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•", save: "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å", cancel: "‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å", close: "‡∏õ‡∏¥‡∏î", lblItemName: "‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏≠‡πÄ‡∏ó‡∏°",
                lblItemSvg: "‡πÇ‡∏Ñ‡πâ‡∏î SVG", lblCatName: "‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà", lblCatIcon: "‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô (Emoji)", copy: "‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å", restore: "‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô",
                delForever: "‡∏•‡∏ö‡∏ñ‡∏≤‡∏ß‡∏£", toastSuccess: "‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!", toastCopy: "‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å SVG ‡πÅ‡∏•‡πâ‡∏ß!", toastBackup: "Backup ‡πÅ‡∏•‡πâ‡∏ß!",
                toastRestore: "‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!", toastItemAdded: "‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏≠‡πÄ‡∏ó‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!", toastCatAdded: "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß!",
                moveSuccess: "‡∏¢‡πâ‡∏≤‡∏¢‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß!", import: "‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô/‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û", dropzone: "‡∏Ñ‡∏•‡∏¥‡∏Å, ‡∏•‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡∏°‡∏≤‡∏ß‡∏≤‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏î Ctrl+V ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà",
                lblImportName: "‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏≠‡πÄ‡∏ó‡∏°", btnGen: "üî® Generate SVG", btnRbg: "‚úÇÔ∏è ‡∏•‡∏ö‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á (‡∏™‡∏µ‡∏Ç‡∏≤‡∏ß)",
                lblOrig: "‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö", lblGen: "‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå SVG", toastGenerating: "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...", toastRbgSuccess: "‡∏•‡∏ö‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!",
                menuAiGen: "AI SVG Creator", titleAiGen: "AI SVG Creator", lblAiPrompt: "‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á (Prompt)", btnRunAi: "‚ú® ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏π‡∏õ SVG ‡∏î‡πâ‡∏ß‡∏¢ AI",
                toastAiGenStart: "AI ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏≤‡∏î‡∏£‡∏π‡∏õ‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì...", toastAiGenSuccess: "AI ‡∏ß‡∏≤‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß!", backupBtn: "Backup (‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)",
                restoreBtn: "Restore ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•", btnCancelAi: "‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å", fallbackTrace: "ImageTracer ‡πÑ‡∏°‡πà‡πÇ‡∏´‡∏•‡∏î ‡πÉ‡∏ä‡πâ‡πÇ‡∏´‡∏°‡∏î Pixel Art ‡πÅ‡∏ó‡∏ô",
                btnEdit: "‚úèÔ∏è", toastNameUpdated: "‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢", menuGithub: "GitHub Config",
                toastPushSuccess: "üöÄ Push ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏π‡∏Å‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡πâ‡∏ß", toastPullSuccess: "üì• Pull ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏π‡∏Å‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÅ‡∏•‡πâ‡∏ß"
            },
            en: {
                categories: "Categories", manage: "Manager", addItem: "Add Item", trash: "Trash", backup: "Backup",
                viewTitle: "Item List", noItems: "No items", trashEmpty: "Empty", addTitle: "Add Item",
                restoreTitle: "Restore", save: "Save", cancel: "Cancel", close: "Close", lblItemName: "Name",
                lblItemSvg: "SVG Code", lblCatName: "Name", lblCatIcon: "Icon", copy: "Copy", restore: "Restore",
                delForever: "Delete Forever", toastSuccess: "Success!", toastCopy: "SVG Copied!", toastBackup: "Backed up!",
                toastRestore: "Restored!", toastItemAdded: "Added!", toastCatAdded: "Category added!",
                moveSuccess: "Moved!", import: "Import Image", dropzone: "Click, Drop or Paste image",
                lblImportName: "Name", btnGen: "üî® Generate SVG", btnRbg: "‚úÇÔ∏è Remove BG (Simple)",
                lblOrig: "Original", lblGen: "Generated SVG", toastGenerating: "Processing...", toastRbgSuccess: "Background removed!",
                menuAiGen: "AI SVG Creator", titleAiGen: "AI SVG Creator", lblAiPrompt: "Prompt", btnRunAi: "‚ú® Generate SVG with AI",
                toastAiGenStart: "AI is drawing...", toastAiGenSuccess: "AI Finished!", backupBtn: "Backup All (Copy)",
                restoreBtn: "Restore System", btnCancelAi: "‚ùå Cancel", fallbackTrace: "ImageTracer failed. Using Pixel Mode.",
                btnEdit: "‚úèÔ∏è", toastNameUpdated: "Name updated", menuGithub: "GitHub Config",
                toastPushSuccess: "üöÄ Push Success!", toastPullSuccess: "üì• Pull Success!"
            }
        };

        // --- 4. Logic Functions (Declared before init) ---
        function handleFileSelect(e) { if (e.target.files[0]) handleImageFile(e.target.files[0]); }
        
        function handleImageFile(file) {
            const reader = new FileReader();
            reader.onload = (re) => {
                originalImgData = re.target.result;
                document.getElementById('img-preview').src = originalImgData;
                document.getElementById('import-preview-area').classList.remove('hidden');
                document.getElementById('svg-preview-cont').innerHTML = '';
                currentGeneratedSvg = '';
            };
            reader.readAsDataURL(file);
        }

        function setupPasteListener() {
            window.addEventListener('paste', (e) => {
                if (document.getElementById('section-import-image').classList.contains('hidden')) return;
                const clipItems = (e.clipboardData || e.originalEvent.clipboardData).items;
                for (let i of clipItems) if (i.type.indexOf('image') !== -1) { handleImageFile(i.getAsFile()); break; }
            });
        }
        
        function handleImportDragOver(e) { e.preventDefault(); document.getElementById('import-dropzone').classList.add('drag-active'); }
        function handleImportDragLeave(e) { e.preventDefault(); document.getElementById('import-dropzone').classList.remove('drag-active'); }
        function handleImportDrop(e) {
            e.preventDefault(); document.getElementById('import-dropzone').classList.remove('drag-active');
            if (e.dataTransfer.files[0]) handleImageFile(e.dataTransfer.files[0]);
        }

        function createNewItem() {
            const name = document.getElementById('new-item-name').value;
            const svg = document.getElementById('new-item-svg').value;
            if(!name || !svg) return;
            const normalizedSVG = normalizeSVG(svg);
            items.unshift({ id: 'item-' + Date.now(), catId: 'cat-import-code', name, svg: normalizedSVG });
            saveToLocal();
            document.getElementById('new-item-name').value = '';
            document.getElementById('new-item-svg').value = '';
            toast(translations[currentLang].toastItemAdded);
            init();
        }

        function saveImportedItem() {
            const name = document.getElementById('import-item-name').value;
            if (!name || !currentGeneratedSvg) return;
            items.unshift({ id: 'item-' + Date.now(), catId: 'cat-import-img', name, svg: currentGeneratedSvg });
            saveToLocal();
            toast(translations[currentLang].toastItemAdded);
            resetImport();
            init();
        }

        function saveAiItem() {
            const name = document.getElementById('ai-item-name').value || "AI Item";
            if(!currentAiSvg) return;
            items.unshift({ id: 'item-' + Date.now(), catId: 'cat-ai-gen', name, svg: currentAiSvg });
            saveToLocal();
            toast(translations[currentLang].toastItemAdded);
            resetAiGen();
            init();
        }

        function editItemName(id) {
            const item = items.find(i => i.id === id);
            if (item) {
                const newName = prompt("Edit Name:", item.name);
                if (newName) {
                    item.name = newName;
                    saveToLocal();
                    renderItems();
                    toast(translations[currentLang].toastNameUpdated);
                }
            }
        }

        function moveToTrash(id) { 
            const idx = items.findIndex(i => i.id === id);
            if (idx !== -1) {
                trash.push(items.splice(idx, 1)[0]); 
                saveToLocal();
                renderItems(); 
                toast(translations[currentLang].toastMovedTrash); 
            }
        }

        function restoreFromTrash(id) { 
            const idx = trash.findIndex(i => i.id === id);
            if (idx !== -1) {
                const item = trash.splice(idx, 1)[0];
                item.catId = 'cat-restore';
                items.push(item); 
                saveToLocal();
                renderTrash(); 
                toast(translations[currentLang].toastRestore); 
            }
        }

        function permanentDelete(id) { 
            if(confirm("Delete Forever?")) {
                const idx = trash.findIndex(i => i.id === id);
                if (idx !== -1) {
                    trash.splice(idx, 1); 
                    saveToLocal();
                    renderTrash(); 
                    toast(translations[currentLang].toastSuccess); 
                }
            }
        }

        function saveCategory() {
            const name = document.getElementById('cat-name-input').value;
            const icon = document.getElementById('cat-icon-input').value || 'üìÅ';
            if(!name) return;
            categories.push({ id: 'cat-' + Date.now(), name, icon });
            saveToLocal();
            document.getElementById('cat-name-input').value = '';
            closeModal('modal-category');
            toast(translations[currentLang].toastCatAdded);
            renderSidebar();
        }

        function processRestore() {
            try {
                const data = JSON.parse(document.getElementById('restore-input').value);
                if(data.items) {
                    let count = 0;
                    if(data.categories) {
                        data.categories.forEach(c => {
                            if(!categories.find(ex => ex.id === c.id)) categories.push(c);
                        });
                    }
                    const existingIds = new Set(items.map(i => i.id));
                    data.items.forEach(item => {
                        if (!existingIds.has(item.id)) {
                            if(!item.catId) item.catId = 'cat-restore';
                            item.svg = normalizeSVG(item.svg);
                            items.push(item);
                            count++;
                        }
                    });
                    saveToLocal();
                    renderSidebar();
                    renderItems();
                    closeModal('modal-restore');
                    toast(translations[currentLang].toastRestore + ` (+${count})`);
                }
            } catch (e) { toast("Error Restore"); }
        }

        function resetAiGen() {
            document.getElementById('ai-prompt-input').value = '';
            document.getElementById('ai-result-area').classList.add('hidden');
            document.getElementById('ai-svg-output').innerHTML = '';
            document.getElementById('ai-loading').style.display = 'none';
            currentAiSvg = '';
        }

        function removeBackgroundSimple() {
            const img = document.getElementById('img-preview');
            if(!img.src) return;
            const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d');
            canvas.width = img.naturalWidth; canvas.height = img.naturalHeight;
            ctx.drawImage(img, 0, 0);
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            for (let i = 0; i < imageData.data.length; i += 4) { if (imageData.data[i] > 230 && imageData.data[i+1] > 230 && imageData.data[i+2] > 230) imageData.data[i+3] = 0; }
            ctx.putImageData(imageData, 0, 0); originalImgData = canvas.toDataURL(); img.src = originalImgData;
            toast(translations[currentLang].toastRbgSuccess);
        }

        function pixelArtTrace(imgSrc) {
            const img = new Image(); img.src = imgSrc;
            img.onload = () => {
                const w = 64; const h = 64; const canvas = document.createElement('canvas'); canvas.width = w; canvas.height = h;
                const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, w, h);
                const data = ctx.getImageData(0,0,w,h).data;
                let svg = `<svg width="200" height="200" viewBox="0 0 ${w} ${h}" xmlns="http://www.w3.org/2000/svg">`;
                for(let y=0; y<h; y++) { for(let x=0; x<w; x++) { const i = (y*w + x) * 4; const a = data[i+3]; if(a > 128) { const hex = "#" + ((1 << 24) + (data[i] << 16) + (data[i+1] << 8) + data[i+2]).toString(16).slice(1); svg += `<rect x="${x}" y="${y}" width="1" height="1" fill="${hex}" />`; } } }
                svg += `</svg>`;
                currentGeneratedSvg = minifySVG(svg);
                document.getElementById('svg-preview-cont').innerHTML = currentGeneratedSvg;
                toast(translations[currentLang].toastSuccess);
            };
        }

        function generateSVG() {
            toast("Generating...");
            if (importMode === 'embed') {
                currentGeneratedSvg = normalizeSVG(`<svg width="200" height="200"><image href="${originalImgData}" width="100%" height="100%" /></svg>`);
                document.getElementById('svg-preview-cont').innerHTML = currentGeneratedSvg;
            } else {
                if (typeof ImageTracer !== 'undefined') {
                    const options = { ltres:1, qtres:1, scale:1, strokewidth:0, viewbox:true };
                    try {
                        ImageTracer.imageToSVG(originalImgData, function(svgstr) {
                            currentGeneratedSvg = minifySVG(svgstr);
                            document.getElementById('svg-preview-cont').innerHTML = currentGeneratedSvg;
                            toast(translations[currentLang].toastSuccess);
                        }, options);
                    } catch(e) {
                        console.warn("Trace failed, using fallback");
                        pixelArtTrace(originalImgData);
                    }
                } else {
                    toast(translations[currentLang].fallbackTrace);
                    pixelArtTrace(originalImgData);
                }
            }
        }

        function handleDragStart(e, id) { draggedItemId = id; e.target.classList.add('dragging'); }
        function handleDragEnd(e) { e.target.classList.remove('dragging'); draggedItemId = null; }
        function handleDragOverCat(e) { e.preventDefault(); e.currentTarget.classList.add('drag-over-cat'); }
        function handleDragLeaveCat(e) { e.currentTarget.classList.remove('drag-over-cat'); }
        function handleDropCat(e, catId) {
            e.preventDefault(); e.currentTarget.classList.remove('drag-over-cat');
            if (draggedItemId) {
                const item = items.find(i => i.id === draggedItemId);
                if (item && item.catId !== catId) { item.catId = catId; saveToLocal(); renderItems(); renderSidebar(); toast(translations[currentLang].moveSuccess); }
            }
        }

        // --- GitHub Sync Logic ---
        function openGithubModal() {
            const config = localStorage.getItem('gh_config');
            if (config) {
                const c = JSON.parse(config);
                document.getElementById('gh-user').value = c.user;
                document.getElementById('gh-repo').value = c.repo;
                document.getElementById('gh-token').value = c.token;
                if(c.path) document.getElementById('gh-path').value = c.path;
            }
            openModal('modal-github');
        }

        async function syncToGitHub(action) {
            const user = document.getElementById('gh-user').value;
            const repo = document.getElementById('gh-repo').value;
            const token = document.getElementById('gh-token').value;
            const path = document.getElementById('gh-path').value || 'magic-items-db.json';

            if(!user || !repo || !token) { 
                // If fields are empty, try loading from local storage first (for Quick Push/Pull)
                const storedConfig = localStorage.getItem('gh_config');
                if (storedConfig) {
                    const c = JSON.parse(storedConfig);
                    return executeGitHubSync(c.user, c.repo, c.token, c.path, action);
                }
                openGithubModal(); 
                return; 
            }

            // Save config if fields are populated
            localStorage.setItem('gh_config', JSON.stringify({ user, repo, token, path }));
            closeModal('modal-github');
            executeGitHubSync(user, repo, token, path, action);
        }

        async function executeGitHubSync(user, repo, token, path, action) {
            toast("Connecting to GitHub...");

            const apiUrl = `https://api.github.com/repos/${user}/${repo}/contents/${path}`;

            try {
                // 1. Get current file data (SHA and Content)
                let sha = null;
                let remoteContent = null;
                
                const getRes = await fetch(apiUrl, {
                    headers: { 'Authorization': `token ${token}` }
                });

                if (getRes.status === 401) {
                    alert("Token ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (401)"); return;
                }

                if (getRes.ok) {
                    const fileData = await getRes.json();
                    sha = fileData.sha;
                    remoteContent = fileData.content; // Base64
                }

                // --- ACTION: PULL ---
                if (action === 'pull') {
                    if (!remoteContent) { toast("‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏ö‡∏ô GitHub"); return; }
                    
                    // Decode Base64
                    const jsonStr = decodeURIComponent(escape(atob(remoteContent)));
                    const data = JSON.parse(jsonStr);

                    // Merge Logic
                    if(data.categories) {
                        data.categories.forEach(c => {
                             if(!categories.find(ex => ex.id === c.id)) categories.push(c);
                        });
                    }
                    if(data.items) {
                        const existingIds = new Set(items.map(i => i.id));
                        data.items.forEach(item => {
                            if (!existingIds.has(item.id)) {
                                items.push(item);
                            }
                        });
                    }

                    saveToLocal();
                    renderSidebar();
                    renderItems();
                    toast(translations[currentLang].toastPullSuccess);
                    return;
                }

                // --- ACTION: PUSH ---
                const content = JSON.stringify({ categories, items: [...items, ...trash] }, null, 2);
                const contentBase64 = btoa(unescape(encodeURIComponent(content)));

                const putBody = {
                    message: "Update db from Magic Item Manager",
                    content: contentBase64
                };
                if (sha) putBody.sha = sha;

                const putRes = await fetch(apiUrl, {
                    method: 'PUT',
                    headers: { 
                        'Authorization': `token ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(putBody)
                });

                if (putRes.ok) {
                    toast(translations[currentLang].toastPushSuccess);
                } else {
                    const err = await putRes.json();
                    alert("Upload Failed: " + err.message);
                }
            } catch (e) {
                console.error(e);
                toast("Connection Error");
            }
        }

        function backupAll() { copyToClipboard(JSON.stringify({ categories, items })); toast(translations[currentLang].toastBackup); }
        
        async function fetchWithRetry(url, options, maxRetries = 5) {
            let lastRes;
            for (let i = 0; i < maxRetries; i++) {
                try {
                    lastRes = await fetch(url, options);
                    if (lastRes.ok || [429, 403, 400].includes(lastRes.status)) return lastRes;
                    await new Promise(r => setTimeout(r, Math.pow(2, i) * 1000));
                } catch (e) { if (i === maxRetries - 1) throw e; await new Promise(r => setTimeout(r, Math.pow(2, i) * 1000)); }
            }
            return lastRes;
        }

        async function generateAiSvg(isRetry = false) {
            const prompt = document.getElementById('ai-prompt-input').value;
            if(!prompt) { toast("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á"); return; }

            const loader = document.getElementById('ai-loading');
            loader.style.display = 'block';
            if(!isRetry) toast(translations[currentLang].toastAiGenStart);

            const currentKey = _pool[activeKeyIndex].k1 + _pool[activeKeyIndex].k2;
            const systemPrompt = "You are an expert SVG artist. Create a clean, flat-style, game icon SVG code based on the user's prompt. Return ONLY the raw <svg> code. Minimize the code size: use integer coordinates where possible, remove comments, and use short hex codes. Do not use markdown blocks.";
            
            const payload = {
                contents: [{ parts: [{ text: systemPrompt + "\nUser Prompt: " + prompt }] }]
            };

            try {
                let response = await fetchWithRetry(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${currentKey}`, {
                    method: 'POST',
                    body: JSON.stringify(payload),
                    headers: { 'Content-Type': 'application/json' }
                });

                if (response.status === 429 || response.status === 403) {
                    if (activeKeyIndex < _pool.length - 1) {
                        activeKeyIndex++;
                        return generateAiSvg(true);
                    } else throw new Error("API Quota Exceeded");
                }

                let result = await response.json();
                let text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                
                if(text) {
                    text = text.replace(/```xml/g, '').replace(/```svg/g, '').replace(/```/g, '');
                    const start = text.indexOf('<svg');
                    const end = text.lastIndexOf('</svg>') + 6;
                    if(start !== -1 && end !== -1) {
                        currentAiSvg = text.substring(start, end);
                        currentAiSvg = minifySVG(currentAiSvg);
                        document.getElementById('ai-svg-output').innerHTML = currentAiSvg;
                        document.getElementById('ai-result-area').classList.remove('hidden');
                        toast(translations[currentLang].toastAiGenSuccess);
                    } else throw new Error("AI output invalid SVG");
                } else throw new Error("No output from AI");

            } catch(e) {
                console.error(e);
                toast("AI Error: " + e.message);
            } finally {
                loader.style.display = 'none';
            }
        }
        
        function flipItem(id) { const el = document.getElementById(`svg-cont-${id}`); if (el) el.classList.toggle('flipped'); }
        function copySVG(id) { const el = document.getElementById(`svg-cont-${id}`); if (el) { copyToClipboard(el.innerHTML.trim()); toast(translations[currentLang].toastCopy); } }
        function setImportMode(mode) { importMode = mode; document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active')); document.getElementById(`mode-${mode}`).classList.add('active'); }

        function applyLanguage() {
            const t = translations[currentLang];
            const ids = {
                'label-categories': t.categories, 'label-manage': t.manage, 'menu-add-item': t.addItem,
                'menu-import': t.import, 'menu-trash': t.trash, 'label-backup': t.backup,
                'menu-backup': t.backup, 'menu-restore': t.restore, 'title-add-new': t.addTitle,
                'title-import': t.import, 'title-trash': t.trash, 'lbl-item-name': t.lblItemName,
                'lbl-item-svg': t.lblItemSvg, 'btn-save-item': "‚ú® " + t.save,
                'modal-cat-title': t.categories, 'lbl-cat-name': t.lblCatName, 'lbl-cat-icon': t.lblCatIcon,
                'btn-save-cat': t.save, 'btn-cancel-cat': t.cancel, 'modal-restore-title': t.restoreTitle,
                'restore-warn': t.restoreWarn, 'lbl-restore-json': t.lblRestoreJson, 'btn-do-restore': t.restore,
                'btn-close-restore': t.close, 'dropzone-text': t.dropzone, 'lbl-import-name': t.lblItemName,
                'btn-generate': t.btnGen, 'btn-remove-bg': t.btnRbg, 'btn-save-imported': "‚úÖ " + t.save,
                'menu-aigen': t.menuAiGen, 'title-aigen': t.titleAiGen, 'lbl-ai-prompt': t.lblAiPrompt,
                'btn-run-ai': t.btnRunAi, 'lbl-ai-item-name': t.lblItemName, 'btn-save-ai': "‚úÖ " + t.save, 'btn-cancel-ai': t.cancel,
                'menu-github': t.menuGithub
            };
            for (let id in ids) if (document.getElementById(id)) document.getElementById(id).innerText = ids[id];
        }

        function setLanguage(lang) {
            currentLang = lang;
            document.querySelectorAll('.btn-lang').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`lang-${lang}`).classList.add('active');
            applyLanguage();
            renderSidebar();
            renderItems();
        }

        function renderSidebar() {
            const container = document.getElementById('sidebar-categories');
            container.innerHTML = categories.map(cat => `
                <div class="menu-item ${cat.id === currentCatId ? 'active' : ''}" 
                     onclick="selectCategory('${cat.id}', this)"
                     ondragover="handleDragOverCat(event)" ondragleave="handleDragLeaveCat(event)" ondrop="handleDropCat(event, '${cat.id}')">
                    <span>${cat.icon}</span><span class="label-text">${cat.name}</span>
                </div>
            `).join('');
        }

        function selectCategory(id, el) {
            currentCatId = id; showSection('category-view', el);
            const cat = categories.find(c => c.id === id);
            document.getElementById('view-title').innerText = cat ? `${cat.icon} ${cat.name}` : translations[currentLang].viewTitle;
            renderItems();
        }

        function showSection(name, menuItem) {
            document.querySelectorAll('.content-section').forEach(s => s.classList.add('hidden'));
            document.getElementById(`section-${name}`).classList.remove('hidden');
            if (menuItem) {
                document.querySelectorAll('.menu-item').forEach(i => i.classList.remove('active'));
                menuItem.classList.add('active');
            }
            if(name === 'trash-bin') renderTrash();
        }

        function renderItems() {
            const grid = document.getElementById('items-display-grid');
            const filtered = items.filter(i => i.catId === currentCatId);
            const t = translations[currentLang];
            if (filtered.length === 0) { grid.innerHTML = `<div style="grid-column: 1/-1; text-align: center; opacity: 0.3; padding: 40px;">${t.noItems}</div>`; return; }
            grid.innerHTML = filtered.map(item => `
                <div class="item-card" draggable="true" ondragstart="handleDragStart(event, '${item.id}')" ondragend="handleDragEnd(event)">
                    <h3>${item.name}</h3><div class="svg-display" id="svg-cont-${item.id}">${item.svg}</div>
                    <div class="btn-row">
                        <button class="btn-action btn-copy-main" onclick="copySVG('${item.id}')">${t.copy}</button>
                        <button class="btn-action btn-flip" onclick="flipItem('${item.id}')">‚ÜîÔ∏è</button>
                        <button class="btn-action btn-edit" onclick="editItemName('${item.id}')" title="${t.btnEdit}">‚úèÔ∏è</button>
                        <button class="btn-action btn-delete" onclick="moveToTrash('${item.id}')">üóëÔ∏è</button>
                    </div>
                </div>
            `).join('');
        }

        function renderTrash() {
            const grid = document.getElementById('trash-display-grid');
            const t = translations[currentLang];
            if (trash.length === 0) { grid.innerHTML = `<div style="grid-column: 1/-1; text-align: center; opacity: 0.3; padding: 40px;">${t.trashEmpty}</div>`; return; }
            grid.innerHTML = trash.map(item => `
                <div class="item-card">
                    <h3>${item.name}</h3><div class="svg-display">${item.svg}</div>
                    <div class="btn-row">
                        <button class="btn-action btn-restore" onclick="restoreFromTrash('${item.id}')">${t.restore}</button>
                        <button class="btn-action btn-permanent" onclick="permanentDelete('${item.id}')">${t.delForever}</button>
                    </div>
                </div>
            `).join('');
        }

        function saveToLocal() {
            localStorage.setItem('magic_items_local', JSON.stringify({ categories, items, trash }));
        }

        function init() {
            // Check Auth First
            checkSession();

            // Load Local Data
            const stored = localStorage.getItem('magic_items_local');
            if (stored) {
                try {
                    const data = JSON.parse(stored);
                    if (data.categories) categories = data.categories;
                    if (data.items) items = data.items;
                    if (data.trash) trash = data.trash;
                } catch(e) { console.error("Load error", e); }
            }

            applyLanguage();
            renderSidebar();
            renderItems();
            setupPasteListener();
        }

        window.onload = init;
    </script>
</body>
</html>
