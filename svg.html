<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Magic Item Manager - Cloud Edition</title>
    
    <!-- Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/imagetracerjs@1.2.6/imagetracer.min.js"></script>
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, query, onSnapshot, deleteDoc, updateDoc, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ==========================================
        //  ‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ FIREBASE (Configured)
        // ==========================================
        
        let firebaseConfig;

        try {
            // ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡πÉ‡∏ä‡πâ Config ‡∏Ç‡∏≠‡∏á Environment (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Preview ‡πÉ‡∏ô Canvas)
            if (typeof __firebase_config !== 'undefined') {
                firebaseConfig = JSON.parse(__firebase_config);
            } else {
                throw new Error("No env config");
            }
        } catch (e) {
            // ‡πÉ‡∏ä‡πâ Config ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö GitHub Pages / Local)
            firebaseConfig = {
                apiKey: "AIzaSyAbWzr8o_OhkjGbEetBYq_nzYmVZ2fTf40",
                authDomain: "rocogh-88a38.firebaseapp.com",
                projectId: "rocogh-88a38",
                storageBucket: "rocogh-88a38.firebasestorage.app",
                messagingSenderId: "1025971309206",
                appId: "1:1025971309206:web:d4f9e0ab6bb016dde590b7",
                measurementId: "G-04JN1ERQ4T"
            };
        }

        const appId = 'magic-item-manager'; // ‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô Database
        
        // Initialize Firebase
        let app, auth, db;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            // Export to global for generic functions
            window.fb = { db, auth, appId, collection, doc, setDoc, getDoc, query, onSnapshot, deleteDoc, updateDoc, addDoc, signInAnonymously, onAuthStateChanged };
        } catch (err) {
            console.error("Firebase Init Error:", err);
            alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Firebase ‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ firebaseConfig");
        }
    </script>

    <style>
        :root {
            --sidebar-width: 260px;
            --bg-dark: #121026;
            --card-bg: rgba(255, 255, 255, 0.05);
            --accent-color: #7c5cdb;
            --warp-blue: #4eeaf6;
            --input-bg: rgba(255, 255, 255, 0.08);
            --danger-color: #ef4444;
            --success-color: #10b981;
            --warning-color: #fbbf24;
            --ai-color: #a855f7;
        }

        body {
            display: flex;
            min-height: 100vh;
            margin: 0;
            background-color: var(--bg-dark);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: white;
            overflow-x: hidden;
        }

        /* Sidebar Navigation */
        .sidebar {
            width: var(--sidebar-width);
            background-color: #1a1635;
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            flex-direction: column;
            position: fixed;
            height: 100vh;
            z-index: 100;
        }

        .sidebar-header {
            padding: 25px 20px;
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .sidebar-header h2 {
            margin: 0;
            font-size: 18px;
            color: var(--accent-color);
            letter-spacing: 1px;
            margin-bottom: 10px;
        }

        .user-info {
            font-size: 10px;
            opacity: 0.5;
            word-break: break-all;
            padding: 0 10px;
            margin-bottom: 10px;
        }

        .lang-toggle {
            display: flex;
            justify-content: center;
            gap: 5px;
        }

        .btn-lang {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            color: white;
            padding: 4px 10px;
            border-radius: 5px;
            font-size: 11px;
            cursor: pointer;
            transition: 0.3s;
        }

        .btn-lang.active {
            background: var(--accent-color);
            border-color: var(--accent-color);
        }

        .menu-scroll {
            flex: 1;
            overflow-y: auto;
        }

        .menu-group { padding: 15px 0; border-bottom: 1px solid rgba(255,255,255,0.03); }
        .menu-label { padding: 10px 25px; font-size: 11px; text-transform: uppercase; color: rgba(255, 255, 255, 0.4); letter-spacing: 2px; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }

        .btn-add-cat { cursor: pointer; color: var(--accent-color); font-size: 16px; transition: 0.2s; }
        .btn-add-cat:hover { transform: scale(1.2); }

        .menu-item {
            padding: 12px 25px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 12px;
            color: rgba(255, 255, 255, 0.7);
            border-left: 3px solid transparent;
        }

        .menu-item:hover, .menu-item.active {
            background: rgba(124, 92, 219, 0.1);
            color: white;
            border-left-color: var(--accent-color);
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            padding: 40px;
            transition: all 0.3s;
        }

        .section-title {
            margin-bottom: 30px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.05);
            padding-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .section-title h1 { margin: 0; font-size: 28px; }

        .item-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 25px;
        }

        /* Card Elements */
        .item-card {
            background: var(--card-bg);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 25px;
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: transform 0.3s, background 0.3s, opacity 0.3s;
            position: relative;
        }

        .item-card:hover {
            transform: translateY(-8px);
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(124, 92, 219, 0.3);
        }

        .svg-display {
            height: 150px;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            margin-bottom: 20px;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            pointer-events: none;
            overflow: hidden;
        }

        .svg-display svg { 
            width: 100% !important; 
            height: 100% !important; 
            max-width: 100%; 
            max-height: 100%;
            object-fit: contain;
        }
        .svg-display.flipped { transform: scaleX(-1); }

        .item-card h3 { 
            margin: 0 0 15px 0; font-size: 17px; color: #eee; text-align: center; 
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis; width: 100%;
        }

        .btn-row { display: flex; gap: 8px; width: 100%; margin-top: 5px; }
        
        .btn-action {
            border: none; padding: 10px; border-radius: 10px; cursor: pointer;
            font-size: 14px; font-weight: 600; transition: 0.2s;
            display: flex; align-items: center; justify-content: center; gap: 5px;
        }

        .btn-copy-main { flex: 1; background: var(--accent-color); color: white; }
        .btn-flip { width: 40px; background: rgba(255,255,255,0.1); color: white; }
        .btn-edit { width: 40px; background: rgba(255,255,255,0.1); color: var(--warning-color); }
        .btn-delete { width: 40px; background: rgba(239, 68, 68, 0.1); color: var(--danger-color); }
        .btn-delete:hover { background: var(--danger-color); color: white; }
        
        .btn-restore-action { background: var(--success-color); color: white; flex: 1; }
        .btn-permanent { background: var(--danger-color); color: white; flex: 1; }
        .btn-ai-gen { background: var(--ai-color); color: white; flex: 2; }
        .btn-cancel-ai { background: rgba(255,255,255,0.1); color: white; flex: 1; min-width: 80px; }

        /* Import Section */
        .import-dropzone {
            border: 2px dashed rgba(255,255,255,0.1);
            padding: 60px 40px;
            text-align: center;
            border-radius: 20px;
            cursor: pointer;
            background: rgba(255,255,255,0.02);
            transition: 0.3s;
            margin-bottom: 20px;
        }

        .import-dropzone:hover {
            border-color: var(--accent-color);
            background: rgba(124, 92, 219, 0.08);
        }

        .preview-container { display: flex; gap: 20px; margin-top: 20px; }
        .preview-box {
            flex: 1; background: rgba(0,0,0,0.2); border-radius: 15px;
            padding: 15px; text-align: center; position: relative; min-height: 200px;
        }
        .preview-box img, .preview-box svg { max-width: 100%; max-height: 180px; margin-top: 10px; object-fit: contain; }

        .mode-toggle { display: flex; background: var(--input-bg); border-radius: 10px; padding: 5px; margin-bottom: 20px; }
        .mode-btn {
            flex: 1; padding: 10px; border-radius: 8px; border: none; background: transparent;
            color: rgba(255,255,255,0.5); cursor: pointer; transition: 0.3s; font-weight: 600;
        }
        .mode-btn.active { background: var(--accent-color); color: white; }

        .import-controls { display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap; }
        .btn-gen { background: var(--warp-blue); color: #003344; flex: 2; min-width: 150px; }
        .btn-rbg { background: #6366f1; color: white; flex: 1; min-width: 120px; }
        .btn-cancel-import { background: rgba(255,255,255,0.1); color: white; flex: 1; min-width: 100px; }

        /* AI SVG Styles */
        .ai-gen-box { background: rgba(168, 85, 247, 0.05); border: 1px solid rgba(168, 85, 247, 0.2); padding: 20px; border-radius: 15px; margin-bottom: 20px; }
        .ai-loading-bar { height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px; margin-top: 15px; overflow: hidden; display: none; }
        .ai-loading-progress { height: 100%; background: var(--ai-color); width: 50%; animation: loadingScan 1.5s infinite ease-in-out; }
        @keyframes loadingScan { 0% { transform: translateX(-100%); } 100% { transform: translateX(200%); } }

        .msg-toast {
            position: fixed; bottom: 20px; right: 20px; background: var(--accent-color);
            padding: 12px 25px; border-radius: 10px; box-shadow: 0 10px 20px rgba(0,0,0,0.3);
            z-index: 1000; opacity: 0; pointer-events: none; transition: 0.3s;
        }
        .msg-toast.show { opacity: 1; transform: translateY(-10px); }

        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 200; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal-content { background: #1a1635; padding: 30px; border-radius: 20px; width: 450px; border: 1px solid rgba(255,255,255,0.1); box-sizing: border-box; }

        .hidden { display: none; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; color: rgba(255,255,255,0.6); font-size: 14px; }
        .form-group input, .form-group textarea {
            width: 100%; padding: 12px; background: var(--input-bg); border: 1px solid rgba(255,255,255,0.1);
            border-radius: 10px; color: white; font-family: inherit; box-sizing: border-box;
        }

        /* Loading Screen */
        #app-loading {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-dark);
            z-index: 2000; display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 0.5s;
        }

        @media (max-width: 768px) {
            .sidebar { width: 70px; }
            .sidebar-header h2, .menu-label, .menu-item .label-text, .user-info { display: none; }
            .main-content { margin-left: 70px; padding: 20px; }
            .menu-item { justify-content: center; padding: 15px; font-size: 24px; }
        }
    </style>
</head>
<body>

    <div id="app-loading">
        <div style="font-size: 24px; margin-bottom: 20px; color: var(--accent-color);">‚ú® MAGIC ITEM MANAGER</div>
        <div style="font-size: 14px;">Connecting to Cloud Storage...</div>
        <div style="font-size: 12px; color: rgba(255,255,255,0.5); margin-top: 10px;">(‡∏ñ‡πâ‡∏≤‡∏Ñ‡πâ‡∏≤‡∏á‡∏ô‡∏≤‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Firebase)</div>
    </div>

    <!-- Modals -->
    <div id="modal-category" class="modal-overlay">
        <div class="modal-content">
            <h3 id="modal-cat-title">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡πÉ‡∏´‡∏°‡πà</h3>
            <div class="form-group">
                <label id="lbl-cat-name">‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</label>
                <input type="text" id="cat-name-input" placeholder="...">
            </div>
            <div class="form-group">
                <label id="lbl-cat-icon">‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô (Emoji)</label>
                <input type="text" id="cat-icon-input" placeholder="‚öîÔ∏è">
            </div>
            <div class="btn-row">
                <button class="btn-action btn-copy-main" onclick="saveCategory()" id="btn-save-cat">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                <button class="btn-action btn-flip" onclick="closeModal('modal-category')" id="btn-cancel-cat">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            </div>
        </div>
    </div>

    <div id="modal-restore" class="modal-overlay">
        <div class="modal-content">
            <h3 id="modal-restore-title">‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h3>
            <p style="font-size: 13px; color: rgba(255,255,255,0.6); margin-bottom: 15px;" id="restore-warn">‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏ô‡∏≥‡∏°‡∏≤‡∏£‡∏ß‡∏°‡∏Å‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà</p>
            <div class="form-group">
                <label id="lbl-restore-json">‡∏ß‡∏≤‡∏á‡∏£‡∏´‡∏±‡∏™ Backup JSON</label>
                <textarea id="restore-input" style="height: 150px; font-family: monospace;" placeholder='{"categories": [...], "items": [...]}'></textarea>
            </div>
            <div class="btn-row">
                <button class="btn-action btn-warning" onclick="processRestore()" id="btn-do-restore">‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô</button>
                <button class="btn-action btn-flip" onclick="closeModal('modal-restore')" id="btn-close-restore">‡∏õ‡∏¥‡∏î</button>
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header">
            <h2>ITEM DB</h2>
            <div id="user-id-display" class="user-info">UID: Loading...</div>
            <div class="lang-toggle">
                <button class="btn-lang active" id="lang-th" onclick="setLanguage('th')">TH</button>
                <button class="btn-lang" id="lang-en" onclick="setLanguage('en')">EN</button>
            </div>
        </div>
        <div class="menu-scroll">
            <div class="menu-group">
                <div class="menu-label">
                    <span id="label-categories">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</span>
                    <span class="btn-add-cat" onclick="openModal('modal-category')" title="Add Category">‚äï</span>
                </div>
                <div id="sidebar-categories"></div>
            </div>

            <div class="menu-group">
                <div class="menu-label" id="label-manage">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÑ‡∏≠‡πÄ‡∏ó‡∏°</div>
                <div class="menu-item" onclick="showSection('add-item', this)">
                    <span>‚ûï</span>
                    <span class="label-text" id="menu-add-item">‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏≠‡πÄ‡∏ó‡∏°</span>
                </div>
                <div class="menu-item" onclick="showSection('import-image', this)">
                    <span>üñºÔ∏è</span>
                    <span class="label-text" id="menu-import">‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô/‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</span>
                </div>
                <div class="menu-item" onclick="showSection('ai-gen', this)">
                    <span>‚ú®</span>
                    <span class="label-text" id="menu-aigen">AI SVG Creator</span>
                </div>
                <div class="menu-item" onclick="showSection('trash-bin', this)">
                    <span>üóëÔ∏è</span>
                    <span class="label-text" id="menu-trash">‡∏ñ‡∏±‡∏á‡∏Ç‡∏¢‡∏∞</span>
                </div>
            </div>

            <div class="menu-group">
                <div class="menu-label" id="label-backup">‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>
                <div class="menu-item" onclick="backupAll()">
                    <span>üíæ</span>
                    <span class="label-text" id="menu-backup">Backup</span>
                </div>
                <div class="menu-item" onclick="openModal('modal-restore')">
                    <span>üîÑ</span>
                    <span class="label-text" id="menu-restore">Restore</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Main -->
    <div class="main-content">
        <div id="section-category-view" class="content-section">
            <div class="section-title"><h1 id="view-title">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÑ‡∏≠‡πÄ‡∏ó‡∏°</h1></div>
            <div class="item-grid" id="items-display-grid"></div>
        </div>

        <div id="section-add-item" class="hidden content-section">
            <div class="section-title"><h1 id="title-add-new">‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏≠‡πÄ‡∏ó‡∏°‡πÉ‡∏´‡∏°‡πà</h1></div>
            <div style="max-width: 600px; background: rgba(255,255,255,0.03); padding: 30px; border-radius: 20px;">
                <div class="form-group">
                    <label id="lbl-item-name">‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏≠‡πÄ‡∏ó‡∏°</label>
                    <input type="text" id="new-item-name" placeholder="...">
                </div>
                <div class="form-group">
                    <label id="lbl-item-svg">‡πÇ‡∏Ñ‡πâ‡∏î SVG</label>
                    <textarea id="new-item-svg" style="height: 150px; font-family: monospace;" placeholder="<svg>...</svg>"></textarea>
                </div>
                <button class="btn-action btn-copy-main" onclick="createNewItem()" id="btn-save-item">‚ú® ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            </div>
        </div>

        <!-- Import Section -->
        <div id="section-import-image" class="hidden content-section">
            <div class="section-title"><h1 id="title-import">‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô/‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</h1></div>
            <div style="max-width: 800px; background: rgba(255,255,255,0.03); padding: 30px; border-radius: 20px;">
                <div class="mode-toggle">
                    <button class="mode-btn active" id="mode-embed" onclick="setImportMode('embed')">Embed (‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏™‡∏µ)</button>
                    <button class="mode-btn" id="mode-trace" onclick="setImportMode('trace')">Trace (Vector)</button>
                </div>

                <div class="import-dropzone" id="import-dropzone" onclick="document.getElementById('file-input').click()" 
                     ondragover="handleImportDragOver(event)" ondragleave="handleImportDragLeave(event)" ondrop="handleImportDrop(event)">
                    <p id="dropzone-text">‡∏Ñ‡∏•‡∏¥‡∏Å, ‡∏•‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡∏°‡∏≤‡∏ß‡∏≤‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏î Ctrl+V ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</p>
                    <input type="file" id="file-input" class="hidden" accept="image/*" onchange="handleFileSelect(event)">
                </div>

                <div id="import-preview-area" class="hidden">
                    <div class="preview-container">
                        <div class="preview-box">
                            <label id="lbl-orig-preview">‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö</label>
                            <div style="display: flex; align-items: center; justify-content: center; height: 180px;">
                                <img id="img-preview" src="">
                            </div>
                        </div>
                        <div class="preview-box">
                            <label id="lbl-gen-preview">‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå SVG</label>
                            <div id="svg-preview-cont" style="display: flex; align-items: center; justify-content: center; height: 180px;"></div>
                        </div>
                    </div>

                    <div class="import-controls">
                        <button class="btn-action btn-rbg" onclick="removeBackgroundSimple()" id="btn-remove-bg">‚úÇÔ∏è ‡∏•‡∏ö‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á (‡∏™‡∏µ‡∏Ç‡∏≤‡∏ß)</button>
                        <button class="btn-action btn-gen" onclick="generateSVG()" id="btn-generate">üî® Generate SVG</button>
                        <button class="btn-action btn-cancel-import" onclick="resetImport()" id="btn-cancel-import">‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    </div>

                    <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1);">
                        <div class="form-group">
                            <label id="lbl-import-name">‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏≠‡πÄ‡∏ó‡∏°</label>
                            <input type="text" id="import-item-name" placeholder="...">
                        </div>
                        <button class="btn-action btn-copy-main" onclick="saveImportedItem()" id="btn-save-imported">‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- AI Gen Section -->
        <div id="section-ai-gen" class="hidden content-section">
            <div class="section-title"><h1 id="title-aigen">AI SVG Creator</h1></div>
            <div style="max-width: 800px; background: rgba(255,255,255,0.03); padding: 30px; border-radius: 20px;">
                <div class="ai-gen-box">
                    <div class="form-group">
                        <label id="lbl-ai-prompt">‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á (Prompt)</label>
                        <textarea id="ai-prompt-input" rows="3" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏î‡∏≤‡∏ö‡∏ß‡∏¥‡πÄ‡∏®‡∏©‡∏™‡∏µ‡∏ü‡πâ‡∏≤‡∏î‡πâ‡∏≤‡∏°‡∏ó‡∏≠‡∏á, ‡∏¢‡∏≤‡∏Ç‡∏ß‡∏î‡∏™‡∏µ‡πÅ‡∏î‡∏á‡∏°‡∏µ‡∏ü‡∏≠‡∏á..."></textarea>
                    </div>
                    <div class="btn-row">
                        <button class="btn-action btn-ai-gen" onclick="generateAiSvg()" id="btn-run-ai">‚ú® ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏π‡∏õ SVG ‡∏î‡πâ‡∏ß‡∏¢ AI</button>
                        <button class="btn-action btn-cancel-ai" onclick="resetAiGen()" id="btn-cancel-ai">‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    </div>
                    <div id="ai-loading" class="ai-loading-bar">
                        <div class="ai-loading-progress"></div>
                    </div>
                </div>
                <div id="ai-result-area" class="hidden">
                    <div class="preview-box" style="margin-bottom: 20px;">
                        <label>AI Result</label>
                        <div id="ai-svg-output" style="display: flex; align-items: center; justify-content: center; height: 200px;"></div>
                    </div>
                    <div class="form-group">
                        <label id="lbl-ai-item-name">‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏≠‡πÄ‡∏ó‡∏°</label>
                        <input type="text" id="ai-item-name" placeholder="...">
                    </div>
                    <button class="btn-action btn-copy-main" onclick="saveAiItem()" id="btn-save-ai">‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á‡∏Ñ‡∏•‡∏±‡∏á</button>
                </div>
            </div>
        </div>

        <div id="section-trash-bin" class="hidden content-section">
            <div class="section-title"><h1 id="title-trash">‡∏ñ‡∏±‡∏á‡∏Ç‡∏¢‡∏∞</h1></div>
            <div class="item-grid" id="trash-display-grid"></div>
        </div>
    </div>

    <div id="toast" class="msg-toast">‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</div>

    <script type="module">
        // Helper: Minify SVG Code
        function minifySVG(svg) {
            if (!svg) return '';
            let clean = svg.replace(/[\r\n\t]+/g, ' ').replace(/\s+/g, ' ');
            clean = clean.replace(/<!--[\s\S]*?-->/g, '');
            clean = clean.replace(/(\d+\.\d{2,})/g, (match) => parseFloat(match).toFixed(1));
            clean = clean.replace(/<\?xml.*?\?>/g, '').replace(/<!DOCTYPE.*?>/g, '');
            return clean.trim();
        }

        // Helper: Normalize SVG for Display
        function normalizeSVG(svgString) {
            if (!svgString) return '';
            try {
                const parser = new DOMParser();
                const doc = parser.parseFromString(svgString, "image/svg+xml");
                const svg = doc.querySelector("svg");
                if (!svg) return svgString;
                if (!svg.hasAttribute("viewBox")) {
                    const w = svg.getAttribute("width") || 100;
                    const h = svg.getAttribute("height") || 100;
                    svg.setAttribute("viewBox", `0 0 ${parseFloat(w)} ${parseFloat(h)}`);
                }
                svg.setAttribute("width", "100%");
                svg.setAttribute("height", "100%");
                svg.setAttribute("preserveAspectRatio", "xMidYMid meet");
                svg.style.width = ""; svg.style.height = ""; svg.style.maxWidth = ""; svg.style.maxHeight = "";
                return new XMLSerializer().serializeToString(svg);
            } catch (e) { return svgString; }
        }

        // --- App State & Firebase Bridge ---
        const _pool = [
            { k1: "AIzaSyCGlXcUwyk5tHZ0cwcn", k2: "-98aw19R2XuiF_Y" },
            { k1: "AIzaSyBmYB-nlMaFNkPxI-BWRQ8k", k2: "n02wbE5ybB8" }
        ];
        let activeKeyIndex = 0;
        let currentLang = 'th';
        let categories = [
            { id: 'cat-ai-gen', name: 'AI Gen', icon: '‚ú®' },
            { id: 'cat-import-code', name: 'Import Code', icon: 'üíª' },
            { id: 'cat-import-img', name: 'Import Img', icon: 'üñºÔ∏è' },
            { id: 'cat-restore', name: 'Restore', icon: '‚ôªÔ∏è' },
            { id: 'cat-consumables', name: '‡πÑ‡∏≠‡πÄ‡∏ó‡∏°‡∏Å‡∏î‡πÉ‡∏ä‡πâ', icon: 'üì¶' }, 
            { id: 'cat-treasures', name: '‡∏™‡∏°‡∏ö‡∏±‡∏ï‡∏¥‡∏•‡πâ‡∏≥‡∏Ñ‡πà‡∏≤', icon: 'üíé' }
        ];
        let items = [];
        let trash = [];
        let currentCatId = 'cat-ai-gen';
        let importMode = 'embed';
        let currentGeneratedSvg = '';
        let originalImgData = '';
        let currentAiSvg = '';
        let user = null;

        const translations = {
            th: {
                categories: "‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà", manage: "‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÑ‡∏≠‡πÄ‡∏ó‡∏°", addItem: "‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏≠‡πÄ‡∏ó‡∏°", trash: "‡∏ñ‡∏±‡∏á‡∏Ç‡∏¢‡∏∞", backup: "Backup",
                viewTitle: "‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÑ‡∏≠‡πÄ‡∏ó‡∏°", noItems: "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏≠‡πÄ‡∏ó‡∏°", trashEmpty: "‡∏ñ‡∏±‡∏á‡∏Ç‡∏¢‡∏∞‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤", addTitle: "‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏≠‡πÄ‡∏ó‡∏°‡πÉ‡∏´‡∏°‡πà",
                restoreTitle: "‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•", save: "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å", cancel: "‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å", close: "‡∏õ‡∏¥‡∏î", lblItemName: "‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏≠‡πÄ‡∏ó‡∏°",
                lblItemSvg: "‡πÇ‡∏Ñ‡πâ‡∏î SVG", lblCatName: "‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà", lblCatIcon: "‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô (Emoji)", copy: "‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å", restore: "‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô",
                delForever: "‡∏•‡∏ö‡∏ñ‡∏≤‡∏ß‡∏£", toastSuccess: "‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!", toastCopy: "‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å SVG ‡πÅ‡∏•‡πâ‡∏ß!", toastBackup: "Backup ‡πÅ‡∏•‡πâ‡∏ß!",
                toastRestore: "‡∏Å‡πâ‡∏≤‡∏Ñ‡∏∑‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!", toastItemAdded: "‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏≠‡πÄ‡∏ó‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!", toastCatAdded: "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß!",
                moveSuccess: "‡∏¢‡πâ‡∏≤‡∏¢‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß!", import: "‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô/‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û", dropzone: "‡∏Ñ‡∏•‡∏¥‡∏Å, ‡∏•‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡∏°‡∏≤‡∏ß‡∏≤‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏î Ctrl+V ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà",
                lblImportName: "‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏≠‡πÄ‡∏ó‡∏°", btnGen: "üî® Gen SVG", btnRbg: "‚úÇÔ∏è ‡∏•‡∏ö‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á", menuAiGen: "AI Creator",
                btnRunAi: "‚ú® Gen SVG with AI", toastNameUpdated: "‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢", errorInit: "‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (Timeout)",
                errorAuth: "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"
            },
            en: {
                categories: "Categories", manage: "Manager", addItem: "Add Item", trash: "Trash", backup: "Backup",
                viewTitle: "Item List", noItems: "No items", trashEmpty: "Empty", addTitle: "Add Item",
                restoreTitle: "Restore", save: "Save", cancel: "Cancel", close: "Close", lblItemName: "Name",
                lblItemSvg: "SVG Code", lblCatName: "Name", lblCatIcon: "Icon", copy: "Copy", restore: "Restore",
                delForever: "Delete Forever", toastSuccess: "Success!", toastCopy: "SVG Copied!", toastBackup: "Backed up!",
                toastRestore: "Restored!", toastItemAdded: "Added!", toastCatAdded: "Category added!",
                moveSuccess: "Moved!", import: "Import Image", dropzone: "Click, Drop or Paste image",
                lblImportName: "Name", btnGen: "üî® Gen SVG", btnRbg: "‚úÇÔ∏è Remove BG", menuAiGen: "AI Creator",
                btnRunAi: "‚ú® Gen SVG with AI", toastNameUpdated: "Name updated", errorInit: "Connection Timeout",
                errorAuth: "Auth Failed"
            }
        };

        // --- Core Functions ---
        async function initApp() {
            // Safety timer to remove loader if Firebase hangs
            const loadingTimer = setTimeout(() => {
                const loader = document.getElementById('app-loading');
                if (loader && !loader.classList.contains('hidden')) {
                    loader.classList.add('hidden');
                    toast(translations[currentLang].errorInit);
                }
            }, 5000);

            const { auth, db, appId, signInAnonymously, onAuthStateChanged, collection, query, onSnapshot, doc, setDoc, getDoc } = window.fb;
            
            try {
                await signInAnonymously(auth);
                onAuthStateChanged(auth, async (u) => {
                    if (u) {
                        clearTimeout(loadingTimer);
                        user = u;
                        document.getElementById('user-id-display').innerText = `UID: ${user.uid.substring(0,6)}...`;
                        
                        // Load/Sync Categories
                        const catRef = doc(db, 'artifacts', appId, 'users', user.uid, 'settings', 'categories');
                        try {
                            const catSnap = await getDoc(catRef);
                            if (catSnap.exists()) {
                                categories = catSnap.data().list;
                            } else {
                                await setDoc(catRef, { list: categories });
                            }
                        } catch (e) { console.warn("Cat Load Error, using defaults"); }

                        // Real-time Listeners
                        const itemsQuery = collection(db, 'artifacts', appId, 'users', user.uid, 'items');
                        onSnapshot(itemsQuery, (snapshot) => {
                            const allItems = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                            items = allItems.filter(i => !i.isTrash);
                            trash = allItems.filter(i => i.isTrash);
                            renderSidebar();
                            renderItems();
                            document.getElementById('app-loading').classList.add('hidden');
                        }, (err) => {
                             console.error("Firestore Error:", err);
                             document.getElementById('app-loading').classList.add('hidden');
                        });
                    }
                }, (error) => {
                    clearTimeout(loadingTimer);
                    console.error("Auth Error", error);
                    document.getElementById('app-loading').classList.add('hidden');
                    toast(translations[currentLang].errorAuth);
                });
            } catch (e) { 
                clearTimeout(loadingTimer);
                console.error("Init Error", e); 
                document.getElementById('app-loading').classList.add('hidden');
            }

            applyLanguage();
            setupPasteListener();
        }

        async function createNewItem() {
            const { db, appId, addDoc, collection } = window.fb;
            const name = document.getElementById('new-item-name').value;
            const svg = document.getElementById('new-item-svg').value;
            if(!name || !svg || !user) return;

            const normalizedSVG = normalizeSVG(svg);
            await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'items'), {
                catId: 'cat-import-code',
                name,
                svg: normalizedSVG,
                isTrash: false,
                createdAt: Date.now()
            });
            document.getElementById('new-item-name').value = '';
            document.getElementById('new-item-svg').value = '';
            toast(translations[currentLang].toastItemAdded);
        }

        async function saveImportedItem() {
            const { db, appId, addDoc, collection } = window.fb;
            const name = document.getElementById('import-item-name').value;
            if (!name || !currentGeneratedSvg || !user) return;

            await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'items'), {
                catId: 'cat-import-img',
                name,
                svg: currentGeneratedSvg,
                isTrash: false,
                createdAt: Date.now()
            });
            toast(translations[currentLang].toastItemAdded);
            resetImport();
        }

        async function saveAiItem() {
            const { db, appId, addDoc, collection } = window.fb;
            const name = document.getElementById('ai-item-name').value || "AI Item";
            if(!currentAiSvg || !user) return;

            await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'items'), {
                catId: 'cat-ai-gen',
                name,
                svg: currentAiSvg,
                isTrash: false,
                createdAt: Date.now()
            });
            toast(translations[currentLang].toastItemAdded);
            resetAiGen();
        }

        async function editItemName(id) {
            const { db, appId, doc, updateDoc } = window.fb;
            const item = items.find(i => i.id === id);
            if (item) {
                const newName = prompt("Edit Item Name:", item.name);
                if (newName) {
                    await updateDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'items', id), { name: newName });
                    toast(translations[currentLang].toastNameUpdated);
                }
            }
        }

        async function moveToTrash(id) {
            const { db, appId, doc, updateDoc } = window.fb;
            await updateDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'items', id), { isTrash: true });
            toast(translations[currentLang].toastMovedTrash);
        }

        async function restoreFromTrash(id) {
            const { db, appId, doc, updateDoc } = window.fb;
            await updateDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'items', id), { isTrash: false });
        }

        async function permanentDelete(id) {
            const { db, appId, doc, deleteDoc } = window.fb;
            if(confirm("Confirm permanent delete?")) {
                await deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'items', id));
            }
        }

        async function saveCategory() {
            const { db, appId, doc, setDoc } = window.fb;
            const name = document.getElementById('cat-name-input').value;
            const icon = document.getElementById('cat-icon-input').value || 'üìÅ';
            if(!name || !user) return;
            categories.push({ id: 'cat-' + Date.now(), name, icon });
            await setDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'settings', 'categories'), { list: categories });
            document.getElementById('cat-name-input').value = '';
            closeModal('modal-category');
            toast(translations[currentLang].toastCatAdded);
            renderSidebar();
        }

        async function processRestore() {
            const { db, appId, collection, addDoc } = window.fb;
            try {
                const data = JSON.parse(document.getElementById('restore-input').value);
                if(data.items && user) {
                    let addedCount = 0;
                    for (let item of data.items) {
                        const exists = items.find(i => i.name === item.name && i.svg === item.svg);
                        if (!exists) {
                            await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'items'), {
                                catId: 'cat-restore',
                                name: item.name,
                                svg: normalizeSVG(item.svg),
                                isTrash: false,
                                createdAt: Date.now()
                            });
                            addedCount++;
                        }
                    }
                    closeModal('modal-restore');
                    toast(translations[currentLang].toastRestore + ` (+${addedCount})`);
                }
            } catch (e) { toast("Error Restore"); }
        }

        // --- AI SVG Generator (Gemini) ---
        async function fetchWithRetry(url, options, maxRetries = 5) {
            let lastRes;
            for (let i = 0; i < maxRetries; i++) {
                try {
                    lastRes = await fetch(url, options);
                    if (lastRes.ok || [429, 403, 400].includes(lastRes.status)) return lastRes;
                    await new Promise(r => setTimeout(r, Math.pow(2, i) * 1000));
                } catch (e) { if (i === maxRetries - 1) throw e; await new Promise(r => setTimeout(r, Math.pow(2, i) * 1000)); }
            }
            return lastRes;
        }

        async function generateAiSvg(isRetry = false) {
            const prompt = document.getElementById('ai-prompt-input').value;
            if(!prompt) return;
            const loader = document.getElementById('ai-loading');
            loader.style.display = 'block';
            const currentKey = _pool[activeKeyIndex].k1 + _pool[activeKeyIndex].k2;
            const payload = { contents: [{ parts: [{ text: "Create a simple game icon SVG for: " + prompt + ". Return raw SVG only." }] }] };
            try {
                let res = await fetchWithRetry(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${currentKey}`, {
                    method: 'POST', body: JSON.stringify(payload), headers: { 'Content-Type': 'application/json' }
                });
                if ([429, 403].includes(res.status) && activeKeyIndex < _pool.length - 1) {
                    activeKeyIndex++; return generateAiSvg(true);
                }
                let json = await res.json();
                let text = json.candidates?.[0]?.content?.parts?.[0]?.text;
                if(text) {
                    text = text.replace(/```xml|```svg|```/g, '');
                    const start = text.indexOf('<svg'); const end = text.lastIndexOf('</svg>') + 6;
                    if(start !== -1 && end !== -1) {
                        currentAiSvg = normalizeSVG(text.substring(start, end));
                        document.getElementById('ai-svg-output').innerHTML = currentAiSvg;
                        document.getElementById('ai-result-area').classList.remove('hidden');
                    }
                }
            } catch(e) { toast("AI Error"); } finally { loader.style.display = 'none'; }
        }

        function resetAiGen() {
            document.getElementById('ai-prompt-input').value = '';
            document.getElementById('ai-result-area').classList.add('hidden');
            document.getElementById('ai-svg-output').innerHTML = '';
            document.getElementById('ai-loading').style.display = 'none';
            currentAiSvg = '';
        }

        // --- Standard UI Functions ---
        function applyLanguage() {
            const t = translations[currentLang];
            const ids = {
                'label-categories': t.categories, 'label-manage': t.manage, 'menu-add-item': t.addItem,
                'menu-import': t.import, 'menu-trash': t.trash, 'label-backup': t.backup,
                'menu-backup': t.backup, 'menu-restore': t.restore, 'title-add-new': t.addTitle,
                'title-import': t.import, 'title-trash': t.trash, 'lbl-item-name': t.lblItemName,
                'lbl-item-svg': t.lblItemSvg, 'btn-save-item': "‚ú® " + t.save,
                'modal-cat-title': t.categories, 'lbl-cat-name': t.lblCatName, 'lbl-cat-icon': t.lblCatIcon,
                'btn-save-cat': t.save, 'btn-cancel-cat': t.cancel, 'modal-restore-title': t.restoreTitle,
                'dropzone-text': t.dropzone, 'lbl-import-name': t.lblItemName,
                'btn-generate': "üî® Gen SVG", 'btn-remove-bg': "‚úÇÔ∏è ‡∏•‡∏ö‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á",
                'btn-save-imported': "‚úÖ " + t.save, 'menu-aigen': t.menuAiGen,
                'title-aigen': t.menuAiGen, 'lbl-ai-prompt': "Prompt", 'btn-run-ai': t.btnRunAi,
                'lbl-ai-item-name': t.lblItemName, 'btn-save-ai': "‚úÖ " + t.save, 'btn-cancel-ai': t.cancel
            };
            for (let id in ids) if (document.getElementById(id)) document.getElementById(id).innerText = ids[id];
        }

        function setLanguage(lang) {
            currentLang = lang;
            document.querySelectorAll('.btn-lang').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`lang-${lang}`).classList.add('active');
            applyLanguage();
            renderSidebar();
            renderItems();
        }

        function renderSidebar() {
            const container = document.getElementById('sidebar-categories');
            if(!container) return;
            container.innerHTML = categories.map(cat => `
                <div class="menu-item ${cat.id === currentCatId ? 'active' : ''}" onclick="window.selectCategory('${cat.id}', this)">
                    <span>${cat.icon}</span><span class="label-text">${cat.name}</span>
                </div>
            `).join('');
        }

        function renderItems() {
            const grid = document.getElementById('items-display-grid');
            if(!grid) return;
            const filtered = items.filter(i => i.catId === currentCatId);
            if (filtered.length === 0) { grid.innerHTML = `<div style="grid-column: 1/-1; text-align: center; opacity: 0.3; padding: 40px;">No items.</div>`; return; }
            grid.innerHTML = filtered.map(item => `
                <div class="item-card">
                    <h3>${item.name}</h3><div class="svg-display" id="svg-cont-${item.id}">${item.svg}</div>
                    <div class="btn-row">
                        <button class="btn-action btn-copy-main" onclick="window.copySVG('${item.id}')">Copy</button>
                        <button class="btn-action btn-flip" onclick="window.flipItem('${item.id}')">‚ÜîÔ∏è</button>
                        <button class="btn-action btn-edit" onclick="window.editItemName('${item.id}')">‚úèÔ∏è</button>
                        <button class="btn-action btn-delete" onclick="window.moveToTrash('${item.id}')">üóëÔ∏è</button>
                    </div>
                </div>
            `).join('');
        }

        function renderTrash() {
            const grid = document.getElementById('trash-display-grid');
            if(!grid) return;
            if (trash.length === 0) { grid.innerHTML = `<div style="grid-column: 1/-1; text-align: center; opacity: 0.3; padding: 40px;">Empty.</div>`; return; }
            grid.innerHTML = trash.map(item => `
                <div class="item-card">
                    <h3>${item.name}</h3><div class="svg-display">${item.svg}</div>
                    <div class="btn-row">
                        <button class="btn-action btn-restore-action" onclick="window.restoreFromTrash('${item.id}')">Restore</button>
                        <button class="btn-action btn-permanent" onclick="window.permanentDelete('${item.id}')">Del</button>
                    </div>
                </div>
            `).join('');
        }

        // --- Export Functions for Global UI ---
        window.selectCategory = (id, el) => { currentCatId = id; showSection('category-view', el); const cat = categories.find(c => c.id === id); document.getElementById('view-title').innerText = cat ? `${cat.icon} ${cat.name}` : "Items"; renderItems(); };
        window.showSection = (name, menuItem) => { document.querySelectorAll('.content-section').forEach(s => s.classList.add('hidden')); document.getElementById(`section-${name}`).classList.remove('hidden'); if (menuItem) { document.querySelectorAll('.menu-item').forEach(i => i.classList.remove('active')); menuItem.classList.add('active'); } if(name === 'trash-bin') renderTrash(); };
        window.copySVG = (id) => { const el = document.getElementById(`svg-cont-${id}`); if (el) { copyToClipboard(el.innerHTML.trim()); toast("Copied!"); } };
        window.flipItem = (id) => { const el = document.getElementById(`svg-cont-${id}`); if (el) el.classList.toggle('flipped'); };
        window.editItemName = editItemName;
        window.moveToTrash = moveToTrash;
        window.restoreFromTrash = restoreFromTrash;
        window.permanentDelete = permanentDelete;
        window.backupAll = () => { copyToClipboard(JSON.stringify({ categories, items: [...items, ...trash] })); toast("JSON Copied!"); };
        window.saveCategory = saveCategory;
        window.createNewItem = createNewItem;
        window.saveAiItem = saveAiItem;
        window.saveImportedItem = saveImportedItem;
        window.processRestore = processRestore;
        window.generateAiSvg = generateAiSvg;
        window.resetAiGen = resetAiGen;
        window.openModal = (id) => document.getElementById(id).style.display = 'flex';
        window.closeModal = (id) => document.getElementById(id).style.display = 'none';
        window.setLanguage = setLanguage;
        window.setImportMode = (mode) => { importMode = mode; document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active')); document.getElementById(`mode-${mode}`).classList.add('active'); };

        // Image Processing Fallbacks
        window.removeBackgroundSimple = () => {
            const img = document.getElementById('img-preview');
            if(!img.src) return;
            const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d');
            canvas.width = img.naturalWidth; canvas.height = img.naturalHeight;
            ctx.drawImage(img, 0, 0);
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            for (let i = 0; i < imageData.data.length; i += 4) { if (imageData.data[i] > 230 && imageData.data[i+1] > 230 && imageData.data[i+2] > 230) imageData.data[i+3] = 0; }
            ctx.putImageData(imageData, 0, 0); originalImgData = canvas.toDataURL(); img.src = originalImgData;
        };

        window.generateSVG = () => {
            toast("Generating...");
            if (importMode === 'embed') {
                currentGeneratedSvg = normalizeSVG(`<svg width="200" height="200"><image href="${originalImgData}" width="100%" height="100%" /></svg>`);
                document.getElementById('svg-preview-cont').innerHTML = currentGeneratedSvg;
            } else {
                if (typeof ImageTracer !== 'undefined') {
                    ImageTracer.imageToSVG(originalImgData, (s) => { currentGeneratedSvg = normalizeSVG(s); document.getElementById('svg-preview-cont').innerHTML = currentGeneratedSvg; }, { ltres:1, qtres:1 });
                }
            }
        };

        window.resetImport = () => { document.getElementById('import-preview-area').classList.add('hidden'); originalImgData = ''; currentGeneratedSvg = ''; };
        window.handleFileSelect = (e) => { if (e.target.files[0]) handleImageFile(e.target.files[0]); };
        window.handleImportDragOver = (e) => e.preventDefault();
        window.handleImportDragLeave = (e) => e.preventDefault();
        window.handleImportDrop = (e) => { e.preventDefault(); if (e.dataTransfer.files[0]) handleImageFile(e.dataTransfer.files[0]); };

        function handleImageFile(file) {
            const reader = new FileReader();
            reader.onload = (re) => { originalImgData = re.target.result; document.getElementById('img-preview').src = originalImgData; document.getElementById('import-preview-area').classList.remove('hidden'); };
            reader.readAsDataURL(file);
        }

        function setupPasteListener() {
            window.addEventListener('paste', (e) => {
                if (document.getElementById('section-import-image').classList.contains('hidden')) return;
                const clipItems = (e.clipboardData || e.originalEvent.clipboardData).items;
                for (let i of clipItems) if (i.type.indexOf('image') !== -1) { handleImageFile(i.getAsFile()); break; }
            });
        }

        function copyToClipboard(text) { const el = document.createElement('textarea'); el.value = text; document.body.appendChild(el); el.select(); document.execCommand('copy'); document.body.removeChild(el); }
        function toast(msg) { const t = document.getElementById('toast'); t.innerText = msg; t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 2000); }

        window.onload = initApp;
    </script>
</body>
</html>
