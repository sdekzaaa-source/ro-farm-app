import React, { useState, useEffect, useMemo, useRef } from 'react';
import { initializeApp } from 'firebase/app';
import { 
  getAuth, 
  signInAnonymously, 
  signInWithCustomToken, 
  onAuthStateChanged, 
  signOut,
  GoogleAuthProvider,
  signInWithPopup
} from 'firebase/auth';
import { 
  getFirestore, 
  doc, 
  setDoc, 
  getDoc, 
  collection, 
  query, 
  onSnapshot, 
  deleteDoc,
  addDoc
} from 'firebase/firestore';
import { 
  LineChart, 
  Line, 
  XAxis, 
  YAxis, 
  CartesianGrid, 
  Tooltip, 
  ResponsiveContainer 
} from 'recharts';
import { 
  Wallet, 
  TrendingUp, 
  Archive, 
  History as HistoryIcon, 
  Pencil, 
  Trash2, 
  PlusCircle, 
  Clock, 
  Play, 
  Pause, 
  Square, 
  ChevronDown, 
  ChevronUp,
  LayoutDashboard,
  Calendar,
  Plus,
  MinusCircle,
  HelpCircle,
  X,
  Youtube,
  LogOut,
  User,
  Check,
  Languages,
  ArrowRightLeft,
  Settings,
  FileText,
  BadgeDollarSign,
  AlertCircle,
  Maximize2,
  Sun,
  Moon
} from 'lucide-react';

// --- CONFIG & CONSTANTS ---
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'ro-farm-app';

const YT_AVATAR_URL = "https://yt3.googleusercontent.com/vlD4rkRPBg-HIUX6kAbuW1AHgE1FzYa4cs7W3ZD1AV0z4Xg_vM42d1r_slf8SVPhjmJXPslvcg=s160-c-k-c0x00ffffff-no-rj";

const SVGs = {
  Google: () => (
    <svg width="18" height="18" viewBox="0 0 24 24">
      <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/>
      <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/>
      <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/>
      <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/>
    </svg>
  ),
  Spell: ({className, style}) => (
    <svg viewBox="0 0 32 32" className={className} style={style} shapeRendering="crispEdges">
      <path d="M16 4 L24 12 L24 22 L16 28 L8 22 L8 12 Z" fill="#7E57C2" />
      <path d="M16 6 L22 12 L22 20 L16 26 L10 20 L10 12 Z" fill="#9575CD" />
      <rect x="13" y="10" width="2" height="2" fill="#EDE7F6" />
    </svg>
  ),
  Magic: ({className, style}) => (
    <svg viewBox="0 0 32 32" className={className} style={style} shapeRendering="crispEdges">
      <circle cx="16" cy="16" r="10" fill="#EF5350" />
      <circle cx="16" cy="16" r="6" fill="#B71C1C" />
      <path d="M16 6 L18 10 L22 10 L20 14 L22 18 L18 18 L16 22 L14 18 L10 18 L12 14 L10 10 L14 10 Z" fill="#FFCDD2" opacity="0.5"/>
    </svg>
  ),
  Gum: ({className, style}) => (
    <svg viewBox="0 0 32 32" className={className} style={style} shapeRendering="crispEdges">
      <rect x="6" y="14" width="20" height="8" fill="#42A5F5" />
      <circle cx="16" cy="12" r="6" fill="#F06292" />
    </svg>
  ),
  Silvervine: ({className, style}) => (
    <svg viewBox="0 0 32 32" className={className} style={style} shapeRendering="crispEdges">
      <rect x="8" y="10" width="16" height="14" fill="#5D4037" />
      <rect x="14" y="4" width="4" height="6" fill="#4CAF50" />
      <rect x="14" y="14" width="4" height="4" fill="#FFD600" />
    </svg>
  )
};

// --- TRANSLATIONS ---
const i18n = {
  th: {
    dashboard: "OLD GLAST HEIM",
    welcomeSub: "ระบบบันทึกสถิติและวิเคราะห์กำไร",
    loginBtn: "เข้าสู่ระบบด้วย Gmail",
    guestBtn: "ใช้งานแบบบุคคลทั่วไป",
    exit: "Exit",
    home: "หน้าแรก",
    addData: "เพิ่มข้อมูล",
    netProfit: "กำไรสุทธิ",
    totalBothModes: "ยอดรวมทั้งสองโหมด",
    avgRev: "รายได้เฉลี่ยต่อรอบ",
    avgMin: "รายได้เฉลี่ยต่อนาที",
    inventory: "คลังสมบัติ",
    stats: "กราฟสถิติ",
    history: "ประวัติการฟาร์ม",
    prices: "ราคาตลาดปัจจุบัน",
    timer: "นาฬิกาจับเวลา",
    install: "Install App",
    newRecord: "บันทึกข้อมูลใหม่",
    editRecord: "แก้ไขข้อมูล",
    date: "วันที่",
    duration: "เวลาที่ใช้ (นาที)",
    trashSale: "ยอดขายขยะ (Zeny)",
    gum: "บับเบิ้ลกั้ม",
    silvervine: "มะละกอ",
    etc: "ต้นทุนอื่นๆ",
    notes: "บันทึกช่วยจำ",
    save: "บันทึกข้อมูล",
    cancel: "ยกเลิก",
    subs: "140+ Subs",
    profit: "กำไร",
    revenue: "รายได้",
    mode: "โหมด",
    guestLogin: "Login mode: Guest",
    gmailLogin: "Login mode: Gmail",
    itemSpell: "หินม่วง",
    itemMagic: "หินแดง",
    itemGum: "บับเบิ้ลกั้ม",
    itemGumBox: "กล่องบับเบิ้ลกั้ม",
    itemSilvervine: "มะละกอ",
    itemSilvervineBox: "กล่องมะละกอ",
    unit: "ชิ้น",
    langName: "English",
    revSource: "ที่มาของรายได้",
    costBreakdown: "รายละเอียดต้นทุน",
    stone: "หิน",
    trash: "ขยะ",
    selectionMode: "เลือกโหมดการเล่น",
    max: "สูงสุด",
    min: "ต่ำสุด",
    currentValue: "มูลค่าปัจจุบัน",
    sell: "ขาย",
    sellPopup: "ขายไอเทมจากคลัง",
    sellQuantity: "จำนวนที่จะขาย",
    sellPrice: "ราคาขายต่อชิ้น",
    confirmSell: "ยืนยันการขาย",
    fromSpell: "จากการขายหินม่วง",
    fromMagic: "จากการขายหินแดง",
    priceWarning: "กรุณาระบุราคาตลาดปัจจุบันให้ครบถ้วนก่อนเพิ่มข้อมูล",
    gumShort: "กั้ม",
    viewDetails: "คลิกเพื่อดูรายละเอียดกราฟ",
    range1W: "1 สัปดาห์",
    range1M: "30 วัน",
    range3M: "3 เดือน",
    range1Y: "1 ปี",
    assetTrend: "มูลค่าทรัพย์สินที่ได้รับ",
    theme: "เปลี่ยนธีม"
  },
  en: {
    dashboard: "OLD GLAST HEIM",
    welcomeSub: "Statistics & Profit Analytics System",
    loginBtn: "Login with Gmail",
    guestBtn: "Use as Guest",
    exit: "Exit",
    home: "Home",
    addData: "Add Data",
    netProfit: "Net Profit",
    totalBothModes: "Total for both modes",
    avgRev: "Avg. Revenue / Round",
    avgMin: "Avg. Revenue / Min",
    inventory: "Inventory",
    stats: "Statistics",
    history: "History",
    prices: "Market Prices",
    timer: "Farm Timer",
    install: "Install App",
    newRecord: "New Record",
    editRecord: "Edit Record",
    date: "Date",
    duration: "Duration (Min)",
    trashSale: "Trash Sales (Zeny)",
    gum: "Bubble Gum",
    silvervine: "Silvervine",
    etc: "Other Costs (etc.)",
    notes: "Notes (Memo)",
    save: "Save Data",
    cancel: "Cancel",
    subs: "140+ Subs",
    profit: "Profit",
    revenue: "Revenue",
    mode: "Mode",
    guestLogin: "Login mode: Guest",
    gmailLogin: "Login mode: Gmail",
    itemSpell: "Coagulated Spell",
    itemMagic: "Contaminated Magic",
    itemGum: "Bubble Gum",
    itemGumBox: "Bubble Gum Box",
    itemSilvervine: "Silvervine",
    itemSilvervineBox: "Silvervine Box",
    unit: "ea.",
    langName: "ภาษาไทย",
    revSource: "Revenue Source",
    costBreakdown: "Costs Breakdown",
    stone: "Stone",
    trash: "Trash",
    selectionMode: "Select Run Mode",
    max: "Max",
    min: "Min",
    currentValue: "Current Value",
    sell: "Sell",
    sellPopup: "Sell Item from Stock",
    sellQuantity: "Quantity to Sell",
    sellPrice: "Price per ea.",
    confirmSell: "Confirm Sale",
    fromSpell: "from Coagulated Spell sales",
    fromMagic: "from Contaminated Magic sales",
    priceWarning: "Please fill in all market prices before adding data",
    gumShort: "Gum",
    viewDetails: "Click to view chart details",
    range1W: "1 Week",
    range1M: "30 Days",
    range3M: "3 Months",
    range1Y: "1 Year",
    assetTrend: "Acquired Asset Value",
    theme: "Change Theme"
  }
};

const WelcomeScreen = ({ onLogin, onGuest, lang, setLang, theme }) => (
  <div className={`min-h-screen flex flex-col items-center justify-center p-6 text-center overflow-hidden transition-colors duration-500 ${theme === 'dark' ? 'bg-slate-950 text-slate-100' : 'bg-[#e5e2da] text-stone-900'}`}>
    <div className={`absolute top-1/4 left-1/4 w-64 h-64 rounded-full blur-[120px] animate-pulse ${theme === 'dark' ? 'bg-purple-600/10' : 'bg-purple-600/5'}`}></div>
    <div className={`absolute bottom-1/4 right-1/4 w-64 h-64 rounded-full blur-[120px] animate-pulse ${theme === 'dark' ? 'bg-blue-600/10' : 'bg-blue-600/5'}`}></div>
    
    <div className="relative mb-12 transform hover:scale-105 transition-transform duration-500">
      <div className={`w-48 h-48 md:w-56 md:h-56 rounded-[4rem] flex items-center justify-center shadow-2xl border-2 rotate-3 ${theme === 'dark' ? 'bg-gradient-to-br from-slate-800 to-slate-900 border-slate-700/50' : 'bg-[#faf9f6] border-stone-300'}`}>
        <SVGs.Spell className="w-28 h-28 md:w-32 md:h-32 drop-shadow-2xl" />
      </div>
      
      <div className="absolute -bottom-2 -right-2 bg-purple-600 text-white flex items-center gap-2 p-1.5 pr-4 rounded-full shadow-lg border-2 border-slate-950 -rotate-6">
        <div className="w-6 h-6 rounded-full bg-cover border border-white/20" style={{backgroundImage: `url('${YT_AVATAR_URL}')`}}></div>
        <span className="text-[10px] font-black uppercase tracking-widest">SDekza RO</span>
      </div>
    </div>

    <h1 className="text-5xl font-black text-transparent bg-clip-text bg-gradient-to-r from-purple-400 via-purple-500 to-pink-500 mb-4 tracking-tighter italic uppercase">OGH TRACKER</h1>
    <p className={`text-sm mb-12 font-medium leading-relaxed max-w-xs mx-auto ${theme === 'dark' ? 'text-slate-400' : 'text-stone-600'}`}>{i18n[lang].welcomeSub}<br/><span className="text-xs mt-1 block uppercase tracking-widest italic font-bold tracking-[0.2em]">RO Classic / GGT</span></p>
    
    <div className="space-y-4 w-full max-w-xs relative z-10">
      <button onClick={onLogin} className={`w-full h-14 flex items-center justify-center gap-3 px-6 rounded-2xl font-bold shadow-xl hover:translate-y-[-2px] transition-all ${theme === 'dark' ? 'bg-white text-slate-900' : 'bg-stone-800 text-white'}`}>
        <SVGs.Google /> <span>{i18n[lang].loginBtn}</span>
      </button>
      <button onClick={onGuest} className={`w-full h-14 flex items-center justify-center gap-2 px-6 rounded-2xl font-semibold text-sm hover:translate-y-[-2px] transition-all border ${theme === 'dark' ? 'bg-transparent text-slate-500 border-slate-800 hover:bg-slate-900 hover:text-white' : 'bg-white text-stone-500 border-stone-300 hover:bg-[#f5f3ee] hover:text-stone-800'}`}>
        <User size={16} /> {i18n[lang].guestBtn}
      </button>
      
      <button onClick={() => setLang(lang === 'th' ? 'en' : 'th')} className={`flex items-center gap-2 mx-auto pt-4 text-[10px] font-black uppercase tracking-widest transition-colors ${theme === 'dark' ? 'text-slate-600 hover:text-white' : 'text-stone-400 hover:text-stone-800'}`}>
        <Languages size={14} /> {i18n[lang].langName}
      </button>
    </div>
  </div>
);

export default function App() {
  const [lang, setLang] = useState('th');
  const [theme, setTheme] = useState('dark'); 
  const [user, setUser] = useState(null);
  const [loading, setLoading] = useState(true);
  const [isGuestMode, setIsGuestMode] = useState(false);
  const [records, setRecords] = useState([]);
  const [manualSales, setManualSales] = useState([]); 
  const [globalPrices, setGlobalPrices] = useState({ purpleStonePrice: 0, contMagicPrice: 0, gumBoxPrice: 0, silvervineBoxPrice: 0 });
  const [activeTab, setActiveTab] = useState('ogh');
  const [isAdding, setIsAdding] = useState(false);
  const [editingId, setEditingId] = useState(null);
  const [chartMode, setChartMode] = useState('profit');
  const [sortOrder, setSortOrder] = useState('date-desc');
  const [expandedId, setExpandedId] = useState(null);
  const [showManual, setShowManual] = useState(false);
  const [priceValidationPulse, setPriceValidationPulse] = useState(false); 
  const [priceWarningActive, setPriceWarningActive] = useState(false);
  const [slideIndex, setSlideIndex] = useState(0); 
  const [timeInMs, setTimeInMs] = useState(0);
  const [isTimerActive, setIsTimerActive] = useState(false);
  const [isTimerPaused, setIsTimerPaused] = useState(true);
  const timerRef = useRef(null);

  const [showDetailChart, setShowDetailChart] = useState(null); 
  const [chartRange, setChartRange] = useState('30D'); 

  const [showSaleModal, setShowSaleModal] = useState(false);
  const [saleItem, setSaleItem] = useState(null); 
  const [saleFormData, setSaleFormData] = useState({ quantity: "", price: "" });
  const [formData, setFormData] = useState({
    date: new Date().toLocaleDateString('en-GB'),
    gumUsed: 0, trashAmount: "", purpleStoneCount: "", contMagicCount: "",
    isSellingSpell: false, isSellingMagic: false, useSilvervine: true,
    minutesUsed: 60, notes: "", otherCosts: [], runMode: 'ogh'
  });

  const t = i18n[lang];

  useEffect(() => {
    const timer = setInterval(() => setSlideIndex(prev => (prev === 0 ? 1 : 0)), 5000);
    return () => clearInterval(timer);
  }, []);

  const formatZeny = (n) => new Intl.NumberFormat('th-TH').format(Math.round(n || 0));
  const formatMZeny = (n) => (Number(n || 0) / 1000000).toFixed(2) + " M";
  const formatTimer = (ms) => {
    const m = Math.floor(ms / 60000).toString().padStart(2, '0');
    const s = Math.floor((ms % 60000) / 1000).toString().padStart(2, '0');
    return `${m}:${s}`;
  };

  useEffect(() => {
    const initAuth = async () => {
      if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
        await signInWithCustomToken(auth, __initial_auth_token);
      } else {
        await signInAnonymously(auth);
      }
    };
    initAuth();
    const unsubscribe = onAuthStateChanged(auth, (u) => { setUser(u); setLoading(false); });
    return () => unsubscribe();
  }, []);

  useEffect(() => {
    if (!user) return;
    const recordsPath = collection(db, 'artifacts', appId, 'users', user.uid, 'farm_records');
    const unsubRecords = onSnapshot(query(recordsPath), (snap) => setRecords(snap.docs.map(d => ({ id: d.id, ...d.data() }))));
    const salesPath = collection(db, 'artifacts', appId, 'users', user.uid, 'manual_sales');
    const unsubSales = onSnapshot(query(salesPath), (snap) => setManualSales(snap.docs.map(d => ({ id: d.id, ...d.data() }))));
    const priceDoc = doc(db, 'artifacts', appId, 'users', user.uid, 'settings', 'prices');
    const unsubPrices = onSnapshot(priceDoc, (snap) => { if (snap.exists()) setGlobalPrices(snap.data()); });
    return () => { unsubRecords(); unsubSales(); unsubPrices(); };
  }, [user]);

  useEffect(() => {
    if (isTimerActive && !isTimerPaused) {
      timerRef.current = setInterval(() => setTimeInMs(p => p + 1000), 1000);
    } else { clearInterval(timerRef.current); }
    return () => clearInterval(timerRef.current);
  }, [isTimerActive, isTimerPaused]);

  const handleLogout = () => signOut(auth).then(() => { setUser(null); setIsGuestMode(false); setRecords([]); setManualSales([]); });
  
  const updatePrice = async (key, val) => {
    const newPrices = { ...globalPrices, [key]: Number(val) };
    setGlobalPrices(newPrices);
    if (user && !isGuestMode) await setDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'settings', 'prices'), newPrices);
  };

  const handleAddDataToggle = () => {
    if (isAdding) { setIsAdding(false); setEditingId(null); setPriceWarningActive(false); return; }
    const isValid = globalPrices.purpleStonePrice > 0 && globalPrices.contMagicPrice > 0 && globalPrices.gumBoxPrice > 0 && globalPrices.silvervineBoxPrice > 0;
    if (!isValid) { setPriceWarningActive(true); setPriceValidationPulse(true); setTimeout(() => setPriceValidationPulse(false), 500); return; }
    setIsAdding(true); setPriceWarningActive(false);
  };

  const handleSave = async (e) => {
    e.preventDefault();
    const id = editingId || Date.now().toString();
    const entryMode = formData.runMode || activeTab;
    const entry = { ...formData, id, timestamp: Date.now(), mode: entryMode, prices: { ...globalPrices } };
    if (user && !isGuestMode) await setDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'farm_records', id), entry);
    else setRecords(prev => editingId ? prev.map(r => r.id === editingId ? entry : r) : [entry, ...prev]);
    setIsAdding(false); setEditingId(null);
    setFormData({ date: new Date().toLocaleDateString('en-GB'), gumUsed: 0, trashAmount: "", purpleStoneCount: "", contMagicCount: "", isSellingSpell: false, isSellingMagic: false, useSilvervine: true, minutesUsed: 60, notes: "", otherCosts: [], runMode: 'ogh' });
  };

  const handleDelete = async (id) => {
    if (user && !isGuestMode) await deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'farm_records', id));
    else setRecords(prev => prev.filter(r => r.id !== id));
  };

  const tableData = useMemo(() => {
    const runsPerDate = {};
    records.forEach(r => { if (r.useSilvervine) { const d = r.date; runsPerDate[d] = (runsPerDate[d] || 0) + 1; } });
    return records.map(r => {
      const p = r.prices || globalPrices; 
      const stoneVal = (Number(r.purpleStoneCount || 0) * p.purpleStonePrice) + ((r.mode === 'aogh') ? (Number(r.contMagicCount || 0) * p.contMagicPrice) : 0);
      const rev = Number(r.trashAmount || 0) + (r.isSellingSpell ? (Number(r.purpleStoneCount || 0) * p.purpleStonePrice) : 0) + ((r.mode === 'aogh' && r.isSellingMagic) ? (Number(r.contMagicCount || 0) * p.contMagicPrice) : 0);
      const gumCost = (r.gumUsed * (p.gumBoxPrice / 10));
      let svCost = r.useSilvervine ? (2 * (p.silvervineBoxPrice / 10)) / (runsPerDate[r.date] || 1) : 0;
      const etcCost = (r.otherCosts || []).reduce((a, b) => a + Number(b.amount || 0), 0);
      const totalCost = gumCost + svCost + etcCost;
      return { ...r, revenue: rev, gumCost, silvervineCost: svCost, totalCost, profit: rev - totalCost, revenuePerMinute: r.minutesUsed > 0 ? rev / r.minutesUsed : 0, stoneValue: stoneVal };
    }).sort((a, b) => sortOrder === 'date-desc' ? b.timestamp - a.timestamp : a.timestamp - b.timestamp);
  }, [records, globalPrices, sortOrder]);

  const filteredData = useMemo(() => tableData.filter(r => (r.mode || 'ogh') === activeTab), [tableData, activeTab]);

  const stats = useMemo(() => {
    const totalEarnedSpell = tableData.reduce((a, b) => a + (!b.isSellingSpell ? Number(b.purpleStoneCount || 0) : 0), 0);
    const totalEarnedMagic = tableData.reduce((a, b) => a + (!b.isSellingMagic ? Number(b.contMagicCount || 0) : 0), 0);
    const totalSoldSpellCount = manualSales.filter(s => s.item === 'spell').reduce((a, b) => a + Number(b.quantity), 0);
    const totalSoldMagicCount = manualSales.filter(s => s.item === 'magic').reduce((a, b) => a + Number(b.quantity), 0);
    const stockSpell = totalEarnedSpell - totalSoldSpellCount;
    const stockMagic = totalEarnedMagic - totalSoldMagicCount;
    const manualSpellRevenue = manualSales.filter(s => s.item === 'spell').reduce((a, b) => a + (Number(b.quantity) * Number(b.price)), 0);
    const manualMagicRevenue = manualSales.filter(s => s.item === 'magic').reduce((a, b) => a + (Number(b.quantity) * Number(b.price)), 0);
    const farmProfit = tableData.reduce((a, b) => a + b.profit, 0);
    const totalNetProfit = farmProfit + manualSpellRevenue + manualMagicRevenue;
    const revs = filteredData.map(r => r.revenue);
    return {
      totalNetProfit, manualSpellRevenue, manualMagicRevenue,
      avgRevenue: revs.length ? revs.reduce((a, b) => a + b, 0) / revs.length : 0,
      maxRevenue: revs.length ? Math.max(...revs) : 0,
      minRevenue: revs.length ? Math.min(...revs) : 0,
      avgRevMin: filteredData.reduce((a, b) => a + (b.revenue / (b.minutesUsed || 1)), 0) / (filteredData.length || 1),
      stockSpell, stockMagic,
      inventoryValue: (stockSpell * globalPrices.purpleStonePrice) + (stockMagic * globalPrices.contMagicPrice)
    };
  }, [tableData, filteredData, manualSales, globalPrices]);

  const chartPopupData = useMemo(() => {
    if (!showDetailChart) return [];
    const now = Date.now();
    let limit;
    if (chartRange === '7D') limit = now - (7 * 24 * 60 * 60 * 1000);
    else if (chartRange === '30D') limit = now - (30 * 24 * 60 * 60 * 1000);
    else if (chartRange === '3M') limit = now - (90 * 24 * 60 * 60 * 1000);
    else limit = now - (365 * 24 * 60 * 60 * 1000);
    const base = showDetailChart === 'avgRevenue' ? filteredData : tableData;
    return base.filter(d => d.timestamp >= limit).reverse();
  }, [showDetailChart, chartRange, tableData, filteredData]);

  const handleManualSell = async () => {
    let q = Number(saleFormData.quantity); let p = Number(saleFormData.price); const max = saleItem === 'spell' ? stats.stockSpell : stats.stockMagic;
    if (q < 0) q = 0; if (q > max) q = max;
    const saleRecord = { item: saleItem, quantity: q, price: p, timestamp: Date.now() };
    if (user && !isGuestMode) await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'manual_sales'), saleRecord);
    else setManualSales(prev => [...prev, { ...saleRecord, id: Date.now().toString() }]);
    setShowSaleModal(false); setSaleFormData({ quantity: "", price: "" });
  };

  if (loading) return <div className={`min-h-screen flex items-center justify-center ${theme === 'dark' ? 'bg-slate-950' : 'bg-[#e5e2da]'}`}><div className="animate-spin rounded-full h-12 w-12 border-t-2 border-purple-500"></div></div>;
  if (!user && !isGuestMode) return <WelcomeScreen onLogin={() => signInWithPopup(auth, new GoogleAuthProvider())} onGuest={() => setIsGuestMode(true)} lang={lang} setLang={setLang} theme={theme} />;

  // Theme-based classes (EYE COMFORT UPDATE)
  const themeClasses = {
    bg: theme === 'dark' ? 'bg-slate-950 text-slate-100' : 'bg-[#e5e2da] text-stone-900',
    card: theme === 'dark' ? 'bg-slate-900/60 border-slate-800' : 'bg-[#faf9f6]/95 border-stone-300 shadow-md',
    innerBg: theme === 'dark' ? 'bg-slate-950/80' : 'bg-[#f0ede6]',
    textDim: theme === 'dark' ? 'text-slate-500' : 'text-stone-500',
    textMain: theme === 'dark' ? 'text-white' : 'text-stone-900',
    btnGhost: theme === 'dark' ? 'bg-slate-950/80 border-slate-800 text-slate-400 hover:text-white' : 'bg-[#faf9f6] border-stone-300 text-stone-500 hover:text-stone-900 shadow-sm'
  };

  return (
    <div className={`min-h-screen p-4 md:p-6 lg:p-8 font-sans selection:bg-purple-500/30 transition-colors duration-500 ${themeClasses.bg}`}>
      <div className="max-w-7xl mx-auto space-y-6">
        
        {priceWarningActive && !isAdding && (
          <div className="bg-rose-500/10 border border-rose-500/30 p-4 rounded-2xl flex items-center justify-between animate-in slide-in-from-top-4 duration-300">
            <div className="flex items-center gap-3 text-rose-500"><AlertCircle size={20} /><span className="text-xs md:text-sm font-black uppercase tracking-tight">{t.priceWarning}</span></div>
            <button onClick={() => setPriceWarningActive(false)} className="text-rose-500/60 hover:text-rose-500"><X size={18}/></button>
          </div>
        )}

        {/* Unified Sliding Header Row */}
        <header className={`border p-4 md:p-6 rounded-[2rem] backdrop-blur-md shadow-2xl overflow-hidden transition-all ${themeClasses.card}`}>
          <div className="flex flex-row justify-between items-center gap-4">
            <a href="https://www.youtube.com/@SDekza-RO" target="_blank" rel="noreferrer" className="relative w-full max-w-[220px] md:max-w-[400px] h-[50px] cursor-pointer shrink-0">
              <div className={`absolute inset-0 flex flex-col justify-center transition-all duration-700 transform ${slideIndex === 0 ? 'translate-x-0 opacity-100' : '-translate-x-12 opacity-0 pointer-events-none'}`}>
                <h1 className="text-xl md:text-3xl font-black tracking-tight bg-gradient-to-r from-purple-400 via-purple-500 to-pink-500 bg-clip-text text-transparent uppercase italic leading-none">{i18n.en.dashboard}</h1>
                <p className={`text-[8px] md:text-[10px] uppercase font-bold mt-1 opacity-60 ${themeClasses.textDim}`}>{isGuestMode ? t.guestLogin : t.gmailLogin}</p>
              </div>
              <div className={`absolute inset-0 flex items-center gap-2 md:gap-4 transition-all duration-700 transform ${slideIndex === 1 ? 'translate-x-0 opacity-100' : '-translate-x-12 opacity-0 pointer-events-none'}`}>
                <div className="w-8 h-8 md:w-11 md:h-11 rounded-full bg-cover border-2 border-red-600/50 shadow-lg" style={{backgroundImage: `url('${YT_AVATAR_URL}')`}}></div>
                <div className="text-left shrink-0"><p className={`text-[10px] md:text-sm font-black leading-none uppercase ${themeClasses.textMain}`}>SDekza RO</p><p className={`text-[8px] md:text-[10px] font-bold mt-0.5 flex items-center gap-1 ${themeClasses.textDim}`}><Youtube size={10} className="text-red-500"/> {i18n.en.subs}</p></div>
                <div className="bg-red-600 text-white text-[8px] md:text-[10px] font-black px-2 md:px-4 py-1 md:py-2 rounded-full hidden sm:flex items-center gap-1.5 shadow-lg">Subscribe</div>
              </div>
            </a>
            <div className="flex items-center gap-1.5 md:gap-3 flex-wrap justify-end">
               <div className="flex gap-1 md:gap-2">
                 {/* Theme Toggle Button (Icon Only) */}
                 <button onClick={() => setTheme(theme === 'dark' ? 'light' : 'dark')} className={`flex items-center justify-center w-10 h-10 md:w-11 md:h-11 rounded-xl border transition-all ${themeClasses.btnGhost}`}>
                    {theme === 'dark' ? <Sun size={18} /> : <Moon size={18} />}
                 </button>
                 <button onClick={() => setShowManual(true)} className={`flex items-center gap-1.5 md:gap-2 text-[8px] md:text-[10px] font-black uppercase tracking-widest px-2 md:px-3 py-1.5 md:py-2.5 rounded-xl border transition-all ${themeClasses.btnGhost}`}>
                   <HelpCircle size={12}/> <span className="hidden sm:inline">{t.install}</span>
                 </button>
                 <button onClick={() => setLang(lang === 'th' ? 'en' : 'th')} className={`flex items-center gap-1.5 md:gap-2 text-[8px] md:text-[10px] font-black uppercase tracking-widest px-2 md:px-3 py-1.5 md:py-2.5 rounded-xl border transition-all ${themeClasses.btnGhost}`}>
                    <Languages size={12} /> <span className="hidden sm:inline">{lang === 'th' ? 'EN' : 'TH'}</span>
                 </button>
                 <button onClick={handleLogout} className={`flex items-center gap-1.5 md:gap-2 text-[8px] md:text-[10px] font-black uppercase tracking-widest px-2 md:px-3 py-1.5 md:py-2.5 rounded-xl border transition-all ${theme === 'dark' ? 'bg-rose-500/10 border-rose-500/20 text-rose-500 hover:text-rose-400' : 'bg-[#fff1f2] border-rose-200 text-rose-600 hover:bg-[#ffe4e6] shadow-sm'}`}>
                   <LogOut size={12}/> <span>{t.exit}</span>
                 </button>
               </div>
               <div className="flex items-center ml-1 md:ml-2 pl-2 md:pl-4 border-l border-stone-300 dark:border-slate-800">
                  <button onClick={handleAddDataToggle} className={`px-3 md:px-6 py-2 md:py-3.5 rounded-xl font-black flex items-center justify-center gap-1.5 md:gap-2 shadow-lg active:scale-95 transition-all text-[9px] md:text-[11px] uppercase tracking-wider ${isAdding ? (theme === 'dark' ? 'bg-slate-800 text-white' : 'bg-stone-700 text-white') : 'bg-purple-600 hover:bg-purple-700 text-white'}`}>{isAdding ? <><LayoutDashboard size={14} /> {t.home}</> : <><PlusCircle size={14} /> {t.addData}</>}</button>
               </div>
            </div>
          </div>
        </header>

        {/* Market Price Bar */}
        {!isAdding && (
          <section className={`border p-5 md:p-6 rounded-[2rem] shadow-xl backdrop-blur-sm transition-all duration-300 ${themeClasses.card} ${priceValidationPulse ? 'border-rose-500 animate-bounce' : ''}`}>
            <h3 className="text-[10px] font-black text-indigo-400 uppercase tracking-widest flex items-center gap-2 italic mb-4"><TrendingUp size={14} /> {t.prices}</h3>
            <div className="grid grid-cols-2 md:grid-cols-4 gap-3 md:gap-4">
              {[
                { key: 'purpleStonePrice', icon: <SVGs.Spell className="w-3.5 h-3.5"/>, label: t.itemSpell, color: 'focus-within:border-indigo-500' },
                { key: 'contMagicPrice', icon: <SVGs.Magic className="w-3.5 h-3.5"/>, label: t.itemMagic, color: 'focus-within:border-rose-500' },
                { key: 'gumBoxPrice', icon: <SVGs.Gum className="w-3.5 h-3.5"/>, label: t.itemGumBox, color: 'focus-within:border-blue-500' },
                { key: 'silvervineBoxPrice', icon: <SVGs.Silvervine className="w-3.5 h-3.5"/>, label: t.itemSilvervineBox, color: 'focus-within:border-emerald-500' }
              ].map(item => (
                <div key={item.key} className={`p-3 rounded-2xl border flex flex-col gap-1 transition-colors ${theme === 'dark' ? 'bg-slate-950/50 border-slate-800' : 'bg-[#f0ede6] border-stone-200'} ${item.color}`}>
                  <span className={`text-[8px] font-black uppercase flex items-center gap-1 ${themeClasses.textDim}`}>{item.icon} {item.label}</span>
                  <div className="flex items-center gap-1">
                    <input type="number" value={globalPrices[item.key]} onChange={e => updatePrice(item.key, e.target.value)} className={`bg-transparent text-sm font-black outline-none w-full ${themeClasses.textMain}`} placeholder="0" />
                    <span className={`text-[9px] font-bold ${themeClasses.textDim}`}>Z</span>
                  </div>
                </div>
              ))}
            </div>
          </section>
        )}

        {isAdding ? (
          /* Form */
          <div className={`max-w-xl mx-auto border rounded-[2.5rem] p-8 md:p-10 shadow-2xl animate-in fade-in zoom-in duration-200 ${themeClasses.card}`}>
            <form onSubmit={handleSave} className="space-y-8">
              <div className="flex justify-between items-center border-b border-stone-200 dark:border-slate-800 pb-6"><h2 className="text-xl font-black text-purple-400 italic uppercase">{editingId ? t.editRecord : t.newRecord}</h2></div>
              <div className="space-y-3">
                <label className={`text-[9px] font-black uppercase tracking-widest flex items-center gap-2 ${themeClasses.textDim}`}><Settings size={12}/> {t.selectionMode}</label>
                <div className="flex flex-col sm:flex-row gap-3">
                  <div className={`flex p-1 rounded-2xl border flex-[2] ${theme === 'dark' ? 'bg-slate-950 border-slate-800' : 'bg-[#f0ede6] border-stone-200'}`}>
                    <button type="button" onClick={() => setFormData(p => ({...p, runMode: 'ogh'}))} className={`flex-1 flex items-center justify-center gap-3 py-3 rounded-xl text-xs font-black transition-all ${formData.runMode === 'ogh' ? 'bg-purple-600 text-white shadow-lg' : 'text-stone-500'}`}><SVGs.Spell className="w-5 h-5"/> OGH</button>
                    <button type="button" onClick={() => setFormData(p => ({...p, runMode: 'aogh'}))} className={`flex-1 flex items-center justify-center gap-3 py-3 rounded-xl text-xs font-black transition-all ${formData.runMode === 'aogh' ? 'bg-rose-600 text-white shadow-lg' : 'text-stone-500'}`}><SVGs.Magic className="w-5 h-5"/> AOGH</button>
                  </div>
                  <label className={`flex-1 flex items-center justify-between gap-3 cursor-pointer p-3 rounded-2xl border group hover:border-emerald-500/50 transition-all ${theme === 'dark' ? 'bg-slate-950 border-slate-800' : 'bg-white border-stone-300'}`}>
                    <div className="flex items-center gap-2"><SVGs.Silvervine className="w-5 h-5"/><span className={`text-[10px] font-black uppercase ${themeClasses.textDim}`}>{t.silvervine}</span></div>
                    <div className={`w-6 h-6 rounded-lg border flex items-center justify-center transition-all ${formData.useSilvervine ? 'bg-emerald-500 border-emerald-500' : 'border-stone-300 dark:border-slate-700'}`}>{formData.useSilvervine && <Check size={14} strokeWidth={4} className="text-white" />}</div>
                    <input type="checkbox" className="hidden" checked={formData.useSilvervine} onChange={e => setFormData(p => ({...p, useSilvervine: e.target.checked}))} />
                  </label>
                </div>
              </div>
              <div className="grid grid-cols-2 gap-6">
                <div className="space-y-2"><label className={`text-[9px] font-black uppercase tracking-widest ${themeClasses.textDim}`}>{t.date}</label><input type="text" value={formData.date} onChange={e => setFormData(p => ({...p, date: e.target.value}))} className={`w-full border rounded-xl p-3 font-bold outline-none focus:border-purple-500 text-sm ${theme === 'dark' ? 'bg-slate-950 border-slate-800 text-white' : 'bg-[#f9f7f2] border-stone-300 text-stone-900'}`} /></div>
                <div className="space-y-2"><label className={`text-[9px] font-black uppercase tracking-widest ${themeClasses.textDim}`}>{t.gum}</label><div className={`flex p-1 rounded-xl border ${theme === 'dark' ? 'bg-slate-950 border-slate-800' : 'bg-[#f0ede6] border-stone-300'}`}>{[0, 1, 2].map(n => (<button key={n} type="button" onClick={() => setFormData(p => ({...p, gumUsed: n}))} className={`flex-1 py-2 rounded-lg text-xs font-black transition-all ${formData.gumUsed === n ? 'bg-blue-600 text-white shadow-md' : 'text-stone-500'}`}>{n}</button>))}</div></div>
              </div>
              <div className="grid grid-cols-2 gap-6">
                <div className="space-y-2"><label className={`text-[9px] font-black uppercase tracking-widest ${themeClasses.textDim}`}>{t.duration}</label><input type="number" value={formData.minutesUsed} onChange={e => setFormData(p => ({...p, minutesUsed: Number(e.target.value)}))} className={`w-full border rounded-xl p-3 font-bold outline-none text-sm ${theme === 'dark' ? 'bg-slate-950 border-slate-800 text-white' : 'bg-[#f9f7f2] border-stone-300 text-stone-900'}`} /></div>
                <div className="space-y-2"><label className={`text-[9px] font-black uppercase tracking-widest ${themeClasses.textDim}`}>{t.trashSale}</label><input type="number" value={formData.trashAmount} onChange={e => setFormData(p => ({...p, trashAmount: e.target.value}))} placeholder="0" className={`w-full border rounded-xl p-3 font-bold outline-none text-sm ${theme === 'dark' ? 'bg-slate-950 border-slate-800 text-white' : 'bg-[#f9f7f2] border-stone-300 text-stone-900'}`} /></div>
              </div>
              <div className="space-y-6 pt-4 border-t border-stone-200 dark:border-slate-800">
                <div className="flex gap-4 items-end">
                  <div className="flex-1 space-y-2"><label className={`text-[9px] font-black uppercase tracking-widest flex items-center gap-1 ${themeClasses.textDim}`}><SVGs.Spell className="w-3 h-3"/> {t.itemSpell}</label><input type="number" value={formData.purpleStoneCount} onChange={e => setFormData(p => ({...p, purpleStoneCount: e.target.value}))} className={`w-full border rounded-xl p-3 font-bold text-sm outline-none ${theme === 'dark' ? 'bg-slate-950 border-slate-800 text-white' : 'bg-[#f9f7f2] border-stone-300 text-stone-900'}`} /></div>
                  <div className={`flex p-1 rounded-xl border w-32 shrink-0 h-[46px] ${theme === 'dark' ? 'bg-slate-950 border-slate-800' : 'bg-[#f0ede6] border-stone-300'}`}><button type="button" onClick={() => setFormData(p => ({...p, isSellingSpell: true}))} className={`flex-1 rounded-lg text-[9px] font-black uppercase transition-all ${formData.isSellingSpell ? 'bg-rose-600 text-white shadow-md' : 'text-stone-600'}`}>ขาย</button><button type="button" onClick={() => setFormData(p => ({...p, isSellingSpell: false}))} className={`flex-1 rounded-lg text-[9px] font-black uppercase transition-all ${!formData.isSellingSpell ? 'bg-emerald-600 text-white shadow-md' : 'text-stone-600'}`}>เก็บ</button></div>
                </div>
                {formData.runMode === 'aogh' && (
                  <div className="flex gap-4 items-end animate-in slide-in-from-top-1">
                    <div className="flex-1 space-y-2"><label className={`text-[9px] font-black uppercase tracking-widest flex items-center gap-1 text-rose-400`}><SVGs.Magic className="w-3 h-3"/> {t.itemMagic}</label><input type="number" value={formData.contMagicCount} onChange={e => setFormData(p => ({...p, contMagicCount: e.target.value}))} className={`w-full border rounded-xl p-3 font-bold text-sm outline-none ${theme === 'dark' ? 'bg-slate-950 border-slate-800 text-white' : 'bg-[#f9f7f2] border-stone-300 text-stone-900'}`} /></div>
                    <div className={`flex p-1 rounded-xl border w-32 shrink-0 h-[46px] ${theme === 'dark' ? 'bg-slate-950 border-slate-800' : 'bg-[#f0ede6] border-stone-300'}`}><button type="button" onClick={() => setFormData(p => ({...p, isSellingMagic: true}))} className={`flex-1 rounded-lg text-[9px] font-black uppercase transition-all ${formData.isSellingMagic ? 'bg-rose-600 text-white shadow-md' : 'text-stone-600'}`}>ขาย</button><button type="button" onClick={() => setFormData(p => ({...p, isSellingMagic: false}))} className={`flex-1 rounded-lg text-[9px] font-black uppercase transition-all ${!formData.isSellingMagic ? 'bg-emerald-600 text-white shadow-md' : 'text-stone-600'}`}>เก็บ</button></div>
                  </div>
                )}
              </div>
              <div className="space-y-4 pt-4 border-t border-stone-200 dark:border-slate-800">
                <div className="flex justify-between items-center"><label className={`text-[9px] font-black uppercase tracking-widest flex items-center gap-1 ${themeClasses.textDim}`}><FileText size={12}/> {t.notes}</label><button type="button" onClick={() => setFormData(p => ({...p, otherCosts: [...p.otherCosts, {name: "", amount: ""}]}))} className="text-[9px] font-black text-blue-500 hover:text-blue-600 transition-colors uppercase">+ {t.etc}</button></div>
                {formData.otherCosts.map((cost, idx) => (
                  <div key={idx} className="flex gap-2"><input type="text" value={cost.name} onChange={e => { const nc = [...formData.otherCosts]; nc[idx].name = e.target.value; setFormData(p => ({...p, otherCosts: nc})); }} placeholder="ชื่อรายการ" className={`flex-[2] border rounded-lg p-2.5 font-bold text-xs outline-none ${theme === 'dark' ? 'bg-slate-950 border-slate-800 text-white' : 'bg-[#f9f7f2] border-stone-300 text-stone-900'}`} /><input type="number" value={cost.amount} onChange={e => { const nc = [...formData.otherCosts]; nc[idx].amount = e.target.value; setFormData(p => ({...p, otherCosts: nc})); }} className={`flex-1 border rounded-lg p-2.5 font-bold text-xs outline-none text-right ${theme === 'dark' ? 'bg-slate-950 border-slate-800 text-white' : 'bg-[#f9f7f2] border-stone-300 text-stone-900'}`} /><button type="button" onClick={() => setFormData(p => ({...p, otherCosts: p.otherCosts.filter((_, i) => i !== idx)}))} className="text-rose-500 hover:text-rose-400"><MinusCircle size={18} /></button></div>
                ))}
                <textarea value={formData.notes} onChange={e => setFormData(p => ({...p, notes: e.target.value}))} placeholder="บันทึก..." className={`w-full border rounded-xl p-4 text-xs outline-none h-24 resize-none transition-all ${theme === 'dark' ? 'bg-slate-950 border-slate-800 text-white focus:border-purple-500' : 'bg-[#f9f7f2] border-stone-300 text-stone-900 focus:border-purple-400'}`} />
              </div>
              <div className="flex gap-4 pt-4"><button type="button" onClick={() => setIsAdding(false)} className={`flex-1 py-4 rounded-xl font-black uppercase text-xs transition-all ${theme === 'dark' ? 'bg-slate-800 hover:bg-slate-700 text-white' : 'bg-stone-200 hover:bg-stone-300 text-stone-600'}`}>{t.cancel}</button><button type="submit" className="flex-[2] bg-gradient-to-r from-purple-600 to-pink-600 text-white py-4 rounded-xl font-black uppercase text-xs shadow-lg active:scale-95 transition-all">{t.save}</button></div>
            </form>
          </div>
        ) : (
          /* Dashboard Content */
          <div className="grid grid-cols-1 lg:grid-cols-3 gap-6 animate-in fade-in duration-300">
            <div className="lg:col-span-2 space-y-6">
              
              <div className="grid grid-cols-1 md:grid-cols-3 gap-5">
                <div onClick={() => setShowDetailChart('profit')} className={`p-6 rounded-3xl group flex flex-col justify-between text-left relative transition-all border cursor-pointer ${themeClasses.card} hover:border-emerald-500/30`}>
                  <div className="absolute top-4 right-4 text-stone-400 opacity-0 group-hover:opacity-100 transition-opacity"><Maximize2 size={12}/></div>
                  <div>
                    <div className="p-2.5 bg-emerald-500/10 rounded-xl text-emerald-500 w-fit mb-4 group-hover:scale-110 transition-transform"><Wallet size={20} /></div>
                    <h3 className={`text-[10px] font-black uppercase tracking-widest mb-1 ${themeClasses.textDim}`}>{t.netProfit}</h3>
                    <p className={`text-2xl font-black ${themeClasses.textMain}`}>{formatMZeny(stats.totalNetProfit)} <span className="text-[10px] opacity-40 ml-1">Z</span></p>
                    <p className={`text-[9px] font-bold mt-1 uppercase tracking-tighter opacity-70 italic ${themeClasses.textDim}`}>{t.totalBothModes}</p>
                  </div>
                  <div className={`mt-3 pt-2 border-t space-y-0.5 ${theme === 'dark' ? 'border-slate-800/50' : 'border-stone-200'}`}>
                    <p className="text-[8px] font-black text-purple-500 uppercase">{t.fromSpell}: <span className={themeClasses.textMain}>{formatZeny(stats.manualSpellRevenue)}</span></p>
                    <p className="text-[8px] font-black text-rose-500 uppercase">{t.fromMagic}: <span className={themeClasses.textMain}>{formatZeny(stats.manualMagicRevenue)}</span></p>
                  </div>
                </div>

                <div className={`p-6 rounded-3xl relative overflow-hidden flex flex-col justify-between group transition-all border ${themeClasses.card} hover:border-blue-500/30`}>
                  <div className="absolute top-4 right-4 text-stone-400 opacity-0 group-hover:opacity-100 transition-opacity"><Maximize2 size={12}/></div>
                  <div onClick={() => setShowDetailChart('avgRevenue')} className="cursor-pointer h-full flex flex-col justify-between">
                    <div>
                      <div className="flex justify-between items-start mb-4">
                        <div className="p-2.5 bg-blue-500/10 rounded-xl text-blue-500 w-fit"><TrendingUp size={20} /></div>
                        <div onClick={(e) => e.stopPropagation()} className={`flex p-1 rounded-xl border ${theme === 'dark' ? 'bg-slate-950 border-slate-800' : 'bg-[#f0ede6] border-stone-200'}`}>
                          <button onClick={() => setActiveTab('ogh')} className={`px-3 py-1 rounded-lg text-[8px] font-black uppercase transition-all ${activeTab === 'ogh' ? 'bg-purple-600 text-white shadow-md' : 'text-stone-500'}`}>OGH</button>
                          <button onClick={() => setActiveTab('aogh')} className={`px-3 py-1 rounded-lg text-[8px] font-black uppercase transition-all ${activeTab === 'aogh' ? 'bg-rose-600 text-white shadow-md' : 'text-stone-500'}`}>AOGH</button>
                        </div>
                      </div>
                      <h3 className={`text-[10px] font-black uppercase tracking-widest mb-1 ${themeClasses.textDim}`}>{t.avgRev}</h3>
                      <p className={`text-2xl font-black ${themeClasses.textMain}`}>{formatMZeny(stats.avgRevenue)} <span className="text-[10px] opacity-40 ml-1">Z</span></p>
                    </div>
                    <div className={`mt-4 pt-3 border-t space-y-1.5 ${theme === 'dark' ? 'border-slate-800/50' : 'border-stone-200'}`}>
                      <div className="flex items-center justify-between text-[10px]"><span className={themeClasses.textDim}>{t.avgMin}</span><span className="text-blue-500 font-black">{formatZeny(stats.avgRevMin)} Z</span></div>
                      <div className="flex gap-2">
                        <span className="text-[8px] font-bold text-emerald-500 bg-emerald-500/5 px-1.5 rounded uppercase">{t.max}: {formatMZeny(stats.maxRevenue)}</span>
                        <span className="text-[8px] font-bold text-rose-500 bg-rose-500/5 px-1.5 rounded uppercase">{t.min}: {formatMZeny(stats.minRevenue)}</span>
                      </div>
                    </div>
                  </div>
                </div>

                <div onClick={() => setShowDetailChart('inventory')} className={`p-6 rounded-3xl flex flex-col justify-between text-left group transition-all border cursor-pointer relative ${themeClasses.card} hover:border-amber-500/30`}>
                  <div className="absolute top-4 right-4 text-stone-400 opacity-0 group-hover:opacity-100 transition-opacity"><Maximize2 size={12}/></div>
                  <div>
                    <div className="flex justify-between items-start mb-4">
                      <div className="p-2.5 bg-amber-500/10 rounded-xl text-amber-500 w-fit"><Archive size={20} /></div>
                      <div className="text-right"><p className={`text-[8px] font-black uppercase tracking-widest ${themeClasses.textDim}`}>{t.currentValue}</p><p className="text-xs font-black text-amber-600">{formatMZeny(stats.inventoryValue)} <span className={`text-[8px] opacity-40`}>Z</span></p></div>
                    </div>
                    <h3 className={`text-[10px] font-black uppercase tracking-widest mb-1 ${themeClasses.textDim}`}>{t.inventory}</h3>
                    <div className="space-y-3 mt-2" onClick={(e) => e.stopPropagation()}>
                      <div className="flex items-center justify-between group/line"><div className="flex items-center gap-2"><SVGs.Spell className="w-4 h-4"/><span className={`text-[9px] font-black uppercase tracking-tighter ${themeClasses.textDim}`}>{t.itemSpell}</span></div><div className="flex items-center gap-2"><span className={`text-xs font-black ${themeClasses.textMain}`}>{stats.stockSpell.toLocaleString()}</span><button onClick={() => { setSaleItem('spell'); setShowSaleModal(true); setSaleFormData({ quantity: stats.stockSpell.toString(), price: globalPrices.purpleStonePrice.toString() }); }} className="bg-purple-600/10 hover:bg-purple-600 text-purple-600 hover:text-white px-2 py-1 rounded-md text-[8px] font-black uppercase transition-all shadow-sm">ขาย</button></div></div>
                      <div className="flex items-center justify-between group/line"><div className="flex items-center gap-2"><SVGs.Magic className="w-4 h-4"/><span className={`text-[9px] font-black uppercase tracking-tighter ${themeClasses.textDim}`}>{t.itemMagic}</span></div><div className="flex items-center gap-2"><span className={`text-xs font-black ${themeClasses.textMain}`}>{stats.stockMagic.toLocaleString()}</span><button onClick={() => { setSaleItem('magic'); setShowSaleModal(true); setSaleFormData({ quantity: stats.stockMagic.toString(), price: globalPrices.contMagicPrice.toString() }); }} className="bg-rose-600/10 hover:bg-rose-600 text-rose-600 hover:text-white px-2 py-1 rounded-md text-[8px] font-black uppercase transition-all shadow-sm">ขาย</button></div></div>
                    </div>
                  </div>
                </div>
              </div>

              {/* Chart */}
              {tableData.length > 0 && (
                <div className={`border p-6 rounded-[2rem] h-[360px] flex flex-col transition-all ${themeClasses.card}`}>
                  <div className="flex justify-between items-center mb-6 px-2"><h2 className={`text-sm font-black uppercase tracking-widest flex items-center gap-2 italic ${themeClasses.textMain}`}><TrendingUp size={16} className="text-purple-500" /> {t.stats} ({activeTab.toUpperCase()})</h2><div className={`flex p-1 rounded-xl border ${theme === 'dark' ? 'bg-slate-950 border-slate-800' : 'bg-[#f0ede6] border-stone-200'}`}><button onClick={() => setChartMode('profit')} className={`px-4 py-1.5 rounded-lg text-[9px] font-black uppercase transition-all ${chartMode === 'profit' ? 'bg-purple-600 text-white shadow-md' : 'text-stone-500'}`}>{t.profit}</button><button onClick={() => setChartMode('revenue')} className={`px-4 py-1.5 rounded-lg text-[9px] font-black uppercase transition-all ${chartMode === 'revenue' ? 'bg-emerald-600 text-white shadow-md' : 'text-stone-500'}`}>{t.revenue}</button></div></div>
                  <div className="flex-1 w-full"><ResponsiveContainer width="100%" height="100%"><LineChart data={[...filteredData].reverse()}><CartesianGrid strokeDasharray="3 3" stroke={theme === 'dark' ? '#1e293b' : '#d1cebd'} vertical={false} /><XAxis dataKey="date" stroke="#94a3b8" fontSize={9} axisLine={false} tickLine={false} dy={5} /><YAxis stroke="#94a3b8" fontSize={9} tickFormatter={v => `${(v/1000).toFixed(0)}k`} axisLine={false} tickLine={false} /><Tooltip contentStyle={{ backgroundColor: theme === 'dark' ? '#0f172a' : '#faf9f6', border: `1px solid ${theme === 'dark' ? '#1e293b' : '#d6d3c1'}`, borderRadius: '12px', fontSize: '10px', color: theme === 'dark' ? '#fff' : '#444' }} formatter={v => [formatZeny(v), t[chartMode]]} /><Line type="monotone" dataKey={chartMode} stroke={chartMode === 'profit' ? '#a855f7' : '#10b981'} strokeWidth={3} dot={{ r: 3, fill: theme === 'dark' ? '#020617' : '#fff', strokeWidth: 2 }} activeDot={{ r: 5 }} /></LineChart></ResponsiveContainer></div>
                </div>
              )}

              {/* History Table */}
              <div className={`border rounded-[2rem] overflow-hidden shadow-xl transition-all ${themeClasses.card}`}>
                <div className={`p-6 border-b flex justify-between items-center transition-all ${theme === 'dark' ? 'bg-slate-950/20 border-slate-800' : 'bg-stone-50/50 border-stone-200'}`}><h2 className="text-sm font-black text-blue-600 italic flex items-center gap-2 uppercase tracking-widest"><HistoryIcon size={18} /> {t.history}</h2></div>
                <div className="overflow-x-auto">
                  <table className="w-full text-left text-[10px]">
                    <thead className={theme === 'dark' ? 'bg-slate-950/40' : 'bg-[#f0ede6]'}><tr><th className={`px-6 py-4 font-black uppercase tracking-widest ${themeClasses.textDim}`}>{t.date}</th><th className={`px-6 py-4 font-black uppercase tracking-widest ${themeClasses.textDim}`}>{t.mode}</th><th className={`px-6 py-4 font-black uppercase tracking-widest ${themeClasses.textDim}`}>{t.itemGum} / {t.itemSilvervine} / {t.stone}</th><th className={`px-6 py-4 text-right font-black uppercase tracking-widest ${themeClasses.textDim}`}>{t.netProfit}</th><th className="px-6 py-4"></th></tr></thead>
                    <tbody className={`divide-y transition-all ${theme === 'dark' ? 'divide-slate-800/40' : 'divide-stone-200'}`}>
                      {tableData.map(record => (
                        <React.Fragment key={record.id}>
                          <tr className={`hover:bg-stone-400/5 cursor-pointer transition-colors ${theme === 'dark' ? '' : 'text-stone-700'}`} onClick={() => setExpandedId(expandedId === record.id ? null : record.id)}>
                            <td className="px-6 py-4 font-bold whitespace-nowrap">{record.date}</td>
                            <td className="px-6 py-4"><span className={`px-2 py-0.5 rounded text-[8px] font-black uppercase ${record.mode === 'aogh' ? 'bg-rose-500/10 text-rose-500 border border-rose-500/20' : 'bg-purple-500/10 text-purple-500 border border-purple-500/20'}`}>{record.mode || 'ogh'}</span></td>
                            <td className="px-6 py-4 whitespace-nowrap"><div className="flex gap-2 items-center"><span className="bg-blue-500/10 text-blue-500 px-1.5 py-0.5 rounded font-black border border-blue-500/10">{t.gumShort} {record.gumUsed}</span><SVGs.Silvervine className="w-4 h-4" style={{ filter: record.useSilvervine ? 'none' : 'grayscale(100%)', opacity: record.useSilvervine ? 1 : 0.2 }} /><div className="flex items-center gap-1 text-purple-500 font-black ml-1"><SVGs.Spell className="w-3.5 h-3.5"/>{record.purpleStoneCount || 0}</div>{record.mode === 'aogh' && <div className="flex items-center gap-1 text-rose-500 font-black"><SVGs.Magic className="w-3.5 h-3.5"/>{record.contMagicCount || 0}</div>}</div></td>
                            <td className={`px-6 py-4 text-right font-black text-sm ${record.profit >= 0 ? 'text-emerald-600' : 'text-rose-600'}`}>{formatZeny(record.profit)}</td>
                            <td className="px-4 py-4 text-center"><button onClick={(e) => { e.stopPropagation(); handleDelete(record.id); }} className={`${themeClasses.textDim} hover:text-rose-600 transition-colors p-1`}><Trash2 size={12}/></button></td>
                          </tr>
                          {expandedId === record.id && (
                            <tr className={`border-l-4 border-purple-500 animate-in slide-in-from-left-1 transition-all ${theme === 'dark' ? 'bg-slate-950/40' : 'bg-[#f5f3ee]'}`}><td colSpan="5" className="px-6 py-6"><div className="grid grid-cols-2 md:grid-cols-4 gap-6"><div><p className={`font-black mb-2 uppercase text-[8px] tracking-widest ${themeClasses.textDim}`}>{t.costBreakdown}</p><p className="flex justify-between">{t.itemGum}: <span className={themeClasses.textMain}>{formatZeny(record.gumCost)} Z</span></p><p className="flex justify-between">{t.itemSilvervine}: <span className={themeClasses.textMain}>{formatZeny(record.silvervineCost)} Z</span></p>{(record.otherCosts || []).map((o,i) => <p key={i} className="flex justify-between">{t.etc} ({o.name}): <span className={themeClasses.textMain}>{formatZeny(o.amount)} Z</span></p>)}</div><div><p className={`font-black mb-2 uppercase text-[8px] tracking-widest ${themeClasses.textDim}`}>{t.revSource}</p><p className="flex justify-between">ขยะ: <span className={themeClasses.textMain}>{formatZeny(record.trashAmount)} Z</span></p><p className="flex justify-between">{t.stone}: <span className={themeClasses.textMain}>{formatZeny(record.revenue - record.trashAmount)} Z</span></p></div><div className="col-span-2"><p className={`font-black mb-2 uppercase text-[8px] tracking-widest ${themeClasses.textDim}`}>{t.notes}</p><p className={`italic p-3 rounded-xl min-h-[50px] whitespace-pre-wrap border ${theme === 'dark' ? 'bg-slate-950/50 border-slate-800 text-slate-400' : 'bg-white border-stone-200 text-stone-600'}`}>{record.notes || '-'}</p></div></div></td></tr>
                          )}
                        </React.Fragment>
                      ))}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>

            <aside className="space-y-6">
              <div className={`border p-6 rounded-[2rem] shadow-xl border-t-rose-500/20 transition-all ${themeClasses.card}`}>
                <h3 className="text-[10px] font-black mb-5 text-rose-500 uppercase tracking-widest flex items-center gap-2 italic"><Clock size={14} /> {t.timer}</h3>
                <div className={`text-4xl font-black tabular-nums mb-6 text-center py-8 rounded-[2rem] border shadow-inner transition-all ${theme === 'dark' ? 'bg-slate-950/80 border-slate-800 text-white' : 'bg-[#f0ede6] border-stone-200 text-stone-900'}`}>{formatTimer(timeInMs)}</div>
                <div className="grid grid-cols-2 gap-3">
                  {!isTimerActive || isTimerPaused ? (
                    <button onClick={() => { setIsTimerActive(true); setIsTimerPaused(false); }} className="bg-emerald-600 hover:bg-emerald-500 text-white py-4 rounded-xl font-black text-[10px] uppercase flex items-center justify-center gap-1.5 transition-all active:scale-95 shadow-lg"><Play size={12} fill="currentColor" /> {timeInMs > 0 ? "ทำต่อ" : "เริ่ม"}</button>
                  ) : (
                    <button onClick={() => setIsTimerPaused(true)} className="bg-amber-600 hover:bg-amber-500 text-white py-4 rounded-xl font-black text-[10px] uppercase flex items-center justify-center gap-1.5 transition-all active:scale-95 shadow-lg"><Pause size={12} fill="currentColor" /> พัก</button>
                  )}
                  <button onClick={() => { setFormData(p => ({...p, minutesUsed: Math.ceil(timeInMs / 60000) || 1})); setIsTimerActive(false); setIsTimerPaused(true); setIsAdding(true); }} className={`py-4 rounded-xl font-black text-[10px] uppercase flex items-center justify-center gap-1.5 transition-all active:scale-95 group shadow-lg ${theme === 'dark' ? 'bg-slate-800 hover:bg-rose-600 text-white' : 'bg-stone-300 hover:bg-rose-600 hover:text-white text-stone-700'}`}><Square size={12} fill="currentColor" className="group-hover:text-white" /> หยุด</button>
                  <button onClick={() => { setTimeInMs(0); setIsTimerActive(false); setIsTimerPaused(true); }} className={`col-span-2 py-2 text-[9px] font-black uppercase transition-colors ${themeClasses.textDim} hover:text-rose-600`}>รีเซต</button>
                </div>
              </div>
            </aside>
          </div>
        )}

        {/* Modal Chart */}
        {showDetailChart && (
          <div className="fixed inset-0 z-[300] flex items-center justify-center p-4 md:p-10 bg-black/60 backdrop-blur-md animate-in fade-in duration-300">
            <div className={`border w-full max-w-5xl p-6 md:p-10 rounded-[3rem] shadow-2xl flex flex-col h-full max-h-[85vh] relative transition-all ${theme === 'dark' ? 'bg-slate-900 border-slate-800' : 'bg-[#e5e2da] border-stone-300'}`} onClick={e => e.stopPropagation()}>
              <button onClick={() => setShowDetailChart(null)} className={`${themeClasses.textDim} hover:text-rose-500 absolute top-8 right-8 transition-all`}><X size={24} /></button>
              <div className="flex flex-col md:flex-row md:items-center justify-between gap-6 mb-8">
                <div><h3 className={`text-2xl font-black uppercase italic tracking-tight flex items-center gap-3 ${themeClasses.textMain}`}>{showDetailChart === 'profit' ? <><Wallet className="text-emerald-500"/> {t.netProfit}</> : showDetailChart === 'avgRevenue' ? <><TrendingUp className="text-blue-500"/> {t.avgRev} ({activeTab.toUpperCase()})</> : <><Archive className="text-amber-500"/> {t.assetTrend}</>}</h3><p className={`text-[10px] font-bold uppercase mt-1 ${themeClasses.textDim}`}>{t.viewDetails}</p></div>
                <div className={`flex p-1 rounded-2xl border ${theme === 'dark' ? 'bg-slate-950 border-slate-800' : 'bg-white/50 border-stone-300 shadow-sm'}`}>
                  {[{ label: t.range1W, value: '7D' }, { label: t.range1M, value: '30D' }, { label: t.range3M, value: '3M' }, { label: t.range1Y, value: '1Y' }].map(r => (<button key={r.value} onClick={() => setChartRange(r.value)} className={`px-4 py-2 rounded-xl text-[10px] font-black uppercase transition-all ${chartRange === r.value ? 'bg-purple-600 text-white shadow-md' : 'text-stone-500 hover:text-stone-900'}`}>{r.label}</button>))}
                </div>
              </div>
              <div className="flex-1 w-full mt-4"><ResponsiveContainer width="100%" height="100%"><LineChart data={chartPopupData}><CartesianGrid strokeDasharray="3 3" stroke={theme === 'dark' ? '#1e293b' : '#d1cebd'} vertical={false} /><XAxis dataKey="date" stroke="#94a3b8" fontSize={11} axisLine={false} tickLine={false} dy={10} /><YAxis stroke="#94a3b8" fontSize={11} tickFormatter={v => `${(v/1000).toFixed(0)}k`} axisLine={false} tickLine={false} dx={-5} /><Tooltip contentStyle={{ backgroundColor: theme === 'dark' ? '#0f172a' : '#faf9f6', border: `1px solid ${theme === 'dark' ? '#1e293b' : '#d6d3c1'}`, borderRadius: '16px', fontSize: '12px', fontWeight: 'bold' }} formatter={v => [formatZeny(v), 'Zeny']} /><Line type="monotone" dataKey={showDetailChart === 'profit' ? 'profit' : showDetailChart === 'avgRevenue' ? 'revenue' : 'stoneValue'} stroke={showDetailChart === 'profit' ? '#10b981' : showDetailChart === 'avgRevenue' ? '#3b82f6' : '#f59e0b'} strokeWidth={4} dot={{ r: 4, fill: theme === 'dark' ? '#020617' : '#fff', strokeWidth: 2 }} activeDot={{ r: 6 }} /></LineChart></ResponsiveContainer></div>
            </div>
          </div>
        )}

        {showSaleModal && (
          <div className="fixed inset-0 z-[200] flex items-center justify-center p-6 bg-black/60 backdrop-blur-md animate-in fade-in duration-200" onClick={() => setShowSaleModal(false)}>
            <div className={`border w-full max-w-sm p-8 rounded-[3rem] shadow-2xl relative transition-all ${theme === 'dark' ? 'bg-slate-900 border-slate-800' : 'bg-white border-stone-300'}`} onClick={e => e.stopPropagation()}>
              <button onClick={() => setShowSaleModal(false)} className={`${themeClasses.textDim} hover:text-rose-500 absolute top-6 right-6`}><X size={20} /></button>
              <div className="flex items-center gap-3 mb-6"><div className="p-3 bg-purple-500/10 rounded-2xl text-purple-600">{saleItem === 'spell' ? <SVGs.Spell className="w-8 h-8" /> : <SVGs.Magic className="w-8 h-8" />}</div><div><h3 className={`text-xl font-black uppercase italic ${themeClasses.textMain}`}>{t.sellPopup}</h3><p className={`text-[10px] font-black uppercase tracking-widest ${themeClasses.textDim}`}>{saleItem === 'spell' ? t.itemSpell : t.itemMagic}</p></div></div>
              <div className="space-y-4">
                <div className="space-y-1.5"><label className={`text-[9px] font-black uppercase tracking-widest ${themeClasses.textDim}`}>{t.sellQuantity} (Max: {saleItem === 'spell' ? stats.stockSpell : stats.stockMagic})</label><input type="number" value={saleFormData.quantity} onChange={e => setSaleFormData({...saleFormData, quantity: e.target.value})} className={`w-full border rounded-xl p-4 font-bold outline-none focus:border-purple-500 ${theme === 'dark' ? 'bg-slate-950 border-slate-800 text-white' : 'bg-stone-50 border-stone-200 text-stone-900'}`} placeholder="0" /></div>
                <div className="space-y-1.5"><label className={`text-[9px] font-black uppercase tracking-widest ${themeClasses.textDim}`}>{t.sellPrice}</label><input type="number" value={saleFormData.price} onChange={e => setSaleFormData({...saleFormData, price: e.target.value})} className={`w-full border rounded-xl p-4 font-bold outline-none focus:border-purple-500 ${theme === 'dark' ? 'bg-slate-950 border-slate-800 text-white' : 'bg-stone-50 border-stone-200 text-stone-900'}`} placeholder="0" /></div>
              </div>
              <button onClick={handleManualSell} className="w-full mt-8 bg-gradient-to-r from-purple-600 to-pink-600 text-white py-4 rounded-xl font-black uppercase text-xs shadow-lg shadow-purple-600/20 active:scale-95 transition-all">{t.confirmSell}</button>
            </div>
          </div>
        )}

        {showManual && (
          <div className="fixed inset-0 z-[100] flex items-center justify-center p-6 bg-black/60 backdrop-blur-md animate-in fade-in duration-200" onClick={() => setShowManual(false)}>
            <div className={`border w-full max-sm p-10 rounded-[3rem] shadow-2xl relative transition-all ${theme === 'dark' ? 'bg-slate-900 border-slate-800 text-white' : 'bg-[#e5e2da] border-stone-300 text-stone-900'}`} onClick={e => e.stopPropagation()}>
              <button onClick={() => setShowManual(false)} className={`${themeClasses.textDim} absolute top-8 right-8 hover:text-rose-600`}><X size={20} /></button>
              <h3 className="text-xl font-black mb-8 text-purple-600 italic uppercase">{t.install} Guide</h3>
              <div className="space-y-6 text-xs text-stone-600">
                <div className="space-y-2"><p className={`font-black uppercase text-[9px] tracking-widest ${themeClasses.textMain}`}>สำหรับ iOS (Safari)</p><p className={`p-4 rounded-2xl border ${theme === 'dark' ? 'bg-slate-950 border-slate-800' : 'bg-white/50 border-stone-300'}`}>กดปุ่มแชร์ &gt; เลือก <span className="text-blue-600 font-bold">"เพิ่มไปยังหน้าจอโฮม"</span></p></div>
                <div className="space-y-2"><p className={`font-black uppercase text-[9px] tracking-widest ${themeClasses.textMain}`}>สำหรับ Android (Chrome)</p><p className={`p-4 rounded-2xl border ${theme === 'dark' ? 'bg-slate-950 border-slate-800' : 'bg-white/50 border-stone-300'}`}>กดปุ่มเมนู (จุดสามจุด) &gt; เลือก <span className="text-purple-600 font-bold">"ติดตั้งแอป"</span></p></div>
              </div>
              <button onClick={() => setShowManual(false)} className={`w-full mt-10 py-4 rounded-xl font-black uppercase text-[10px] tracking-widest transition-all ${theme === 'dark' ? 'bg-slate-800 hover:bg-slate-700' : 'bg-stone-300 hover:bg-stone-400'}`}>Close</button>
            </div>
          </div>
        )}
      </div>
    </div>
  );
}
