<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>OGH Farm - SDekza RO</title>
    
    <!-- Mobile Web App Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#020617">
    <meta name="application-name" content="OGH Farm">

    <!-- App Icons -->
    <link rel="icon" type="image/png" href="icon.png">
    <link rel="apple-touch-icon" href="icon.png">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React Dependencies -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/prop-types@15.8.1/prop-types.min.js"></script>
    <!-- Recharts (UMD version) -->
    <script src="https://unpkg.com/recharts@2.12.7/umd/Recharts.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Firebase SDKs -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
      import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
      import { getFirestore, doc, setDoc, getDoc, collection, query, onSnapshot, addDoc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

      window.FirebaseSDK = { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut, getFirestore, doc, setDoc, getDoc, collection, query, onSnapshot, addDoc, updateDoc, deleteDoc };
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            background-color: #020617; 
            color: #f8fafc;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
        }
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }
        
        .custom-scrollbar::-webkit-scrollbar { width: 4px; height: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
        
        .animate-fade-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .safe-area-pb { padding-bottom: env(safe-area-inset-bottom, 20px); }

        .btn-google {
            background-color: white;
            color: #1f2937;
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 16px;
            border-radius: 12px;
            font-weight: 700;
            font-size: 12px;
            transition: all 0.2s;
            cursor: pointer;
        }
        .btn-google:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(255,255,255,0.1); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // ==========================================
        // üî¥ ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 1: ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡πÄ‡∏ß‡πá‡∏ö (YOU) üî¥
        // ==========================================
        const OWNER_CONFIG = {
          apiKey: "AIzaSyAbWzr8o_OhkjGbEetBYq_nzYmVZ2fTf40",
          authDomain: "rocogh-88a38.firebaseapp.com",
          projectId: "rocogh-88a38",
          storageBucket: "rocogh-88a38.firebasestorage.app",
          messagingSenderId: "1025971309206",
          appId: "1:1025971309206:web:d4f9e0ab6bb016dde590b7",
          measurementId: "G-04JN1ERQ4T"
        };
        // ==========================================


        const { useState, useEffect, useMemo, useRef } = React;
        const Recharts = window.Recharts || { LineChart: () => null, Line: () => null, XAxis: () => null, YAxis: () => null, CartesianGrid: () => null, Tooltip: () => null, ResponsiveContainer: () => null };
        const { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer } = Recharts;

        const Icon = ({ name, size = 20, className = "" }) => {
            useEffect(() => { if (window.lucide) window.lucide.createIcons(); }, [name]);
            return <i data-lucide={name} className={className} style={{ width: size, height: size }}></i>;
        };

        const Zeny16Bit = ({ className }) => (
            <svg viewBox="0 0 32 32" className={className} xmlns="http://www.w3.org/2000/svg" shapeRendering="crispEdges">
                <rect x="10" y="4" width="12" height="24" fill="#FFD700" rx="4" />
                <rect x="8" y="6" width="16" height="20" fill="#FFD700" />
                <rect x="10" y="6" width="12" height="20" fill="#FFEC8B" /> 
                <path d="M12 4 L20 4 L22 6 L22 26 L20 28 L12 28 L10 26 L10 6 Z" fill="none" stroke="#B8860B" strokeWidth="2" />
                <path d="M14 10 L20 10 L20 12 L16 18 L20 18 L20 20 L12 20 L12 18 L16 12 L12 12 Z" fill="#8B4513" />
            </svg>
        );

        const BubbleGum16Bit = ({ className }) => (
            <svg viewBox="0 0 32 32" className={className} xmlns="http://www.w3.org/2000/svg" shapeRendering="crispEdges">
                <rect x="6" y="14" width="20" height="8" fill="#42A5F5" />
                <rect x="4" y="16" width="2" height="4" fill="#1E88E5" />
                <rect x="26" y="16" width="2" height="4" fill="#1E88E5" />
                <circle cx="16" cy="12" r="6" fill="#F06292" />
                <circle cx="14" cy="10" r="2" fill="#F48FB1" />
                <rect x="8" y="15" width="16" height="1" fill="#90CAF9" opacity="0.5" />
            </svg>
        );

        const CoagulatedSpell16Bit = ({ className }) => (
            <svg viewBox="0 0 32 32" className={className} xmlns="http://www.w3.org/2000/svg" shapeRendering="crispEdges">
                <path d="M16 4 L24 12 L24 22 L16 28 L8 22 L8 12 Z" fill="#7E57C2" />
                <path d="M16 6 L22 12 L22 20 L16 26 L10 20 L10 12 Z" fill="#9575CD" />
                <path d="M16 4 L16 28" stroke="#D1C4E9" strokeWidth="1" opacity="0.4" />
                <rect x="13" y="10" width="2" height="2" fill="#EDE7F6" />
                <rect x="18" y="18" width="1" height="1" fill="#EDE7F6" />
            </svg>
        );

        const Silvervine16Bit = ({ className }) => (
            <svg viewBox="0 0 32 32" className={className} xmlns="http://www.w3.org/2000/svg" shapeRendering="crispEdges">
                <rect x="8" y="10" width="16" height="14" fill="#5D4037" />
                <rect x="14" y="4" width="4" height="6" fill="#4CAF50" />
                <rect x="14" y="14" width="4" height="4" fill="#FFD600" />
                <rect x="8" y="10" width="16" height="2" fill="#795548" />
            </svg>
        );

        const App = () => {
            // Helpers
            const formatZeny = (num) => new Intl.NumberFormat('th-TH').format(Math.round(num || 0));
            const formatMZeny = (num) => (Number(num || 0) / 1000000).toFixed(2) + " M";
            
            const formatTimerDisplay = (ms) => {
                const mins = Math.floor(ms / 60000);
                const secs = Math.floor((ms % 60000) / 1000);
                const centi = Math.floor((ms % 1000) / 10);
                return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}:${centi.toString().padStart(2, '0')}`;
            };

            const convertToISO = (displayDate) => {
                if (!displayDate) return "";
                const parts = displayDate.split('/');
                return parts.length === 3 ? `${parts[2]}-${parts[1]}-${parts[0]}` : displayDate;
            };

            const convertToDisplay = (isoDate) => {
                if (!isoDate) return "";
                const parts = isoDate.split('-');
                return parts.length === 3 ? `${parts[2]}/${parts[1]}/${parts[0]}` : isoDate;
            };

            // State
            const [records, setRecords] = useState(() => {
                const saved = localStorage.getItem('ogh_records');
                return saved ? JSON.parse(saved) : [];
            });
            const [globalPrices, setGlobalPrices] = useState(() => {
                const saved = localStorage.getItem('ogh_prices');
                return saved ? JSON.parse(saved) : {
                    purpleStonePrice: 15000,
                    gumBoxPrice: 1000000,
                    silvervineBoxPrice: 2000000,
                };
            });

            // UI State
            const [isAdding, setIsAdding] = useState(false);
            const [showManual, setShowManual] = useState(false);
            const [showConfigModal, setShowConfigModal] = useState(false);
            const [configInput, setConfigInput] = useState("");
            const [editingId, setEditingId] = useState(null);
            const [chartMode, setChartMode] = useState('profit');
            const [gumFilter, setGumFilter] = useState('all');
            const [sortOrder, setSortOrder] = useState('date-desc');
            const [expandedId, setExpandedId] = useState(null);

            // Timer State
            const [timeInMs, setTimeInMs] = useState(0);
            const [isTimerActive, setIsTimerActive] = useState(false);
            const [isTimerPaused, setIsTimerPaused] = useState(true);
            const timerRef = useRef(null);

            // Form Data
            const [formData, setFormData] = useState({
                date: new Date().toLocaleDateString('th-TH'),
                gumUsed: 0,
                trashAmount: "",
                purpleStoneCount: "",
                isSellingSpell: false,
                minutesUsed: 60,
                notes: "",
                otherCosts: []
            });

            // Firebase Refs
            const firebaseAppRef = useRef(null);
            const authRef = useRef(null);
            const dbRef = useRef(null);
            const [user, setUser] = useState(null);
            const [isLoading, setIsLoading] = useState(true);

            // Initialize App & Load Config
            useEffect(() => {
                const initSystem = async () => {
                    let fbConfig = OWNER_CONFIG;
                    
                    if (!fbConfig) {
                        const savedConfig = localStorage.getItem('firebase_config_json');
                        if (savedConfig) fbConfig = JSON.parse(savedConfig);
                    }
                    
                    if (!fbConfig && typeof __firebase_config !== 'undefined') {
                        fbConfig = JSON.parse(__firebase_config);
                    }

                    if (fbConfig && window.FirebaseSDK) {
                        try {
                            const { initializeApp, getAuth, getFirestore, onAuthStateChanged } = window.FirebaseSDK;
                            if (!firebaseAppRef.current) {
                                firebaseAppRef.current = initializeApp(fbConfig);
                                authRef.current = getAuth(firebaseAppRef.current);
                                dbRef.current = getFirestore(firebaseAppRef.current);
                            }

                            onAuthStateChanged(authRef.current, (u) => {
                                setUser(u);
                                setIsLoading(false);
                                if (!u) {
                                    const localRecords = localStorage.getItem('ogh_records');
                                    if (localRecords) setRecords(JSON.parse(localRecords));
                                    const localPrices = localStorage.getItem('ogh_prices');
                                    if (localPrices) setGlobalPrices(JSON.parse(localPrices));
                                }
                            });
                        } catch (e) {
                            console.error("Firebase Init Error:", e);
                            setIsLoading(false);
                        }
                    } else {
                        console.log("Running in Local Mode");
                        const localRecords = localStorage.getItem('ogh_records');
                        if (localRecords) setRecords(JSON.parse(localRecords));
                        const localPrices = localStorage.getItem('ogh_prices');
                        if (localPrices) setGlobalPrices(JSON.parse(localPrices));
                        setIsLoading(false);
                    }
                };
                
                if (window.FirebaseSDK) {
                    initSystem();
                } else {
                    setTimeout(initSystem, 500);
                }
            }, []);

            // Data Sync Effect
            useEffect(() => {
                if (!user || !dbRef.current) return;
                setIsLoading(true);

                const { collection, doc, query, onSnapshot, getDoc, setDoc } = window.FirebaseSDK;
                const appId = 'ro-farm-app';
                const recordsRef = collection(dbRef.current, 'artifacts', appId, 'users', user.uid, 'farm_records');
                const pricesRef = doc(dbRef.current, 'artifacts', appId, 'users', user.uid, 'settings', 'prices');

                const unsubRecords = onSnapshot(query(recordsRef), (snapshot) => {
                    const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setRecords(data);
                    setIsLoading(false);
                }, (err) => {
                    console.error("Records Sync Error:", err);
                    setIsLoading(false);
                });

                const fetchPrices = async () => {
                    try {
                        const docSnap = await getDoc(pricesRef);
                        if (docSnap.exists()) {
                            setGlobalPrices(docSnap.data());
                        } else {
                            await setDoc(pricesRef, globalPrices);
                        }
                    } catch(e) { console.error("Prices Sync Error:", e); }
                };
                fetchPrices();

                return () => unsubRecords();
            }, [user]);

            // Save to LocalStorage
            useEffect(() => { 
                if (!user) localStorage.setItem('ogh_records', JSON.stringify(records)); 
            }, [records, user]);
            useEffect(() => { 
                if (!user) localStorage.setItem('ogh_prices', JSON.stringify(globalPrices)); 
            }, [globalPrices, user]);

            // Timer Logic
            useEffect(() => {
                if (isTimerActive && !isTimerPaused) {
                    timerRef.current = setInterval(() => {
                        setTimeInMs(prev => {
                            if (prev >= 3600000) {
                                setIsTimerActive(false);
                                setIsTimerPaused(true);
                                setFormData(f => ({ ...f, minutesUsed: 60 }));
                                return 3600000;
                            }
                            return prev + 10;
                        });
                    }, 10);
                } else { clearInterval(timerRef.current); }
                return () => clearInterval(timerRef.current);
            }, [isTimerActive, isTimerPaused]);

            // Handlers
            const handleTimerStart = () => { setIsTimerActive(true); setIsTimerPaused(false); };
            const handleTimerPause = () => { setIsTimerPaused(true); };
            const handleTimerStop = () => {
                const mins = Math.ceil(timeInMs / 60000);
                setFormData(prev => ({ ...prev, minutesUsed: mins > 0 ? mins : 1 }));
                setIsTimerActive(false);
                setIsTimerPaused(true);
            };
            const handleTimerReset = () => { setTimeInMs(0); setIsTimerActive(false); setIsTimerPaused(true); };

            const handleLogin = async () => {
                if (!authRef.current) {
                    setShowConfigModal(true);
                    return;
                }
                const { GoogleAuthProvider, signInWithPopup } = window.FirebaseSDK;
                const provider = new GoogleAuthProvider();
                try { await signInWithPopup(authRef.current, provider); } catch (error) { console.error("Login Error:", error); }
            };

            const handleLogout = () => {
                if (authRef.current) {
                    const { signOut } = window.FirebaseSDK;
                    signOut(authRef.current);
                    setRecords([]); 
                    window.location.reload(); 
                }
            };

            const saveConfig = () => {
                try {
                    JSON.parse(configInput);
                    localStorage.setItem('firebase_config_json', configInput);
                    window.location.reload();
                } catch (e) {
                    alert("‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö JSON ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö");
                }
            };

            const updatePricesInCloud = async (newPrices) => {
                if (!user || !dbRef.current) return;
                const { doc, setDoc } = window.FirebaseSDK;
                const appId = 'ro-farm-app';
                const pricesRef = doc(dbRef.current, 'artifacts', appId, 'users', user.uid, 'settings', 'prices');
                await setDoc(pricesRef, newPrices);
            };

            const handleSave = async (e) => {
                e.preventDefault();
                
                const dataToSave = {
                    ...formData,
                    id: editingId || Date.now(),
                    timestamp: Date.now(),
                    revenue: Number(formData.trashAmount || 0) + (formData.isSellingSpell ? (Number(formData.purpleStoneCount || 0) * globalPrices.purpleStonePrice) : 0),
                    totalCost: (formData.gumUsed * (globalPrices.gumBoxPrice / 10)) + (2 * (globalPrices.silvervineBoxPrice / 10)) + formData.otherCosts.reduce((a, b) => a + Number(b.amount || 0), 0)
                };
                dataToSave.profit = dataToSave.revenue - dataToSave.totalCost;
                dataToSave.revenuePerMinute = dataToSave.minutesUsed > 0 ? dataToSave.revenue / dataToSave.minutesUsed : 0;

                if (user && dbRef.current) {
                     const { collection, doc, addDoc, updateDoc } = window.FirebaseSDK;
                     const appId = 'ro-farm-app';
                     try {
                        const recordsRef = collection(dbRef.current, 'artifacts', appId, 'users', user.uid, 'farm_records');
                        if (editingId) {
                            const recordRef = doc(dbRef.current, 'artifacts', appId, 'users', user.uid, 'farm_records', editingId);
                            await updateDoc(recordRef, dataToSave);
                        } else {
                            await addDoc(recordsRef, dataToSave);
                        }
                    } catch (err) { console.error("Cloud Save Error:", err); }
                } else {
                    if (editingId) {
                        setRecords(records.map(r => r.id === editingId ? dataToSave : r));
                    } else {
                        setRecords([dataToSave, ...records]);
                    }
                }
                
                setIsAdding(false);
                setEditingId(null);
                setFormData({ date: new Date().toLocaleDateString('th-TH'), gumUsed: 0, trashAmount: "", purpleStoneCount: "", isSellingSpell: false, minutesUsed: 60, notes: "", otherCosts: [] });
            };

            const handleDelete = async (id) => {
                if (user && dbRef.current) {
                    const { doc, deleteDoc } = window.FirebaseSDK;
                    const appId = 'ro-farm-app';
                    try {
                        const recordRef = doc(dbRef.current, 'artifacts', appId, 'users', user.uid, 'farm_records', id);
                        await deleteDoc(recordRef);
                    } catch (e) { console.error(e); }
                } else {
                    setRecords(records.filter(r => r.id !== id));
                }
            };

            // --- Handlers for Backup/Restore (Fixed Location) ---
            const handleBackup = () => {
                const data = { records, globalPrices };
                const blob = new Blob([JSON.stringify(data)], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `ogh_backup_${new Date().toISOString().slice(0,10)}.json`;
                a.click();
            };

            const handleRestore = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = JSON.parse(event.target.result);
                        if (data.records) setRecords(data.records);
                        if (data.globalPrices) setGlobalPrices(data.globalPrices);
                        alert("‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
                    } catch (err) {
                        alert("‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
                    }
                };
                reader.readAsText(file);
            };

            const addOtherCostField = () => setFormData(prev => ({ ...prev, otherCosts: [...prev.otherCosts, { name: "", amount: "" }] }));
            const removeOtherCostField = (index) => setFormData(prev => ({ ...prev, otherCosts: prev.otherCosts.filter((_, i) => i !== index) }));
            const updateOtherCost = (index, field, value) => {
                const newList = [...formData.otherCosts];
                newList[index][field] = value;
                setFormData(prev => ({ ...prev, otherCosts: newList }));
            };

            const startEdit = (record) => {
                setFormData({
                    date: record.date.includes('/') ? record.date : convertToDisplay(record.date),
                    gumUsed: record.gumUsed,
                    trashAmount: record.trashAmount,
                    purpleStoneCount: record.purpleStoneCount,
                    isSellingSpell: record.isSellingSpell !== false,
                    minutesUsed: record.minutesUsed || 60,
                    notes: record.notes || "",
                    otherCosts: record.otherCosts || []
                });
                setEditingId(record.id);
                setIsAdding(true);
            };

            // Analytics
            const processedData = useMemo(() => {
                return [...records].sort((a, b) => {
                    const dateA = new Date(convertToISO(a.date));
                    const dateB = new Date(convertToISO(b.date));
                    const diff = dateA - dateB;
                    return diff === 0 ? (a.timestamp || 0) - (b.timestamp || 0) : diff;
                });
            }, [records]);

            const chartData = useMemo(() => {
                const data = gumFilter === 'all' ? processedData : processedData.filter(item => item.gumUsed === Number(gumFilter));
                return data.map(item => ({ ...item, purpleStoneCount: Number(item.purpleStoneCount || 0) }));
            }, [processedData, gumFilter]);

            const chartConfig = useMemo(() => {
                switch(chartMode) {
                    case 'revenue': return { key: 'revenue', color: '#10b981', label: '‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ', unit: 'Z' };
                    case 'stones': return { key: 'purpleStoneCount', color: '#f59e0b', label: '‡∏´‡∏¥‡∏ô‡∏°‡πà‡∏ß‡∏á', unit: '‡∏ä‡∏¥‡πâ‡∏ô' };
                    case 'profit': default: return { key: 'profit', color: '#a855f7', label: '‡∏Å‡∏≥‡πÑ‡∏£', unit: 'Z' };
                }
            }, [chartMode]);

            const sortedTableData = useMemo(() => {
                const data = [...records];
                switch (sortOrder) {
                    case 'revenue-desc': return data.sort((a, b) => b.revenue - a.revenue);
                    case 'revenue-asc': return data.sort((a, b) => a.revenue - b.revenue);
                    case 'profit-desc': return data.sort((a, b) => b.profit - a.profit);
                    case 'profit-asc': return data.sort((a, b) => a.profit - b.profit);
                    case 'date-asc': return data.sort((a, b) => (new Date(convertToISO(a.date)) - new Date(convertToISO(b.date))) || (a.timestamp - b.timestamp));
                    case 'date-desc': default: return data.sort((a, b) => (new Date(convertToISO(b.date)) - new Date(convertToISO(a.date))) || (b.timestamp - a.timestamp));
                }
            }, [records, sortOrder]);

            const stats = useMemo(() => {
                if (records.length === 0) return { totalProfit: 0, avgProfit: 0, totalStoredStones: 0, avgRevenue: 0, minRevenue: 0, maxRevenue: 0, avgRevenuePerMinute: 0 };
                const totalProfit = records.reduce((a, b) => a + b.profit, 0);
                const totalStoredStones = records.reduce((a, b) => a + (!b.isSellingSpell ? Number(b.purpleStoneCount || 0) : 0), 0);
                const revenues = records.map(r => r.revenue);
                return {
                    totalProfit,
                    avgProfit: totalProfit / records.length,
                    totalStoredStones,
                    avgRevenue: revenues.reduce((a, b) => a + b, 0) / records.length,
                    minRevenue: Math.min(...revenues),
                    maxRevenue: Math.max(...revenues),
                    avgRevenuePerMinute: records.reduce((a, b) => a + (b.revenuePerMinute || 0), 0) / records.length
                };
            }, [records]);

            // Render
            if (isLoading && user) { // Loading state only for logged in user syncing
                return (
                    <div className="min-h-screen flex items-center justify-center bg-slate-950 text-white">
                        <div className="text-center">
                            <div className="w-12 h-12 border-4 border-purple-500 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
                            <p className="font-bold tracking-widest animate-pulse">SYNCING DATA...</p>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen p-4 md:p-6 lg:p-8 pb-32 max-w-7xl mx-auto safe-area-pb">
                     {/* Config Modal */}
                     {showConfigModal && (
                        <div className="fixed inset-0 z-[200] flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm animate-fade-in">
                            <div className="bg-slate-900 border border-slate-800 w-full max-w-lg p-8 rounded-[2rem] shadow-2xl relative">
                                <button onClick={() => setShowConfigModal(false)} className="absolute top-6 right-6 text-slate-500 hover:text-white"><Icon name="x" size={24}/></button>
                                <h3 className="text-xl font-black mb-4 text-purple-400">‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Firebase Cloud</h3>
                                <p className="text-slate-400 text-xs mb-4">‡πÇ‡∏õ‡∏£‡∏î‡∏ß‡∏≤‡∏á Firebase Config (JSON) ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô Login:</p>
                                <textarea 
                                    className="w-full h-40 bg-slate-950 border border-slate-700 rounded-xl p-4 text-xs font-mono text-green-400 outline-none mb-4"
                                    placeholder='{ "apiKey": "...", ... }'
                                    value={configInput}
                                    onChange={e => setConfigInput(e.target.value)}
                                ></textarea>
                                <button onClick={saveConfig} className="w-full bg-blue-600 hover:bg-blue-500 py-3 rounded-xl font-bold uppercase text-xs">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î</button>
                            </div>
                        </div>
                    )}

                    {/* Manual Modal */}
                    {showManual && (
                        <div className="fixed inset-0 z-[200] flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm animate-fade-in" onClick={() => setShowManual(false)}>
                            <div className="bg-slate-900 border border-slate-800 w-full max-w-md p-8 rounded-[2rem] shadow-2xl relative" onClick={e => e.stopPropagation()}>
                                <button onClick={() => setShowManual(false)} className="absolute top-6 right-6 text-slate-500 hover:text-white"><Icon name="x" size={24}/></button>
                                <h3 className="text-xl font-black mb-6 text-purple-400 italic">üì± ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠</h3>
                                <div className="space-y-6 text-sm">
                                    <div className="flex gap-4">
                                        <div className="bg-blue-600/20 text-blue-400 w-8 h-8 rounded-full flex items-center justify-center font-bold shrink-0">1</div>
                                        <p className="text-slate-300"><span className="text-white font-bold">iOS (iPhone):</span> ‡πÄ‡∏õ‡∏¥‡∏î‡∏ú‡πà‡∏≤‡∏ô Safari ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° <span className="inline-flex bg-slate-800 p-1 rounded"><Icon name="share" size={14}/></span> ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å <span className="text-white font-bold">"Add to Home Screen"</span></p>
                                    </div>
                                    <div className="flex gap-4">
                                        <div className="bg-green-600/20 text-green-400 w-8 h-8 rounded-full flex items-center justify-center font-bold shrink-0">2</div>
                                        <p className="text-slate-300"><span className="text-white font-bold">Android:</span> ‡πÄ‡∏õ‡∏¥‡∏î‡∏ú‡πà‡∏≤‡∏ô Chrome ‡∏Å‡∏î‡∏à‡∏∏‡∏î 3 ‡∏à‡∏∏‡∏î <span className="text-white font-bold">(‚ãÆ)</span> ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å <span className="text-white font-bold">"‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏≠‡∏õ"</span> ‡∏´‡∏£‡∏∑‡∏≠ <span className="text-white font-bold">"‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏´‡∏•‡∏±‡∏Å"</span></p>
                                    </div>
                                </div>
                                <button onClick={() => setShowManual(false)} className="w-full mt-8 bg-slate-800 py-3 rounded-xl font-bold uppercase tracking-widest text-xs">‡∏ï‡∏Å‡∏•‡∏á</button>
                            </div>
                        </div>
                    )}

                    {/* Header */}
                    <div className="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
                        <div className="w-full md:w-auto">
                            <div className="flex flex-wrap items-center gap-2 md:gap-4">
                                <h1 className="text-3xl font-black tracking-tight bg-gradient-to-r from-purple-400 via-purple-500 to-pink-500 bg-clip-text text-transparent uppercase italic">
                                    Old Glast Heim
                                </h1>
                                <div className="flex gap-2">
                                    <a href="https://www.youtube.com/@SDekza-RO" target="_blank" className="inline-flex items-center gap-2 text-[10px] font-black text-slate-400 hover:text-red-500 uppercase tracking-widest px-3 py-1.5 bg-slate-900/80 border border-slate-800 rounded-2xl group shadow-sm transition-all w-fit">
                                        <Icon name="youtube" size={14} className="text-red-500" />
                                        <span>SDekza RO</span>
                                    </a>
                                    <button onClick={() => setShowManual(true)} className="inline-flex items-center gap-2 text-[10px] font-black text-blue-400 hover:text-blue-300 uppercase tracking-widest px-3 py-1.5 bg-blue-500/10 border border-blue-500/20 rounded-2xl transition-all">
                                        <Icon name="help-circle" size={14} />
                                        <span>‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏≠‡∏õ</span>
                                    </button>
                                </div>
                            </div>
                            <p className="text-slate-500 text-[10px] uppercase tracking-[0.4em] font-black mt-2">Cloud Farming Dashboard</p>
                        </div>
                        
                        <div className="flex items-center gap-4 w-full md:w-auto justify-between md:justify-end">
                             {user ? (
                                <div className="flex items-center gap-3 bg-slate-900 p-1 pr-4 rounded-2xl border border-slate-800">
                                    <img src={user.photoURL || "https://via.placeholder.com/32"} className="w-8 h-8 rounded-xl" />
                                    <div className="flex flex-col">
                                        <span className="text-[10px] font-black text-white truncate max-w-[100px]">{user.displayName}</span>
                                        <button onClick={handleLogout} className="text-[8px] font-bold text-red-500 uppercase text-left">Logout</button>
                                    </div>
                                </div>
                             ) : (
                                <button onClick={handleLogin} className="btn-google text-[10px] py-2 cursor-pointer">
                                    <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/action/google.svg" className="w-4 h-4" />
                                    Login / Config
                                </button>
                             )}

                             {!user && (
                                <div className="flex gap-2">
                                     <button onClick={handleBackup} className="bg-slate-800 hover:bg-slate-700 p-2 rounded-xl transition-all" title="Backup"><Icon name="download" size={16}/></button>
                                     <label className="bg-slate-800 hover:bg-slate-700 p-2 rounded-xl transition-all cursor-pointer" title="Restore">
                                        <input type="file" accept=".json" onChange={handleRestore} className="hidden" />
                                        <Icon name="upload" size={16}/>
                                     </label>
                                </div>
                             )}

                            <button onClick={() => { setIsAdding(!isAdding); if(isAdding) setEditingId(null); }} className="flex-1 md:flex-none bg-purple-600 hover:bg-purple-700 transition-all px-6 py-3 rounded-2xl font-black flex items-center justify-center gap-3 shadow-[0_0_20px_rgba(168,85,247,0.3)] active:scale-95 uppercase tracking-widest text-xs">
                                <Icon name={isAdding ? "layout-dashboard" : "plus-circle"} /> {isAdding ? "‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å" : "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"}
                            </button>
                        </div>
                    </div>

                    {!isAdding && (
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8 animate-fade-in">
                            <div className="bg-slate-900 border border-slate-800 p-6 rounded-[2rem] shadow-xl">
                                <div className="p-3 bg-green-500/10 rounded-xl text-green-500 w-fit mb-4"><Icon name="wallet" size={24} /></div>
                                <h3 className="text-slate-400 text-xs font-black uppercase mb-1 tracking-widest">‡∏Å‡∏≥‡πÑ‡∏£‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</h3>
                                <p className="text-3xl font-black">{formatMZeny(stats.totalProfit)} <span className="text-sm text-slate-600 font-bold ml-1">Zeny</span></p>
                            </div>
                            <div className="bg-slate-900 border border-slate-800 p-6 rounded-[2rem] shadow-xl relative border-b-blue-500/30">
                                <div className="p-3 bg-blue-500/10 rounded-xl text-blue-500 w-fit mb-4"><Icon name="trending-up" size={24} /></div>
                                <h3 className="text-slate-400 text-xs font-black uppercase mb-1 tracking-widest">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ï‡πà‡∏≠‡∏£‡∏≠‡∏ö</h3>
                                <p className="text-3xl font-black">{formatMZeny(stats.avgRevenue)} <span className="text-sm text-slate-600 font-bold ml-1">Zeny</span></p>
                                <div className="flex flex-wrap items-center gap-2 mt-2 text-[10px] font-bold uppercase text-slate-500">
                                     <span className="text-green-500 flex items-center gap-1 bg-green-500/10 px-2 py-1 rounded"><Icon name="arrow-up" size={10}/> {formatMZeny(stats.maxRevenue)}</span>
                                     <span className="text-red-500 flex items-center gap-1 bg-red-500/10 px-2 py-1 rounded"><Icon name="arrow-down" size={10}/> {formatMZeny(stats.minRevenue)}</span>
                                </div>
                            </div>
                            <div className="bg-slate-900 border border-slate-800 p-6 rounded-[2rem] shadow-xl border-b-amber-500/30">
                                <div className="p-3 bg-amber-500/10 rounded-xl text-amber-500 w-fit mb-4"><Icon name="archive" size={24} /></div>
                                <h3 className="text-slate-400 text-xs font-black uppercase mb-1 tracking-widest">Coagulated Spell ‡πÉ‡∏ô‡∏Ñ‡∏•‡∏±‡∏á</h3>
                                <p className="text-3xl font-black">{stats.totalStoredStones.toLocaleString()} <span className="text-sm text-slate-600 font-bold ml-1">‡∏ä‡∏¥‡πâ‡∏ô</span></p>
                                <div className="text-[10px] text-amber-400 mt-2 font-bold uppercase italic flex items-center gap-1">
                                    <Icon name="sparkles" size={12} /> ‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤: {formatMZeny(stats.totalStoredStones * globalPrices.purpleStonePrice)} Zeny
                                </div>
                            </div>
                        </div>
                    )}

                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div className="lg:col-span-2">
                            {isAdding ? (
                                <form onSubmit={handleSave} className="bg-slate-900 border border-slate-800 p-6 md:p-10 rounded-[2.5rem] shadow-xl animate-fade-in">
                                    <h2 className="text-xl md:text-2xl font-black uppercase mb-8 text-purple-400 italic flex items-center gap-3">
                                        <Icon name={editingId ? "pencil" : "plus-circle"} size={24} /> {editingId ? "‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•" : "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"}
                                    </h2>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                        <div className="space-y-3">
                                            <label className="text-[10px] font-black text-slate-500 uppercase tracking-widest flex items-center gap-2"><Icon name="calendar" size={14}/> ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ü‡∏≤‡∏£‡πå‡∏°</label>
                                            <input type="text" value={formData.date} onChange={e => setFormData({...formData, date: e.target.value})} className="w-full bg-slate-950 border border-slate-800 rounded-2xl p-4 text-white font-bold outline-none focus:ring-2 focus:ring-purple-500/50" required />
                                        </div>
                                        <div className="space-y-3">
                                            <label className="text-[10px] font-black text-slate-500 uppercase tracking-widest flex items-center gap-2"><BubbleGum16Bit className="w-4 h-4"/> Bubble Gum</label>
                                            <div className="flex bg-slate-950 p-1 rounded-2xl border border-slate-800">
                                                {[0, 1, 2].map(n => (
                                                    <button type="button" key={n} onClick={() => setFormData({...formData, gumUsed: n})} className={`flex-1 py-3 rounded-xl text-sm font-black transition-all ${formData.gumUsed === n ? 'bg-blue-600 text-white shadow-lg' : 'text-slate-500 hover:text-slate-300'}`}>{n} EA</button>
                                                ))}
                                            </div>
                                        </div>
                                        <div className="space-y-3">
                                            <label className="text-[10px] font-black text-slate-500 uppercase tracking-widest flex items-center gap-2"><Icon name="clock" size={14}/> ‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ü‡∏≤‡∏£‡πå‡∏°</label>
                                            <div className="relative">
                                                <input type="number" value={formData.minutesUsed} onChange={e => setFormData({...formData, minutesUsed: Number(e.target.value)})} className="w-full bg-slate-950 border border-slate-800 rounded-2xl p-4 pr-16 text-white font-bold outline-none" />
                                                <span className="absolute right-6 top-1/2 -translate-y-1/2 text-[10px] font-black text-slate-500">‡∏ô‡∏≤‡∏ó‡∏µ</span>
                                            </div>
                                        </div>
                                        <div className="space-y-3">
                                            <label className="text-[10px] font-black text-slate-500 uppercase tracking-widest">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢</label>
                                            <div className="relative">
                                                <input type="number" value={formData.trashAmount} onChange={e => setFormData({...formData, trashAmount: e.target.value})} className="w-full bg-slate-950 border border-slate-800 rounded-2xl p-4 pr-16 text-white font-bold outline-none" placeholder="" />
                                                <span className="absolute right-6 top-1/2 -translate-y-1/2 text-[10px] font-black text-slate-500">Zeny</span>
                                            </div>
                                        </div>
                                        <div className="md:col-span-2 space-y-3">
                                            <label className="text-[10px] font-black text-slate-500 uppercase tracking-widest flex items-center gap-2"><CoagulatedSpell16Bit className="w-4 h-4"/> Coagulated Spell</label>
                                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                <div className="relative">
                                                    <input type="number" value={formData.purpleStoneCount} onChange={e => setFormData({...formData, purpleStoneCount: e.target.value})} className="w-full bg-slate-950 border border-slate-800 rounded-2xl p-4 pr-16 text-white font-bold outline-none" placeholder="" />
                                                    <span className="absolute right-6 top-1/2 -translate-y-1/2 text-[10px] font-black text-slate-500">‡∏ä‡∏¥‡πâ‡∏ô</span>
                                                </div>
                                                <div className="flex bg-slate-950 p-1 rounded-2xl border border-slate-800">
                                                    <button type="button" onClick={() => setFormData({...formData, isSellingSpell: true})} className={`flex-1 py-2 rounded-xl text-[10px] font-black uppercase ${formData.isSellingSpell ? 'bg-green-600 text-white shadow-lg' : 'text-slate-600'}`}>‡∏Ç‡∏≤‡∏¢ (Sell)</button>
                                                    <button type="button" onClick={() => setFormData({...formData, isSellingSpell: false})} className={`flex-1 py-2 rounded-xl text-[10px] font-black uppercase ${!formData.isSellingSpell ? 'bg-amber-600 text-white shadow-lg' : 'text-slate-600'}`}>‡πÄ‡∏Å‡πá‡∏ö (Store)</button>
                                                </div>
                                            </div>
                                        </div>
                                        <div className="md:col-span-2 space-y-3 border-t border-slate-800 pt-6">
                                            <div className="flex justify-between items-center">
                                                <label className="text-[10px] font-black text-slate-500 uppercase tracking-widest flex items-center gap-2"><Icon name="plus" size={14}/> ‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</label>
                                                <button type="button" onClick={addOtherCostField} className="text-[9px] font-black px-3 py-1 rounded-lg border border-blue-500/30 bg-blue-500/10 text-blue-500 hover:bg-blue-500/20 transition-all">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
                                            </div>
                                            {formData.otherCosts.map((cost, idx) => (
                                                <div key={idx} className="flex gap-3">
                                                    <input type="text" value={cost.name} onChange={(e) => updateOtherCost(idx, 'name', e.target.value)} className="flex-[2] bg-slate-950 border border-slate-800 rounded-xl p-3 text-white text-xs font-bold outline-none" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£..." />
                                                    <div className="flex-1 relative">
                                                        <input type="number" value={cost.amount} onChange={(e) => updateOtherCost(idx, 'amount', e.target.value)} className="w-full bg-slate-950 border border-slate-800 rounded-xl p-3 pr-8 text-white text-xs font-bold outline-none text-right" />
                                                        <span className="absolute right-3 top-1/2 -translate-y-1/2 text-[8px] font-black text-slate-600">Z</span>
                                                    </div>
                                                    <button type="button" onClick={() => removeOtherCostField(idx)} className="text-red-500 p-2 hover:bg-red-500/10 rounded-xl"><Icon name="minus-circle" size={18}/></button>
                                                </div>
                                            ))}
                                        </div>
                                        <div className="md:col-span-2 space-y-3">
                                            <label className="text-[10px] font-black text-slate-500 uppercase tracking-widest flex items-center gap-2"><Icon name="file-text" size={14}/> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (Memo)</label>
                                            <textarea value={formData.notes} onChange={(e) => setFormData({...formData, notes: e.target.value})} className="w-full bg-slate-950 border border-slate-800 rounded-2xl p-4 text-white text-sm outline-none font-medium h-24 mt-2 focus:border-purple-500/50 transition-all" placeholder="‡∏à‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î..."></textarea>
                                        </div>
                                    </div>
                                    <div className="mt-10 pt-8 border-t border-slate-800 flex gap-4">
                                        <button type="button" onClick={() => setIsAdding(false)} className="flex-1 bg-slate-800 py-5 rounded-2xl font-black uppercase tracking-widest transition-all hover:bg-slate-700">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                                        <button type="submit" className="flex-[2] bg-gradient-to-r from-purple-600 to-pink-600 py-5 rounded-2xl font-black uppercase tracking-widest shadow-2xl active:scale-95">{editingId ? "‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•" : "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏ö"}</button>
                                    </div>
                                </form>
                            ) : (
                                <>
                                    {/* Chart */}
                                    <div className="bg-slate-900 border border-slate-800 p-6 md:p-8 rounded-[2.5rem] shadow-xl h-[400px] md:h-[450px] mb-8 flex flex-col animate-fade-in">
                                        <div className="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                                            <div className="flex items-center gap-4">
                                                <h2 className="text-xl font-black uppercase tracking-tight flex items-center gap-3 italic"><Icon name="trending-up" className="text-green-500"/> ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥</h2>
                                                <select value={gumFilter} onChange={e => setGumFilter(e.target.value)} className="bg-slate-950 text-[10px] font-black uppercase p-2 rounded-xl border border-slate-800 outline-none text-slate-300">
                                                    <option value="all">‡∏ó‡∏∏‡∏Å Gum</option>
                                                    <option value="0">Gum 0</option>
                                                    <option value="1">Gum 1</option>
                                                    <option value="2">Gum 2</option>
                                                </select>
                                            </div>
                                            <div className="flex bg-slate-950 p-1 rounded-2xl border border-slate-800">
                                                <button onClick={() => setChartMode('profit')} className={`px-4 py-2 rounded-xl text-[10px] font-black uppercase transition-all ${chartMode === 'profit' ? 'bg-purple-600 text-white shadow-lg' : 'text-slate-500'}`}>‡∏Å‡∏≥‡πÑ‡∏£</button>
                                                <button onClick={() => setChartMode('revenue')} className={`px-4 py-2 rounded-xl text-[10px] font-black uppercase transition-all ${chartMode === 'revenue' ? 'bg-green-600 text-white shadow-lg' : 'text-slate-500'}`}>‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ</button>
                                                <button onClick={() => setChartMode('stones')} className={`px-4 py-2 rounded-xl text-[10px] font-black uppercase transition-all ${chartMode === 'stones' ? 'bg-amber-500 text-white shadow-lg' : 'text-slate-500'}`}>‡∏´‡∏¥‡∏ô‡∏°‡πà‡∏ß‡∏á</button>
                                            </div>
                                        </div>
                                        <div className="flex-1 w-full">
                                            <ResponsiveContainer width="100%" height="100%">
                                                <LineChart data={chartData}>
                                                    <CartesianGrid strokeDasharray="3 3" stroke="#1e293b" vertical={false} />
                                                    <XAxis dataKey="date" stroke="#475569" fontSize={10} axisLine={false} tickLine={false} />
                                                    <YAxis stroke="#475569" fontSize={10} tickFormatter={v => `${v/1000}k`} axisLine={false} tickLine={false} />
                                                    <Tooltip 
                                                        contentStyle={{ backgroundColor: '#0f172a', border: '1px solid #1e293b', borderRadius: '16px' }} 
                                                        formatter={(v) => [formatZeny(v) + ' ' + chartConfig.unit, chartConfig.label]}
                                                    />
                                                    <Line 
                                                        type="monotone" 
                                                        dataKey={chartConfig.key} 
                                                        stroke={chartConfig.color} 
                                                        strokeWidth={4} 
                                                        dot={{ r: 4 }} 
                                                    />
                                                </LineChart>
                                            </ResponsiveContainer>
                                        </div>
                                    </div>

                                    {/* History Table */}
                                    <div className="bg-slate-900 border border-slate-800 rounded-[2.5rem] shadow-xl overflow-hidden animate-fade-in">
                                        <div className="p-8 border-b border-slate-800 flex justify-between items-center">
                                            <h2 className="text-xl font-black text-blue-400 italic flex items-center gap-3 tracking-tight"><Icon name="history" /> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ü‡∏≤‡∏£‡πå‡∏°</h2>
                                            <select className="bg-slate-950 text-[10px] font-black uppercase p-2 rounded-xl border border-slate-800 outline-none text-slate-300" onChange={e => setSortOrder(e.target.value)}>
                                                <option value="date-desc">‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</option>
                                                <option value="date-asc">‡πÄ‡∏Å‡πà‡∏≤‡∏™‡∏∏‡∏î</option>
                                                <option value="revenue-desc">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ ‡∏™‡∏π‡∏á-‡∏ï‡πà‡∏≥</option>
                                                <option value="profit-desc">‡∏Å‡∏≥‡πÑ‡∏£ ‡∏™‡∏π‡∏á-‡∏ï‡πà‡∏≥</option>
                                            </select>
                                        </div>
                                        <div className="overflow-x-auto custom-scrollbar">
                                            <table className="w-full text-left">
                                                <thead className="bg-slate-900/50 border-b border-slate-800">
                                                    <tr>
                                                        <th className="px-6 py-4 text-[10px] font-black text-slate-500 uppercase tracking-widest whitespace-nowrap">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                                                        <th className="px-6 py-4 text-[10px] font-black text-slate-500 uppercase tracking-widest whitespace-nowrap">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ü‡∏≤‡∏£‡πå‡∏°</th>
                                                        <th className="px-6 py-4 text-[10px] font-black text-slate-500 uppercase text-right tracking-widest whitespace-nowrap">‡∏Å‡∏≥‡πÑ‡∏£‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</th>
                                                        <th className="px-6 py-4 text-[10px] font-black text-slate-500 uppercase text-center tracking-widest whitespace-nowrap">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                                                    </tr>
                                                </thead>
                                                <tbody className="divide-y divide-slate-800/50">
                                                    {sortedTableData.length > 0 ? sortedTableData.map((record) => (
                                                        <React.Fragment key={record.id}>
                                                            <tr className={`hover:bg-white/[0.02] cursor-pointer transition-colors ${expandedId === record.id ? 'bg-white/[0.03]' : ''}`} onClick={() => setExpandedId(expandedId === record.id ? null : record.id)}>
                                                                <td className="px-6 py-4 font-bold text-sm text-slate-300 flex items-center gap-2 whitespace-nowrap">
                                                                    {record.date} {expandedId === record.id ? <Icon name="chevron-up" size={14}/> : <Icon name="chevron-down" size={14}/>}
                                                                </td>
                                                                <td className="px-6 py-4 whitespace-nowrap">
                                                                    <div className="flex gap-2">
                                                                        <span className={`px-2 py-0.5 rounded-lg text-[9px] font-black border ${record.gumUsed > 0 ? 'bg-blue-500/10 text-blue-400 border-blue-500/20' : 'bg-slate-800 text-slate-500'}`}>GUM {record.gumUsed}</span>
                                                                        <span className={`px-2 py-0.5 rounded-lg text-[9px] font-black border ${record.isSellingSpell !== false ? 'bg-green-500/10 text-green-500 border-green-500/20' : 'bg-amber-500/10 text-amber-500 border-amber-500/20'}`}>{record.isSellingSpell !== false ? 'SELL' : `STORE (${record.purpleStoneCount || 0})`}</span>
                                                                    </div>
                                                                </td>
                                                                <td className={`px-6 py-4 text-right font-black text-lg tabular-nums whitespace-nowrap ${record.profit >= 0 ? 'text-green-400' : 'text-red-400'}`}>{formatZeny(record.profit)} <span className="text-[10px] opacity-40 ml-1">Z</span></td>
                                                                <td className="px-6 py-4 text-center whitespace-nowrap">
                                                                    <div className="flex justify-center gap-2">
                                                                        <button onClick={(e) => { e.stopPropagation(); startEdit(record); }} className="text-slate-500 hover:text-purple-400 p-2 bg-slate-800/50 rounded-xl"><Icon name="pencil" size={14} /></button>
                                                                        <button onClick={(e) => { e.stopPropagation(); handleDelete(record.id); }} className="text-slate-500 hover:text-red-500 p-2 bg-slate-800/50 rounded-xl"><Icon name="trash-2" size={14} /></button>
                                                                    </div>
                                                                </td>
                                                            </tr>
                                                            {expandedId === record.id && (
                                                                <tr className="bg-slate-950/50 border-x-2 border-purple-500/30">
                                                                    <td colSpan="4" className="px-6 md:px-10 py-6 border-b border-slate-800">
                                                                        <div className="grid grid-cols-1 md:grid-cols-4 gap-8">
                                                                            <div className="space-y-3 border-r border-slate-800 pr-8">
                                                                                <h4 className="text-[10px] font-black text-slate-500 uppercase tracking-widest flex items-center gap-2"><Icon name="sparkles" size={12} className="text-purple-500"/> ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ</h4>
                                                                                <p className="text-xs text-slate-300 flex justify-between font-bold"><span>‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏°:</span> <span className="text-green-400 font-black">{formatZeny(record.revenue)} Z</span></p>
                                                                                <p className="text-xs text-slate-300 flex justify-between font-bold"><span>‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ:</span> <span>{record.minutesUsed || 0} ‡∏ô‡∏≤‡∏ó‡∏µ</span></p>
                                                                                <p className="text-xs text-slate-300 flex justify-between font-bold"><span>‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢/‡∏ô‡∏≤‡∏ó‡∏µ:</span> <span className="text-blue-400">{formatZeny(record.revenuePerMinute || 0)} Z</span></p>
                                                                            </div>
                                                                            <div className="space-y-3 border-r border-slate-800 pr-8">
                                                                                <h4 className="text-[10px] font-black text-slate-500 uppercase tracking-widest flex items-center gap-2"><Icon name="package" size={12} className="text-blue-500"/> ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô</h4>
                                                                                <p className="text-xs text-slate-300 flex justify-between font-bold"><span>‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏£‡∏ß‡∏°:</span> <span className="text-red-400 font-black">{formatZeny(record.totalCost)} Z</span></p>
                                                                                <div className="pt-2">
                                                                                    {Array.isArray(record.otherCosts) && record.otherCosts.length > 0 ? record.otherCosts.map((c, i) => (
                                                                                        <p key={i} className="text-[11px] text-slate-400 flex justify-between"><span>- {c.name}:</span> <span>{formatZeny(c.amount)} Z</span></p>
                                                                                    )) : <p className="text-[10px] text-slate-600 italic">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</p>}
                                                                                </div>
                                                                            </div>
                                                                            <div className="md:col-span-2 space-y-3">
                                                                                <h4 className="text-[10px] font-black text-slate-500 uppercase tracking-widest flex items-center gap-2"><Icon name="file-text" size={12} className="text-amber-500"/> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</h4>
                                                                                <p className="text-[11px] text-slate-300 leading-relaxed italic bg-slate-900/50 p-4 rounded-xl border border-slate-800 whitespace-pre-wrap">{record.notes || "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å"}</p>
                                                                            </div>
                                                                        </div>
                                                                    </td>
                                                                </tr>
                                                            )}
                                                        </React.Fragment>
                                                    )) : <tr><td colSpan="4" className="px-8 py-20 text-center text-slate-700 font-black italic">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </>
                            )}
                        </div>

                        {/* Sidebar */}
                        <div className="space-y-6">
                            <div className="bg-slate-900 border border-slate-800 p-8 rounded-[2.5rem] shadow-xl">
                                <h3 className="text-sm font-black mb-6 text-indigo-400 uppercase tracking-widest flex items-center gap-3 italic font-black"><Icon name="database" /> ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</h3>
                                <div className="space-y-4">
                                    {[
                                        { key: 'purpleStonePrice', label: 'Coagulated Spell', icon: <CoagulatedSpell16Bit className="absolute right-[-8px] bottom-[-8px] w-20 h-20 opacity-5" /> },
                                        { key: 'gumBoxPrice', label: '‡∏£‡∏≤‡∏Ñ‡∏≤ Bubble Gum Box', icon: <BubbleGum16Bit className="absolute right-[-8px] bottom-[-8px] w-20 h-20 opacity-5" /> },
                                        { key: 'silvervineBoxPrice', label: '‡∏£‡∏≤‡∏Ñ‡∏≤ Silvervine Box', icon: <Silvervine16Bit className="absolute right-[-8px] bottom-[-8px] w-20 h-20 opacity-5" /> }
                                    ].map(item => (
                                        <div key={item.key} className="bg-slate-950 p-5 rounded-2xl border border-slate-800 group hover:border-indigo-500/30 transition-all relative overflow-hidden">
                                            {item.icon}
                                            <p className="text-[9px] text-slate-600 font-black uppercase mb-1 tracking-tighter relative z-10">{item.label}</p>
                                            <div className="flex items-baseline gap-2 relative z-10">
                                                <input type="number" value={globalPrices[item.key]} 
                                                    onChange={e => {
                                                        const newVal = Number(e.target.value);
                                                        setGlobalPrices({...globalPrices, [item.key]: newVal});
                                                        updatePricesInCloud({...globalPrices, [item.key]: newVal});
                                                    }} 
                                                    className="bg-transparent text-2xl font-black outline-none w-full text-white" />
                                                <span className="text-[10px] font-bold text-slate-600 uppercase">Zeny</span>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>

                            <div className="bg-slate-900 border border-slate-800 p-8 rounded-[2.5rem] shadow-xl border-t-red-500/20">
                                <h3 className="text-sm font-black mb-6 text-red-400 uppercase tracking-widest flex items-center gap-3 italic"><Icon name="clock" /> ‡∏à‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡∏Å‡∏≤‡∏£‡∏ü‡∏≤‡∏£‡πå‡∏°</h3>
                                <div className="text-4xl font-black text-white tabular-nums mb-10 bg-slate-950 text-center py-8 rounded-[2rem] border border-slate-800 shadow-inner tracking-tighter">
                                    {formatTimerDisplay(timeInMs)}
                                </div>
                                <div className="grid grid-cols-2 gap-4">
                                    {!isTimerActive || isTimerPaused ? (
                                        <button onClick={handleTimerStart} className="bg-green-600 hover:bg-green-500 py-4 rounded-2xl font-black text-xs uppercase flex items-center justify-center gap-2 shadow-lg transition-all active:scale-95"><Icon name="play" size={14} fill="currentColor"/> {timeInMs > 0 ? "‡∏ï‡πà‡∏≠" : "‡πÄ‡∏£‡∏¥‡πà‡∏°"}</button>
                                    ) : (
                                        <button onClick={handleTimerPause} className="bg-amber-600 hover:bg-amber-500 py-4 rounded-2xl font-black text-xs uppercase flex items-center justify-center gap-2 shadow-lg transition-all active:scale-95"><Icon name="pause" size={14} fill="currentColor"/> ‡∏û‡∏±‡∏Å</button>
                                    )}
                                    <button onClick={handleTimerStop} className="bg-slate-800 hover:bg-red-600 py-4 rounded-2xl font-black text-xs uppercase flex items-center justify-center gap-2 transition-all active:scale-95 group shadow-lg"><Icon name="square" size={14} fill="currentColor" className="group-hover:text-white"/> ‡∏´‡∏¢‡∏∏‡∏î/‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                                    <button onClick={handleTimerReset} className="col-span-2 py-3 bg-slate-950 border border-slate-800 rounded-xl text-[10px] font-black text-slate-500 uppercase tracking-widest hover:text-slate-300 transition-colors">‡∏£‡∏µ‡πÄ‡∏ã‡∏ï‡πÄ‡∏ß‡∏•‡∏≤</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
