<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>OGHza Tracker V2</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Add Prop-Types for Recharts -->
    <script src="https://unpkg.com/prop-types@15.8.1/prop-types.min.js"></script>
    <script src="https://unpkg.com/recharts@2.12.7/umd/Recharts.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&family=Kanit:wght@300;400;500;700;900&display=swap');
        
        :root {
            --app-bg: #0f172a;
            --glass-bg: rgba(30, 41, 59, 0.95);
        }

        body { 
            font-family: 'Inter', 'Kanit', sans-serif; 
            background-color: var(--app-bg); 
            color: #f1f5f9; 
            overflow-x: hidden; 
            margin: 0;
            padding: 0;
        }

        .glass-panel { 
            background: var(--glass-bg); 
            backdrop-filter: blur(16px); 
            border: 1px solid rgba(255, 255, 255, 0.08); 
        }

        /* สำหรับเนื้อหาหน้าจอ (View Content) ให้เว้นด้านล่างเผื่อเมนู */
        .view-content {
            padding-bottom: calc(env(safe-area-inset-bottom) + 120px) !important;
        }

        /* สำหรับเมนูบาร์ (Nav Bar) ให้เว้นด้านล่างแค่พอดี Safe Area */
        .nav-bar-padding {
            padding-bottom: calc(env(safe-area-inset-bottom) + 10px);
        }

        .progress-bar { transition: width 0.5s ease-out; }

        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .animate-slide-up { animation: slideUp 0.3s ease-out forwards; }
        
        @keyframes fadeIn { from { opacity: 0; } to { transform: opacity: 1; } }
        .animate-fade-in { animation: fadeIn 0.2s ease-in-out forwards; }

        @keyframes slideDown { from { transform: translate(-50%, -150%); opacity: 0; } to { transform: translate(-50%, 0); opacity: 1; } }
        .animate-slide-down { animation: slideDown 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }

        @keyframes popIn { 0% { transform: scale(0.8); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        .animate-pop-in { animation: popIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }

        /* Hugin Animation */
        @keyframes huginFloat { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
        .animate-hugin { animation: huginFloat 3s ease-in-out infinite; }

        ::-webkit-scrollbar { width: 0px; background: transparent; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        const { useState, useEffect, useMemo, useRef } = React;
        const { ResponsiveContainer, AreaChart, Area, XAxis, YAxis, Tooltip } = window.Recharts;

        // --- Firebase Modules ---
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { getFirestore, doc, setDoc, getDoc, collection, query, orderBy, onSnapshot, addDoc, updateDoc, deleteDoc, getDocs, limit } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

        // --- Configuration & Constants ---
        const APP_VERSION = "Ver.2.13.3 (Hugin's Quest)";
        
        const CHANGELOGS = [
            { ver: "2.13.3", date: "Latest", desc: "เพิ่มเงื่อนไขปลดล็อค AI (ต้องบันทึก 5 รอบ), ปรับปรุงปุ่ม Reset UID เป็นลิงก์เล็กๆ และจัดเรียงเมนูใหม่" },
            { ver: "2.13.2", date: "Previous", desc: "เพิ่มระบบตรวจสอบ UID ก่อนกู้คืน (ป้องกันการกรอกผิด) และปรับปุ่ม Restore ให้ Interactive" },
            { ver: "2.13.0", date: "Old", desc: "เพิ่ม NPC Hugin สำหรับวิเคราะห์ข้อมูล" }
        ];

        const MANUAL_FIREBASE_CONFIG = {
            apiKey: "AIzaSyAbWzr8o_OhkjGbEetBYq_nzYmVZ2fTf40",
            authDomain: "rocogh-88a38.firebaseapp.com",
            projectId: "rocogh-88a38",
            storageBucket: "rocogh-88a38.firebasestorage.app",
            messagingSenderId: "1025971309206",
            appId: "1:1025971309206:web:d4f9e0ab6bb016dde590b7"
        };

        const INITIAL_STATS = { 
            baseLv: 1, baseExp: 0, jobLv: 1, jobExp: 0, 
            jobClass: 'Novice', coins: 0, zeny: 0, isHighClass: false 
        };

        // --- Helper Functions ---
        const formatMoney = (n) => new Intl.NumberFormat('en-US', { notation: "compact", maximumFractionDigits: 1 }).format(n);
        const formatFullMoney = (n) => new Intl.NumberFormat('th-TH').format(n);
        
        const getExpReq = (lv, type) => {
            if (type === 'base') return Math.floor(100 * Math.pow(lv, 1.5));
            return Math.floor(50 * Math.pow(lv, 1.3));
        };

        const handleNumberInput = (e, field, setter) => {
            const val = e.target.value.replace(/[^0-9]/g, '');
            setter(prev => ({ ...prev, [field]: val }));
        };

        const copyToClipboard = (text) => {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.top = "0";
            textArea.style.left = "0";
            textArea.style.position = "fixed";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try { document.execCommand('copy'); } catch (err) { console.error('Fallback copy failed', err); }
            document.body.removeChild(textArea);
        };

        // --- SVGs & Icons ---
        const SVGs = {
            Hugin: ({className}) => (
                <svg viewBox="0 0 120 120" className={className} fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M35,45 Q30,80 60,95 Q90,80 85,45" fill="#f5d0a9" stroke="#5a3a29" strokeWidth="2.5" />
                    <path d="M30,60 Q25,65 32,70" fill="#f5d0a9" stroke="#5a3a29" strokeWidth="2" />
                    <path d="M90,60 Q95,65 88,70" fill="#f5d0a9" stroke="#5a3a29" strokeWidth="2" />
                    <path d="M25,50 C10,20 110,20 95,50 C100,30 90,10 60,10 C30,10 20,30 25,50" fill="#fbbf24" stroke="#92400e" strokeWidth="2.5" />
                    <path d="M35,15 Q60,5 85,15" fill="none" stroke="#fbbf24" strokeWidth="2" opacity="0.6"/>
                    <path d="M60,10 Q60,25 50,30" fill="none" stroke="#b45309" strokeWidth="2" />
                    <path d="M60,10 Q65,25 75,28" fill="none" stroke="#b45309" strokeWidth="2" />
                    <path d="M45,55 Q50,53 55,55" stroke="#3e2723" strokeWidth="2" fill="none" />
                    <path d="M65,55 Q70,53 75,55" stroke="#3e2723" strokeWidth="2" fill="none" />
                    <circle cx="50" cy="58" r="2.5" fill="#1e293b" />
                    <circle cx="70" cy="58" r="2.5" fill="#1e293b" />
                    <path d="M42,65 Q50,68 58,65" stroke="#d4a373" strokeWidth="1" fill="none" opacity="0.6" />
                    <path d="M35,58 Q40,62 42,60" stroke="#d4a373" strokeWidth="1" fill="none" opacity="0.6" />
                    <path d="M78,60 Q80,62 85,58" stroke="#d4a373" strokeWidth="1" fill="none" opacity="0.6" />
                    <path d="M60,60 L58,72 L62,72 Z" fill="#e0b084" />
                    <path d="M52,82 Q60,85 68,82" stroke="#5a3a29" strokeWidth="2" fill="none" strokeLinecap="round" />
                    <circle cx="50" cy="58" r="8" stroke="#94a3b8" strokeWidth="1.5" fill="none" opacity="0.4"/>
                    <circle cx="70" cy="58" r="8" stroke="#94a3b8" strokeWidth="1.5" fill="none" opacity="0.4"/>
                    <line x1="58" y1="58" x2="62" y2="58" stroke="#94a3b8" strokeWidth="1.5" opacity="0.4"/>
                </svg>
            ),
            Spell: ({className}) => (
                <svg viewBox="0 0 100 120" className={className} fill="none" xmlns="http://www.w3.org/2000/svg">
                    <polygon points="50,5 92,30 92,90 50,115 8,90 8,30" fill="#4b3a8a"></polygon>
                    <polygon points="50,5 8,30 8,90 50,115 50,60" fill="#6a4eb3"></polygon>
                    <polygon points="50,5 92,30 92,90 50,115 50,60" fill="#8464d1"></polygon>
                    <polygon points="50,20 80,40 80,80 50,100 20,80 20,40" fill="#a68af0"></polygon>
                    <g stroke="#ffffff" strokeWidth="0.5" strokeOpacity="0.3">
                        <line x1="50" y1="5" x2="50" y2="20"></line><line x1="8" y1="30" x2="20" y2="40"></line>
                        <line x1="92" y1="30" x2="80" y2="40"></line><line x1="8" y1="90" x2="20" y2="80"></line>
                        <line x1="92" y1="90" x2="80" y2="80"></line><line x1="50" y1="115" x2="50" y2="100"></line>
                    </g>
                    <rect x="30" y="35" width="8" height="8" fill="white" opacity="0.6" rx="1"></rect>
                    <polygon points="50,5 92,30 92,90 50,115 8,90 8,30" fill="none" stroke="#9d81e1" strokeWidth="2" strokeLinejoin="round"></polygon>
                </svg>
            ),
            Magic: ({className}) => (
                <svg viewBox="0 0 100 120" className={className} fill="none" xmlns="http://www.w3.org/2000/svg">
                    <polygon points="50,5 92,30 92,90 50,115 8,90 8,30" fill="#7a1a1a"></polygon>
                    <polygon points="50,5 8,30 8,90 50,115 50,60" fill="#a32929"></polygon>
                    <polygon points="50,5 92,30 92,90 50,115 50,60" fill="#c43333"></polygon>
                    <polygon points="50,20 80,40 80,80 50,100 20,80 20,40" fill="#ff5757"></polygon>
                    <g stroke="#ffffff" strokeWidth="0.5" strokeOpacity="0.3">
                        <line x1="50" y1="5" x2="50" y2="20"></line><line x1="8" y1="30" x2="20" y2="40"></line>
                        <line x1="92" y1="30" x2="80" y2="40"></line><line x1="8" y1="90" x2="20" y2="80"></line>
                        <line x1="92" y1="90" x2="80" y2="80"></line><line x1="50" y1="115" x2="50" y2="100"></line>
                    </g>
                    <rect x="30" y="35" width="8" height="8" fill="white" opacity="0.6" rx="1"></rect>
                    <polygon points="50,5 92,30 92,90 50,115 8,90 8,30" fill="none" stroke="#ff7a7a" strokeWidth="2" strokeLinejoin="round"></polygon>
                </svg>
            ),
            Silvervine: ({className}) => (
                <svg viewBox="0 0 120 160" className={className} fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M60,10 L60,25" stroke="#4a7729" strokeWidth="4" strokeLinecap="round"></path>
                    <path d="M60,25 Q40,15 35,25" fill="none" stroke="#6aa329" strokeWidth="3" strokeLinecap="round"></path>
                    <path d="M60,25 Q80,15 85,25" fill="none" stroke="#6aa329" strokeWidth="3" strokeLinecap="round"></path>
                    <path d="M60,25 C75,25 75,45 75,60 C75,80 95,90 95,115 C95,145 75,155 60,155 C45,155 25,145 25,115 C25,90 45,80 45,60 C45,45 45,25 60,25 Z" fill="#8cc63f"></path>
                    <path d="M60,25 C60,25 70,45 70,60 C70,80 88,90 88,115 C88,138 75,148 60,148 L60,155 C75,155 95,145 95,115 C95,90 75,80 75,60 C75,45 75,25 60,25" fill="#6aa329" opacity="0.6"></path>
                    <path d="M48,40 Q40,50 40,65" stroke="white" strokeWidth="3" strokeLinecap="round" opacity="0.4" fill="none"></path>
                    <ellipse cx="45" cy="100" rx="4" ry="12" fill="white" opacity="0.3" transform="rotate(-10, 45, 100)"></ellipse>
                    <path d="M35,110 Q45,120 55,115" fill="none" stroke="#4a7729" strokeWidth="1" opacity="0.2"></path>
                    <path d="M65,125 Q75,130 80,120" fill="none" stroke="#4a7729" strokeWidth="1" opacity="0.2"></path>
                </svg>
            ),
            SilvervineBox: ({className}) => (
                <svg viewBox="0 0 250 200" className={className} fill="none" xmlns="http://www.w3.org/2000/svg">
                    <defs>
                        <linearGradient id="boxGrad" x1="0%" y1="0%" x2="0%" y2="100%">
                            <stop offset="0%" stopColor="#b19cd9" stopOpacity="1"></stop>
                            <stop offset="100%" stopColor="#7a59c7" stopOpacity="1"></stop>
                        </linearGradient>
                        <linearGradient id="goldGrad" x1="0%" y1="0%" x2="0%" y2="100%">
                            <stop offset="0%" stopColor="#f9e498" stopOpacity="1"></stop>
                            <stop offset="100%" stopColor="#d4a017" stopOpacity="1"></stop>
                        </linearGradient>
                    </defs>
                    <path d="M40,80 L210,80 L220,160 L30,160 Z" fill="url(#boxGrad)" stroke="#5e449e" strokeWidth="2"></path>
                    <path d="M30,85 C30,30 220,30 220,85 L220,95 L30,95 Z" fill="#c3b1e1" stroke="#5e449e" strokeWidth="2"></path>
                    <path d="M45,85 C45,45 205,45 205,85" fill="none" stroke="white" strokeWidth="3" strokeOpacity="0.3"></path>
                    <rect x="35" y="80" width="10" height="85" fill="url(#goldGrad)" rx="2"></rect>
                    <rect x="205" y="80" width="10" height="85" fill="url(#goldGrad)" rx="2"></rect>
                    <rect x="35" y="85" width="180" height="8" fill="url(#goldGrad)"></rect>
                    <circle cx="125" cy="95" r="22" fill="#fdf2d0" stroke="#d4a017" strokeWidth="2"></circle>
                    <circle cx="125" cy="82" r="5" fill="#ff44cc" stroke="white" strokeWidth="1"></circle>
                    <path d="M110,105 Q125,120 140,105" fill="none" stroke="#d4a017" strokeWidth="2"></path>
                </svg>
            ),
            Gum: ({className}) => (
                <svg viewBox="0 0 160 160" className={className} fill="none" xmlns="http://www.w3.org/2000/svg">
                    <g transform="rotate(15, 80, 100)">
                        <rect x="30" y="80" width="100" height="35" rx="3" fill="#ffb38a" stroke="#d18a66" strokeWidth="1.5"></rect>
                        <rect x="35" y="83" width="90" height="29" rx="2" fill="#ffe0cf"></rect>
                        <circle cx="50" cy="97" r="6" fill="#ff7da1"></circle>
                    </g>
                    <g transform="rotate(-30, 80, 70)">
                        <rect x="30" y="45" width="100" height="35" rx="3" fill="#a0d8f5" stroke="#6ba8cc" strokeWidth="1.5"></rect>
                        <rect x="35" y="48" width="90" height="29" rx="2" fill="#def4ff"></rect>
                        <circle cx="55" cy="62" r="5" fill="#ff9aa2"></circle>
                        <circle cx="70" cy="58" r="6" fill="#fff5ba"></circle>
                        <rect x="95" y="55" width="12" height="15" rx="1" fill="#4d3b2c" opacity="0.8"></rect>
                    </g>
                </svg>
            ),
            GumBox: ({className}) => (
                <svg viewBox="0 0 150 150" className={className} fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M30,50 L120,50 L125,120 L25,120 Z" fill="#b1a5cc" stroke="#7e709e" strokeWidth="2"></path>
                    <path d="M25,55 L125,55 L125,35 C125,35 75,30 25,35 Z" fill="#c9bddb" stroke="#7e709e" strokeWidth="2"></path>
                    <path d="M90,120 C100,105 125,110 125,95 L125,120 Z" fill="#d4af37" opacity="0.6"></path>
                    <path d="M30,50 L45,50 L30,65 Z" fill="#d4af37" opacity="0.8"></path>
                    <path d="M120,50 L105,50 L120,65 Z" fill="#d4af37" opacity="0.8"></path>
                </svg>
            ),
            Zeny: ({className}) => (
                <svg viewBox="0 0 24 24" className={className} fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                    <circle cx="12" cy="12" r="10"/><path d="M16 8h-6a2 2 0 1 0 0 4h4a2 2 0 1 1 0 4H8"/>
                </svg>
            )
        };

        const Icon = ({ name, size = 20, className = "" }) => {
            const icons = {
                Home: <><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></>,
                History: <><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></>,
                Box: <><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></>,
                Settings: <><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0 2.83l.06.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></>,
                Plus: <><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></>,
                Trash: <><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></>,
                TrendingUp: <><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></>,
                Check: <polyline points="20 6 9 17 4 12"/>,
                AlertTriangle: <><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="M12 9v4"/><path d="M12 17h.01"/></>,
                Sparkles: <path d="M12 3v1m0 16v1m5-15-1 1m-10 10-1 1M21 12h-1M4 12H3m15.364 6.364-1 1m-10.728-10.728-1 1M12 8l-2 4 2 4 2-4-2-4z"/>,
                Loader: <path d="M12 2v4m0 12v4M4.93 4.93l2.83 2.83m8.48 8.48l2.83 2.83M2 12h4m12 0h4M4.93 19.07l2.83-2.83m8.48-8.48l2.83-2.83"/>,
                Copy: <><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></>,
                Refresh: <><path d="M23 4v6h-6"></path><path d="M1 20v-6h6"></path><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></>,
                Key: <><path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"></path></>,
                Pen: <><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></>,
                X: <><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></>,
                Save: <><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></>,
                ToggleOn: <><rect x="1" y="5" width="22" height="14" rx="7" fill="#4ade80"/><circle cx="16" cy="12" r="5" fill="white"/></>,
                ToggleOff: <><rect x="1" y="5" width="22" height="14" rx="7" fill="#475569"/><circle cx="8" cy="12" r="5" fill="white"/></>,
                Warp: <><path d="M12 20a8 8 0 1 0 0-16 8 8 0 0 0 0 16z" opacity="0.3"/><path d="M12 2a10 10 0 0 1 10 10 10 10 0 0 1-10 10 10 10 0 0 1-10-10A10 10 0 0 1 12 2m0 2a8 8 0 0 0-8 8 8 8 0 0 0 8 8 8 8 0 0 0 8-8 8 8 0 0 0-8-8z"/><path d="M12 8a4 4 0 0 1 4 4 4 4 0 0 1-4 4 4 4 0 0 1-4-4 4 4 0 0 1 4-4m0 2a2 2 0 0 0-2 2 2 2 0 0 0 2 2 2 2 0 0 0 2-2 2 2 0 0 0-2-2z"/></>,
                Lock: <><rect x="3" y="11" width="18" height="11" rx="2" ry="2" /><path d="M7 11V7a5 5 0 0 1 10 0v4" /></>
            };
            return (
                <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    {icons[name]}
                </svg>
            );
        };

        // --- UI Components ---
        const Toast = ({ message, onClose }) => {
            useEffect(() => {
                const timer = setTimeout(onClose, 2500);
                return () => clearTimeout(timer);
            }, [onClose]);

            return (
                <div className="fixed top-6 left-1/2 transform -translate-x-1/2 z-[100] animate-slide-down pointer-events-none w-full max-w-sm px-4">
                    <div className="bg-slate-800/95 backdrop-blur-md border border-white/10 text-white px-5 py-3 rounded-full shadow-2xl flex items-center gap-3 justify-center">
                        <div className="bg-emerald-500/20 p-1 rounded-full text-emerald-400">
                            <Icon name="Check" size={14} />
                        </div>
                        <span className="text-xs font-bold tracking-wide">{message}</span>
                    </div>
                </div>
            );
        };

        const RewardPopup = ({ data, onClose }) => {
            useEffect(() => {
                const timer = setTimeout(onClose, 3000);
                return () => clearTimeout(timer);
            }, [onClose]);

            return (
                <div className="fixed inset-0 z-[200] flex items-center justify-center p-6 bg-black/80 backdrop-blur-sm animate-fade-in" onClick={onClose}>
                    <div className="bg-slate-900 border border-yellow-500/30 p-8 rounded-3xl text-center relative overflow-hidden animate-pop-in shadow-2xl shadow-yellow-500/20 max-w-xs w-full">
                        <div className="absolute inset-0 bg-yellow-500/5 mix-blend-overlay"></div>
                        <div className="w-20 h-20 bg-yellow-500/20 rounded-full flex items-center justify-center mx-auto mb-4 animate-bounce">
                            <Icon name="Sparkles" size={40} className="text-yellow-400"/>
                        </div>
                        <h3 className="text-2xl font-black text-white mb-1">RECORD SAVED!</h3>
                        <p className="text-xs text-yellow-400 font-bold tracking-widest uppercase mb-6">Mission Complete</p>
                        <div className="flex justify-center gap-4">
                            <div className="bg-slate-800 p-3 rounded-2xl min-w-[80px]">
                                <p className="text-[10px] opacity-50 uppercase">Exp</p>
                                <p className="text-lg font-black text-white">+50</p>
                            </div>
                            <div className="bg-slate-800 p-3 rounded-2xl min-w-[80px]">
                                <p className="text-[10px] opacity-50 uppercase">Coins</p>
                                <p className="text-lg font-black text-amber-400">+1</p>
                            </div>
                            <div className="bg-slate-800 p-3 rounded-2xl min-w-[80px] border border-emerald-500/30">
                                <p className="text-[10px] opacity-50 uppercase text-emerald-400">DEK</p>
                                <p className="text-lg font-black text-emerald-400">+{data.dekEarned}</p>
                            </div>
                        </div>
                        <div className="mt-4 pt-4 border-t border-white/5">
                            <p className="text-xs text-slate-400 font-bold">Profit: {formatMoney(data.profit)} z</p>
                        </div>
                    </div>
                </div>
            );
        };

        const Modal = ({ children, onClose }) => (
            <div className="fixed inset-0 z-50 flex items-center justify-center p-6 bg-black/90 backdrop-blur-sm animate-fade-in" onClick={onClose}>
                <div className="w-full max-w-sm bg-[#1e293b] rounded-3xl p-6" onClick={e => e.stopPropagation()}>
                    {children}
                </div>
            </div>
        );

        const ConfirmModal = ({ title, message, onConfirm, onCancel, color = "rose", isLoading = false }) => (
            <Modal onClose={onCancel}>
                <div className="text-center space-y-4">
                    <div className={`mx-auto w-16 h-16 rounded-full bg-${color}-500/10 flex items-center justify-center text-${color}-500`}>
                        <Icon name="AlertTriangle" size={32} />
                    </div>
                    <h3 className="text-xl font-black">{title}</h3>
                    <p className="text-sm opacity-60">{message}</p>
                    <div className="flex gap-3 pt-4">
                        <button onClick={onCancel} className="flex-1 py-3 bg-slate-800/50 rounded-xl font-bold hover:bg-slate-800 transition-colors" disabled={isLoading}>ยกเลิก</button>
                        <button onClick={onConfirm} className={`flex-1 py-3 bg-${color}-600 rounded-xl font-bold text-white flex items-center justify-center gap-2`} disabled={isLoading}>
                            {isLoading ? <Icon name="Loader" className="animate-spin" size={16}/> : "ยืนยัน"}
                        </button>
                    </div>
                </div>
            </Modal>
        );

        const AiAnalysisModal = ({ onClose, analysisResult }) => (
            <Modal onClose={onClose}>
                <div className="text-center">
                    <div className="w-20 h-20 bg-slate-800 rounded-full flex items-center justify-center mx-auto mb-4 border-2 border-yellow-500 shadow-xl overflow-hidden relative">
                         <div className="absolute inset-0 bg-yellow-500/10"></div>
                         <SVGs.Hugin className="w-16 h-16"/>
                    </div>
                    <h3 className="text-xl font-black text-amber-400 mb-2">Hugin's Report</h3>
                    <div className="bg-slate-800/50 p-4 rounded-2xl text-left border border-slate-700 max-h-60 overflow-y-auto">
                         <p className="text-sm leading-relaxed opacity-90 text-slate-200 whitespace-pre-wrap font-medium">{analysisResult}</p>
                    </div>
                    <button onClick={onClose} className="mt-6 w-full py-3 bg-slate-800 hover:bg-slate-700 rounded-xl font-bold text-xs transition-colors">Close</button>
                </div>
            </Modal>
        );

        const NumberStepper = ({ value, onChange, label, step = 1, disabled = false, small = false }) => (
            <div className={`flex items-center justify-between p-1.5 rounded-2xl transition-colors ${disabled ? 'bg-slate-800/20 opacity-30 cursor-not-allowed' : 'bg-slate-800'}`}>
                <button type="button" disabled={disabled} onClick={() => onChange(Math.max(0, parseInt(value || 0) - step))} className={`w-8 h-8 rounded-xl flex items-center justify-center transition-colors ${disabled ? 'bg-slate-700/50 text-slate-500' : 'bg-slate-700 hover:bg-rose-500/20'}`}>
                    <Icon name="Plus" className="rotate-45" size={14}/>
                </button>
                <div className="text-center flex-1">
                    <input type="text" inputMode="numeric" disabled={disabled} value={value} onChange={e => {
                        const val = e.target.value.replace(/[^0-9]/g, '');
                        onChange(val === '' ? '' : parseInt(val));
                    }} className="w-full bg-transparent text-center text-lg font-black outline-none" />
                    {label && <p className="text-[8px] opacity-40 font-bold uppercase tracking-widest leading-none">{label}</p>}
                </div>
                <button type="button" disabled={disabled} onClick={() => onChange(parseInt(value || 0) + step)} className={`w-8 h-8 rounded-xl flex items-center justify-center transition-colors ${disabled ? 'bg-slate-700/50 text-slate-500' : 'bg-slate-700 hover:bg-emerald-500/20'}`}>
                    <Icon name="Plus" size={14}/>
                </button>
            </div>
        );

        // --- Core Gemini API Logic ---
        const callGemini = async (prompt, specificKey = null) => {
            const savedKey = localStorage.getItem('ogh_gemini_key');
            const apiKey = specificKey || savedKey || ""; 
            const model = "gemini-2.5-flash-preview-09-2025";
            const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;
            
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: { parts: [{ text: "You are Hugin, the researcher NPC from Ragnarok Online's Old Glast Heim instance. You speak Thai. You analyze player's loot data. Your tone is knowledgeable, slightly mysterious but helpful. Keep it short." }] }
            };

            for (let i = 0; i < 5; i++) {
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    const data = await response.json();
                    
                    if (data.error) {
                         if (data.error.code === 403 || data.error.message.includes('API key')) {
                             return "API Key ไม่ถูกต้อง หรือโควต้าเต็ม";
                         }
                         throw new Error(data.error.message);
                    }

                    return data.candidates?.[0]?.content?.parts?.[0]?.text || "Hugin กำลังยุ่ง...";
                } catch (e) {
                    if (i === 4) return `Error: ${e.message}`;
                    await new Promise(resolve => setTimeout(resolve, Math.pow(2, i) * 1000));
                }
            }
            return "Server Busy! Hugin ไม่ว่างคุย";
        };

        // --- Application Views ---
        const HomeView = ({ records, stats, goToTab }) => {
            const totalProfit = records.reduce((acc, r) => acc + (r.profit || 0), 0);
            const chartData = [...records].reverse().slice(-7).map((r, i) => ({ name: `Run ${i+1}`, profit: r.profit }));

            return (
                <div className="p-6 animate-fade-in view-content">
                    <header className="flex justify-between items-center mb-6">
                        <div onClick={() => goToTab('profile')} className="flex items-center gap-3 bg-white/5 p-2 rounded-full pr-4 cursor-pointer hover:bg-white/10">
                            <div className={`w-10 h-10 rounded-full flex items-center justify-center font-black ${stats.isHighClass ? 'bg-amber-500' : 'bg-slate-600'}`}>
                                {stats.jobClass.substring(0, 1)}
                            </div>
                            <div>
                                <p className="text-[10px] font-bold opacity-50">LV.{stats.baseLv}</p>
                                <p className="text-xs font-black">{stats.jobClass}</p>
                            </div>
                        </div>
                        <div className="text-right">
                            <p className="text-[10px] opacity-50 font-bold">TOTAL PROFIT</p>
                            <p className="text-2xl font-black text-emerald-400">{formatMoney(totalProfit)}</p>
                        </div>
                    </header>

                    <div className="grid grid-cols-2 gap-4 mb-4">
                        <div className="glass-panel p-4 rounded-3xl">
                            <Icon name="TrendingUp" className="text-blue-400 mb-2" />
                            <p className="text-2xl font-black">{records.length}</p>
                            <p className="text-[10px] opacity-40 font-bold">รอบที่ลงทั้งหมด</p>
                        </div>
                        <div className="glass-panel p-4 rounded-3xl">
                            <Icon name="History" className="text-amber-400 mb-2" />
                            <p className="text-lg font-black truncate">{records[0]?.date || '-'}</p>
                            <p className="text-[10px] opacity-40 font-bold">ล่าสุดเมื่อ</p>
                        </div>
                    </div>

                    <div className="glass-panel p-4 rounded-3xl h-48 overflow-hidden mb-4">
                        <p className="text-xs font-bold opacity-40 mb-2">PROFIT TREND (Last 7)</p>
                        <ResponsiveContainer width="100%" height="80%">
                            <AreaChart data={chartData}>
                                <defs>
                                    <linearGradient id="colorP" x1="0" y1="0" x2="0" y2="1">
                                        <stop offset="5%" stopColor="#a855f7" stopOpacity={0.8}/>
                                        <stop offset="95%" stopColor="#a855f7" stopOpacity={0}/>
                                    </linearGradient>
                                </defs>
                                <Area type="monotone" dataKey="profit" stroke="#a855f7" fillOpacity={1} fill="url(#colorP)" strokeWidth={3} />
                            </AreaChart>
                        </ResponsiveContainer>
                    </div>

                    <div className="space-y-3">
                        <h4 className="text-xs font-bold opacity-40 px-2 uppercase tracking-widest">Recent Activity</h4>
                        {records.slice(0, 3).map(r => (
                            <div key={r.id} className="glass-panel p-4 rounded-2xl flex justify-between items-center animate-slide-up">
                                <div className="flex items-center gap-3">
                                    <div className={`w-10 h-10 rounded-xl flex items-center justify-center font-black ${r.isSaleRecord ? 'bg-emerald-500' : (r.runMode === 'aogh' ? 'bg-rose-500' : 'bg-purple-500')}`}>
                                        {r.isSaleRecord ? '$' : r.runMode?.charAt(0).toUpperCase()}
                                    </div>
                                    <div>
                                        <p className="font-bold text-sm">{r.date}</p>
                                        <p className="text-[10px] opacity-40">{r.isSaleRecord ? 'Manual Sale' : `${formatFullMoney(r.trashAmount)} Zeny`}</p>
                                    </div>
                                </div>
                                <p className={`font-black ${r.isSaleRecord ? 'text-emerald-300' : 'text-emerald-400'}`}>{r.isSaleRecord ? '+' : ''}{formatMoney(r.profit)}</p>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const AddDataView = ({ db, uid, prices, onBack, stats, showToast, setGlobalIsSaving, onSuccess, isSaving }) => {
            const [form, setForm] = useState({
                date: new Date().toISOString().split('T')[0],
                runMode: 'ogh',
                trashAmount: '',
                gumUsed: 1,
                useSilvervine: true,
                purpleStoneCount: 0,
                contMagicCount: 0,
                isSellingSpell: false,
                isSellingMagic: false,
                customSpellPrice: '',
                customMagicPrice: '',
                minutesUsed: 60,
                otherCosts: [],
                notes: ''
            });

            useEffect(() => {
                if (form.runMode === 'ogh') {
                    setForm(prev => ({ ...prev, contMagicCount: 0, isSellingMagic: false }));
                }
            }, [form.runMode]);

            const calculateCurrentProfit = () => {
                const trash = parseInt(form.trashAmount) || 0;
                const spellPrice = form.isSellingSpell ? (parseInt(form.customSpellPrice) || prices.purpleStonePrice) : 0;
                const magicPrice = form.isSellingMagic ? (parseInt(form.customMagicPrice) || prices.contMagicPrice) : 0;
                
                const spells = (parseInt(form.purpleStoneCount) || 0) * spellPrice;
                const magics = (parseInt(form.contMagicCount) || 0) * magicPrice;
                
                const gumCost = form.gumUsed * (prices.gumBoxPrice / 10);
                const svCost = form.useSilvervine ? (prices.silvervineBoxPrice / 5) : 0;
                const otherCostTotal = form.otherCosts.reduce((acc, c) => acc + (parseInt(c.amount) || 0), 0);

                return (trash + spells + magics) - (gumCost + svCost + otherCostTotal);
            };

            const addCost = () => setForm(p => ({...p, otherCosts: [...p.otherCosts, {id: Date.now(), name: '', amount: ''}]}));
            const updateCost = (id, field, val) => {
                if (field === 'amount') {
                    val = val.replace(/[^0-9]/g, '');
                }
                setForm(p => ({...p, otherCosts: p.otherCosts.map(c => c.id === id ? {...c, [field]: val} : c)}));
            };
            const removeCost = (id) => setForm(p => ({...p, otherCosts: p.otherCosts.filter(c => c.id !== id)}));

            const handleSubmit = async (e) => {
                if(e) e.preventDefault();
                if (!form.trashAmount) return;
                setGlobalIsSaving(true);
                
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'oghza-tracker';
                const profit = calculateCurrentProfit();
                const timestamp = Date.now();
                const dekEarned = Math.floor(profit / 1000);

                try {
                    await addDoc(collection(db, 'artifacts', appId, 'users', uid, 'records'), {
                        ...form,
                        profit,
                        timestamp
                    });

                    // Update Gamification
                    const newBaseExp = stats.baseExp + 50; 
                    
                    await setDoc(doc(db, 'artifacts', appId, 'users', uid, 'gamification', 'stats'), {
                        ...stats,
                        baseExp: newBaseExp,
                        zeny: (stats.zeny || 0) + dekEarned, // Storing DEK amount in 'zeny' field for consistency with existing schema
                        coins: stats.coins + 1
                    });

                    onSuccess({ profit, dekEarned }); // Trigger Reward Popup
                    setForm({ ...form, trashAmount: '', purpleStoneCount: 0, contMagicCount: 0 }); 
                } catch (err) {
                    console.error(err);
                } finally {
                    setGlobalIsSaving(false);
                }
            };

            return (
                <div className="p-6 animate-fade-in view-content">
                    <h2 className="text-2xl font-black italic mb-6">New Run</h2>
                    
                    <form id="add-data-form" onSubmit={handleSubmit} className="space-y-6">
                        <div className="flex bg-slate-800 p-1 rounded-2xl">
                            <button type="button" onClick={() => setForm({...form, runMode: 'ogh'})} className={`flex-1 py-3 rounded-xl text-xs font-black transition-all ${form.runMode === 'ogh' ? 'bg-purple-600 shadow-lg' : 'opacity-40'}`}>OGH (Normal)</button>
                            <button type="button" onClick={() => setForm({...form, runMode: 'aogh'})} className={`flex-1 py-3 rounded-xl text-xs font-black transition-all ${form.runMode === 'aogh' ? 'bg-rose-600 shadow-lg' : 'opacity-40'}`}>AOGH (Advanced)</button>
                        </div>

                        <div className="bg-slate-900 p-6 rounded-[2.5rem] border border-white/5 text-center">
                            <p className="text-[10px] font-bold opacity-30 uppercase tracking-widest mb-2">ยอดขาย (Zeny)</p>
                            <input type="text" inputMode="numeric" placeholder="0" value={form.trashAmount} onChange={e => handleNumberInput(e, 'trashAmount', setForm)} className="w-full bg-transparent text-center text-5xl font-black outline-none placeholder-white/5" />
                        </div>

                        {/* Stones Layout - 2 Columns */}
                        <div className="grid grid-cols-2 gap-3">
                            {/* Spell Block */}
                            <div className="bg-slate-800/50 p-3 rounded-2xl flex flex-col justify-between space-y-2">
                                <div className="flex justify-between items-center mb-1">
                                    <div className="flex items-center gap-2">
                                        <SVGs.Spell className="w-6 h-6"/>
                                        <span className="text-[10px] font-bold uppercase opacity-70">Spell</span>
                                    </div>
                                    <button type="button" onClick={() => setForm(p => ({...p, isSellingSpell: !p.isSellingSpell}))} className={`px-2 py-1 rounded text-[8px] font-bold uppercase ${form.isSellingSpell ? 'bg-emerald-500 text-white' : 'bg-slate-700 text-slate-400'}`}>
                                        {form.isSellingSpell ? 'Sell' : 'Keep'}
                                    </button>
                                </div>
                                <NumberStepper value={form.purpleStoneCount} onChange={v => setForm({...form, purpleStoneCount: v})} small/>
                                {/* Persistent Price Input */}
                                <input 
                                    type="text" 
                                    placeholder={prices.purpleStonePrice} 
                                    value={form.customSpellPrice} 
                                    onChange={e => handleNumberInput(e, 'customSpellPrice', setForm)} 
                                    disabled={!form.isSellingSpell}
                                    className={`bg-slate-900/80 rounded-lg p-2 text-[10px] text-center w-full outline-none transition-all ${!form.isSellingSpell ? 'opacity-30 cursor-not-allowed' : 'opacity-100'}`} 
                                />
                            </div>

                            {/* Magic Block */}
                            <div className={`bg-slate-800/50 p-3 rounded-2xl flex flex-col justify-between space-y-2 transition-all ${form.runMode === 'ogh' ? 'opacity-30 pointer-events-none grayscale' : ''}`}>
                                <div className="flex justify-between items-center mb-1">
                                    <div className="flex items-center gap-2">
                                        <SVGs.Magic className="w-6 h-6"/>
                                        <span className="text-[10px] font-bold uppercase opacity-70">Magic</span>
                                    </div>
                                    <button type="button" onClick={() => setForm(p => ({...p, isSellingMagic: !p.isSellingMagic}))} className={`px-2 py-1 rounded text-[8px] font-bold uppercase ${form.isSellingMagic ? 'bg-emerald-500 text-white' : 'bg-slate-700 text-slate-400'}`}>
                                        {form.isSellingMagic ? 'Sell' : 'Keep'}
                                    </button>
                                </div>
                                <NumberStepper value={form.contMagicCount} onChange={v => setForm({...form, contMagicCount: v})} disabled={form.runMode === 'ogh'} small/>
                                {/* Persistent Price Input */}
                                <input 
                                    type="text" 
                                    placeholder={prices.contMagicPrice} 
                                    value={form.customMagicPrice} 
                                    onChange={e => handleNumberInput(e, 'customMagicPrice', setForm)} 
                                    disabled={!form.isSellingMagic}
                                    className={`bg-slate-900/80 rounded-lg p-2 text-[10px] text-center w-full outline-none transition-all ${!form.isSellingMagic ? 'opacity-30 cursor-not-allowed' : 'opacity-100'}`} 
                                />
                            </div>
                        </div>

                        {/* Supplies */}
                        <div className="glass-panel p-5 rounded-3xl space-y-4">
                            <div className="flex justify-between items-center">
                                <span className="text-xs font-bold opacity-50 flex items-center gap-2">
                                    <SVGs.Gum className="w-5 h-5"/> Bubble Gum
                                </span>
                                <div className="flex gap-2">
                                    {[0, 1, 2].map(n => (
                                        <button key={n} type="button" onClick={() => setForm({...form, gumUsed: n})} className={`w-8 h-8 rounded-lg font-bold text-xs transition-all ${form.gumUsed === n ? 'bg-blue-600' : 'bg-slate-800 opacity-40'}`}>{n}</button>
                                    ))}
                                </div>
                            </div>
                            <div className="flex justify-between items-center">
                                <span className="text-xs font-bold opacity-50 flex items-center gap-2">
                                    <SVGs.Silvervine className="w-5 h-6"/> Use Silvervine
                                </span>
                                <button type="button" onClick={() => setForm({...form, useSilvervine: !form.useSilvervine})} className={`w-12 h-6 rounded-full relative transition-all ${form.useSilvervine ? 'bg-emerald-500' : 'bg-slate-700'}`}>
                                    <div className={`absolute top-1 w-4 h-4 bg-white rounded-full transition-all ${form.useSilvervine ? 'right-1' : 'left-1'}`}></div>
                                </button>
                            </div>
                        </div>

                        {/* Etc Costs */}
                        <div>
                            <div className="flex justify-between items-center mb-2">
                                <span className="text-xs font-bold opacity-50 uppercase">Etc. Cost</span>
                                <button type="button" onClick={addCost} className="text-[10px] bg-slate-800 px-2 py-1 rounded text-white flex items-center gap-1"><Icon name="Plus" size={10}/> Add</button>
                            </div>
                            {form.otherCosts.map(c => (
                                <div key={c.id} className="flex gap-2 mb-2">
                                    <input type="text" placeholder="รายการ" value={c.name} onChange={e => updateCost(c.id, 'name', e.target.value)} className="flex-1 bg-slate-800 rounded-lg px-3 py-2 text-xs outline-none" />
                                    <input type="text" inputMode="numeric" placeholder="0" value={c.amount} onChange={e => updateCost(c.id, 'amount', e.target.value)} className="w-20 bg-slate-800 rounded-lg px-3 py-2 text-xs outline-none text-right" />
                                    <button type="button" onClick={() => removeCost(c.id)} className="p-2 text-rose-500"><Icon name="Trash" size={14}/></button>
                                </div>
                            ))}
                        </div>

                        {/* Notes */}
                        <div>
                            <span className="text-xs font-bold opacity-50 uppercase mb-2 block">Memo</span>
                            <textarea value={form.notes} onChange={e => setForm({...form, notes: e.target.value})} className="w-full bg-slate-800 rounded-xl p-3 text-xs outline-none h-20 resize-none" placeholder="Notes..."></textarea>
                        </div>
                        
                        {/* Restore Save Button */}
                        <button 
                            type="submit"
                            disabled={isSaving || !form.trashAmount} 
                            className="w-full py-4 bg-gradient-to-tr from-purple-600 to-indigo-600 rounded-2xl font-black text-lg shadow-xl shadow-purple-500/20 active:scale-95 transition-transform disabled:opacity-50 flex items-center justify-center gap-2"
                        >
                            {isSaving ? <Icon name="Loader" className="animate-spin" size={24}/> : "SAVE RECORD"}
                        </button>
                    </form>
                </div>
            );
        };

        const InventoryView = ({ records, prices, db, uid, showToast }) => {
            const [sellModal, setSellModal] = useState(null); 
            const [sellQty, setSellQty] = useState("");
            const [sellPrice, setSellPrice] = useState("");

            const totalSpells = records.reduce((acc, r) => acc + (parseInt(r.purpleStoneCount) || 0), 0);
            const totalMagics = records.reduce((acc, r) => acc + (parseInt(r.contMagicCount) || 0), 0);
            
            const handleSell = async () => {
                if(!sellModal || !sellQty || !sellPrice) return;
                const qty = parseInt(sellQty);
                const price = parseInt(sellPrice);
                
                try {
                    const appId = typeof __app_id !== 'undefined' ? __app_id : 'oghza-tracker';
                    await addDoc(collection(db, 'artifacts', appId, 'users', uid, 'records'), {
                        date: new Date().toISOString().split('T')[0],
                        runMode: 'SALE',
                        trashAmount: 0,
                        purpleStoneCount: sellModal.item === 'spell' ? -qty : 0,
                        contMagicCount: sellModal.item === 'magic' ? -qty : 0,
                        profit: qty * price,
                        isSaleRecord: true,
                        timestamp: Date.now()
                    });
                    
                    showToast(`ขาย ${sellModal.item} x${qty} สำเร็จ!`);
                    setSellModal(null);
                    setSellQty("");
                    setSellPrice("");
                } catch(e) {
                    console.error(e);
                }
            };

            // Grid Slots logic
            const slots = Array.from({ length: 24 });
            
            return (
                <div className="p-6 animate-fade-in view-content h-full">
                    <h2 className="text-2xl font-black italic">Inventory</h2>

                    {/* Inventory Grid */}
                    <div className="bg-[#1e293b] p-4 rounded-[2rem] shadow-xl border border-slate-700/50">
                        <div className="grid grid-cols-4 gap-3">
                            {slots.map((_, index) => {
                                let content = null;
                                let onClick = null;
                                
                                if (index === 0) {
                                     content = { icon: <SVGs.Spell className="w-10 h-10 drop-shadow-md"/>, count: totalSpells, id: 'spell', price: prices.purpleStonePrice };
                                } else if (index === 1) {
                                     content = { icon: <SVGs.Magic className="w-10 h-10 drop-shadow-md"/>, count: totalMagics, id: 'magic', price: prices.contMagicPrice };
                                }

                                if (content) {
                                    onClick = () => { setSellModal({item: content.id, max: content.count}); setSellPrice(content.price); };
                                }

                                return (
                                     <div key={index} onClick={onClick} className={`aspect-square rounded-2xl relative flex items-center justify-center transition-all ${content ? 'bg-slate-800 border border-slate-600 cursor-pointer active:scale-95 hover:border-indigo-400' : 'bg-slate-800/20 border-2 border-dashed border-slate-700/50 hover:border-slate-600/50'}`}>
                                        {content && (
                                            <>
                                                <div className="animate-pop-in">{content.icon}</div>
                                                <span className="absolute bottom-1 right-1.5 text-[10px] font-black text-white bg-black/60 px-1.5 rounded-md backdrop-blur-sm">{content.count}</span>
                                            </>
                                        )}
                                     </div>
                                );
                            })}
                        </div>
                         <div className="mt-4 pt-4 border-t border-slate-700 flex justify-between items-center px-2">
                            <span className="text-[10px] font-bold opacity-50 uppercase tracking-widest">Total Value</span>
                            <span className="text-lg font-black text-emerald-400">{formatMoney((totalSpells * prices.purpleStonePrice) + (totalMagics * prices.contMagicPrice))} z</span>
                         </div>
                    </div>

                    {sellModal && (
                        <Modal onClose={() => setSellModal(null)}>
                            <h3 className="text-xl font-black mb-4 uppercase">Sell {sellModal.item}</h3>
                            <div className="space-y-4">
                                <div>
                                    <label className="text-[10px] opacity-50 uppercase">Quantity (Max: {sellModal.max})</label>
                                    <input type="text" inputMode="numeric" value={sellQty} onChange={e => {
                                        let val = parseInt(e.target.value.replace(/\D/g, '')) || '';
                                        if(val > sellModal.max) val = sellModal.max;
                                        setSellQty(val);
                                    }} className="w-full bg-slate-800 p-3 rounded-xl outline-none font-bold text-lg" autoFocus/>
                                </div>
                                <div>
                                    <label className="text-[10px] opacity-50 uppercase">Price / Unit</label>
                                    <input type="text" inputMode="numeric" value={sellPrice} onChange={e => handleNumberInput(e, '', setSellPrice)} className="w-full bg-slate-800 p-3 rounded-xl outline-none font-bold text-lg"/>
                                </div>
                                <div className="flex gap-2 pt-2">
                                    <button onClick={() => setSellModal(null)} className="flex-1 py-3 bg-slate-800 rounded-xl font-bold text-xs">Cancel</button>
                                    <button onClick={handleSell} className="flex-1 py-3 bg-emerald-600 rounded-xl font-bold text-xs">Confirm Sale</button>
                                </div>
                            </div>
                        </Modal>
                    )}
                </div>
            );
        };

        const SettingsView = ({ uid, defaultUid, prices, setPrices, db, onResetUid, onRestoreUid, showToast, showAiFab, setShowAiFab }) => {
            // ... (Previous Settings code maintained for brevity, assumed unchanged logic)
            // Including full code for context
            const [localPrices, setLocalPrices] = useState(prices);
            const [isSaving, setIsSaving] = useState(false);
            const [restoreInput, setRestoreInput] = useState("");
            const [apiKeyInput, setApiKeyInput] = useState(localStorage.getItem('ogh_gemini_key') || "");
            const [showChangelog, setShowChangelog] = useState(false);
            const [isDeleting, setIsDeleting] = useState(false);
            const [isSavingKey, setIsSavingKey] = useState(false);
            const [isRestoring, setIsRestoring] = useState(false);

            const savePrices = async () => {
                setIsSaving(true);
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'oghza-tracker';
                await setDoc(doc(db, 'artifacts', appId, 'users', uid, 'config', 'prices'), localPrices);
                setPrices(localPrices);
                setIsSaving(false);
            };

            const handleSaveApiKey = async () => {
                if (!apiKeyInput) return;
                setIsSavingKey(true);
                const check = await callGemini("Say Hello", apiKeyInput);
                if (check.startsWith("API Key ไม่ถูกต้อง") || check.startsWith("Error")) {
                    alert("API Key ไม่สามารถใช้งานได้จริง: " + check);
                    setIsSavingKey(false);
                    return;
                }
                localStorage.setItem('ogh_gemini_key', apiKeyInput);
                setIsSavingKey(false);
                if(showToast) showToast("API Key ใช้งานได้! บันทึกเรียบร้อย");
            };

            const handleRestore = async () => {
                if (!restoreInput.trim()) return;
                if (restoreInput.length < 5) {
                    alert("UID สั้นเกินไป กรุณาตรวจสอบอีกครั้ง");
                    return;
                }
                
                setIsRestoring(true);
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'oghza-tracker';
                try {
                    // Check for existence
                    const statsRef = doc(db, 'artifacts', appId, 'users', restoreInput, 'gamification', 'stats');
                    const statsSnap = await getDoc(statsRef);
                    
                    if (!statsSnap.exists()) {
                        // Not found - strict validation
                        alert("❌ ไม่พบ UID นี้ในระบบ\nกรุณาตรวจสอบว่าพิมพ์ถูกต้องหรือไม่");
                    } else {
                        // Found
                        const userData = statsSnap.data();
                        const confirmMsg = `✅ ค้นพบข้อมูล!\nClass: ${userData.jobClass || 'Novice'}\nCoins: ${userData.coins || 0}\n\nต้องการกู้คืนข้อมูลนี้ใช่หรือไม่?`;
                        
                        if(confirm(confirmMsg)) {
                            onRestoreUid(restoreInput);
                            setRestoreInput("");
                        }
                    }
                } catch (e) {
                    alert("Error: " + e.message);
                } finally {
                    setIsRestoring(false);
                }
            };

            const handleDeleteAll = async () => {
                if (!confirm("⚠️ คำเตือน: คุณแน่ใจหรือไม่ที่จะลบข้อมูลทั้งหมด?")) return;
                const confirm2 = prompt("พิมพ์คำว่า 'DELETE' เพื่อยืนยัน");
                if (confirm2 !== 'DELETE') return;
                setIsDeleting(true);
                try {
                    const appId = typeof __app_id !== 'undefined' ? __app_id : 'oghza-tracker';
                    const userRef = collection(db, 'artifacts', appId, 'users', uid, 'records');
                    const snapshot = await getDocs(userRef);
                    const deletePromises = snapshot.docs.map(doc => deleteDoc(doc.ref));
                    await Promise.all(deletePromises);
                    await setDoc(doc(db, 'artifacts', appId, 'users', uid, 'gamification', 'stats'), INITIAL_STATS);
                    alert("ลบข้อมูลทั้งหมดเรียบร้อยแล้ว");
                    window.location.reload();
                } catch(e) { alert("Error: " + e.message); } finally { setIsDeleting(false); }
            };

            const configItems = [
                { id: 'purpleStonePrice', label: 'Coagulated Spell', icon: <SVGs.Spell className="w-5 h-5"/> },
                { id: 'contMagicPrice', label: 'Contaminated Magic', icon: <SVGs.Magic className="w-5 h-5"/> },
                { id: 'gumBoxPrice', label: 'Bubble Gum (Box)', icon: <SVGs.GumBox className="w-5 h-5"/> },
                { id: 'silvervineBoxPrice', label: 'Silvervine (Box)', icon: <SVGs.SilvervineBox className="w-5 h-5"/> }
            ];

            return (
                <div className="p-6 animate-fade-in view-content space-y-8">
                    <h2 className="text-2xl font-black italic">Settings</h2>
                    
                    <div className="glass-panel p-5 rounded-3xl space-y-4">
                        <div className="flex justify-between items-center">
                            <span className="text-xs font-bold uppercase opacity-50">UID Recovery</span>
                            {uid !== defaultUid && (
                                <button onClick={onResetUid} className="text-[10px] text-rose-400 font-bold uppercase border border-rose-500/30 px-2 py-1 rounded-lg">Reset</button>
                            )}
                        </div>
                        <div className="bg-black/30 p-3 rounded-xl flex items-center justify-between gap-2">
                            <div className="overflow-hidden">
                                <p className="text-[9px] opacity-40 uppercase">Current UID</p>
                                <code className="text-xs font-mono opacity-80 truncate block">{uid}</code>
                            </div>
                            <button onClick={() => { copyToClipboard(uid); if(showToast) showToast("คัดลอก UID แล้ว"); }} className="p-2 bg-white/5 rounded-lg active:scale-95">
                                <Icon name="Copy" size={14}/>
                            </button>
                            {/* NEW: Small text link for resetting UID */}
                        </div>
                        <div className="text-right">
                             <button onClick={onResetUid} className="text-[10px] text-slate-400 hover:text-white underline">กลับสู่ UID เดิมของเครื่องนี้</button>
                        </div>
                        <div className="flex gap-2">
                            <input 
                                type="text" 
                                value={restoreInput} 
                                onChange={e => setRestoreInput(e.target.value)} 
                                placeholder="ระบุ UID เพื่อกู้คืน..." 
                                className="flex-1 bg-slate-800 rounded-xl px-4 text-xs outline-none focus:ring-2 focus:ring-blue-500/50 transition-all" 
                            />
                            <button 
                                onClick={handleRestore} 
                                disabled={isRestoring || !restoreInput}
                                className={`px-4 py-2 rounded-xl text-xs font-bold transition-all flex items-center gap-2 ${
                                    isRestoring || !restoreInput 
                                    ? 'bg-slate-700 text-slate-500 cursor-not-allowed' 
                                    : 'bg-blue-600 text-white shadow-lg shadow-blue-500/30 active:scale-95 hover:bg-blue-500'
                                }`}
                            >
                                {isRestoring ? <Icon name="Loader" className="animate-spin" size={16}/> : <><Icon name="Refresh" size={16}/> Restore</>}
                            </button>
                        </div>
                    </div>

                    <div className="glass-panel p-5 rounded-3xl space-y-4">
                        <div className="flex justify-between items-center">
                            <span className="text-xs font-bold uppercase opacity-50">Hugin's Service (AI)</span>
                            <button onClick={() => setShowAiFab(!showAiFab)} className="text-indigo-400">
                                {showAiFab ? <Icon name="ToggleOn" size={28}/> : <Icon name="ToggleOff" size={28}/>}
                            </button>
                        </div>
                        <div className="flex gap-2">
                            <input type="password" value={apiKeyInput} onChange={e => setApiKeyInput(e.target.value)} placeholder="Paste Key..." className="flex-1 bg-slate-800 rounded-xl px-4 text-xs outline-none h-12" />
                            <button onClick={handleSaveApiKey} disabled={!apiKeyInput || isSavingKey} className={`px-4 rounded-xl text-xs font-bold flex items-center gap-2 ${!apiKeyInput ? 'bg-slate-700' : 'bg-indigo-600'}`}>
                                {isSavingKey ? <Icon name="Loader" className="animate-spin" size={16}/> : <Icon name="Check" size={16}/>}
                            </button>
                        </div>
                    </div>

                    <div className="space-y-4">
                        <h3 className="text-xs font-bold opacity-40 px-2 uppercase tracking-widest">Prices</h3>
                        <div className="grid grid-cols-2 gap-4">
                            {configItems.map(item => (
                                <div key={item.id} className="glass-panel p-4 rounded-2xl">
                                    <div className="flex items-center gap-2 mb-2 opacity-50">
                                        {item.icon}
                                        <span className="text-[9px] font-bold uppercase truncate">{item.label}</span>
                                    </div>
                                    <input type="text" inputMode="numeric" value={localPrices[item.id]} onChange={e => setLocalPrices({...localPrices, [item.id]: parseInt(e.target.value.replace(/\D/g,'')) || 0})} className="w-full bg-transparent text-xl font-black outline-none" />
                                </div>
                            ))}
                        </div>
                        <button onClick={savePrices} disabled={isSaving} className="w-full py-4 bg-emerald-600 rounded-2xl font-black text-lg active:scale-95 transition-all">
                            {isSaving ? "SAVING..." : "SAVE PRICES"}
                        </button>
                    </div>

                    <div className="pt-8 border-t border-white/5">
                        <button onClick={handleDeleteAll} disabled={isDeleting} className="w-full py-4 border border-rose-500/30 text-rose-400 rounded-2xl font-bold text-xs uppercase hover:bg-rose-500/10 flex justify-center gap-2">
                            {isDeleting ? <Icon name="Loader" className="animate-spin" size={16}/> : <><Icon name="Trash" size={16}/> DELETE ALL DATA</>}
                        </button>
                    </div>

                    <div className="text-center pt-4">
                        <button onClick={() => setShowChangelog(true)} className="opacity-20 hover:opacity-100 text-[10px] font-bold">{APP_VERSION}</button>
                    </div>

                    {showChangelog && (
                        <Modal onClose={() => setShowChangelog(false)}>
                            <div className="space-y-4">
                                <h3 className="text-xl font-black italic">Changelog</h3>
                                <div className="space-y-4 max-h-[60vh] overflow-y-auto">
                                    {CHANGELOGS.map((log, idx) => (
                                        <div key={idx} className="bg-slate-800/50 p-4 rounded-2xl">
                                            <div className="flex justify-between items-end mb-1">
                                                <span className="text-lg font-black text-white">{log.ver}</span>
                                                <span className="text-[9px] opacity-40 uppercase">{log.date}</span>
                                            </div>
                                            <p className="text-xs opacity-70 leading-relaxed">{log.desc}</p>
                                        </div>
                                    ))}
                                </div>
                                <button onClick={() => setShowChangelog(false)} className="w-full py-3 bg-slate-800 rounded-xl font-bold text-xs">Close</button>
                            </div>
                        </Modal>
                    )}
                </div>
            );
        };

        // --- Main App Component ---
        function App() {
            const [authUser, setAuthUser] = useState(null);
            const [targetUid, setTargetUid] = useState(null);
            const [activeTab, setActiveTab] = useState('home');
            const [records, setRecords] = useState([]);
            const [prices, setPrices] = useState({ purpleStonePrice: 150000, contMagicPrice: 450000, gumBoxPrice: 1500000, silvervineBoxPrice: 2500000 });
            const [stats, setStats] = useState(INITIAL_STATS);
            const [loading, setLoading] = useState(true);
            const [toast, setToast] = useState(null);
            const [isSaving, setIsSaving] = useState(false);
            const [rewardData, setRewardData] = useState(null);
            const [showAiFab, setShowAiFab] = useState(false); // Default OFF
            const [aiResult, setAiResult] = useState(null);
            const [isAnalysing, setIsAnalysing] = useState(false);

            const dbRef = useRef(null);
            const authRef = useRef(null);
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'oghza-tracker';

            const showToast = (message) => setToast(message);
            const handleRestoreUid = (newUid) => { localStorage.setItem('ogh_target_uid', newUid); setTargetUid(newUid); showToast("Restored UID: " + newUid); };
            const handleResetUid = () => { localStorage.removeItem('ogh_target_uid'); if (authUser) setTargetUid(authUser.uid); showToast("Reset to Default"); };

            useEffect(() => {
                const initFirebase = async () => {
                    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : MANUAL_FIREBASE_CONFIG;
                    const app = initializeApp(firebaseConfig);
                    authRef.current = getAuth(app);
                    dbRef.current = getFirestore(app);
                    
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) { await signInWithCustomToken(authRef.current, __initial_auth_token); } else { await signInAnonymously(authRef.current); }

                    onAuthStateChanged(authRef.current, (u) => {
                        setAuthUser(u);
                        const savedUid = localStorage.getItem('ogh_target_uid');
                        const effectiveUid = savedUid || u?.uid;
                        setTargetUid(effectiveUid);
                        if (effectiveUid) {
                            onSnapshot(query(collection(dbRef.current, 'artifacts', appId, 'users', effectiveUid, 'records'), orderBy('timestamp', 'desc')), (snap) => {
                                setRecords(snap.docs.map(d => ({ ...d.data(), id: d.id })));
                            });
                            onSnapshot(doc(dbRef.current, 'artifacts', appId, 'users', effectiveUid, 'config', 'prices'), d => { if (d.exists()) setPrices(d.data()); });
                            onSnapshot(doc(dbRef.current, 'artifacts', appId, 'users', effectiveUid, 'gamification', 'stats'), d => { if (d.exists()) setStats(d.data()); });
                        }
                        setLoading(false);
                    });
                };
                initFirebase();
            }, []);

            useEffect(() => {
                if (!dbRef.current || !targetUid) return;
                const unsubRecords = onSnapshot(query(collection(dbRef.current, 'artifacts', appId, 'users', targetUid, 'records'), orderBy('timestamp', 'desc')), (snap) => setRecords(snap.docs.map(d => ({ ...d.data(), id: d.id }))));
                const unsubPrices = onSnapshot(doc(dbRef.current, 'artifacts', appId, 'users', targetUid, 'config', 'prices'), d => { if (d.exists()) setPrices(d.data()); });
                const unsubStats = onSnapshot(doc(dbRef.current, 'artifacts', appId, 'users', targetUid, 'gamification', 'stats'), d => { if (d.exists()) setStats(d.data()); else setStats(INITIAL_STATS); });
                return () => { unsubRecords(); unsubPrices(); unsubStats(); };
            }, [targetUid]);

            const triggerAiAnalysis = async () => {
                // Check if user has recorded at least 5 times (QUEST)
                if (records.length < 5) {
                    showToast(`🔒 ยังไม่ปลดล็อค: ต้องบันทึกข้อมูลให้ครบ 5 รอบ (ขาดอีก ${5 - records.length} รอบ)`);
                    return;
                }

                if (stats.coins < 1) {
                    showToast("ไม่สามารถวิเคราะห์ได้: Coins ไม่พอ (ต้องการ 1 Coin)");
                    return;
                }

                setIsAnalysing(true);
                
                // Deduct Coin
                try {
                    await setDoc(doc(dbRef.current, 'artifacts', appId, 'users', targetUid, 'gamification', 'stats'), {
                        ...stats,
                        coins: stats.coins - 1
                    });
                } catch (e) {
                    console.error("Coin deduction failed", e);
                    setIsAnalysing(false);
                    return;
                }

                // Calculate Stock Data
                const totalSpells = records.reduce((acc, r) => acc + (parseInt(r.purpleStoneCount) || 0), 0);
                const totalMagics = records.reduce((acc, r) => acc + (parseInt(r.contMagicCount) || 0), 0);
                const totalValue = (totalSpells * prices.purpleStonePrice) + (totalMagics * prices.contMagicPrice);
                
                // Get Recent History (Last 5 Runs)
                const recentRuns = records.slice(0, 5).map(r => ({ date: r.date, profit: r.profit }));

                const prompt = `
                    ข้อมูลผู้เล่น OGHza Tracker:
                    - คลังปัจจุบัน: หินม่วง ${totalSpells} ชิ้น, หินแดง ${totalMagics} ชิ้น
                    - มูลค่ารวมในคลัง: ${totalValue.toLocaleString()} Zeny
                    - ราคากลาง: หินม่วง ${prices.purpleStonePrice}, หินแดง ${prices.contMagicPrice}
                    - ประวัติ 5 รอบล่าสุด: ${JSON.stringify(recentRuns)}
                    
                    สวมบทบาทเป็น Hugin (NPC นักวิจัยหน้าดัน OGH):
                    1. ทักทายแบบนักวิจัยลึกลับ
                    2. วิเคราะห์ดวงจากประวัติล่าสุด (เกลือ/เทพ)
                    3. แนะนำการขายของ (ช่วงนี้ควรรีบขายหรือดองไว้)
                    4. ทิ้งท้ายกวนๆ
                    (ตอบสั้นๆ ไม่เกิน 3 ย่อหน้า ภาษาไทย)
                `;
                
                const result = await callGemini(prompt);
                setAiResult(result);
                setIsAnalysing(false);
            };

            if (loading) return ( <div className="h-screen flex flex-col items-center justify-center space-y-4 bg-[#0f172a]"><Icon name="Loader" className="animate-spin text-purple-500" size={40} /><p className="font-black text-xs uppercase tracking-widest opacity-30">Connecting...</p></div> );

            const renderContent = () => {
                switch(activeTab) {
                    case 'home': return <HomeView records={records} stats={stats} goToTab={setActiveTab} />;
                    case 'add': return <AddDataView db={dbRef.current} uid={targetUid} prices={prices} stats={stats} onBack={() => setActiveTab('home')} showToast={showToast} setGlobalIsSaving={setIsSaving} onSuccess={setRewardData} isSaving={isSaving} />;
                    case 'inventory': return <InventoryView records={records} prices={prices} db={dbRef.current} uid={targetUid} showToast={showToast} />;
                    case 'settings': return <SettingsView uid={targetUid} defaultUid={authUser?.uid} prices={prices} setPrices={setPrices} db={dbRef.current} onResetUid={handleResetUid} onRestoreUid={handleRestoreUid} showToast={showToast} showAiFab={showAiFab} setShowAiFab={setShowAiFab} />;
                    case 'history': return (
                        <div className="p-6 animate-fade-in view-content space-y-4">
                            <h2 className="text-2xl font-black italic">History Logs</h2>
                            {records.map(r => (
                                <div key={r.id} className={`glass-panel p-4 rounded-2xl flex justify-between items-center ${r.isSaleRecord ? 'border-l-4 border-l-emerald-500' : ''}`}>
                                    <div className="flex gap-3">
                                        <div className={`w-10 h-10 rounded-xl flex items-center justify-center font-black ${r.isSaleRecord ? 'bg-emerald-500' : (r.runMode === 'aogh' ? 'bg-rose-500' : 'bg-purple-500')}`}>
                                            {r.isSaleRecord ? '$' : r.runMode?.charAt(0).toUpperCase()}
                                        </div>
                                        <div>
                                            <p className="font-bold">{r.date}</p>
                                            <p className="text-[10px] opacity-40">{r.isSaleRecord ? 'Manual Sale' : `${formatFullMoney(r.trashAmount)} Zeny`}</p>
                                        </div>
                                    </div>
                                    <div className="text-right">
                                        <p className={`font-black ${r.isSaleRecord ? 'text-emerald-300' : 'text-emerald-400'}`}>{r.isSaleRecord ? '+' : ''}{formatMoney(r.profit)}</p>
                                        <button onClick={async () => { if(confirm("Delete this record?")) await deleteDoc(doc(dbRef.current, 'artifacts', appId, 'users', targetUid, 'records', r.id)); }} className="text-[9px] font-bold opacity-20 hover:opacity-100 text-rose-400 uppercase">Del</button>
                                    </div>
                                </div>
                            ))}
                        </div>
                    );
                    case 'profile': return (
                        <div className="p-6 animate-fade-in view-content space-y-8">
                            <div className="text-center space-y-4">
                                <div className={`w-32 h-32 mx-auto rounded-[2.5rem] flex items-center justify-center text-4xl font-black shadow-2xl ${stats.isHighClass ? 'bg-amber-500' : 'bg-slate-700'}`}>{stats.jobClass.substring(0, 2).toUpperCase()}</div>
                                <div><h2 className="text-3xl font-black italic">{stats.jobClass}</h2><p className="text-xs font-bold opacity-40 uppercase tracking-widest">Base Lv. {stats.baseLv} / Job Lv. {stats.jobLv}</p></div>
                            </div>
                            <div className="grid grid-cols-2 gap-4">
                                <div className="glass-panel p-6 rounded-3xl text-center"><p className="text-2xl font-black text-amber-500">{stats.coins}</p><p className="text-[10px] font-bold opacity-40 uppercase">Coins</p></div>
                                <div className="glass-panel p-6 rounded-3xl text-center"><p className="text-xl font-black text-blue-400 truncate">{formatMoney(stats.zeny)}</p><p className="text-[10px] font-bold opacity-40 uppercase">DEKZA Coin (DEK)</p></div>
                            </div>
                        </div>
                    );
                    default: return <HomeView records={records} stats={stats} goToTab={setActiveTab} />;
                }
            };

            const isAiLocked = records.length < 5;

            return (
                <div className="max-w-md mx-auto relative min-h-screen">
                    {toast && <Toast message={toast} onClose={() => setToast(null)} />}
                    {rewardData && <RewardPopup data={rewardData} onClose={() => setRewardData(null)} />}
                    {aiResult && <AiAnalysisModal analysisResult={aiResult} onClose={() => setAiResult(null)} />}
                    
                    {/* Floating AI Button (Global) */}
                    {showAiFab && (
                        <button 
                            onClick={triggerAiAnalysis}
                            disabled={isAnalysing}
                            className={`fixed bottom-24 right-6 w-16 h-16 rounded-full shadow-lg flex items-center justify-center animate-hugin active:scale-90 transition-transform z-50 border-2 border-white/20 ${isAiLocked ? 'bg-slate-700 grayscale' : 'bg-gradient-to-br from-amber-500 to-orange-600 shadow-orange-500/40'}`}
                        >
                            {isAnalysing ? <Icon name="Loader" className="animate-spin text-white" size={28}/> : (isAiLocked ? <Icon name="Lock" className="text-white/50" size={24}/> : <SVGs.Hugin className="w-10 h-10"/>)}
                        </button>
                    )}

                    {renderContent()}

                    {/* New Standard Tab Bar - Reordered */}
                    <nav className="fixed bottom-0 left-0 right-0 max-w-md mx-auto glass-panel border-t border-white/5 nav-bar-padding pt-2 px-2 flex justify-between items-end z-40 rounded-t-[2rem]">
                        <button onClick={() => setActiveTab('home')} className={`flex-1 flex flex-col items-center gap-1 py-3 transition-all ${activeTab === 'home' ? 'text-purple-400' : 'opacity-40'}`}>
                            <Icon name="Home" size={24}/>
                            <span className="text-[9px] font-bold uppercase">Home</span>
                        </button>
                        <button onClick={() => setActiveTab('add')} className={`flex-1 flex flex-col items-center gap-1 py-3 transition-all ${activeTab === 'add' ? 'text-purple-400' : 'opacity-40'}`}>
                            <Icon name="Warp" size={24}/>
                            <span className="text-[9px] font-bold uppercase">Dungeon</span>
                        </button>
                        <button onClick={() => setActiveTab('history')} className={`flex-1 flex flex-col items-center gap-1 py-3 transition-all ${activeTab === 'history' ? 'text-purple-400' : 'opacity-40'}`}>
                            <Icon name="History" size={24}/>
                            <span className="text-[9px] font-bold uppercase">History</span>
                        </button>
                        <button onClick={() => setActiveTab('inventory')} className={`flex-1 flex flex-col items-center gap-1 py-3 transition-all ${activeTab === 'inventory' ? 'text-purple-400' : 'opacity-40'}`}>
                            <Icon name="Box" size={24}/>
                            <span className="text-[9px] font-bold uppercase">Stock</span>
                        </button>
                        <button onClick={() => setActiveTab('settings')} className={`flex-1 flex flex-col items-center gap-1 py-3 transition-all ${activeTab === 'settings' ? 'text-purple-400' : 'opacity-40'}`}>
                            <Icon name="Settings" size={24}/>
                            <span className="text-[9px] font-bold uppercase">Setting</span>
                        </button>
                    </nav>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
